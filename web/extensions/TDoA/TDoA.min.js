

/* web/extensions/TDoA/TDoA.min.js (web/extensions/TDoA/TDoA.js = Wed Jun 26 04:53:47 2024) */
var tdoa={ext_name:'TDoA',first_time:true,new_polling_method:true,old_algorithm:false,all_results:false,prev_ui:false,spiderfied:false,spiderfy_deferred:false,orange_rect:false,ii:0,leaflet:true,w_data:1024,h_data:445,hosts_sel:0,hosts_sel_s:['all','&le;1.646','&ge;1.653'],pkgs_maps_js:['pkgs_maps/pkgs_maps.js','pkgs_maps/pkgs_maps.css'],gmap_js:['http://maps.googleapis.com/maps/api/js?key=','pkgs_maps/gmaps/daynightoverlay.js','pkgs_maps/gmaps/markerwithlabel.js','pkgs_maps/gmaps/v3_ll_grat.js','pkgs_maps/gmaps/markerclusterer.js',],hosts:[],hosts_dither:[],tfields:6,ngood:0,field:[],list:[],results:[],result_refs:[],result_mkrs:[],heatmap:[],cur_map:null,kiwi_map:null,result_map:null,map_layers:[],init_lat:20,init_lon:15,init_zoom:2,mapZoom_nom:17,hosts_clusterer:null,refs_clusterer:null,heatmap_visible:true,show_hosts:true,show_refs:true,rerun:0,last_was_rerun:0,FIRST_REF:2,known_location:'',quick_zoom:[{n:'World',lat:20,lon:0,z:2},{n:'Europe',lat:52,lon:10,z:4},{n:'N.Amer',lat:40,lon:-90,z:3},{n:'S.Amer',lat:-20,lon:-50,z:3},{n:'Asia',lat:40,lon:120,z:3},{n:'Japan',lat:40,lon:140,z:4},{n:'Aus/NZ',lat:-30,lon:150,z:3},],sample_time_i:1,sample_time_s:['15s','30s','45s','60s'],sample_time:30,sample_status:[{s:'sampling complete',retry:0},{s:'connection failed',retry:0},{s:'all channels in use',retry:1},{s:'no recent GPS timestamps',retry:0},{s:'',retry:0}],SAMPLE_STATUS_BLANK:4,submit_status:[{n:0,f:0,m:'TDoA complete'},{n:1,f:1,m:'Octave'},{n:2,f:0,m:'some Kiwis had a sampling error'},{n:3,f:0,m:'some Kiwis had no GPS timestamps at all'},{n:4,f:0,m:'some Kiwis had no recent GPS timestamps'},{n:5,f:1,m:'pair map'},{n:6,f:1,m:'combined map'},{n:7,f:1,m:'dt plot'},{n:8,f:0,m:'out of memory: use fewer Kiwis or check signal quality'},{n:9,f:1,m:'combined contour'},{n:10,f:1,m:'map plot'},{n:11,f:0,m:'reposition map not to span 180 deg meridian'},{n:12,f:0,m:'files for rerun no longer exist'},],KIWI_MAP:0,TDOA_MAP_NO_HOSTS:1,TDOA_MAP_WITH_HOSTS:2,COMBINED_MAP:3,SINGLE_MAPS:4,state:0,READY_SAMPLE:0,READY_COMPUTE:1,RUNNING:2,RETRY:3,RESULT:4,ERROR:5,key:'',response:{},SEQ_DONE:4,select:undefined,};function TDoA_main(){tdoa.url_base=kiwi_add_end(cfg.tdoa.server,'/');tdoa.url=tdoa.url_base+'tdoa/';tdoa.url_files=tdoa.url+'files/';tdoa.rep_files=kiwi_remove_protocol(tdoa.url)+'files';ext_switch_to_client(tdoa.ext_name,tdoa.first_time,tdoa_recv);if(!tdoa.first_time)
tdoa_controls_setup();tdoa.first_time=false;}
function tdoa_recv(data){var firstChars=arrayBufferToStringLen(data,3);if(firstChars=="DAT"){var ba=new Uint8Array(data,4);var cmd=ba[0];if(cmd==0){}else{}
return;}
var stringData=arrayBufferToString(data);var params=stringData.substring(4).split(" ");for(var i=0;i<params.length;i++){var param=params[i].split("=");if(0&&param[0]!="keepalive"){if(isDefined(param[1]))
console.log('tdoa_recv: '+param[0]+'='+param[1]);else
console.log('tdoa_recv: '+param[0]);}
switch(param[0]){case"ready":tdoa.a=(decodeURIComponent(param[1])).split(',');tdoa.a[0]=enc(tdoa.a[0]);tdoa.a[1]=enc(tdoa.a[1]);tdoa.params=ext_param();console.log('### TDoA: tdoa.params='+tdoa.params);if(tdoa.params&&tdoa.params.includes('gmap:')){tdoa.leaflet=false;tdoa.gmap_param=true;}
kiwi_load_js(tdoa.leaflet?tdoa.pkgs_maps_js:tdoa.gmap_js,'tdoa_controls_setup');break;default:console.log('tdoa_recv: UNKNOWN CMD '+param[0]);break;}}}
function tdoa_controls_setup(){var i;for(i=0;i<tdoa.tfields;i++)tdoa.field[i]={};var wh='width:'+px(tdoa.w_data)+'; height:'+px(tdoa.h_data);var cbox='w3-label-inline w3-label-not-bold';var cbox2='w3-margin-left//'+cbox;var data_html=time_display_html('tdoa','25px')+
w3_div('id-tdoa-data w3-display-container|left:0px; '+wh,w3_div('|'+wh+'|id="id-tdoa-map-kiwi"',''),w3_div('w3-hide|'+wh+'|id="id-tdoa-map-result"',''),w3_div('id-tdoa-png w3-display-topleft w3-scroll-y w3-hide|left:0px; '+wh,''),w3_inline('id-tdoa-sorry w3-hide w3-display-topleft|left:0px',w3_div('w3-show-inline w3-padding-LR-8 w3-yellow','Our current map provider is unavailable and we must switch back to using broken Google maps')))+
w3_div('id-tdoa-options w3-display-right w3-text-white w3-light-greyx|top:200px; right:0px; width:200px; height:200px',w3_text('w3-text-aqua w3-bold','TDoA options'),w3_checkbox(cbox,'Show heatmap','tdoa.heatmap_visible',true,'tdoa_heatmap_visible_cb'),w3_checkbox(cbox,'Show day/night','tdoa.day_night_visible',true,'tdoa_day_night_visible_cb'),w3_checkbox(cbox,'Show graticule','tdoa.graticule_visible',true,'tdoa_graticule_visible_cb'),w3_checkbox(cbox,'Show all results','tdoa.all_results',false,'tdoa_all_results_cb'),w3_button('w3-btn w3-margin-L-20 w3-margin-T-8 w3-small w3-grey w3-text-css-white w3-momentary','Clear old results','tdoa_clear_results_cb',1),w3_checkbox('w3-margin-T-8//'+cbox,'Kiwi hosts','tdoa.hosts_visible',true,'tdoa_hosts_visible_cb'),w3_checkbox(cbox,'Reference locations','tdoa.refs_visible',true,'tdoa_refs_visible_cb'),w3_checkbox(cbox2,'VLF/LF','tdoa.refs_v',true,'tdoa_refs_cb'),w3_checkbox(cbox2,'Milcom','tdoa.refs_m',true,'tdoa_refs_cb'),w3_checkbox(cbox2,'Radar','tdoa.refs_r',true,'tdoa_refs_cb'),w3_checkbox(cbox2,'Aero','tdoa.refs_a',true,'tdoa_refs_cb'),w3_checkbox(cbox2,'Marine','tdoa.refs_w',true,'tdoa_refs_cb'),w3_checkbox(cbox2,'Broadcast','tdoa.refs_b',true,'tdoa_refs_cb'),w3_checkbox(cbox2,'Utility','tdoa.refs_u',true,'tdoa_refs_cb'),w3_checkbox(cbox2,'Time/Freq','tdoa.refs_t',true,'tdoa_refs_cb'));tdoa.ref_ids=['v','m','r','a','w','b','u','t'];var control_html=w3_divs('w3-tspace-8',w3_inline('w3-halign-space-between|width:86%/',w3_div('id-tdoa-controls w3-medium w3-text-aqua','<b><a href="https://www.rtl-sdr.com/kiwisdr-tdoa-direction-finding-now-freely-available-for-public-use" target="_blank">TDoA</a> direction finding service</b>'),w3_div('',w3_div('id-tdoa-info w3-small|color: hsl(0, 0%, 70%)'),w3_inline('',w3_div('id-tdoa-result w3-small|color: hsl(0, 0%, 70%)','most likely:'),w3_div('id-tdoa-gmap-link w3-margin-L-4'))),w3_div('id-tdoa-bookmark')),w3_div('id-tdoa-hosts-container'),w3_inline('',w3_button('id-tdoa-submit-button w3-padding-smaller w3-css-yellow','Submit','tdoa_submit_button_cb'),w3_div('id-tdoa-submit-icon-c w3-margin-left'),w3_div('id-tdoa-results-select w3-margin-left w3-hide'),w3_div('id-tdoa-results-options w3-margin-left w3-hide'),w3_div('id-tdoa-submit-status w3-margin-left'),w3_div('id-tdoa-download-KML w3-margin-left w3-hide||title="download KML file"'),w3_div('id-tdoa-download-MAT w3-margin-left w3-hide||title="download MAT file"')),w3_inline('w3-gap-8/',w3_select('w3-text-red','','zoom to','tdoa.quick_zoom',-1,tdoa.quick_zoom,'tdoa_quick_zoom_cb'),w3_select('w3-text-red','','sample','tdoa.sample_time_i',tdoa.sample_time_i,tdoa.sample_time_s,'tdoa_sample_time_cb'),w3_div('w3-width-full',w3_input('id-tdoa-known-location w3-padding-tiny','','tdoa.known_location','','tdoa_edit_known_location_cb','Map ref location: type lat, lon and name or click green map markers'))));ext_panel_show(control_html,data_html,null);time_display_setup('tdoa');ext_set_controls_width_height(650,270);ext_set_data_height(tdoa.h_data);var s='';for(i=0;i<tdoa.tfields;i++){s+=w3_inline(i?'w3-margin-T-3':'',w3_input('w3-padding-tiny||size=10','','tdoa.id_field-'+i,''),w3_input('w3-margin-L-3 w3-padding-tiny||size=28','','tdoa.url_field-'+i,'','tdoa_edit_url_field_cb'),w3_icon('w3-margin-L-8 id-tdoa-clear-icon-'+i,'fa-cut',20,'red','tdoa_clear_host_cb',i),w3_div('w3-margin-L-8 id-tdoa-listen-icon-c'+i),w3_div('w3-margin-L-8 id-tdoa-sample-icon-c'+i),w3_div('w3-margin-L-8 id-tdoa-download-icon-c'+i),w3_div('w3-margin-L-8 id-tdoa-sample-status-'+i));}
w3_innerHTML('id-tdoa-hosts-container',s);if(tdoa.leaflet){var map_tiles;var maxZoom=19;var server_e={MapTiler_Vector:0,MapTiler_Raster_512:1,MapTiler_Raster_256:2,OSM_Raster:3};var server=server_e.OSM_Raster;if(server==server_e.MapTiler_Vector){map_tiles=function(map_style){return L.mapboxGL({attribution:'<a href="https://www.maptiler.com/license/maps/" target="_blank">&copy; MapTiler</a> <a href="https://www.openstreetmap.org/copyright" target="_blank">&copy; OpenStreetMap contributors</a>',accessToken:'not-needed',style:'https://api.maptiler.com/maps/'+map_style+'/style.json'+tdoa.a[1]});};}
if(server==server_e.MapTiler_Raster_512||server==server_e.MapTiler_Raster_256){var slash_256=(server==server_e.MapTiler_Raster_256)?'/256':'';map_tiles=function(map_style){return L.tileLayer((map_style=='hybrid')?'https://api.maptiler.com/maps/'+map_style+slash_256+'/{z}/{x}/{y}{r}.jpg'+tdoa.a[1]:'https://api.maptiler.com/maps/'+map_style+slash_256+'/{z}/{x}/{y}.png'+tdoa.a[1],{tileSize:(server==server_e.MapTiler_Raster_256)?256:512,zoomOffset:(server==server_e.MapTiler_Raster_256)?0:-1,attribution:'<a href="https://www.maptiler.com/copyright/" target="_blank">&copy; MapTiler</a> <a href="https://www.openstreetmap.org/copyright" target="_blank">&copy; OpenStreetMap contributors</a>',crossOrigin:true});};}
if(server==server_e.OSM_Raster){map_tiles=function(){maxZoom=18;return L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png',{tileSize:256,zoomOffset:0,attribution:'<a href="https://www.openstreetmap.org/copyright" target="_blank">&copy; OpenStreetMap contributors</a>',crossOrigin:true});};}
var sat_map=map_tiles('hybrid');var m=L.map('id-tdoa-map-kiwi',{maxZoom:maxZoom,minZoom:1,doubleClickZoom:false,zoomControl:false}).setView([tdoa.init_lat,tdoa.init_lon],tdoa.init_zoom);m.on('baselayerchange',function(e){var map=e.target;var center=map.getCenter();tdoa_pan_zoom(map,[center.lat+0.1,center.lng],-1);tdoa_pan_zoom(map,[center.lat,center.lng],-1);});m.on('click',tdoa_click_info_cb);m.on('mousemove',tdoa_mouse_move_cb,this);m.on('moveend',function(e){tdoa_pan_end(e);});m.on('zoomend',function(e){tdoa_zoom_end(e);});L.control.zoom_Kiwi().addTo(m);sat_map.addTo(m);if(server!=server_e.OSM_Raster){L.control.layers({'Satellite':sat_map,'Basic':map_tiles('basic'),'Bright':map_tiles('bright'),'Positron':map_tiles('positron'),'Street':map_tiles('streets'),'Topo':map_tiles('topo')},null).addTo(m);}
tdoa.cur_map=tdoa.kiwi_map=m;if(dbgUs)sat_map.getPane()._jks='MAP';var scale=L.control.scale();scale.addTo(m);scale.setPosition('bottomright');L.control.ruler({position:'bottomright'}).addTo(m);var terminator=new Terminator();terminator.setStyle({fillOpacity:0.35});terminator.addTo(m);tdoa.day_night_interval=setInterval(function(){var t2=new Terminator();terminator.setLatLngs(t2.getLatLngs());terminator.redraw();},60000);tdoa.day_night=terminator;if(dbgUs)terminator.getPane()._jks='Terminator';tdoa.graticule=L.latlngGraticule();tdoa.graticule.addTo(m);tdoa.map_layers.push(tdoa.graticule);m.on('zoom',tdoa_info_cb);m.on('move',tdoa_info_cb);}else{tdoa.kiwi_map=new google.maps.Map(w3_el('id-tdoa-map-kiwi'),{zoom:tdoa.init_zoom,center:new google.maps.LatLng(tdoa.init_lat,tdoa.init_lon),navigationControl:false,mapTypeControl:true,streetViewControl:false,draggable:true,scaleControl:true,gestureHandling:'greedy',mapTypeId:google.maps.MapTypeId.SATELLITE});tdoa.cur_map=tdoa.kiwi_map;if(!tdoa.gmap_param)
w3_show('id-tdoa-sorry');tdoa.day_night=new DayNightOverlay({map:tdoa.kiwi_map,fillColor:'rgba(0,0,0,0.35)'});var grid=new Graticule(tdoa.kiwi_map,false);tdoa.kiwi_map.addListener('zoom_changed',tdoa_info_cb);tdoa.kiwi_map.addListener('center_changed',tdoa_info_cb);tdoa.kiwi_map.addListener('maptypeid_changed',tdoa_info_cb);}
kiwi_ajax(tdoa.url+'refs.cjson','tdoa_get_refs_cb');tdoa_ui_reset(true);TDoA_environment_changed({resize:1});tdoa.state=tdoa.WAIT_HOSTS;}
function tdoa_zoom_end(e){tdoa_reset_spiderfied();var m=tdoa.cur_map;for(var i=0;i<tdoa.hosts_dither.length;i++){var h=tdoa.hosts_dither[i];var pt=m.latLngToLayerPoint(L.latLng(h.lat,h.lon));pt.y-=h.dither_idx*20;h.mkr.setLatLng(m.layerPointToLatLng(pt));}
tdoa_ref_marker_offset(true);}
function tdoa_pan_end(e){tdoa_reset_spiderfied();}
function tdoa_lat(c){return tdoa.leaflet?c.lat:c.lat();}
function tdoa_lon(c){return tdoa.leaflet?c.lng:c.lng();}
function tdoa_info_cb(){var m=tdoa.cur_map;var c=m.getCenter();w3_innerHTML('id-tdoa-info','map center: '+tdoa_lat(c).toFixed(2)+', '+tdoa_lon(c).toFixed(2)+' z'+m.getZoom());tdoa_update_link();if(!tdoa.leaflet){tdoa_gmap_update('id-tdoa-map-kiwi');tdoa_gmap_update('id-tdoa-map-result');}}
function tdoa_click_info_cb(ev){tdoa_reset_spiderfied();if(0&&dbgUs){var s='';tdoa.cur_map.eachLayer(function(layer){var el=layer.getPane();console.log(el);if(el._jks)s+=el._jks+'='+el.style.zIndex+' ';});alert(s);console.log('----');}}
function tdoa_update_link(){var url=kiwi_url_origin()+'/?f='+ext_get_freq_kHz()+'iqz'+ext_get_zoom();var pb=ext_get_passband();url+='&pbw='+(pb.high*2).toFixed(0)+'&ext=tdoa';var m=tdoa.cur_map;if(!m)return;var c=m.getCenter();url+=',lat:'+tdoa_lat(c).toFixed(2)+',lon:'+tdoa_lon(c).toFixed(2)+',z:'+m.getZoom();if(tdoa.sample_time!=30)url+=',sample:'+tdoa.sample_time;if(!tdoa.leaflet&&m.getMapTypeId()!='satellite')url+=',map:1';tdoa.field.forEach(function(f,i){if(f.good){url+=','+w3_get_value('tdoa.id_field-'+i);}});var r=w3_get_value('id-tdoa-known-location');if(r&&r!=''){r=r.replace(/\s+/g,' ').split(/[ ,]/g);if(r.length>=2){url+=','+r[2].replace(/[^0-9A-Za-z]/g,'');}}
if(tdoa.old_algorithm)url+=',old:';if(tdoa.devl)url+=',devl:';if(tdoa.kml)url+=',kml:';w3_innerHTML('id-tdoa-bookmark',w3_link('',url,w3_icon('w3-text-css-lime','fa-external-link-square',16)));}
function tdoa_marker_remove(mkr){if(tdoa.leaflet){mkr.unbindTooltip();mkr.remove();mkr.off();}else{mkr.setMap(null);}}
function tdoa_marker_click(marker,ev){if(tdoa.click_pending===true)return;tdoa.click_pending=true;tdoa.click_timeout=setTimeout(function(marker){tdoa.click_pending=false;marker.kiwi_mkr_2_ref_or_host.click(marker,ev);},300,marker);}
function tdoa_marker_dblclick(marker){kiwi_clearTimeout(tdoa.click_timeout);tdoa.click_pending=false;marker.kiwi_mkr_2_ref_or_host.dblclick(marker);}
function tdoa_place_host_marker(h,map){h.have_event_listeners=[];h.hp=h.h+':'+h.p;h.call=h.id.replace(/\-/g,'/');var title=h.n+'\nUsers: '+h.u+'/'+h.um+'  v'+h.v;if(h.tc){if(h.tc<=0){console.log('TDoA OPT-OUT: '+h.tc+' '+h.id+' '+h.h);return null;}
title+='\nTDoA channels: '+h.tc;}
title+='\nAntenna: '+h.a;if(h.snr>0)
title+='\nS/N score: '+h.snr+' dB';title+='\n'+h.fm+' GPS fixes/min';title+='\nShift-click for waterfall preview';if(tdoa.leaflet){var icon=L.divIcon({className:"",iconAnchor:[12,12],labelAnchor:[-6,0],popupAnchor:[0,-36],html:''});var marker=L.marker([h.lat,h.lon],{'icon':icon,'opacity':1.0});h.title=title;if(map!=tdoa.kiwi_map){marker.kiwi_mkr_2_ref_or_host=h;h.id_snr=h.id;if(h.snr>0)h.id_snr+=' '+h.snr;tdoa_style_marker(h.mkr,h.idx,h.id_snr,'host',map);}}else{var latlon=new google.maps.LatLng(h.lat,h.lon);var marker=new MarkerWithLabel({position:latlon,draggable:false,raiseOnDrag:false,map:map,labelContent:h.call,labelAnchor:new google.maps.Point(h.call.length*3.6,36),labelClass:(map==tdoa.kiwi_map)?'cl-tdoa-gmap-host-label':'cl-tdoa-gmap-selected-label',labelStyle:{opacity:1.0},title:title,icon:kiwi_mapPinSymbol('red','white')});google.maps.event.addListener(marker,"click",function(){tdoa_marker_click(marker);});google.maps.event.addListener(marker,"dblclick",function(){tdoa_marker_dblclick(marker);});}
h.type_host=true;h.click=tdoa_host_marker_click;h.dblclick=tdoa_host_marker_dblclick;marker.kiwi_mkr_2_ref_or_host=h;return marker;}
function tdoa_host_marker_click(mkr,ev){var h=mkr.kiwi_mkr_2_ref_or_host;if(ev&&ev.shiftKey){tdoa_preview_click(mkr,ev);return;}
for(var j=0;j<tdoa.tfields;j++){if(w3_get_value('tdoa.id_field-'+j)==h.call)return;}
for(var j=0;j<tdoa.tfields;j++){var f=tdoa.field[j];if(f.inuse)continue;var url=h.hp;f.inuse=true;f.good=true;f.use=true;f.mkr=mkr;f.host=h;w3_set_value('tdoa.id_field-'+j,h.call);w3_set_value('tdoa.url_field-'+j,url);tdoa_set_icon('sample',j,'fa-refresh fa-spin',20,'lightGrey');tdoa_rerun_clear();var s=(dbgUs&&url=='kiwisdr.jks.com:8073')?'www:8073':url;kiwi_ajax('http://'+s+'/status','tdoa_host_click_status_cb',j,5000);break;}}
function tdoa_open_window(host){var url='http://'+host.hp+'/?f='+ext_get_freq_kHz()+ext_get_mode()+'z'+ext_get_zoom();var pb=ext_get_passband();url+='&pbw='+(pb.high*2).toFixed(0);console.log('tdoa_open_window '+url);var win=kiwi_open_or_reload_page({url:url,tab:1});if(win)win.focus();}
function tdoa_listen_cb(path,val,first,ev){var field_idx=+val;var f=tdoa.field[field_idx];if(f&&f.mkr&&f.mkr.kiwi_mkr_2_ref_or_host){if(ev&&ev.shiftKey){tdoa_preview_click(f.mkr,ev);}else{tdoa_open_window(f.mkr.kiwi_mkr_2_ref_or_host);}}}
function tdoa_host_marker_dblclick(marker){kiwi_clearTimeout(tdoa.click_timeout);tdoa.click_pending=false;tdoa_open_window(marker.kiwi_mkr_2_ref_or_host);}
function tdoa_place_ref_marker(idx,map,ref){var r;if(ref){r=ref;}else{r=tdoa.refs[idx];}
r.have_event_listeners=[];r.idx=idx;var title;if(r.t!='')
title=r.t+(r.f?(', '+r.f+' kHz'):'');else
title='';if(tdoa.leaflet){var icon=L.divIcon({className:"",iconAnchor:[12,12],labelAnchor:[-6,0],popupAnchor:[0,-36],html:''});var marker=L.marker([r.lat,r.lon],{'icon':icon,'opacity':1.0});r.title=title;if(map){marker.kiwi_mkr_2_ref_or_host=r;tdoa_style_marker(marker,r.idx,r.id,'ref',map);}}else{var latlon=new google.maps.LatLng(r.lat,r.lon);var marker=new MarkerWithLabel({position:latlon,draggable:false,raiseOnDrag:false,map:map,labelContent:r.id,labelAnchor:new google.maps.Point(r.id.length*3.6,36),labelClass:'cl-tdoa-gmap-ref-label',labelStyle:{opacity:1.0},title:title,icon:kiwi_mapPinSymbol('lime','black')});if(map!=tdoa.kiwi_map&&map!=null)return marker;google.maps.event.addListener(marker,"click",function(){tdoa_marker_click(marker);});google.maps.event.addListener(marker,"dblclick",function(){tdoa_marker_dblclick(marker);});}
r.type_host=false;r.click=tdoa_ref_marker_click;r.dblclick=tdoa_ref_marker_dblclick;marker.kiwi_mkr_2_ref_or_host=r;return marker;}
function tdoa_ref_marker_offset(doOffset){if(!tdoa.leaflet||!tdoa.known_location_idx)return;var r=tdoa.refs[tdoa.known_location_idx];if(false){var m=tdoa.cur_map;var pt=m.latLngToLayerPoint(L.latLng(r.lat,r.lon));pt.x+=20;pt.y-=20;r.mkr.setLatLng(m.layerPointToLatLng(pt));}else{r.mkr.setLatLng([r.lat,r.lon]);}}
function tdoa_ref_marker_click(mkr){if(tdoa.cur_map!=tdoa.kiwi_map)return;var r=mkr.kiwi_mkr_2_ref_or_host;var t=r.t.replace('\n',' ');var loc=r.lat.toFixed(2)+' '+r.lon.toFixed(2)+' '+r.id+' '+t+(r.f?(' '+r.f+' kHz'):'');w3_set_value('id-tdoa-known-location',loc);if(tdoa.known_location_idx){var rp=tdoa.refs[tdoa.known_location_idx];rp.selected=false;console.log('ref_click: deselect ref '+rp.id);tdoa_ref_marker_offset(false);}
tdoa.known_location_idx=r.idx;r.selected=true;console.log('ref_click: select ref '+r.id+' '+r.f);tdoa_rebuild_refs();if(r.f)
ext_tune(r.f,'iq',ext_zoom.ABS,r.z,-r.p/2,r.p/2);tdoa_update_link();tdoa_ref_marker_offset(true);}
function tdoa_ref_marker_dblclick(mkr){var r=mkr.kiwi_mkr_2_ref_or_host;var map=tdoa.cur_map;if(map.getZoom()>=(r.mz||tdoa.mapZoom_nom)){if(tdoa.last_center&&tdoa.last_zoom){tdoa_pan_zoom(map,tdoa.last_center,tdoa.last_zoom);}else{tdoa_pan_zoom(map,[tdoa.init_lat,tdoa.init_lon],tdoa.init_zoom);}}else{tdoa.last_center=map.getCenter();tdoa.last_zoom=map.getZoom();var zoom=r.mz||tdoa.mapZoom_nom;tdoa_pan_zoom(map,[r.lat,r.lon],zoom);}}
function tdoa_style_marker(marker,idx,name,type,map){marker.bindTooltip(name,{className:'id-tdoa-'+type+' id-tdoa-'+type+'-'+idx,permanent:true,direction:'right'});marker.on('add',function(ev){var rh=ev.sourceTarget.kiwi_mkr_2_ref_or_host;w3_iterate_classname('id-tdoa-'+type+'-'+rh.idx,function(el,i){if(el){rh.clientWidth=el.clientWidth;if(rh.type_host){if(rh.selected)w3_color(el,'black','yellow');else w3_color(el,'white','blue');}
el.title=rh.title;el.kiwi_mkr_2_ref_or_host=rh;if(!rh.have_event_listeners[i]){rh.have_event_listeners[i]=true;el.addEventListener('click',function(ev){tdoa_marker_click(ev.target,ev);});el.addEventListener('dblclick',function(ev){tdoa_marker_dblclick(ev.target);});el.addEventListener('mouseenter',function(ev){if(!rh.selected){w3_color(el,'black','yellow');el.style.zIndex=9001;}
tdoa_clear_unspiderfy_timeout();});el.addEventListener('mouseleave',function(ev){if(!rh.selected){if(rh.type_host)
w3_color(el,'white','blue');else
w3_color(el,'black','lime');el.style.zIndex=9000;}
tdoa_set_unspiderfy_timeout();});}}});});if(map){marker.addTo(map);tdoa.map_layers.push(marker);}}
function tdoa_change_marker_style(mkr,body_color,outline_color,label_class){if(tdoa.leaflet){}else{mkr.setMap(null);mkr.labelClass=label_class;mkr.icon=kiwi_mapPinSymbol(body_color,outline_color);mkr.setMap(tdoa.kiwi_map);}}
function tdoa_create_cluster_list(mc){var s='';mc.getAllChildMarkers().forEach(function(m){var r=m.kiwi_mkr_2_ref_or_host;s+=((s!='')?'\n':'')+r.id;});mc._icon.title=s;}
function tdoa_reset_spiderfied(){if(tdoa.spiderfied){tdoa.spiderfied.unspiderfy();}
tdoa.spiderfied=false;}
function tdoa_spiderfied(which,a){var m=tdoa.cur_map;var cP=m.latLngToLayerPoint(a.cluster.getLatLng());console.log(which,' spiderfied ');console.log(cP);var nw=cP.clone(),se=cP.clone();a.markers.forEach(function(mkr,i){var cw=mkr.kiwi_mkr_2_ref_or_host.clientWidth;var mP=m.latLngToLayerPoint(mkr.getLatLng());if(mP.x<nw.x)nw.x=mP.x;if(mP.y<nw.y)nw.y=mP.y;if((mP.x+cw)>se.x)se.x=mP.x+cw;if(mP.y>se.y)se.y=mP.y;});var l=10,r=20,tb=20;var nwLL=m.layerPointToLatLng([nw.x-l,nw.y-tb]);var seLL=m.layerPointToLatLng([se.x+r,se.y+tb]);tdoa.clusterLLB=L.latLngBounds([nwLL,seLL]);if(tdoa.orange_rect)tdoa.orange_rect.removeFrom(m);if(dbgUs)tdoa.orange_rect=L.rectangle(tdoa.clusterLLB,{color:"#ff7800",weight:0.5}).addTo(m);}
function tdoa_set_unspiderfy_timeout(){if(!tdoa.spiderfied)return;kiwi_clearTimeout(tdoa.spiderfied_timeo);tdoa.spiderfied_timeo=setTimeout(function(){if(tdoa.spiderfied){if(tdoa.spiderfied_contains_mouse){tdoa_set_unspiderfy_timeout();console.log('RE');}else{console.log('UN');tdoa.spiderfied.unspiderfy();tdoa.spiderfied=false;}}},1000);console.log('SCHED');}
function tdoa_clear_unspiderfy_timeout(){kiwi_clearTimeout(tdoa.spiderfied_timeo);tdoa.spiderfied_timeo=null;console.log('CLR');}
function tdoa_mouse_move_cb(ev){var m=tdoa.cur_map;if(!tdoa.spiderfied){if(tdoa.orange_rect){tdoa.orange_rect.removeFrom(m);tdoa.orange_rect=false;}
tdoa.spiderfied_contains_mouse=false;return;}
var mLL=ev.latlng;tdoa.spiderfied_contains_mouse=(tdoa.clusterLLB&&tdoa.clusterLLB.contains(mLL));}
function tdoa_hosts_visible_cb(path,checked,first){if(first)return;tdoa.show_hosts=checked;w3_checkbox_set(path,checked?true:false);tdoa_rebuild_hosts();}
function tdoa_remove_hosts(){if(tdoa.cur_host_markers){tdoa.hosts.forEach(function(h){tdoa_marker_remove(h.mkr);});if(tdoa.leaflet&&tdoa.hosts_clusterer)tdoa.hosts_clusterer.clearLayers();else tdoa.hosts_clusterer.clearMarkers();}}
function tdoa_rebuild_hosts(opts){if(!tdoa.hosts)return;tdoa_remove_hosts();var show_hosts=(opts==undefined)?tdoa.show_hosts:opts.show;tdoa.cur_host_markers=[];for(var i=0;i<tdoa.hosts.length;i++){var h=tdoa.hosts[i];var v=+h.v;if(tdoa.hosts_sel&&((tdoa.hosts_sel==1&&v>1.646)||(tdoa.hosts_sel==2&&v<1.653))){continue;}
if(h.mkr){h.have_event_listeners=[];h.id_snr=h.id;if(h.snr>0)h.id_snr+=' '+h.snr;if(h.selected){if(tdoa.leaflet)tdoa_style_marker(h.mkr,h.idx,h.id_snr,'host',tdoa.kiwi_map);else h.mkr.setMap(tdoa.kiwi_map);}else{if(show_hosts){if(tdoa.leaflet)tdoa_style_marker(h.mkr,h.idx,h.id_snr,'host');tdoa.cur_host_markers.push(h.mkr);}}}}
console.log('tdoa_rebuild_hosts cur_host_markers='+tdoa.cur_host_markers.length);if(tdoa.leaflet){var mc=L.markerClusterGroup({maxClusterRadius:tdoa.prev_ui?30:80,spiderLegPolylineOptions:{weight:1.5,color:'white',opacity:1.0},iconCreateFunction:function(mc){return new L.DivIcon({html:'<div><span>'+mc.getChildCount()+'</span></div>',className:'marker-cluster id-tdoa-marker-cluster-hosts',iconSize:new L.Point(40,40)});}});mc.addLayers(tdoa.cur_host_markers);if(tdoa.prev_ui){mc.on('clustermouseover',function(a){tdoa_create_cluster_list(a.layer);});}else{mc.on('clustermouseover',function(a){if(tdoa.spiderfied){if(tdoa.spiderfied==a.layer){return;}
tdoa.spiderfied.unspiderfy();tdoa.spiderfy_deferred=a.layer;}else{tdoa_remove_refs();a.layer.spiderfy();tdoa.spiderfied=a.layer;}});mc.on('spiderfied',function(a){tdoa_spiderfied('HOSTS',a);tdoa_set_unspiderfy_timeout();});mc.on('unspiderfied',function(a){if(tdoa.spiderfy_deferred){tdoa.spiderfy_deferred.spiderfy();tdoa.spiderfied=tdoa.spiderfy_deferred;tdoa.spiderfy_deferred=false;}else{tdoa.spiderfied=false;tdoa_clear_unspiderfy_timeout();tdoa_rebuild_refs();}});}
tdoa.kiwi_map.addLayer(mc);tdoa.hosts_clusterer=mc;}else{tdoa.hosts_clusterer=new MarkerClusterer(tdoa.kiwi_map,tdoa.cur_host_markers,{averageCenter:true,gridSize:30,cssClass:'cl-tdoa-cluster-base cl-tdoa-cluster-kiwi',onMouseoverCluster:function(this_,ev){var s='';this_.cluster_.markers_.forEach(function(m){s+=((s!='')?'\n':'')+m.labelContent;});this_.div_.title=s;}});}}
function tdoa_hosts_sel_cb(path,idx,first){console.log('tdoa_hosts_sel_cb: idx='+idx);tdoa.hosts_sel=+idx;tdoa_rebuild_hosts();}
function tdoa_refs_visible_cb(path,checked,first){if(first)return;if(!checked)
w3_checkbox_set('tdoa.refs_visible',checked?true:false);tdoa.ref_ids.forEach(function(id){w3_checkbox_set('tdoa.refs_'+id,checked?true:false);});tdoa.show_refs=checked;tdoa_rebuild_refs();}
function tdoa_refs_cb(path,checked,first){if(first)return;if(checked){tdoa.show_refs=checked;w3_checkbox_set('tdoa.refs_visible',true);}
tdoa_rebuild_refs();}
function tdoa_remove_refs(){if(tdoa.cur_ref_markers){tdoa.refs_markers.forEach(function(mkr){tdoa_marker_remove(mkr);});if(tdoa.leaflet&&tdoa.refs_clusterer)tdoa.refs_clusterer.clearLayers();else tdoa.refs_clusterer.clearMarkers();}}
function tdoa_rebuild_refs(opts){if(!tdoa.refs)return;tdoa_remove_refs();var ids=[];tdoa.ref_ids.forEach(function(id){if(w3_checkbox_get('tdoa.refs_'+id))
ids.push(id);});console.log('tdoa_rebuild_refs REFS <'+ids+'> show_refs='+tdoa.show_refs+' opts=...');tdoa.cur_ref_markers=[];var show_refs=(opts==undefined)?tdoa.show_refs:opts.show;if(show_refs){for(var i=tdoa.FIRST_REF;i<tdoa.refs.length-1;i++){var r=tdoa.refs[i];r.have_event_listeners=[];var done=false;ids.forEach(function(id){if(r.r.includes(id)&&!done){if(r.selected){if(tdoa.leaflet)
tdoa_style_marker(r.mkr,r.idx,r.id,'ref',tdoa.kiwi_map);else
r.mkr.setMap(tdoa.kiwi_map);}else{if(tdoa.leaflet)tdoa_style_marker(r.mkr,r.idx,r.id,'ref');tdoa.cur_ref_markers.push(r.mkr);}
done=true;}});}}
if(tdoa.leaflet){var mc=L.markerClusterGroup({maxClusterRadius:tdoa.prev_ui?30:80,spiderLegPolylineOptions:{weight:1.5,color:'white',opacity:1.0},iconCreateFunction:function(mc){return new L.DivIcon({html:'<div><span>'+mc.getChildCount()+'</span></div>',className:'marker-cluster id-tdoa-marker-cluster-refs',iconSize:new L.Point(40,40)});}});mc.addLayers(tdoa.cur_ref_markers);if(tdoa.prev_ui){mc.on('clustermouseover',function(a){tdoa_create_cluster_list(a.layer);});}else{mc.on('clustermouseover',function(a){if(tdoa.spiderfied){if(tdoa.spiderfied==a.layer){return;}
tdoa.spiderfied.unspiderfy();tdoa.spiderfy_deferred=a.layer;}else{tdoa_remove_hosts();a.layer.spiderfy();tdoa.spiderfied=a.layer;}});mc.on('spiderfied',function(a){tdoa_spiderfied('REFS',a);tdoa_set_unspiderfy_timeout();});mc.on('unspiderfied',function(a){if(tdoa.spiderfy_deferred){tdoa.spiderfy_deferred.spiderfy();tdoa.spiderfied=tdoa.spiderfy_deferred;tdoa.spiderfy_deferred=false;}else{tdoa.spiderfied=false;tdoa_clear_unspiderfy_timeout();tdoa_rebuild_hosts();}});}
tdoa.kiwi_map.addLayer(mc);tdoa.refs_clusterer=mc;}else{tdoa.refs_clusterer=new MarkerClusterer(tdoa.kiwi_map,tdoa.cur_ref_markers,{averageCenter:true,gridSize:30,cssClass:'cl-tdoa-cluster-base cl-tdoa-cluster-refs',onMouseoverCluster:function(this_,ev){var s='';this_.cluster_.markers_.forEach(function(m){s+=((s!='')?'\n':'')+m.labelContent;});this_.div_.title=s;}});}}
function tdoa_get_refs_cb(refs){var err;if(!refs){console.log('tdoa_get_refs_cb refs='+refs);return;}
tdoa.refs=refs;var markers=[];for(i=tdoa.FIRST_REF;i<tdoa.refs.length-1;i++){var r=tdoa.refs[i];r.id_lcase=r.id.toLowerCase();var mkr=tdoa_place_ref_marker(i,null);markers.push(mkr);r.mkr=mkr;}
tdoa.refs_markers=markers;tdoa_rebuild_refs();kiwi_ajax(tdoa.url_files+'kiwi.gps.json','tdoa_get_hosts_cb');}
function tdoa_get_hosts_cb(hosts){var err;if(!hosts){console.log('tdoa_get_hosts_cb hosts='+hosts);return;}
tdoa.hosts=hosts;var markers=[];for(var i=0;i<hosts.length;i++){var h=hosts[i];h.idx=i;if(h.h==''){console.log('TDoA WARNING: hosts.h empty?');console.log(h);continue;}
for(var j=0;j<i;j++){var h0=hosts[j];if(tdoa.leaflet){var h_ll=L.latLng(h.lat,h.lon);var h0_ll=L.latLng(h0.lat,h0.lon);var spacing=h_ll.distanceTo(h0_ll);if(spacing<2000){if(h0.dither_idx==undefined){h0.dither_idx=1;}
h.dither_idx=h0.dither_idx++;tdoa.hosts_dither.push(h);}}
if(h0.id==h.id){if(h0.dup==undefined)h0.dup=0;h0.dup++;h.id+='/'+h0.dup;}}
h.id_lcase=h.id.toLowerCase();var mkr=tdoa_place_host_marker(h,tdoa.kiwi_map);if(mkr)markers.push(mkr);h.mkr=mkr;}
var lat,lon,zoom,maptype,init_submit;if(isArg(tdoa.params))console.log(tdoa.params);if(tdoa.params){var p=tdoa.params.split(',');tdoa.params=null;for(var i=0,len=p.length;i<len;i++){var a=p[i];console.log('TDoA: param <'+a+'>');var r;if(a.includes(':')){if(a.startsWith('lat:')){lat=parseFloat(a.substring(4));}else
if(a.startsWith('lon:')||a.startsWith('lng:')){lon=parseFloat(a.substring(4));}else
if((r=w3_ext_param('z',a)).match){zoom=r.num;}else
if(a.startsWith('map:')){maptype=parseInt(a.substring(4));}else
if(a.startsWith('submit:')){init_submit=true;}else
if(a.startsWith('leaflet:')){tdoa.leaflet=true;}else
if(a.startsWith('google:')){tdoa.leaflet=false;}else
if(a.startsWith('prev_ui:')){tdoa.prev_ui=true;}else
if(a.startsWith('help:')){ext_help_click();}else
if(a.startsWith('kml:')){tdoa.kml=true;}else
if(a.startsWith('all:')){tdoa_all_results_cb('tdoa.all_results',true);}else
if(a.startsWith('hosts:')){tdoa_hosts_visible_cb('tdoa.hosts_visible',false);}else
if((r=w3_ext_param('refs',a)).match){r.items.forEach(function(s,i){if(i==0)return;var n=+s;if(n==0){tdoa_refs_visible_cb('tdoa.refs_visible',false);}else
if(n>=1&&n<=8){var id='tdoa.refs_'+tdoa.ref_ids[n-1];w3_el(id).checked=!w3_el(id).checked;tdoa_refs_cb(null,true);}});}else
if(a.startsWith('old:')){tdoa.old_algorithm=true;}else
if(a.startsWith('new:')){tdoa.old_algorithm=false;}else
if(a.startsWith('devl:')){tdoa.devl=true;}else
if((r=w3_ext_param('sample',a)).match){w3_ext_param_array_match_num(tdoa.sample_time_s,r.num,function(i,n){tdoa_sample_time_cb('tdoa.sample_time_i',i);});}}else{a=a.toLowerCase();var match=false;tdoa.refs.forEach(function(r){if(!match&&r.id_lcase&&r.id_lcase.includes(a)){console.log('TDoA refs match: '+a);r.selected=true;tdoa_ref_marker_click(r.mkr);match=true;}});match=false;tdoa.hosts.forEach(function(h){if(!match&&h.id_lcase&&h.id_lcase.includes(a)){console.log('TDoA hosts match: '+a);h.selected=true;tdoa_host_marker_click(h.mkr);match=true;}});}}}
tdoa_rebuild_hosts();tdoa_rebuild_refs();tdoa_pan_zoom(tdoa.kiwi_map,(isNumber(lat)&&isNumber(lon))?[lat,lon]:null,zoom?zoom:-1);if(!tdoa.leaflet&&maptype==1)tdoa.kiwi_map.setMapTypeId('roadmap');tdoa.state=tdoa.READY_SAMPLE;if(init_submit==true)
tdoa.init_submit_timeout=setTimeout(tdoa_submit_button_cb2,6000);}
function TDoA_environment_changed(changed){if(changed.resize){var el=w3_el('id-tdoa-data');if(!el)return;var left=Math.max(0,(window.innerWidth-tdoa.w_data-time_display_width())/ 2);el.style.left=px(left);if(zoom_center!=0.5)
zoom_step(ext_zoom.CUR);return;}
tdoa_update_link();}
function tdoa_gmap_update(id,tick){var el=w3_el(id);if(!el)return;tick=tick||0;if(el.childElementCount<2){if(tick>=50)return;setTimeout(function(){tdoa_gmap_update(id,tick+1);},200);return;}
el.removeChild(el.children[1]);var observer=new MutationObserver(function(){tdoa.mo_w++;});observer.observe(el,{attributes:true,childList:true,subtree:true});setInterval(function(){var w=tdoa.mo_w;if(tdoa.mo_r!=w){tdoa.mo_r=w;w3_iterateDeep_children(el,function(el){if(el.tagName=='SPAN'&&el.innerHTML.endsWith('nly')){el.parentElement.parentElement.style.backgroundColor='';}});}},250);}
function tdoa_show_maps(map){if(tdoa.leaflet){tdoa_rebuild_hosts({show:(map.result?false:tdoa.show_hosts)});tdoa_rebuild_refs({show:(map.result?false:tdoa.show_refs)});w3_show_hide('id-tdoa-map-kiwi',map.kiwi||map.result);}else{w3_show_hide('id-tdoa-map-kiwi',map.kiwi);w3_show_hide('id-tdoa-map-result',map.result);}
if(!tdoa.leaflet){tdoa_gmap_update('id-tdoa-map-kiwi');tdoa_gmap_update('id-tdoa-map-result');}}
function tdoa_ui_reset(reset_map){tdoa_set_icon('submit',-1,'fa-refresh',20,'lightGrey');tdoa_submit_state(tdoa.READY_SAMPLE,'');tdoa_info_cb();w3_innerHTML('id-tdoa-result','most likely:');w3_innerHTML('id-tdoa-gmap-link','');w3_hide('id-tdoa-results-select');w3_hide('id-tdoa-results-options');if(reset_map){tdoa_show_maps({kiwi:true,result:false});w3_hide('id-tdoa-png');}}
function tdoa_set_icon(name,field_idx,icon,size,color,title,cb,cb_param){field_idx=(field_idx>=0)?field_idx:'';var el_s='id-tdoa-'+name+'-icon';var el=null;w3_innerHTML(el_s+'-c'+field_idx,(icon=='')?'':w3_icon(el_s,icon,size,color,cb,cb_param));if(isString(title))
w3_els(el_s,function(el){w3_title(el,title);});}
function tdoa_submit_state(state,msg){if(state==tdoa.ERROR){tdoa_set_icon('submit',-1,'fa-times-circle',20,'red');}
w3_innerHTML('id-tdoa-submit-status',msg);w3_show_hide('id-tdoa-rerun-button',state==tdoa.RESULT);w3_show_hide('id-tdoa-download-KML',state==tdoa.RESULT&&tdoa.leaflet);w3_show_hide('id-tdoa-download-MAT',state==tdoa.RESULT);tdoa.state=state;}
function tdoa_rerun_clear(){w3_hide('id-tdoa-rerun-button');w3_hide('id-tdoa-download-KML');w3_hide('id-tdoa-download-MAT');tdoa.rerun=tdoa.last_was_rerun=0;}
function tdoa_edit_url_field_cb(path,val,first){var field_idx=+path.match(/\d+/).shift();var f=tdoa.field[field_idx];w3_innerHTML('id-tdoa-sample-status-'+field_idx,'');if(f.mkr){if(f.host)f.host.selected=false;tdoa_change_marker_style(f.mkr,'red','white','cl-tdoa-gmap-host-label');}
f.mkr=undefined;f.host=undefined;f.inuse=true;f.good=true;f.use=true;tdoa_set_icon('download',field_idx,'');if(val==''){tdoa_set_icon('sample',field_idx,'');tdoa_set_icon('listen',field_idx,'');return;}
tdoa_set_icon('sample',field_idx,'fa-refresh fa-spin',20,'lightGrey');tdoa_rerun_clear();var s=(dbgUs&&val=='kiwisdr.jks.com:8073')?'www:8073':val;kiwi_ajax('http://'+s+'/status','tdoa_host_click_status_cb',field_idx,5000);tdoa_rebuild_hosts();}
function tdoa_clear_host_cb(path,val,first){if(tdoa.state==tdoa.RUNNING)return;var field_idx=+val;var f=tdoa.field[field_idx];f.inuse=false;f.good=false;f.use=false;w3_set_value('tdoa.id_field-'+field_idx,'');w3_set_value('tdoa.url_field-'+field_idx,'');tdoa_set_icon('sample',field_idx,'');tdoa_set_icon('listen',field_idx,'');tdoa_set_icon('download',field_idx,'');w3_innerHTML('id-tdoa-sample-status-'+field_idx,'');if(f.mkr){if(f.host)f.host.selected=false;tdoa_change_marker_style(f.mkr,'red','white','cl-tdoa-gmap-host-label');}
f.mkr=undefined;f.host=undefined;tdoa_rebuild_hosts();tdoa_update_link();}
function tdoa_clear_all_hosts(){for(var i=0;i<tdoa.tfields;i++){var f=tdoa.field[i];if(!f.inuse)continue;tdoa_clear_host_cb(null,i);}}
function tdoa_edit_known_location_cb(path,val,first){if(tdoa.known_location_idx){var rp=tdoa.refs[tdoa.known_location_idx];rp.selected=false;tdoa_ref_marker_offset(false);console.log('edit_known_location: deselect ref '+rp.id);}
tdoa.known_location_idx=undefined;tdoa_update_link();tdoa_rebuild_refs();}
function tdoa_host_click_status_cb(obj,field_idx){var err;var f=tdoa.field[field_idx];if(obj.response){var arr=obj.response.split('\n');var offline=null,auth=null,users=null,users_max=null,preempt=null,fixes_min=null;for(var i=0;i<arr.length;i++){var a=arr[i];if(a.startsWith('offline='))offline=a.split('=')[1];if(a.startsWith('auth='))auth=a.split('=')[1];if(a.startsWith('users='))users=a.split('=')[1];if(a.startsWith('users_max='))users_max=a.split('=')[1];if(a.startsWith('preempt='))preempt=a.split('=')[1];if(a.startsWith('fixes_min='))fixes_min=a.split('=')[1];}
if(fixes_min==null)return;if(0&&f.host&&f.host.id_lcase=='kuwait'){err='Error test';}else
if(offline=='yes'){err='Kiwi is offline';}else
if(auth=='password'){err='Kiwi requires password';}else
if(fixes_min==0){err='no recent GPS timestamps';}else{if(users_max==null)return;if(users<users_max||preempt>0){tdoa_set_icon('sample',field_idx,'fa-refresh',20,'lime');tdoa_set_icon('listen',field_idx,'fa-volume-up',20,'lime','click to open in new tab/page\nshift-click for waterfall preview','tdoa_listen_cb',field_idx);var s=fixes_min?(fixes_min+' GPS fixes/min'):'channel available';w3_innerHTML('id-tdoa-sample-status-'+field_idx,s);if(f.host)f.host.selected=true;tdoa_rebuild_hosts();if(f.mkr)tdoa_change_marker_style(f.mkr,'red','white','cl-tdoa-gmap-selected-label');tdoa_update_link();return;}
err='all channels in use';}}else{console.log(obj);err='no response';}
tdoa_set_icon('sample',field_idx,'fa-times-circle',20,'red');tdoa_set_icon('listen',field_idx,'fa-volume-up',20,'red');w3_innerHTML('id-tdoa-sample-status-'+field_idx,err);f.good=false;f.mkr=undefined;if(f.host)f.host.selected=false;f.host=undefined;tdoa_rebuild_hosts();}
function tdoa_submit_button_cb(){kiwi_clearTimeout(tdoa.init_submit_timeout);var state_save=tdoa.state;tdoa_ui_reset(false);if(state_save==tdoa.RUNNING||state_save==tdoa.RETRY){tdoa.response.key=0;for(var i=0;i<tdoa.tfields;i++){var f=tdoa.field[i];if(!f.good)continue;tdoa_set_icon('sample',i,'fa-refresh',20,'lightGrey');tdoa_set_icon('download',i,'');w3_innerHTML('id-tdoa-sample-status-'+i,'stopped');}
w3_button_text('id-tdoa-submit-button','Submit','w3-css-yellow','w3-red');return;}
setTimeout(tdoa_submit_button_cb2,1000);}
function tdoa_use_cb(path,checked,first){var fn=parseInt(path);tdoa.field[fn].use=checked;}
function tdoa_submit_button_cb2(){var i,j;tdoa.ngood=0;tdoa.field.forEach(function(f,i){if(f.good&&f.use)tdoa.ngood++;});if(tdoa.ngood<2){tdoa_submit_state(tdoa.ERROR,'at least 2 available hosts needed');tdoa.rerun=tdoa.last_was_rerun=0;return;}
if(tdoa.cur_map.getZoom()<3){tdoa_submit_state(tdoa.ERROR,'must be zoomed in further');tdoa.rerun=tdoa.last_was_rerun=0;return;}
var h,p,id;var h_v='&h=',p_v='&p=',id_v='&id=';var list_i=0;tdoa.list=[];for(i=0;i<tdoa.tfields;i++){var f=tdoa.field[i];if(!f.good||!f.use)continue;tdoa.list[list_i]={};var li=tdoa.list[list_i];var a=w3_get_value('tdoa.url_field-'+i);if(a==''){f.good=false;continue;}
a=a.split(':');if(a.length!=2||a[0]==''||a[1]==''){f.good=false;continue;}
if(list_i){h_v+=',';p_v+=',';id_v+=',';}
h=a[0];li.h=h;h_v+=h;p=a[1];li.p=p;p_v+=p;id=w3_get_value('tdoa.id_field-'+i);if(id==''){id='id_'+i;w3_set_value('tdoa.id_field-'+i,id);}
id=id.replace(/[^0-9A-Za-z\-\/]/g,'');li.call=id;id=id.replace(/\//g,'-');li.id=id;id_v+=id;li.field_idx=i;list_i++;}
if(list_i<2){tdoa_submit_state(tdoa.ERROR,'at least 2 available hosts needed');tdoa.rerun=tdoa.last_was_rerun=0;return;}
var s=h_v+p_v+id_v;s+='&f='+(ext_get_passband_center_freq()/1e3).toFixed(2);s+='&s='+tdoa.sample_time;var pb=ext_get_passband();s+='&w='+pb.high.toFixed(0);if(tdoa.cur_map==null)tdoa.cur_map=tdoa.kiwi_map;var b=tdoa.cur_map.getBounds();var ne=b.getNorthEast();var sw=b.getSouthWest();var lat_n=Math.round(tdoa_lat(ne)+1);var lat_s=Math.round(tdoa_lat(sw)-1);var lon_e=Math.round(tdoa_lon(ne)+1);var lon_w=Math.round(tdoa_lon(sw)-1);s+="&pi=struct('lat_range',\\["+lat_s+","+lat_n+"\\],'lon_range',\\["+lon_w+","+lon_e+"\\]";var r=w3_get_value('id-tdoa-known-location');if(r&&r!=''){r=r.replace(/\s+/g,' ').split(/[ ,]/g);if(r.length>=3){var lat=parseFloat(r[0]),lon=parseFloat(r[1]);if(!isNaN(lat)&&!isNaN(lon)){var name=r[2].replace(/[^0-9A-Za-z]/g,'');s+=",'known_location',struct('coord',\\["+lat+","+lon+"\\],'name',"+sq(name)+")";}}}
if(!tdoa.old_algorithm)s+=",'new',true";if(tdoa.kml)s+=",'kml',1";s+=')';if(tdoa.rerun)s+='&rerun='+tdoa.response.key;if(tdoa.devl)s+='&devl=1';tdoa.last_menu_select=undefined;tdoa.response={};tdoa.response.seq=0;if(tdoa.new_polling_method){tdoa.response.key=(Date.now()%100000).leadingZeros(5);kiwi_ajax_progress(tdoa.url_base+'php/tdoa.php'+tdoa.a[0]+'&key='+tdoa.response.key+s,function(json){},0,0,'',0);tdoa.progress_interval=setInterval(function(){if(tdoa.response.key){kiwi_ajax(tdoa.url_files+tdoa.response.key+'/progress.json',function(json){tdoa_protocol_response_cb(json);if(tdoa.response.seq==tdoa.SEQ_DONE){kiwi_clearInterval(tdoa.progress_interval);}});}},500);}else{kiwi_ajax_progress(tdoa.url_base+'php/tdoa.php'+tdoa.a[0]+s,function(json){tdoa_protocol_response_cb(json);},0,0,function(json){tdoa_protocol_response_cb(json);},0);}
if(!tdoa.rerun){tdoa.field.forEach(function(f,i){if(f.good){if(f.use)
w3_innerHTML('id-tdoa-sample-icon-c'+i,kiwi_pie('id-tdoa-pie',tdoa.pie_size,'#eeeeee','deepSkyBlue'));tdoa_set_icon('download',i,'');w3_innerHTML('id-tdoa-sample-status-'+i,'sampling started');}});tdoa_submit_state(tdoa.RUNNING,'sampling started');tdoa.last_was_rerun=0;}else{tdoa_submit_state(tdoa.RUNNING,'rerun using same samples');tdoa.rerun=0;tdoa.last_was_rerun=1;}
w3_button_text('id-tdoa-submit-button','Stop','w3-red','w3-css-yellow');w3_color('id-tdoa-submit-icon','lime');if(!tdoa.leaflet)tdoa.gmap_map_type=tdoa.cur_map.getMapTypeId();tdoa.map_zoom=tdoa.cur_map.getZoom();tdoa.map_center=tdoa.cur_map.getCenter();}
function tdoa_rerun_button_cb(){tdoa.rerun=1;tdoa_submit_button_cb();}
function tdoa_sample_status_cb(status){var error=false;var retry=0;for(var i=0;i<tdoa.ngood;i++){var li=tdoa.list[i];var field_idx=li.field_idx;var stat=(status>>(i*2))&3;if(stat){tdoa_set_icon('sample',field_idx,'fa-times-circle',20,'red');error=true;}else{if(status!=0||tdoa.response.files==''){tdoa_set_icon('sample',field_idx,'fa-refresh',20,'lime');stat=tdoa.SAMPLE_STATUS_BLANK;}else{var f=tdoa.field[field_idx];w3_innerHTML('id-tdoa-sample-icon-c'+field_idx,w3_checkbox('','',field_idx+'-tdoa-use',f.use,'tdoa_use_cb'));var url=tdoa.response.files[i].replace(/^\.\.\/files/,tdoa.rep_files);w3_innerHTML('id-tdoa-download-icon-c'+field_idx,w3_link('',url,w3_icon('w3-text-aqua','fa-download',18)));}}
var s=(stat>=tdoa.sample_status.length)?'recording error':tdoa.sample_status[stat].s;retry|=tdoa.sample_status[stat].retry;w3_innerHTML('id-tdoa-sample-status-'+field_idx,s);}
if(!error){tdoa_set_icon('submit',-1,'fa-refresh fa-spin',20,'lime');var which='TDoA';if(tdoa.old_algorithm)which+='-old';else
if(tdoa.devl)which+='-devl';which+=' algorithm running.';if(tdoa.ngood>3)
which+=' Warning: using > 3 hosts can be slow. See help.';tdoa_submit_state(tdoa.RUNNING,which);}else{if(0&&retry){tdoa_set_icon('submit',-1,'fa-cog fa-spin',20,'yellow');tdoa.retry_count=15;tdoa.retry_interval=setInterval(function(){tdoa_submit_state(tdoa.RETRY,'sampling error, will retry in '+tdoa.retry_count+'s');if(tdoa.retry_count==0){kiwi_clearInterval(tdoa.retry_interval);console.log('RETRY');tdoa_submit_button_cb();}
tdoa.retry_count--;},1000);}else{w3_button_text('id-tdoa-submit-button','Submit','w3-css-yellow','w3-red');tdoa_submit_state(tdoa.ERROR,'sampling error');}}}
function tdoa_submit_status_new_cb(no_rerun_files){if(no_rerun_files){tdoa_submit_status_old_cb(no_rerun_files);return;}
kiwi_ajax(tdoa.url_files+tdoa.response.key+'/status.json',function(j){console.log('tdoa_submit_status_new_cb');console.log(j);var okay=0;var info;var err='unknown status returned';var per_file,status,message;if(j.AJAX_error){if(j.AJAX_error=='status'){err='status file missing';okay=1;}else{var nj=j.response.replace(/\n/g,'');j=kiwi_JSON_parse('tdoa_submit_status_new_cb',nj);if(j){okay=0;}else{err='status JSON parse error';okay=2;}}}
if(okay==0){try{status=j.octave_error.identifier;}catch(ex){status=undefined;}
try{message=j.octave_error.message;}catch(ex){message=undefined;}
console.log('status='+status+' message='+message);if(status||message){if(status!='')err=status;else
if(message!='')err=message;console.log('err='+err);okay=3;}else{okay=0;}}
if(okay==0){try{per_file=j.input.per_file;}catch(ex){per_file=undefined;}
w3_enum_obj_or_array_of_objs(per_file,function(pf,i){if(pf.status=='BAD'){var name=pf.name.toLowerCase();tdoa.field.forEach(function(f,i){if(f.good&&f.host.id_lcase==name){tdoa_set_icon('sample',i,'fa-times-circle',20,'red');w3_innerHTML('id-tdoa-sample-status-'+i,'unused, poor data quality');}});}});}
if(okay==0){try{status=j.input.result.status;}catch(ex){status=undefined;}
try{message=j.input.result.message;}catch(ex){message=undefined;}
if(status){if(status=='OK'||status=='GOOD'){okay=0;}else
if(status=='BAD'){okay=4;if(message.endsWith('< 2')){err='after errors less than 2 hosts remain';}else{err='FIXME: '+message;}}else{err='unknown result: '+status;okay=5;}}}
if(okay==0){try{status=j.constraints.result.status;}catch(ex){status=undefined;}
try{message=j.constraints.result.message;}catch(ex){message=undefined;}
if(status){if(status=='OK'||status=='GOOD'){okay=0;}else
if(status=='BAD'){okay=6;if(message.endsWith('< 2')){err='after errors less than 2 hosts remain';}else{err='FIXME: '+message;}}else{err='unknown constraint: '+status;okay=7;}}else{if(status!=undefined)info='no reasonable solution';}}
if(j.likely_position){tdoa.response.likely_lat=parseFloat(j.likely_position.lat).toFixed(2);tdoa.response.likely_lon=parseFloat(j.likely_position.lng).toFixed(2);}
if(j.position&&j.position.likely_position){tdoa.response.likely_lat=parseFloat(j.position.likely_position.lat).toFixed(2);tdoa.response.likely_lon=parseFloat(j.position.likely_position.lng).toFixed(2);}
if(okay==0){tdoa_submit_status_old_cb(0,info);}else{w3_button_text('id-tdoa-submit-button','Submit','w3-css-yellow','w3-red');tdoa_submit_state(tdoa.ERROR,err);}});}
function tdoa_submit_status_old_cb(status,info){if(status!=0){var s=(status>=tdoa.submit_status.length)?'unknown':tdoa.submit_status[status].m;if(tdoa.submit_status[status].f==1)s+=' error: zoom map in or check reception';tdoa_submit_state(tdoa.ERROR,s);}else{tdoa_set_icon('submit',-1,'fa-check-circle',20,'lime');var i,j;tdoa.results=[];tdoa.results[0]={};tdoa.results[1]={};tdoa.results[2]={};tdoa.results[3]={};tdoa.results[0].menu='Kiwi map';tdoa.results[1].menu='TDoA map no hosts';tdoa.results[2].menu='TDoA map with hosts';tdoa.results[3].menu='TDoA combined';tdoa.results[0].file='Kiwi map';tdoa.results[1].file='TDoA map';tdoa.results[2].file='TDoA map';tdoa.results[3].file='TDoA combined';tdoa.results[1].ids='TDoA map';tdoa.results[2].ids='TDoA map';tdoa.results[3].ids='TDoA combined';var ri=tdoa.SINGLE_MAPS;var npairs=tdoa.ngood*(tdoa.ngood-1)/ 2;for(i=0;i<tdoa.ngood;i++){for(j=i+1;j<tdoa.ngood;j++){var li1=tdoa.list[i];var li2=tdoa.list[j];tdoa.results[ri]={};tdoa.results[ri].menu=li1.call+'-'+li2.call+' map';tdoa.results[ri].file=li1.id+'-'+li2.id+' map';tdoa.results[ri].ids=li1.id+'-'+li2.id;tdoa.results[ri].list1=i;tdoa.results[ri].list2=j;tdoa.results[ri+npairs]={};tdoa.results[ri+npairs].menu=li1.call+'-'+li2.call+' dt';tdoa.results[ri+npairs].file=li1.id+'-'+li2.id+' dt';ri++;}}
w3_innerHTML('id-tdoa-results-select',w3_select('w3-text-red','','TDoA results','tdoa.result_select',-1,tdoa.results,'tdoa_result_menu_click_cb'));w3_show('id-tdoa-results-select');w3_show('id-tdoa-results-options');tdoa_result_menu_click_cb('',tdoa.TDOA_MAP_NO_HOSTS);w3_select_value('tdoa.result_select',tdoa.TDOA_MAP_NO_HOSTS);var which='TDoA';if(tdoa.old_algorithm)which+='-old';else
if(tdoa.devl)which+='-devl';tdoa_submit_state(tdoa.RESULT,info?info:which+' complete');}
w3_button_text('id-tdoa-submit-button','Submit','w3-css-yellow','w3-red');}
function tdoa_KML_link(url){w3_innerHTML('id-tdoa-download-KML',w3_link('',url,w3_icon('w3-text-aqua','fa-download',18))+' KML');}
function tdoa_protocol_response_cb(json){var obj;if(isString(json)){json=json.trim();var sl=json.length;if(sl&&json[0]=='{'&&json[sl-1]!='}'){json+='}';}
obj=kiwi_JSON_parse('tdoa_protocol_response_cb',json);if(!obj)return;}else{if(json&&json.AJAX_error&&json.AJAX_error=='JSON parse')
json=kiwi_JSON_parse('tdoa_protocol_response_cb',json.response+'}');obj=json;}
if(tdoa.response.seq>0&&obj.key&&obj.key!=tdoa.response.key){return;}
var v;if(tdoa.response.seq==0&&obj.key!=undefined){tdoa.response.key=obj.key;tdoa.response.seq++;console.log('GOT key='+obj.key);}
if(tdoa.response.seq==1&&obj.files!=undefined){tdoa.response.files=obj.files;tdoa.response.seq++;console.log('GOT files='+tdoa.response.files.toString());}
if(tdoa.response.seq==2&&obj.status0!=undefined){v=obj.status0;tdoa_sample_status_cb(v);tdoa.response.seq++;console.log('GOT status0='+v);}
if(tdoa.response.seq==3&&obj.done!=undefined){v=obj.done;tdoa_submit_status_new_cb(v);tdoa.response.seq=tdoa.SEQ_DONE;console.log('GOT done='+v);}}
function tdoa_result_menu_click_cb(path,idx,first){var i,k;idx=+idx;tdoa.last_menu_select=idx;tdoa_KML_link('');if(tdoa.leaflet){if(tdoa.map_layers){tdoa.map_layers.forEach(function(ml){if(ml)ml.remove();});tdoa.map_layers=[];}
tdoa_day_night_visible_cb('tdoa.day_night_visible');tdoa_graticule_visible_cb('tdoa.graticule_visible');}
if(idx==tdoa.KIWI_MAP){tdoa_show_maps({kiwi:true,result:false});w3_hide('id-tdoa-png');tdoa_info_cb();tdoa.cur_map=tdoa.kiwi_map;}else{var npairs=tdoa.ngood*(tdoa.ngood-1)/ 2;if(idx<(tdoa.SINGLE_MAPS+npairs)){w3_hide('id-tdoa-png');if(tdoa.leaflet){tdoa.result_map=tdoa.cur_map;}else{tdoa.result_map=new google.maps.Map(w3_el('id-tdoa-map-result'),{zoom:tdoa.map_zoom,center:tdoa.map_center,navigationControl:false,mapTypeControl:true,streetViewControl:false,draggable:true,scaleControl:true,gestureHandling:'greedy',mapTypeId:tdoa.gmap_map_type});tdoa.cur_map=tdoa.result_map;var grid=new Graticule(tdoa.result_map,false);tdoa.result_map.addListener('zoom_changed',tdoa_info_cb);tdoa.result_map.addListener('center_changed',tdoa_info_cb);tdoa.result_map.addListener('maptypeid_changed',tdoa_info_cb);}
tdoa_show_maps({kiwi:false,result:true});var url=tdoa.url_files+tdoa.response.key+'/tdoa_data.mat';w3_innerHTML('id-tdoa-download-MAT',w3_link('',url,w3_icon('w3-text-aqua','fa-download',18))+' MAT');var ms,me;if(idx==tdoa.COMBINED_MAP){ms=tdoa.SINGLE_MAPS;me=tdoa.SINGLE_MAPS+npairs;}else{ms=idx;me=ms+1;}
for(var mi=ms;mi<me;mi++){var ext=tdoa.kml?'kml':'json';var fn=tdoa.url_files+tdoa.response.key+'/'+tdoa.results[mi].ids+'_contour_for_map.'+ext;if(tdoa.kml){if(idx!=tdoa.COMBINED_MAP)tdoa_KML_link(fn);console.log('TDoA KML test: mi='+mi+' '+fn);}
kiwi_ajax(fn,function(j,midx){if(j.AJAX_error){console.log(j);return;}
if(tdoa.leaflet){if(tdoa.last_was_rerun){}else{tdoa.heatmap[midx]=L.imageOverlay(tdoa.url_files+tdoa.response.key+'/'+tdoa.results[midx].ids+'_for_map.png',[[j.imgBounds.north,j.imgBounds.east],[j.imgBounds.south,j.imgBounds.west]],{opacity:0.5});if(tdoa.heatmap_visible){tdoa.heatmap[midx].addTo(tdoa.result_map);tdoa.map_layers.push(tdoa.heatmap[midx]);}}
if(tdoa.kml){console.log('TDoA start KML '+fn);if(!j.XML){console.log(j);return;}
parser=new DOMParser();kml=parser.parseFromString(j.text,'text/xml');track=new L.KML(kml);tdoa.result_map.addLayer(track);}else{if(j.polygons&&j.polygons.length){var pg=new Array(j.polygons.length);for(i=0;i<j.polygons.length;++i){var p=j.polygons[i];var poly=[];for(k=0;k<p.length;k++){poly[k]=[p[k].lat,p[k].lng];}
pg[i]=L.polygon(poly,{color:j.polygon_colors[i],opacity:1,weight:1,fillOpacity:0});pg[i].addTo(tdoa.result_map);tdoa.map_layers.push(pg[i]);}}
if(j.polylines&&j.polylines.length){var pl=new Array(j.polylines.length);for(i=0;i<j.polylines.length;++i){var p=j.polylines[i];var poly=[];for(k=0;k<p.length;k++){poly[k]=[p[k].lat,p[k].lng];}
pl[i]=L.polyline(poly,{color:j.polyline_colors[i],opacity:1,weight:1,fillOpacity:0});pl[i].addTo(tdoa.result_map);tdoa.map_layers.push(pl[i]);}}}}else{tdoa.heatmap[midx]=new google.maps.GroundOverlay(tdoa.url_files+j.filename,j.imgBounds,{opacity:0.5});tdoa.heatmap[midx].setMap(tdoa.heatmap_visible?tdoa.result_map:null);if(j.polygons&&j.polygons.length){var pg=new Array(j.polygons.length);for(i=0;i<j.polygons.length;++i){pg[i]=new google.maps.Polygon({paths:j.polygons[i],strokeColor:j.polygon_colors[i],strokeOpacity:1,strokeWeight:1,fillOpacity:0});pg[i].setMap(tdoa.result_map);}}
if(j.polylines&&j.polylines.length){var pl=new Array(j.polylines.length);for(i=0;i<j.polylines.length;++i){pl[i]=new google.maps.Polyline({path:j.polylines[i],strokeColor:j.polyline_colors[i],strokeOpacity:1,strokeWeight:1,fillOpacity:0});pl[i].setMap(tdoa.result_map);}}}},mi);}
var show_mkrs=[];var ms2,me2;if(idx==tdoa.TDOA_MAP_NO_HOSTS||idx==tdoa.TDOA_MAP_WITH_HOSTS||idx==tdoa.COMBINED_MAP){ms2=tdoa.SINGLE_MAPS;me2=tdoa.SINGLE_MAPS+npairs;}else{ms2=idx;me2=ms2+1;}
for(var mi=ms2;mi<me2;mi++){var list1=tdoa.results[mi].list1;var list2=tdoa.results[mi].list2;show_mkrs[list1]=tdoa.list[list1].field_idx;show_mkrs[list2]=tdoa.list[list2].field_idx;}
for(var i=0;i<show_mkrs.length;i++){var field_idx=show_mkrs[i];if(field_idx==undefined)continue;var f=tdoa.field[field_idx];if(f.mkr&&f.host){if(idx==tdoa.TDOA_MAP_NO_HOSTS){var mkr=f.host.mkr;tdoa_marker_remove(mkr);}else{tdoa_place_host_marker(f.host,tdoa.result_map);}}}
if(tdoa.known_location_idx!=undefined){tdoa_place_ref_marker(tdoa.known_location_idx,tdoa.result_map);}else{var r=w3_get_value('id-tdoa-known-location');if(r&&r!=''){r=r.replace(/\s+/g,' ').split(/[ ,]/g);if(r.length>=2){var lat=parseFloat(r[0]),lon=parseFloat(r[1]);if(!isNaN(lat)&&!isNaN(lon)){var ref=tdoa.refs[0];ref.id=r[2].replace(/[^0-9A-Za-z]/g,'');ref.lat=lat;ref.lon=lon;r.shift();r.shift();r.shift();ref.t=r.join(' ');ref.f=undefined;tdoa_place_ref_marker(0,tdoa.result_map);}}}}
if(tdoa.response.likely_lat!=undefined&&tdoa.response.likely_lon!=undefined){var ref={};ref.id=tdoa.response.likely_lat+', '+tdoa.response.likely_lon;ref.lat=tdoa.response.likely_lat;ref.lon=tdoa.response.likely_lon;ref.t='Most likely position';if(!tdoa.all_results){tdoa.result_refs=[];}
tdoa.result_refs.push(ref);tdoa.result_mkrs=[];tdoa.result_refs.forEach(function(ref,idx){var mkr=tdoa_place_ref_marker(idx+1000,tdoa.result_map,ref);tdoa.result_mkrs.push(mkr);});}}else{tdoa_show_maps({kiwi:false,result:false});var s;if(idx==tdoa.COMBINED_MAP)
s='Available only for new map option';else
s=w3_img('||alt="Image not available"',tdoa.url_files+tdoa.response.key+'/'+tdoa.results[idx].file+'.png');w3_innerHTML('id-tdoa-png',w3_div('w3-text-yellow',s));w3_show('id-tdoa-png');tdoa.cur_map=tdoa.kiwi_map;}
if(tdoa.response.likely_lat!=undefined&&tdoa.response.likely_lon!=undefined){var s='most likely: '+tdoa.response.likely_lat+', '+tdoa.response.likely_lon;w3_innerHTML('id-tdoa-result',w3_text('|color: hsl(0, 0%, 70%)',s));var url='https://google.com/maps/place/'+tdoa.response.likely_lat+','+tdoa.response.likely_lon;w3_innerHTML('id-tdoa-gmap-link',w3_link('',url,w3_icon('w3-text-aqua','fa-map-marker',18)));}}}
function tdoa_all_results_cb(path,checked){tdoa.all_results=checked;w3_checkbox_set(path,checked?true:false);}
function tdoa_clear_results_cb(path,idx,first){if((+idx)==0)return;tdoa.result_refs.forEach(function(ref,i){if(tdoa.result_refs.length<=1)return;var mkr=tdoa.result_mkrs.shift();tdoa.result_refs.shift();if(mkr==null)return;console.log(mkr);tdoa_marker_remove(mkr);});}
function tdoa_heatmap_visible_cb(path,checked){tdoa.heatmap_visible=checked;if(!tdoa.last_menu_select)return;var ms,me;if(tdoa.last_menu_select==tdoa.COMBINED_MAP){var npairs=tdoa.ngood*(tdoa.ngood-1)/ 2;ms=tdoa.SINGLE_MAPS;me=tdoa.SINGLE_MAPS+npairs;}else{ms=tdoa.last_menu_select;me=ms+1;}
for(var mi=ms;mi<me;mi++){var heatmap=tdoa.heatmap[mi];if(!heatmap)continue;if(tdoa.leaflet){if(tdoa.heatmap_visible){heatmap.addTo(tdoa.result_map);tdoa.map_layers.push(heatmap);}else{heatmap.remove();}}else{heatmap.setMap(tdoa.heatmap_visible?tdoa.result_map:null);}}}
function tdoa_day_night_visible_cb(path,checked,first){if(first)return;if(!tdoa.day_night)return;var checked=w3_checkbox_get(path);if(tdoa.leaflet){if(checked){tdoa.day_night.addTo(tdoa.kiwi_map);tdoa.map_layers.push(tdoa.day_night);}else{tdoa.day_night.remove();}}else{tdoa.day_night.setMap(checked?tdoa.kiwi_map:null);}}
function tdoa_graticule_visible_cb(path,checked,first){if(first)return;if(!tdoa.graticule)return;checked=w3_checkbox_get(path);if(tdoa.leaflet){if(checked){tdoa.graticule.addTo(tdoa.cur_map);tdoa.map_layers.push(tdoa.graticule);}else{tdoa.graticule.remove();}}else{tdoa.graticule.setMap(checked?tdoa.cur_map:null);}}
function tdoa_pan_zoom(map,latlon,zoom){if(tdoa.leaflet){if(latlon==null)latlon=map.getCenter();if(zoom==-1)zoom=map.getZoom();map.setView(latlon,zoom,{duration:0,animate:false});}else{if(latlon!=null){if(isArray(latlon))latlon=new google.maps.LatLng(latlon[0],latlon[1]);map.panTo(latlon);}
if(zoom!=-1)map.setZoom(zoom);}}
function tdoa_quick_zoom_cb(path,idx,first){if(first)return;var q=tdoa.quick_zoom[+idx];tdoa_pan_zoom(tdoa.kiwi_map,[q.lat+0.1,q.lon],q.z);tdoa_pan_zoom(tdoa.kiwi_map,[q.lat,q.lon],-1);}
function tdoa_sample_time_cb(path,idx,first){if(first)return;idx=+idx;console.log('tdoa_sample_time_cb idx='+idx);w3_select_value(path,idx);tdoa.sample_time=parseInt(tdoa.sample_time_s[idx]);tdoa.pie_max=tdoa.sample_time;tdoa_update_link();}
function TDoA_help(show){if(show){var s=w3_text('w3-medium w3-bold w3-text-aqua','TDoA Help')+
w3_div('w3-margin-T-8 w3-scroll-y|height:90%',w3_div('w3-margin-R-8','See the <a href="http://forum.kiwisdr.com/categories/kiwisdr-tdoa-topics" target="_blank">Kiwi forum</a> for more information. <br><br>'+'<b>Very important:</b> If the TDoA computation cannot converge on a solution within 3 minutes it will timeout. '+'Start with 2 or 3 sampling stations and if you get reasonable solutions add additional stations one-at-a-time. '+'If you begin with 4 or more stations that have no correlation of the signal the computation will timeout and '+'you\'ll be wasting your time as well as the servers time. <br><br>'+'If you are getting errors check these common problems:<ul>'+'<li>Not zoomed-in far enough. The TDoA process will run out of memory or have problems plotting the maps.</li>'+'<li>Not all Kiwis used for sampling have good reception of target signal. '+'Open a connection to each Kiwi by double clicking on its marker to check the reception '+'or by clicking on the speaker icon in the sampling station list.</li>'+'<li>Don\'t use Kiwis that are spaced too far apart (i.e. many thousands of km).</li>'+'<li>Use minimum IQ-mode passband. Just enough to capture the signal. '+'Use the "p" and "P" keys to narrow/widen the passband. '+'For AM broadcast signals try a narrow passband that only passes the carrier.</li> '+'</ul>'+'Once you configure this extension, and click the "Submit" button, '+'information is sent to the kiwisdr.com server. The server then records '+'30 seconds of IQ data from the two to six sampling Kiwis specified. '+'The frequency and passband of <b><i>this</i></b> Kiwi will be used for all recording. '+'So make sure it is set correctly before proceeding. Always use the minimum necessary passband and '+'make sure it is symmetrical about the carrier. The current mode (e.g. AM) is ignored as all '+'recording is automatically done in IQ mode. '+'After sampling, the TDoA process will be run on the server. After it finishes a result map will appear. '+'Additional maps may be viewed with the TDoA result menu. '+'You can pan and zoom the resulting maps and click submit again after making any changes. '+'<br><br>'+'The <i>show all results</i> checkbox, if checked, will cause the most likely position markers to accumulate for '+'successive runs. The <i>clear old results</i> button will erase all but the most recent likely position marker.<br><br>'+'To begin zoom into the general area of interest on the Kiwi map (note the "zoom to" menu). '+'Click on the desired blue Kiwi sampling stations. If they are not responding or have '+'had no recent GPS solutions an error message will appear. '+'<br><b>Important:</b> the position and zooming of the Kiwi map determines the same for the resulting TDoA maps. '+'Double click on the blue markers (or speaker icon) to open that Kiwi in a new tab to check if it is receiving the target signal well. '+'You can also manually edit the sampling station list (white fields). '+'<br><br>'+'You can click on the green map markers to set the frequency/passband of some well-known reference stations. '+'The known locations of these stations will be shown in the result maps '+'so you can see how well it agrees with the TDoA solution. '+'Practice with VLF/LF references stations as their ground-wave signals usually give good results. '+'Start with only two sampling stations and check the quality of the solution before adding more. '+'Of course you need three or more stations to generate a localized solution. '+'<br><br>'+'URL parameters: <br>'+
w3_text('|color:orange','(samp/ref station list) lat:<i>num</i> lon:<i>num</i> z|zoom:<i>num</i> sample:<i>secs</i> all: <br>'+'hosts: refs:0 refs:[1-8] submit:')+'<br> List of sampling stations and/or reference station IDs. Case-insensitive and can be abbreviated '+'(e.g. "dcf" matches "DCF77", "cyp2" matches "OTHR/CYP2") <br>'+'sample:<i>secs</i> (one of the time values from the "sample" menu) <br>'+'all: (check "show all results" checkbox) &nbsp; hosts: (uncheck "Kiwi hosts" checkbox) <br>'+'refs:0 (uncheck "Reference locations" checkbox) <br>'+'refs:[1-8] (cumulatively check/uncheck "Reference locations" checkboxes e.g. <i>refs:2:3</i>) <br>'+'submit: (start TDoA process) <br>'+'Example: <i>ext=tdoa,lat:35,lon:35,z:6,cyp2,ur5vib,kuwait,all:,refs:0:2:3,submit:</i> <br>'+''));confirmation_show_content(s,625,350);w3_el('id-confirmation-container').style.height='100%';}
return true;}
function TDoA_focus(){tdoa.optbar=ext_get_optbar();if(window.innerHeight<970)
zoom_center=0.6;ext_set_optbar('optbar-off','init');tdoa.pie_size=10;tdoa.pie_cnt=0;tdoa.pie_max=tdoa.sample_time;tdoa.pie_interval=setInterval(function(){if(!w3_el('id-tdoa-pie')){tdoa.pie_cnt=0;return;}
kiwi_draw_pie('id-tdoa-pie',tdoa.pie_size,tdoa.pie_cnt / tdoa.pie_max);tdoa.pie_cnt=Math.min(tdoa.pie_cnt+1,tdoa.pie_max);},1000);}
function TDoA_blur(){tdoa_waterfall_close();tdoa_clear_all_hosts();ext_set_data_height();zoom_center=0.5;if(ext_get_optbar()=='optbar-off'&&tdoa.optbar!='optbar-off')
ext_set_optbar(tdoa.optbar);kiwi_clearInterval(tdoa.pie_interval);kiwi_clearInterval(tdoa.day_night_interval);}
function TDoA_config_focus(){admin_set_decoded_value('tdoa_id');}
function TDoA_config_blur(){}
function TDoA_config_html(){var nchans=ext_get_cfg_param('tdoa_nchans',-1);if(nchans==-1)nchans=rx_chans;tdoa.nchans=Math.min(nchans,rx_chans);tdoa.chans_u={0:'none'};for(var i=1;i<=rx_chans;i++)
tdoa.chans_u[i]=i.toFixed(0);var s=w3_inline_percent('w3-container',w3_div('w3-center',w3_select('w3-width-auto','Number of simultaneous channels available<br>for connection by the TDoA service','','tdoa_nchans',tdoa.nchans,tdoa.chans_u,'admin_select_cb'),w3_div('w3-margin-T-8 w3-text-black','If you want to limit incoming connections from the <br> kiwisdr.com TDoA service set this value.<br>'+'These connections are identified in the user lists and logs as: "TDoA_service"')),40,w3_div('w3-text-black'),15,w3_div('',w3_input('||size=12','TDoA ID (alphanumeric and \'/\', 12 char max)','cfg.tdoa_id','','tdoa_id_cb','TDoA map marker id (e.g. callsign)'),w3_div('w3-margin-T-8 w3-text-black','When this Kiwi is used as a measurement station for the TDoA service it displays an '+'identifier on a map pin and in the first column of the TDoA extension control panel (when selected). '+'<br><br>You can customize that identifier by setting this field. By default the identifier will be '+'one of two items. Either what appears to be a ham callsign in the the "name" field on the '+'admin page Public tab or the grid square computed from your Kiwis lat/lon.')),40,w3_div('w3-text-black'),5)+
w3_inline_percent('w3-container',w3_div('',w3_input_get('w3-restart','TDoA server URL','tdoa.server','w3_url_set_cfg_cb','http://tdoa.kiwisdr.com'),w3_div('w3-margin-T-8 w3-text-black','Change <b>only</b> if you have implemented an alternate TDoA server. <br>'+'Set to "http://tdoa.kiwisdr.com" for the default TDoA server.')),48,w3_div('w3-text-black'),4,w3_div());ext_config_html(tdoa,'tdoa','TDoA','TDoA configuration',s);}
function tdoa_id_cb(path,val){val=val.replace(/[^a-zA-Z0-9\/]/g,'');val=val.substr(0,12);w3_set_value(path,val);w3_string_set_cfg_cb(path,val);}
function tdoa_chans_cb(path,idx,first){if(first)return;tdoa.nchans=+idx;}
function tdoa_preview_click(mkr,ev){if(tdoa.wf_ws!=null){tdoa.wf_mkr=mkr;tdoa.wf_ws.close();}else{var auto=(wf.aper==kiwi.APER_AUTO);tdoa.aper_save=wf.aper;tdoa.maxdb_save=auto?wf.save_maxdb:maxdb;tdoa.mindb_un_save=auto?wf.save_mindb_un:mindb_un;tdoa_wf_preview(mkr);}}
function tdoa_all_msg_cb(msg_a,ws){var cmd=msg_a[0];var param=isString(msg_a[1])?msg_a[1]:'';switch(cmd){case'badp':if(+param!=0){tdoa.wf_conn_bad=true;}
break;case'monitor':tdoa.wf_conn_bad=true;break;case'wf_setup':if(tdoa.wf_up)break;tdoa.wf_up=true;waterfall_add_line(wf_canvas_actual_line+1);var c=wf_cur_canvas;var x=freq_to_pixel(freq_passband_center());waterfall_add_text(wf_canvas_actual_line+4,x,12,tdoa.wf_id_snr,'Arial',14,'white');break;case'maxdb':case'mindb':kiwi_msg(msg_a,ws);break;default:break;}
if(tdoa.wf_conn_bad){if(tdoa.wf_ws)tdoa.wf_ws.close();w3_innerHTML('id-tdoa-submit-status','CONNECTION FAILED: '+tdoa.wf_id_snr+' ('+tdoa.wf_url+')');}
return true;}
function tdoa_waterfall_add_queue(what,ws,firstChars){if(kiwi.wf_preview_mode)
waterfall_add_queue2(what,ws,firstChars);tdoa.preview_lines++;if(tdoa.preview_lines==2){wf_aper_cb('wf.aper',kiwi.APER_MAN);setTimeout(wf_autoscale_cb,1);}
else
if(kiwi_gc_wf)what=null;}
function tdoa_waterfall_close(){kiwi_clearTimeout(tdoa.preview_timeo);if(tdoa.wf_ws!=null&&tdoa.wf_mkr!=null){var mkr=tdoa.wf_mkr;tdoa.wf_mkr=null;tdoa_wf_preview(mkr);}else{tdoa.wf_ws=tdoa.wf_mkr=null;kiwi.wf_preview_mode=false;var auto=(wf.aper==kiwi.APER_AUTO);if(isArg(tdoa.maxdb_save))wf.save_maxdb=maxdb=tdoa.maxdb_save;if(isArg(tdoa.mindb_un_save))wf.save_mindb_un=mindb_un=tdoa.mindb_un_save;if(isArg(tdoa.aper_save))wf_aper_cb('wf.aper',tdoa.aper_save);if(!tdoa.wf_conn_bad){w3_clearInnerHTML('id-tdoa-submit-status');}
if(tdoa.wf_up){wf_send('SET zoom='+zoom_level+' start='+x_bin);waterfall_add_line(wf_canvas_actual_line+1);var c=wf_cur_canvas;var id='Back to this Kiwi';var x=freq_to_pixel(freq_passband_center());waterfall_add_text(wf_canvas_actual_line+4,x,12,id,'Arial',14,'white');}}
tdoa.wf_up=false;}
function tdoa_wf_preview(mkr){var h=mkr.kiwi_mkr_2_ref_or_host;tdoa.wf_url=h.h+':'+h.p;tdoa.wf_id_snr=h.id_snr;w3_innerHTML('id-tdoa-submit-status','Waterfall preview: '+h.id_snr+' ('+tdoa.wf_url+')');tdoa.wf_ws=open_websocket('W/F',function(){tdoa.preview_lines=0;tdoa.wf_ws.send("SET auth t=kiwi");tdoa.wf_ws.send("SERVER DE CLIENT openwebrx.js W/F");tdoa.wf_ws.send("SET ident_user=TDoA_preview");tdoa.wf_ws.send("SET send_dB=1");tdoa.wf_ws.send('SET zoom='+zoom_level+' start='+x_bin);tdoa.wf_ws.send("SET maxdb=0 mindb=-100");tdoa.wf_ws.send("SET wf_speed=3");tdoa.preview_timeo=setTimeout(function(){if(tdoa.wf_ws)tdoa.wf_ws.close();},10000);},null,null,tdoa_waterfall_add_queue,on_ws_error,tdoa_waterfall_close,{url:tdoa.wf_url,new_ts:true,qs:'',all_msg_cb:tdoa_all_msg_cb});tdoa.wf_conn_bad=false;kiwi.wf_preview_mode=true;}



