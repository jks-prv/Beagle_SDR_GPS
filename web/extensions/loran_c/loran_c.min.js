

/* web/extensions/loran_c/loran_c.min.js */
var loran_c={ext_name:"loran_c",first_time:!0,setup_init:!0,gri0:0,gri_sel0:0,gain0:0,offset0:0,avg_algo0:0,avg_param0:0,gri1:0,gri_sel1:0,gain1:0,offset1:0,avg_algo1:0,avg_param1:0,scope:null},gri_s=["5960 North Russia (Chayka)","5990 Caucasus","6000 China BPL Pucheng","6731 Anthorn UK","6780 China South Sea","7430 China North Sea","7950 Eastern Russia (Chayka)","8000 Western Russia (Chayka)","8390 China East Sea","8830 Saudi Arabia North","8970 Wildwood USA (eLoran)","9930 Korea","9960 Wildwood USA (eLoran)"],gri_2s=["North Russia","(Chayka)","Caucasus","","China BPL","Pucheng","Anthorn UK","","China Sea","South","China Sea","North","Eastern Russia","(Chayka)","Western Russia","(Chayka)","China Sea","East","Saudi Arabia","North","Wildwood USA","(eLoran)","Korea","","Wildwood USA","(eLoran)"],loran_c_default_chain1=7,loran_c_default_chain2=3,emission_delay={5960:[{s:"M Inta",d:0},{s:"X Tumanny Pen",d:14670.15},{s:"Z Norilsk",d:45915.33}],5990:[{s:"M Caucasian Center",d:0},{s:"X Caucasian West",d:16587},{s:"Y Caucasian East",d:31304},{s:"Z Caucasian North",d:46440}],6000:[{s:"M Pucheng",d:0}],6731:[{s:"M Anthorn",d:0},{s:"Y Anthorn",d:27300}],6780:[{s:"M Hexian",d:0},{s:"X Raoping",d:14464.69},{s:"Y Chongzuo",d:26925.76}],7430:[{s:"M Rongcheng",d:0},{s:"X Xuancheng",d:13459.7},{s:"Y Helong",d:30852.32}],7950:[{s:"M Aleksandrovsk",d:0},{s:"W Petropavlovsk",d:14506.5},{s:"X Ussuriisk",d:33678},{s:"Y (ex-Tokachibuto)",d:49104.15},{s:"Z Okhotsk",d:64102.05}],8000:[{s:"M Bryansk",d:0},{s:"W Petrozavodsk",d:13217.21},{s:"X Slonim",d:27125},{s:"Y Simferopol",d:53070.25},{s:"Z Syzran",d:67941.6}],8390:[{s:"M Xuancheng",d:0},{s:"X Raoping",d:13795.52},{s:"Y Rongcheng",d:31459.7}],8830:[{s:"M Afif",d:0},{s:"W Salwa",d:13645},{s:"X (ex-Al Khamasin)",d:27265},{s:"Y Ash Shaykh",d:42645},{s:"Z Al Muwassam",d:58790}],8970:[{s:"M Wildwood",d:0}],9930:[{s:"M Pohang",d:0},{s:"W Kwang Ju",d:11946.97},{s:"X (ex-Gesashi)",d:25565.52},{s:"Y (ex-Niijima)",d:40085.64},{s:"Z Ussuriisk",d:54162.44}],9960:[{s:"M Wildwood",d:0}]};function loran_c_main(){ext_switch_to_client(loran_c.ext_name,loran_c.first_time,loran_c_recv),loran_c.first_time||loran_c_controls_setup(),loran_c.first_time=!1}var loran_c_cmd_e={SCOPE_DATA:0,SCOPE_RESET:1},loran_c_startx=125,loran_c_hlegend=20,loran_c_nbuckets=[];function loran_c_recv(a){if("DAT"!=arrayBufferToStringLen(a,3))for(var _=arrayBufferToString(a).substring(4).split(" "),r=0;r<_.length;r++){var n=_[r].split("=");switch(n[0]){case"ready":loran_c_controls_setup();break;case"ms_per_bin":loran_c_ms_per_bin=parseFloat(n[1]);break;default:console.log("loran_c_recv: UNKNOWN CMD "+n[0])}}else{var l=new Uint8Array(a,4),o=l[0];if(o==loran_c_cmd_e.SCOPE_DATA||o==loran_c_cmd_e.SCOPE_RESET){var e=l[1],c=l.length-2;loran_c_nbuckets[e]=c;var t=loran_c_startx,i=loran_c.scope.width,s=loran_c.scope.height,g=(e+1)*s/2-loran_c_hlegend,d=s/2-loran_c_hlegend;for(o==loran_c_cmd_e.SCOPE_RESET&&(loran_c.scope.ct.fillStyle="black",loran_c.scope.ct.fillRect(t,e*s/2,i-t,d)),r=0;r<c;r++){var p=l[2+r]/255;loran_c.scope.ct.fillStyle="black",loran_c.scope.ct.fillRect(t+r,g,1,-d),loran_c.scope.ct.fillStyle=e?"violet":"cyan",loran_c.scope.ct.fillRect(t+r,g,1,p*-d)}loran_c.scope.ct.fillStyle="black",loran_c.scope.ct.fillRect(t+r,g,i-t+r,-d)}else console.log("loran_c_recv: DATA UNKNOWN cmd="+o+" len="+(l.length-1))}}var loran_c_ms_per_bin,loran_c_station_colors=["red","yellow","lime","blue","grey"];function loran_c_draw_legend(a,_,r){loran_c.scope.width;var n=loran_c.scope.height,l=loran_c_startx,o=(a+1)*n/2,e=loran_c_hlegend,c=n/2-e;loran_c.scope.ct.fillStyle="white",loran_c.scope.ct.fillText("GRI "+_,0,o-c/3-e-8);var t=w3_el(r).value;null!=t&&-1!=t&&(loran_c.scope.ct.fillText(gri_2s[2*t],0,o-c/3-e+8),loran_c.scope.ct.fillText(gri_2s[2*t+1],0,o-c/3-e+24));var i=emission_delay[_];if(null!=i)for(var s=0;s<i.length;s++){var g,d=i[s].d/1e3;g=s<i.length-1?i[s+1].d/1e3:_/100,d=Math.round(d/loran_c_ms_per_bin),g=Math.round(g/loran_c_ms_per_bin),loran_c.scope.ct.fillStyle=loran_c_station_colors[s],loran_c.scope.ct.fillRect(l+d,o-e,g-d,6),loran_c.scope.ct.fillStyle="white",loran_c.scope.ct.fillText(i[s].s,l+d,o-3)}}function loran_c_update_gri(a,_,r){var n=loran_c.scope.width,l=loran_c.scope.height;loran_c.scope.ct.fillStyle="black",loran_c.scope.ct.fillRect(0,a*l/2,n,l/2),loran_c.scope.ct.font="12px Verdana",loran_c_draw_legend(a,r,_),ext_send("SET gri"+a+"="+r)}function loran_c_param_val(a,_){var r=_*loran_c_avg_param_max[a]/100;return loran_c_avg_param_max[a]>1&&(r=Math.ceil(r)),r<loran_c_avg_param_min[a]&&(r=loran_c_avg_param_min[a]),r}function loran_c_param_init(a){loran_c_slider_param_init[a]=Math.ceil(loran_c_avg_param_init[a]/loran_c_avg_param_max[a]*100)}var loran_c_nalgo=3,loran_c_avg_algo_e={CMA:0,EMA:1,IIR:2},loran_c_avg_algo_s=["CMA","EMA","IIR"],loran_c_avg_param_s=["Averages","Decay","Exp"],loran_c_avg_param_init={0:8,1:256,2:.2},loran_c_avg_param_min={0:1,1:1,2:0},loran_c_avg_param_max={0:32,1:512,2:1},loran_c_avg_param_cur=[],loran_c_slider_algo_init=loran_c_avg_algo_e.EMA,loran_c_slider_param_init=[];function loran_c_controls_setup(){if(loran_c.setup_init){for(var a=0;a<2;a++){loran_c["avg_algo"+a]=loran_c_slider_algo_init,loran_c["avg_param"+a]=loran_c_slider_param_init[loran_c_slider_algo_init];for(var _=0;_<loran_c_nalgo;_++)loran_c_avg_param_cur[a*loran_c_nalgo+_]=loran_c_slider_param_init[_]}loran_c.setup_init=!1}var r=time_display_html("loran_c")+w3_div("id-loran_c-data|height:200px; background-color:black; position:relative;",'<canvas id="id-loran_c-scope" height="200" style="position:absolute"></canvas>'),n=[];(e=loran_c.url_param=ext_param())&&e.split(",").forEach(function(a,_){n[_]=parseInt(a)});var l=loran_c.gri0;0==l&&(l=n[0],isNaN(l)&&(0!=(l=ext_get_cfg_param("loran_c.gri0"))&&null!=l&&null!=l||(l=parseInt(gri_s[loran_c_default_chain1]))),loran_c.gri0=l);var o=loran_c.gri1;0==o&&(o=n[1],isNaN(o)&&(0!=(o=ext_get_cfg_param("loran_c.gri1"))&&null!=o&&null!=o||(o=parseInt(gri_s[loran_c_default_chain2]))),loran_c.gri1=o);var e,c=w3_div("id-loran_c-controls w3-text-white",w3_col_percent("",w3_div("w3-medium w3-text-aqua","<b>Loran-C viewer</b>"),40,w3_div("",'See also <b><a href="http://df6nm.bplaced.net/LoranView/LoranGrabber.htm" target="_blank">LoranView</a></b> by DF6NM'),60),w3_half("","",w3_divs("w3-margin-T-8 w3-margin-R-10",w3_col_percent("",w3_input("w3-padding-smaller","GRI","loran_c.gri0",loran_c.gri0,"loran_c_gri_cb"),25),w3_select("|color:red","GRI","select","loran_c.gri_sel0",0,gri_s,"loran_c_gri_select_cb"),w3_slider("","Gain (auto-scale)","loran_c.gain0",loran_c.gain0,0,100,1,"loran_c_gain_cb"),w3_select("|color:red","Averaging","","loran_c.avg_algo0",loran_c.avg_algo0,loran_c_avg_algo_s,"loran_c_avg_algo_select_cb"),w3_slider("","?","loran_c.avg_param0",loran_c.avg_param0,0,100,1,"loran_c_avg_param_cb")),w3_divs("w3-margin-T-8 w3-margin-R-10",w3_col_percent("",w3_input("w3-padding-smaller","GRI","loran_c.gri1",loran_c.gri1,"loran_c_gri_cb"),25),w3_select("|color:red","GRI","select","loran_c.gri_sel1",0,gri_s,"loran_c_gri_select_cb"),w3_slider("","Gain (auto-scale)","loran_c.gain1",loran_c.gain1,0,100,1,"loran_c_gain_cb"),w3_select("|color:red","Averaging","","loran_c.avg_algo1",loran_c.avg_algo1,loran_c_avg_algo_s,"loran_c_avg_algo_select_cb"),w3_slider("","?","loran_c.avg_param1",loran_c.avg_param1,0,100,1,"loran_c_avg_param_cb"))));ext_tune(100,"am",ext_zoom.ABS,8),ext_panel_show(c,r,null),ext_set_controls_width_height(525,290),time_display_setup("loran_c"),loran_c.scope=w3_el("id-loran_c-scope"),loran_c.scope.ct=loran_c.scope.getContext("2d"),loran_c.scope.addEventListener("mousedown",loran_c_mousedown,!1),loran_c.data=w3_el("id-loran_c-data"),loran_c_environment_changed({resize:1}),(e=loran_c.url_param)&&e.split(",").forEach(function(a,_){w3_ext_param("help",a).match&&extint_help_click()}),ext_send("SET start")}function loran_c_environment_changed(a){if(a.resize){var _,r=1440-time_display_width()-32,n=(w3_el("id-loran_c-data"),(window.innerWidth-r-time_display_width())/2);w3_show_hide("loran_c-time-display",n>0),n>0?(_=r,console.log("$nom "+_)):(n=(window.innerWidth-r)/2)>0?(_=r,console.log("$no time "+_)):(_=window.innerWidth-32,console.log("$shrink to "+_),n=16),loran_c.data.style.width=px(_),loran_c.scope.width=_,loran_c.left=n,loran_c.data.style.left=px(n),loran_c_update_gri(0,"loran_c.gri_sel0",loran_c.gri0),loran_c_update_gri(1,"loran_c.gri_sel1",loran_c.gri1)}}function loran_c_mousedown(a){var _=a.clientX?a.clientX:a.offsetX?a.offsetX:a.layerX,r=(a.clientY?a.clientY:a.offsetY?a.offsetY:a.layerY)<loran_c.scope.height/2?0:1,n=_-loran_c.left-loran_c_startx;n<0||n>=loran_c_nbuckets[r]||ext_send("SET offset"+r+"="+n)}function loran_c_blur(){ext_send("SET stop")}function loran_c_gri_cb(a,_){w3_num_cb(a,_);var r=a.replace("gri","gri_sel");loran_c_gri_select_cb(r,-1),loran_c_update_gri(parseInt(a.charAt(a.length-1)),r,_)}function loran_c_gri_select_cb(a,_,r){_=+_;var n=a.replace("_sel","");if(r||-1==_){var l=w3_get_value(n),o=!1;w3_select_enum(a,function(_){var r=_.value;r>=0&&l==parseInt(gri_s[r])&&(w3_select_value(a,_.value),o=!0)}),o||w3_select_value(a,-1)}else{l=parseInt(gri_s[_]);w3_num_cb(n,l),w3_set_value(n,l)}loran_c_update_gri(parseInt(a.charAt(a.length-1)),a,l)}function loran_c_gain_cb(a,_){w3_num_cb(a,_),w3_set_label("Gain "+(0==_?"(auto-scale)":_+" dB"),a);var r=parseInt(a.charAt(a.length-1));ext_send("SET gain"+r+"="+_)}function loran_c_avg_algo_select_cb(a,_){_=+_,w3_num_cb(a,_);var r=_,n=parseInt(a.charAt(a.length-1));ext_send("SET avg_algo"+n+"="+r);var l,o=a.replace("algo","param");null==(l=loran_c_avg_param_cur[n*loran_c_nalgo+r])&&(l=loran_c_slider_param_init[r],console.log("loran_c_slider_param_init="+l+"/100")),loran_c_avg_param_cb(o,l),w3_set_value(o,l)}function loran_c_avg_param_cb(a,_){w3_num_cb(a,_);var r=a.replace("param","algo"),n=+w3_get_value(r),l=parseInt(a.charAt(a.length-1)),o=loran_c_param_val(n,_);ext_send("SET avg_param"+l+"="+o.toFixed(2)),loran_c_avg_param_cur[l*loran_c_nalgo+n]=+_,w3_set_label(loran_c_avg_param_s[n]+" "+o,a)}function loran_c_help(a){if(a){var _=w3_text("w3-medium w3-bold w3-text-aqua","Loran-C viewer help")+'<br><br>You can manually align the master station (the one with the 9th pulse) <br>to the left "M" slot by shift-clicking (touch on mobile devices) <br>at the location in the display you want moved to the left edge. <br><br>URL parameters: <br>First and second parameters can optionally be GRIs. <br>Example: <i>&ext=loran,8970,9960</i> <br>';confirmation_show_content(_,500,200)}return!0}function loran_c_config_html(){var a=w3_div("w3-show-inline-block",w3_div("w3-container w3-show-inline-block|width:200px",w3_divs("w3-margin-bottom",w3_input_get("","default GRI 0","loran_c.gri0","w3_num_set_cfg_cb",""),w3_input_get("","default GRI 1","loran_c.gri1","w3_num_set_cfg_cb",""))));ext_config_html(loran_c,"loran_c","Loran-C","Loran-C configuration",a)}loran_c_param_init(loran_c_avg_algo_e.CMA),loran_c_param_init(loran_c_avg_algo_e.EMA),loran_c_param_init(loran_c_avg_algo_e.IIR);