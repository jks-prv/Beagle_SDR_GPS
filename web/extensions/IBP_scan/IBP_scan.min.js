

/* web/extensions/IBP_scan/IBP_scan.min.js (web/extensions/IBP_scan/IBP_scan.js = Sat Apr 16 09:27:16 2022) */
var ibp={scan_ext_name:"IBP_scan",first_time:!0,SLOTS:18,ALL:20,BANDS:30,run:!1,annotate:!0,autosave:!1,lineCanvas:0,mindb_band:[],canvasSaved:!1,oldSlot:-1,monitorBeacon:-1,sound:!1,band:0,bands_s:["IBP 20m","IBP 17m","IBP 15m","IBP 12m","IBP 10m"],freqs:["14.100","18.110","21.150","24.930","28.200"]};function IBP_scan_main(){ext_switch_to_client(ibp.scan_ext_name,ibp.first_time,ibp_recv_msg),ibp.first_time||ibp_controls_setup(),ibp.first_time=!1}function ibp_recv_msg(e){for(var i=arrayBufferToString(e).substring(4).split(" "),t=0;t<i.length;t++){var a=i[t].split("=");switch(a[0]){case"ready":ibp_controls_setup();break;default:console.log("ibp_recv: UNKNOWN CMD "+a[0])}}}function ibp_controls_setup(){var e,i=time_display_html("IBP_scan")+w3_div("id-IBP-report|width:1024px; height:200px; overflow:hidden; position:relative; background-color:white;",'<canvas id="id-IBP-canvas" width="1024" height="200" style="position:absolute"></canvas>'),t={IBP:{value:-2,disabled:1,selected:1},OFF:{value:-1}};w3_obj_enum(dx_ibp_stations,function(e,i,a){t[e]={value:a.value,text:a.text}}),t["By band:"]={value:-1,disabled:1,text:"<b>By band:</b>"},t["All Bands"]={value:ibp.ALL,text:"All Bands"},ibp.bands_s.forEach(function(e,i){t[e]={value:ibp.BANDS+i,text:e}});var a=w3_div("id-tc-controls w3-text-white",w3_div("w3-medium w3-text-aqua",'<b><a href="http://www.ncdxf.org/beacon/index.html">International Beacon Project</a> (IBP) Scanner</b>'),w3_col_percent("w3-margin-T-4",w3_div("","by VE3SUN"),25,w3_div("",'Info: <b><a href="http://ve3sun.com/KiwiSDR/IBP.html" target="_blank">ve3sun.com/KiwiSDR/IBP</a></b>'),55,"",10),w3_inline("w3-halign-space-between w3-margin-T-8|width:90%;/",w3_select("id-IBP-menu w3-left w3-margin-right w3-show-inline","","","",0,t,"IBP_set"),w3_checkbox("w3-label-inline w3-label-not-bold","Annotate Waterfall","ibp.annotate",!0,"w3_bool_cb"),w3_checkbox("w3-label-inline w3-label-not-bold","Autosave PNG","ibp.autosave",!1,"IBP_Autosave")));ext_panel_show(a,i,null),ext_set_controls_width_height(475,90),time_display_setup("IBP_scan"),IBP_environment_changed({resize:1});var n=ext_param();if(n){n=n.toLowerCase();var l,o=-1;w3_obj_enum(dx_ibp_stations,function(e,i,t){e.toLowerCase()==n&&(o=i)}),-1!=o&&((l=o>=ibp.SLOTS&&"cycle"==n)||o<ibp.SLOTS)&&(l&&(o=ibp.ALL),IBP_set("",o))}ibp.autosave=readCookie("IBP_PNG_Autosave"),"true"!=ibp.autosave&&(ibp.autosave=!1),w3_checkbox_set("id-IBP-Autosave",ibp.autosave);var b=document.createElement("canvas");b.width=16,b.height=1,(_=b.getContext("2d")).fillStyle="white",_.fillRect(0,0,8,1),_.fillStyle="black",_.fillRect(8,0,8,1),ibp.lineCanvas=b;var _,d=w3_el("id-IBP-canvas"),s="";if(d)for((_=d.getContext("2d")).fillStyle="#ffffff",_.fillRect(0,0,1024,200),_.font="12px Arial",_.fillStyle="red",_.textAlign="center",w3_obj_enum(dx_ibp_stations,function(e,i,t){_.fillText(e,102+51*t.value,16)}),e=0;e<5;e++)s=ibp.freqs[e],_.fillText(s,45,36*e+40);var r=readCookie("mindb_band");if(r){var c=kiwi_JSON_parse("ibp_controls_setup",r);c&&(ibp.mindb_band=c)}ibp.run=!0}function IBP_environment_changed(e){if(e.resize){var i=w3_el("id-IBP-report"),t=(window.innerWidth-1024-time_display_width())/2;i.style.left=px(t)}}function IBP_scan_blur(){IBP_set("",-1),ibp.run=!1}function IBP_Autosave(e,i){ibp.autosave=!!i,writeCookie("IBP_PNG_Autosave",ibp.autosave)}function IBP_set(e,i,t){if(!t){i=+i,w3_el("id-IBP-menu").value=i;var a=i>=0;ibp.band=0,ibp.monitorBeacon=i,i>=ibp.BANDS?ibp.band=i-ibp.BANDS:i<0&&(w3_el("id-IBP-menu").selectedIndex=0,a&&(ibp.band=0)),select_band(ibp.bands_s[ibp.band])}}function IBP_bandchange(e,i){if(ibp.monitorBeacon==ibp.ALL){var t=Math.floor(e.getTime()/18e4)%5;return t!=ibp.band&&(ibp.band=t,select_band(ibp.bands_s[ibp.band]),ibp.band)}return ibp.monitorBeacon==(i+ibp.SLOTS-1)%ibp.SLOTS&&(ibp.band++,ibp.band%=5,select_band(ibp.bands_s[ibp.band]),ibp.band)}function ibp_save_Canvas(e){var i=w3_el("id-IBP-canvas");if(i){var t=i.getContext("2d");t.fillStyle="black",t.fillText(e.getUTCHours().leadingZeros()+":"+e.getUTCMinutes().leadingZeros()+" UTC",40,16);var a=i.toDataURL("image/png"),n=document.createElement("a");n.download="IBP "+e.getUTCFullYear()+(e.getUTCMonth()+1).leadingZeros()+e.getUTCDate().leadingZeros()+" "+e.getUTCHours().leadingZeros()+"h"+e.getUTCMinutes().leadingZeros()+"Z.png",n.href=a,n.dataset.downloadurl=["image/png",n.download,n.href].join(":"),document.body.appendChild(n),n.click(),document.body.removeChild(n),t.fillStyle="#ffffff",t.fillRect(0,0,75,19)}}function ibp_annotate_waterfall(e){var i=wf_cur_canvas;i.ctx.strokeStyle="red";var t=wf_canvas_actual_line+1;t>i.height&&(t-=2),i.ctx.moveTo(0,t),i.ctx.lineTo(i.width,t),i.ctx.rect(0,t,i.width,1);var a,n,l=i.ctx.createPattern(ibp.lineCanvas,"repeat");i.ctx.fillStyle=l,i.ctx.fill(),w3_obj_enum(dx_ibp_stations,function(i,t,l){t==e&&(a=i,n=l.text)});var o=a+" "+n;t=wf_canvas_actual_line;var b=(i.width-i.ctx.measureText(o).width)/2;if(w3_fillText_shadow(i,o,b,t+14,"Arial",13,"lime",4),wf_canvas_actual_line+10>i.height){var _=wf_canvases[1];_&&w3_fillText_shadow(_,o,b,t-i.height+14,"Arial",13,"lime",4)}}function IBP_scan_plot(e){if(ibp.run){var i=w3_el("id-IBP-canvas");if(i){var t=i.getContext("2d"),a=new ImageData(1,1),n=new Date(dx_ibp_server_time_ms+(Date.now()-dx_ibp_local_time_epoch_ms)),l=n.getTime(),o=Math.floor(l%1e4/200),b=Math.floor(l/1e4)%ibp.SLOTS,_=get_visible_freq_range(),d=Math.floor((_.center-14e6)/3e6),s=20+36*d,r=(b-d+ibp.SLOTS)%ibp.SLOTS,c=76+51*r;if(ibp.autosave&&(b?ibp.canvasSaved=!1:ibp.canvasSaved||(t.fillStyle="red",t.fillRect(c-1,s,1,35),ibp_save_Canvas(n),ibp.canvasSaved=!0,t.fillStyle="#ffffff",t.fillRect(c-1,s,1,35))),ibp.oldSlot>-1&&ibp.oldSlot!=b){ibp.annotate&&ibp_annotate_waterfall((r+ibp.SLOTS-1)%ibp.SLOTS);var p=IBP_bandchange(n,r);if(!1!==p)return ibp.mindb_band[p]&&mindb!=ibp.mindb_band[p]&&setmindb(!0,ibp.mindb_band[p]),void(ibp.oldSlot=-2)}ibp.oldSlot!=b?(kiwi.muted&&ibp.monitorBeacon==r&&(toggle_or_set_mute(),setTimeout(function(){toggle_or_set_mute()},5e4)),t.fillStyle="#000055",t.fillRect(c,s,50,35)):ibp.mindb_band[d]!=mindb&&(ibp.mindb_band[d]=mindb,writeCookie("mindb_band",JSON.stringify(ibp.mindb_band)));for(var f=495;f<530;f++)for(var v=0;v<4;v++)a.data[v]=e.data[4*f+v],t.putImageData(a,c+o,s+f-495);ibp.oldSlot=b}}}


