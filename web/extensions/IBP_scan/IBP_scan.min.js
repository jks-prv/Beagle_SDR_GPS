var ibp_lineCanvas,ibp_scan_ext_name="IBP_scan",ibp_first_time=!0,ibp_run=!1,ibp_autosave=!1;function IBP_scan_main(){ext_switch_to_client(ibp_scan_ext_name,ibp_first_time,ibp_recv_msg),ibp_first_time||ibp_controls_setup(),ibp_first_time=!1}function ibp_recv_msg(e){for(var t=arrayBufferToString(e).substring(4).split(" "),a=0;a<t.length;a++){var n=t[a].split("=");switch(n[0]){case"ready":ibp_controls_setup();break;default:console.log("ibp_recv: UNKNOWN CMD "+n[0])}}}var mindb_band=[];function ibp_controls_setup(){var e=time_display_html("IBP_scan")+w3_div("id-IBP-report|width:1024px; height:200px; overflow:hidden; position:relative; background-color:white;",'<canvas id="id-IBP-canvas" width="1024" height="200" style="position:absolute"></canvas>'),t=w3_div("id-tc-controls w3-text-white",w3_div("w3-medium w3-text-aqua",'<b><a href="http://www.ncdxf.org/beacon/index.html">International Beacon Project</a> (IBP) Scanner</b>'),w3_col_percent("",w3_div("","by VE3SUN"),25,w3_div("",'Info: <b><a href="http://ve3sun.com/KiwiSDR/IBP.html" target="_blank">ve3sun.com/KiwiSDR/IBP</a></b>'),55,"",10),w3_inline("w3-halign-space-between|width:90%;/",w3_divs("w3-margin-T-8/w3-show-inline w3-left w3-margin-right",IBP_select),w3_divs("w3-margin-T-8/cl-ibp-annotate-checkbox w3-padding-L-16",'<input id="id-IBP-Annotate" class="w3-pointer" type="checkbox" value="" checked> Annotate Waterfall'),w3_divs("w3-margin-T-8/cl-ibp-annotate-checkbox",'<input id="id-IBP-Autosave" class="w3-pointer" type="checkbox" value="" onclick="IBP_Autosave(this.checked)"> Autosave PNG')));ext_panel_show(t,e,null),ext_set_controls_width_height(475,90),time_display_setup("IBP_scan"),IBP_environment_changed({resize:1});var a=ext_param();if(a){var n;for(a=a.toLowerCase(),o=0;o<18&&a!=dx_ibp[2*o].toLowerCase();o++);((n=o>=18&&"cycle"==a)||o<18)&&(n&&(o=20),console.log("IBP: URL set "+a),w3_el("select-IBP").value=o,set_IBP(o))}"true"!=(ibp_autosave=readCookie("IBP_PNG_Autosave"))&&(ibp_autosave=!1),document.getElementById("id-IBP-Autosave").checked=ibp_autosave;var i=document.createElement("canvas");i.width=16,i.height=1,(l=i.getContext("2d")).fillStyle="white",l.fillRect(0,0,8,1),l.fillStyle="black",l.fillRect(8,0,8,1),ibp_lineCanvas=i;var _=document.getElementById("id-IBP-canvas"),c="";if(_){var l;(l=_.getContext("2d")).fillStyle="#ffffff",l.fillRect(0,0,1024,200),l.font="12px Arial",l.fillStyle="red",l.textAlign="center";for(var o=0;o<18;o++)c=dx_ibp[2*o],l.fillText(c,102+51*o,16);var d=["14.100","18.110","21.150","24.930","28.200"];for(o=0;o<5;o++)c=d[o],l.fillText(c,45,36*o+40)}var r=readCookie("mindb_band");r&&(mindb_band=JSON.parse(r)),ibp_run=!0}function IBP_environment_changed(e){if(e.resize){var t=w3_el("id-IBP-report"),a=(window.innerWidth-1024-time_display_width())/2;t.style.left=px(a)}}function IBP_scan_blur(){console.log("IBP_scan_blur"),set_IBP(-1),ibp_run=!1}function IBP_Autosave(e){ibp_autosave=e,writeCookie("IBP_PNG_Autosave",ibp_autosave)}var IBP_monitorBeacon=-1,IBP_sound=!1,IBP_band=0,IBP_muted="undefined"!=typeof muted?muted:0,IBP_bands=["IBP 20m","IBP 17m","IBP 15m","IBP 12m","IBP 10m"],IBP_select='<select id="select-IBP" class="w3-pointer" onchange="set_IBP(this.value)"><option value="-2" selected="" disabled="">IBP</option><option value="-1">OFF</option>';if("undefined"!=typeof dx_ibp){for(var i=0;i<18;i++)IBP_select+='<option value="'+i+'">'+dx_ibp[2*i]+"</option>";IBP_select+='<option value="-1" disabled><b>By band:</b></option>',IBP_select+='<option value="20">All Bands</option>';for(i=0;i<5;i++)IBP_select+='<option value="'+(30+i)+'">'+IBP_bands[i]+"</option>";IBP_select+="</select>"}var IBP_selected=!1;function set_IBP(e){e>=0&&(IBP_selected=!0),IBP_band=0,IBP_monitorBeacon=e,IBP_sound=!1,e>=30&&(IBP_band=e-30),e<0&&(document.getElementById("select-IBP").selectedIndex=0,IBP_selected&&select_band(IBP_bands[0]))}function leadZero(e){return e<10&&(e="0"+e),e}function IBP_bandchange(e,t){if(20==IBP_monitorBeacon){var a=Math.floor(e.getTime()/18e4)%5;return a!=IBP_band&&(IBP_band=a,select_band(IBP_bands[IBP_band]),IBP_band)}return IBP_monitorBeacon==(t+17)%18&&(IBP_band++,IBP_band%=5,select_band(IBP_bands[IBP_band]),IBP_band)}function save_Canvas(e){var t=document.getElementById("id-IBP-canvas");if(t){var a=t.getContext("2d");a.fillStyle="black",a.fillText(leadZero(e.getUTCHours())+":"+leadZero(e.getUTCMinutes())+" UTC",40,16);var n=t.toDataURL("image/png"),i=document.createElement("a");i.download="IBP "+e.getUTCFullYear()+(e.getUTCMonth()+1)+e.getUTCDate()+" "+leadZero(e.getUTCHours())+"h"+leadZero(e.getUTCMinutes())+"z.png",i.href=n,i.dataset.downloadurl=["image/png",i.download,i.href].join(":"),document.body.appendChild(i),i.click(),document.body.removeChild(i),a.fillStyle="#ffffff",a.fillRect(0,0,75,19)}}function Annotate_waterfall(e){wf_cur_canvas.ctx.strokeStyle="red";var t=wf_canvas_actual_line+1;t>wf_cur_canvas.height&&(t-=2),wf_cur_canvas.ctx.moveTo(0,t),wf_cur_canvas.ctx.lineTo(wf_cur_canvas.width,t),wf_cur_canvas.ctx.rect(0,t,wf_cur_canvas.width,1);var a=wf_cur_canvas.ctx.createPattern(ibp_lineCanvas,"repeat");wf_cur_canvas.ctx.fillStyle=a,wf_cur_canvas.ctx.fill(),wf_cur_canvas.ctx.strokeStyle="black",wf_cur_canvas.ctx.miterLimit=2,wf_cur_canvas.ctx.lineJoin="circle",wf_cur_canvas.ctx.font="10px Arial",wf_cur_canvas.ctx.fillStyle="lime";var n=dx_ibp[2*e]+" "+dx_ibp[2*e+1];if(wf_cur_canvas.ctx.lineWidth=3,wf_cur_canvas.ctx.strokeText(n,(wf_cur_canvas.width-wf_cur_canvas.ctx.measureText(n).width)/2,wf_canvas_actual_line+12),wf_cur_canvas.ctx.lineWidth=1,wf_cur_canvas.ctx.fillText(n,(wf_cur_canvas.width-wf_cur_canvas.ctx.measureText(n).width)/2,wf_canvas_actual_line+12),wf_canvas_actual_line+10>wf_cur_canvas.height){var i=wf_canvases[1];i&&(i.ctx=i.getContext("2d"),i.ctx.strokeStyle="black",i.ctx.miterLimit=2,i.ctx.lineJoin="circle",i.ctx.font="10px Arial",i.ctx.fillStyle="lime",i.ctx.lineWidth=3,i.ctx.strokeText(n,(wf_cur_canvas.width-wf_cur_canvas.ctx.measureText(n).width)/2,wf_canvas_actual_line-wf_cur_canvas.height+12),i.ctx.lineWidth=1,i.ctx.fillText(n,(wf_cur_canvas.width-wf_cur_canvas.ctx.measureText(n).width)/2,wf_canvas_actual_line-wf_cur_canvas.height+12))}}var IBP_oldSlot=-1,canvasSaved=!1;function IBP_scan_plot(e){if(ibp_run){var t=document.getElementById("id-IBP-canvas");if(t){var a=t.getContext("2d"),n=new ImageData(1,1),i=new Date(dx_ibp_server_time_ms+(Date.now()-dx_ibp_local_time_epoch_ms)),_=i.getTime(),c=Math.floor(_%1e4/200),l=Math.floor(_/1e4)%18,o=get_visible_freq_range(),d=Math.floor((o.center-14e6)/3e6),r=20+36*d,s=(l-d+18)%18,f=76+51*s;if(ibp_autosave&&(l?canvasSaved=!1:canvasSaved||(a.fillStyle="red",a.fillRect(f-1,r,1,35),save_Canvas(i),canvasSaved=!0,a.fillStyle="#ffffff",a.fillRect(f-1,r,1,35))),IBP_oldSlot>-1&&IBP_oldSlot!=l){document.getElementById("id-IBP-Annotate")&&document.getElementById("id-IBP-Annotate").checked&&Annotate_waterfall((s+17)%18);var v=IBP_bandchange(i,s);if(!1!==v)return mindb_band[v]&&mindb!=mindb_band[v]&&setmindb(!0,mindb_band[v]),void(IBP_oldSlot=-2)}IBP_oldSlot!=l?(muted&&IBP_monitorBeacon==s&&(toggle_or_set_mute(),setTimeout(function(){toggle_or_set_mute()},5e4)),a.fillStyle="#000055",a.fillRect(f,r,50,35)):mindb_band[d]!=mindb&&(mindb_band[d]=mindb,writeCookie("mindb_band",JSON.stringify(mindb_band)));for(var u=495;u<530;u++)for(var b=0;b<4;b++)n.data[b]=e.data[4*u+b],a.putImageData(n,f+c,r+u-495);IBP_oldSlot=l}}}