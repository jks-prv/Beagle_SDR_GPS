var cw={ext_name:"cw_decoder",first_time:!0,pboff:-1,wspace:!0,thresh:!1,threshold:45,console_status_msg_p:{scroll_only_at_bottom:!0,process_return_nexttime:!1,remove_returns:!0,ncol:135}};function cw_decoder_main(){ext_switch_to_client(cw.ext_name,cw.first_time,cw_decoder_recv),cw.first_time||cw_decoder_controls_setup(),cw.first_time=!1}function cw_decoder_recv(e){if("DAT"!=arrayBufferToStringLen(e,3))for(var c=arrayBufferToString(e).substring(4).split(" "),t=0;t<c.length;t++){var o=c[t].split("=");switch(o[0]){case"ready":kiwi_load_js(["pkgs/js/graph.js"],"cw_decoder_controls_setup");break;case"cw_chars":cw_decoder_output_chars(o[1]);break;case"cw_wpm":w3_innerHTML("id-cw-wpm",o[1]+" WPM");break;case"cw_train":var r=w3_el("id-cw-train"),_=+o[1];_<0?w3_innerHTML(r,"error "+-_+"/4"):w3_innerHTML(r,"train "+_+"/98"),w3_background_color(r,_<0?"orange":"lime"),w3_show_hide(r,_);break;case"cw_plot":graph_plot(+o[1]);break;default:console.log("cw_decoder_recv: UNKNOWN CMD "+o[0])}}else{var s=new Uint8Array(e,4),d=s[0],w=s.length-1;console.log("cw_decoder_recv: DATA UNKNOWN cmd="+d+" len="+w)}}function cw_decoder_output_chars(e){cw.console_status_msg_p.s=e,kiwi_output_msg("id-cw-console-msgs","id-cw-console-msg",cw.console_status_msg_p)}function cw_decoder_controls_setup(){var e=time_display_html("cw")+w3_div("id-cw-data|left:150px; width:1044px; height:300px; overflow:hidden; position:relative; background-color:mediumBlue;",'<canvas id="id-cw-canvas" width="1024" height="180" style="position:absolute; padding: 10px"></canvas>',w3_div("id-cw-console-msg w3-text-output w3-scroll-down w3-small w3-text-black|top:200px; width:1024px; height:100px; position:absolute; overflow-x:hidden;",'<pre><code id="id-cw-console-msgs"></code></pre>')),c=w3_div("id-cw-controls w3-text-white",w3_divs("w3-container/w3-tspace-8",w3_col_percent("",w3_div("w3-medium w3-text-aqua","<b>CW decoder</b>"),30,w3_div("",'From Loftur Jonasson, TF3LJ / VE2LJX <br> and the <b><a href="https://github.com/df8oe/UHSDR" target="_blank">UHSDR project</a></b> &copy; 2016'),55),w3_inline("",w3_button("w3-padding-smaller","Clear","cw_clear_cb",0),w3_div("id-cw-wpm w3-margin-left","0 WPM"),w3_checkbox("w3-margin-left w3-label-inline w3-label-not-bold","word space<br>correction","cw.wspace",!0,"cw_decoder_wsc_cb"),w3_input("id-cw-threshold w3-margin-left/w3-label-not-bold/|padding:0;width:auto|size=4","threshold","cw.threshold",cw.threshold,"cw_decoder_threshold_cb"),w3_button("w3-margin-left w3-padding-smaller","Reset","cw_reset_cb",0),w3_div("id-cw-train w3-margin-left w3-padding-small w3-text-black w3-hide","train"))));ext_panel_show(c,e,null),time_display_setup("cw"),cw.canvas=w3_el("id-cw-canvas"),cw.canvas.ctx=cw.canvas.getContext("2d"),graph_init(cw.canvas,{dBm:0,speed:1,averaging:!0}),graph_mode(0,45,35),graph_clear(),cw_decoder_threshold_cb("cw.threshold",cw.threshold),ext_set_data_height(300),ext_set_controls_width_height(550,90);var t=ext_param();cw.pboff_locked=parseFloat(t),console.log("CW pboff_locked="+cw.pboff_locked),cw_clear_cb(),ext_send("SET cw_start"),cw.pboff=-1,cw_decoder_environment_changed()}function cw_decoder_environment_changed(e){var c=Math.abs(ext_get_passband_center_freq()-ext_get_carrier_freq());if(cw.pboff!=c){var t=-1==cw.pboff&&cw.pboff_locked,o=t?cw.pboff_locked:c;!t&&cw.pboff_locked||(console.log("CW ENV new pbo="+o),ext_send("SET cw_pboff="+o)),cw.pboff=c}}function cw_clear_cb(e,c,t){t||(cw.console_status_msg_p.s=encodeURIComponent("\f"),kiwi_output_msg("id-cw-console-msgs","id-cw-console-msg",cw.console_status_msg_p))}function cw_decoder_wsc_cb(e,c,t){t||ext_send("SET cw_wsc="+(c?1:0))}function cw_decoder_thresh_cb(e,c,t){t||ext_send("SET cw_thresh="+(c?1:0))}function cw_decoder_threshold_cb(e,c){var t=parseFloat(c);t&&!isNaN(t)&&(console.log("cw_decoder_threshold_cb path="+e+" val="+c+" threshold_dB="+t),w3_num_cb(e,t),cw.threshold=t,graph_threshold(cw.threshold),ext_send("SET cw_threshold="+Math.pow(10,cw.threshold/10).toFixed(0)))}function cw_reset_cb(e,c,t){t||(ext_send("SET cw_reset"),cw.pboff=-1,cw_decoder_environment_changed())}function cw_decoder_blur(){ext_set_data_height(),ext_send("SET cw_stop")}function cw_decoder_help(e){if(e){var c=w3_text("w3-medium w3-bold w3-text-aqua","CW decoder help")+"<br>Use the CWN mode with its narrow passband to maximize the signal/noise ratio. <br>The decoder doesn't do very well with weak or fading signals. <br><br>Adjust the <i>threshold</i> value so the red line in the signal level display is just under the <br>average value of the signal peaks. <br>The <i>word space correction</i> checkbox sets the algorithm used to determine word spacing. ";confirmation_show_content(c,610,150)}return!0}