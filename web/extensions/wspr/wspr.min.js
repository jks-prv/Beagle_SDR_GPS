

/* web/extensions/wspr/wspr.min.js */
var wspr={ext_name:"wspr",first_time:!0,focus_interval:null,pie_size:25,stack_decoder:0,debug:0,no_upload:0},wspr_canvas_width=1024;function wspr_main(){ext_switch_to_client(wspr.ext_name,wspr.first_time,wspr_recv),wspr.first_time||wspr_controls_setup(),wspr.first_time=!1}var wspr_bins,wspr_startx,wspr_cmd_e={WSPR_DATA:0},wspr_cmd_d={0:"WSPR_DATA"},aw_ypos=0,y_tstamp=-1,span=0,over=16;function wspr_scroll(){var r=wccva.height;if(wccva.style.top=r-aw_ypos+"px",wccvao.style.top=-aw_ypos+"px",++aw_ypos>=r){aw_ypos=0;var e=wccvao;wccvao=wccva,wccva=e}}var WSPR_F_BIN=4095,WSPR_F_DECODING=4096,WSPR_F_DELETE=8192,WSPR_F_DECODED=16384,WSPR_F_IMAGE=32768;function wspr_recv(r){if("DAT"!=arrayBufferToStringLen(r,3))for(var e=arrayBufferToString(r).substring(4).split(" "),t=0;t<e.length;t++){var s=e[t].split("=");switch(s[0]){case"ready":var _=parseInt(ext_get_cfg_param("WSPR.BFO",wspr_bfo));isNaN(_)||(wspr_bfo=_),ext_send("SET BFO="+wspr_bfo.toFixed(0)),wspr_controls_setup(),ext_send("SET stack_decoder="+wspr.stack_decoder),ext_send("SET debug="+wspr.debug);break;case"WSPR_TIME_MSEC":wspr_server_time_ms=1e3*s[1]+ +s[2],wspr_local_time_epoch_ms=Date.now();break;case"WSPR_SYNC":break;case"WSPR_STATUS":wspr_set_status(parseInt(s[1]));break;case"WSPR_DECODED":var a=decodeURIComponent(s[1]),i=(v=html("id-wspr-decode"),kiwi_isScrolledDown(v));v.innerHTML+=a+"<br>",i&&(v.scrollTop=v.scrollHeight);break;case"WSPR_UPLOAD":a=decodeURIComponent(s[1]);wspr_upload(wspr_report_e.SPOT,a);break;case"WSPR_PEAKS":var p,w=0;""!=(a=decodeURIComponent(s[1]))&&(p=a.split(":")).length&&(w=(p.length-1)/2);for(t=0;t<w;t++){var o=parseInt(p[2*t]),n=o&~WSPR_F_BIN;if(o&=WSPR_F_BIN,!(n&WSPR_F_DELETE)){var c,l=wspr_startx+2*o;if(l>wspr_canvas_width)break;(c=t<w-1?wspr_startx+2*parseInt(p[2*(t+1)]):wspr_canvas_width)>=wspr_canvas_width&&(c=wspr_canvas_width+256);var d,u=p[2*t+1],m=u.filterInt();isNaN(m)?d=n&WSPR_F_IMAGE?"cl-wspr-image":"cl-wspr-call":(u=m.toFixed(0),d=n&WSPR_F_DECODING?"cl-wspr-decoding":""),a+=w3_div("cl-wspr-mkr1|max-width:"+(c-l)+"px; left:"+(l-6)+"px; bottom:8px",w3_div("cl-wspr-mkr2",w3_div("cl-wspr-snr "+d,u)))+w3_div("cl-wspr-line "+d+"|width:1px; height:10px; position:absolute; left:"+l+"px; bottom:0px;")}}html("id-wspr-peaks-labels").innerHTML=a;break;case"nbins":wspr_bins=parseInt(s[1]),wspr_startx=Math.round((wspr_canvas_width-2*wspr_bins)/2);break;default:console.log("wspr_recv: UNKNOWN CMD "+s[0])}}else{var g=new Uint8Array(r,4),f=g[0];if(f==wspr_cmd_e.WSPR_DATA){var v=2,b=g.length-v,h=wccva.height;g[1]&&(y_tstamp=aw_ypos+12,wccva.ct.fillStyle="white",wccva.ct.fillRect(wspr_startx-over,aw_ypos,2*b+2*over,1),wspr_scroll());var S=wccva.im;for(t=0;t<b;t++){var k=g[v+t];for(k>255&&(k=255),k<0&&(k=0),j=0;j<2;j++){var x=4*(2*t+j+wspr_startx);S.data[x]=color_map_r[k],S.data[x+1]=color_map_g[k],S.data[x+2]=color_map_b[k],S.data[x+3]=255}}if(wccva.ct.putImageData(S,0,aw_ypos),y_tstamp>=h&&aw_ypos==h-1&&(span=1),y_tstamp==aw_ypos||span){wccva.ct.fillStyle="white",wccva.ct.font="10px Verdana";var T=new Date(wspr_server_time_ms+(Date.now()-wspr_local_time_epoch_ms));wccva.ct.fillText(T.toUTCString().substr(17,5)+" UTC",wspr_startx+2*b+over,y_tstamp),span?(y_tstamp-=h,span=0):y_tstamp=-1}wspr_scroll()}else console.log("wspr_recv: DATA UNKNOWN cmd="+f+" len="+(g.length-1))}}var wspr_spectrum_A,wspr_spectrum_B,wspr_scale_canvas,wccva,wccva0,wspr_report_e={STATUS:0,SPOT:1},wspr_config={deco:1},wspr_config_okay=!0,wspr_init_band=-1;function wspr_controls_setup(){var r,e=time_display_html("wspr")+w3_div("id-wspr-peaks|width:1024px; height:30px; background-color:black; position:relative;",w3_div("id-wspr-peaks-labels|width:1024px; height:30px; position:absolute;"))+w3_div("id-wspr-spectrum|width:1024px; height:150px; overflow:hidden; position:relative;",'<canvas id="id-wspr-spectrum-A" width="1024" height="150" style="position:absolute">test</canvas>','<canvas id="id-wspr-spectrum-B" width="1024" height="150" style="position:absolute">test</canvas>')+w3_div("id-wspr-scale|width:1024px; height:20px; background-color:black; position:relative;",'<canvas id="id-wspr-scale-canvas" width="1024" height="20" style="position:absolute"></canvas>'),t=ext_get_cfg_param_string("WSPR.callsign","");null!=t&&null!=t&&""!=t||(t="(not set)",wspr_config_okay=!1);var s=kiwi.WSPR_rgrid;null==s||null==s||""==s?(s="(not set)",wspr_config_okay=!1,wspr.grid=""):wspr.grid=s;var _=ext_get_freq_range();if(_.lo_kHz>32e3&&_.hi_kHz>32e3){var a,i=!1;for(r=0;r<wspr_xvtr_center_freqs.length;r++)if((a=wspr_xvtr_center_freqs[r])>=_.lo_kHz&&a<=_.hi_kHz){i=!0;break}if(console.log("found="+i+" i="+r),wspr_center_freqs=[],wspr_freqs_s={},wspr_freqs_m=[],i){wspr_center_freqs[0]=a;var p=wspr_xvtr_freqs_s[r];wspr_freqs_m=[p],wspr_freqs_s[p]=0,wspr_init_band>0&&(wspr_init_band=0)}}var w=w3_div("id-wspr-controls",w3_inline("w3-halign-space-between|width:83%/",w3_select("|color:red","","band","wspr_init_band",wspr_init_band,wspr_freqs_m,"wspr_band_select_cb"),w3_button("cl-wspr-button","stop","wspr_stop_start_cb"),w3_button("cl-wspr-button","clear","wspr_clear_cb"),w3_div("id-wspr-upload-bkg cl-upload-checkbox",'<input id="id-wspr-upload" type="checkbox" value="" onclick="wspr_set_upload_cb(this.checked)"> upload spots'),w3_div("w3-medium w3-text-aqua cl-viewer-label","<b>WSPR<br>viewer</b>")),w3_inline("w3-halign-space-between/",w3_div("cl-wspr-pie|background-color:#575757",kiwi_pie("id-wspr-pie",wspr.pie_size,"#eeeeee","deepSkyBlue")),w3_div("",w3_div("id-wspr-time cl-wspr-text"),w3_div("id-wspr-status cl-wspr-text")),w3_div("",w3_div("cl-wspr-text","BFO "+wspr_bfo),w3_div("id-wspr-cf cl-wspr-text")),w3_div("cl-wspr-text","reporter call "+t),w3_div("id-wspr-rgrid cl-wspr-text","reporter grid "+s)),w3_div("|background-color:lightGray; overflow:auto; width:100%; margin-top:5px; margin-bottom:0px; font-family:monospace; font-size:100%",'<pre style="display:inline"> UTC  dB   dT      Freq dF  Call   Grid    km  dBm</pre>')+w3_div("id-wspr-decode|white-space:pre; background-color:white; overflow:scroll; height:100px; width:100%; margin-top:0px; font-family:monospace; font-size:100%"));ext_panel_show(w,e,null),ext_set_controls_width_height(null,240),time_display_setup("wspr"),(wspr_spectrum_A=w3_el("id-wspr-spectrum-A")).ct=wspr_spectrum_A.getContext("2d"),wspr_spectrum_A.im=wspr_spectrum_A.ct.createImageData(1024,1),(wspr_spectrum_B=w3_el("id-wspr-spectrum-B")).ct=wspr_spectrum_B.getContext("2d"),wspr_spectrum_B.im=wspr_spectrum_B.ct.createImageData(1024,1),wccva=wspr_spectrum_A,wccvao=wspr_spectrum_B,(wspr_scale_canvas=w3_el("id-wspr-scale-canvas")).ct=wspr_scale_canvas.getContext("2d"),wspr_pie_interval=setInterval(wspr_draw_pie,1e3),wspr_draw_pie(),wspr_draw_scale(100),wspr_reset(),wspr_upload_timeout=setTimeout(function(){wspr_upload(wspr_report_e.STATUS)},1e3);var o=ext_param();o?(o=o.toLowerCase().split(",")).forEach(function(r,e){if(0==e&&isDefined(wspr_freqs_s[r])){var t=wspr_freqs_s[r],s=wspr_center_freqs[t];s>=_.lo_kHz&&s<=_.hi_kHz&&wspr_band_select_cb("wspr_init_band",t,!1)}else r.startsWith("stack")?wspr.stack_decoder=1:r.startsWith("debug")?wspr.debug=1:r.startsWith("noupload")?(wspr.no_upload=1,wspr_set_upload_cb(!1)):console.log("WSPR unknown URL param <"+r+">")}):-1!=wspr_init_band&&wspr_freq(wspr_init_band)}function wspr_help(r){return console.log("wspr_help show="+r),!1}function wspr_band_select_cb(r,e,t){-1==(e=+e)||t||(w3_set_value(r,e),wspr_init_band=e,wspr_freq(e))}function wspr_focus(){}function wspr_blur(){ext_send("SET capture=0"),kiwi_clearTimeout(wspr_upload_timeout),kiwi_clearInterval(wspr_pie_interval)}function wspr_input_grid_cb(r,e,t){e=e.trim(),w3_string_set_cfg_cb(r,e),kiwi.WSPR_rgrid=e}var wspr_autorun_u=["regular use","LF","MF","160m","80m_JA","80m","60m","60m_EU","40m","30m","20m","17m","15m","12m","10m","6m","4m","2m","440","1296","ISM_6","ISM_13"];function wspr_config_html(){var r=w3_div("w3-show-inline-block",w3_col_percent("w3-container w3-restart/w3-margin-bottom",w3_input_get("","BFO Hz (multiple of 375 Hz)","WSPR.BFO","w3_num_set_cfg_cb","","typically 750 Hz"),30,""),w3_col_percent("w3-container w3-restart/w3-margin-bottom",w3_input_get("","Reporter callsign","WSPR.callsign","w3_string_set_cfg_cb",""),30,""),w3_col_percent("w3-container/w3-margin-bottom",w3_input_get("",w3_label("w3-bold","Reporter grid square ")+w3_div("id-wspr-grid-set cl-admin-check w3-blue w3-btn w3-round-large w3-hide","set from GPS"),"WSPR.grid","wspr_input_grid_cb","","4 or 6-character grid square location"),30,"",5,w3_divs("w3-center w3-tspace-8",w3_div("","<b>Update grid continuously from GPS?</b>"),w3_switch("","Yes","No","cfg.WSPR.GPS_update_grid",cfg.WSPR.GPS_update_grid,"admin_radio_YN_cb"),w3_text("w3-text-black w3-center","Useful for Kiwis in motion <br> (e.g. marine mobile)")),35,"",5,w3_divs("w3-center w3-tspace-8",w3_div("","<b>Log decodes to syslog?</b>"),w3_switch("","Yes","No","cfg.WSPR.syslog",cfg.WSPR.syslog,"admin_radio_YN_cb"),w3_text("w3-text-black w3-center","Use with care as over time <br> filesystem can fill up."))),"<hr>",w3_div("w3-container",w3_div("","<b>Autorun</b>"),w3_div("w3-container",w3_div("w3-text-black",'On startup automatically begins running the WSPR decoder on the selected band(s).<br>Channels available for regular use are reduced by one for each WSPR autorun enabled.<br>If Kiwi has been configured for a mix of channels with and without waterfalls then channels without waterfalls will be used first.<br><br>Spot decodes are available in the Kiwi log (use "Log" tab above) and are listed on <a href="http://wsprnet.org/drupal/wsprnet/spots" target="_blank">wsprnet.org</a><br>The "Reporter" fields above must be set to valid values for proper spot entry into the <a href="http://wsprnet.org/drupal/wsprnet/spots" target="_blank">wsprnet.org</a> database.'),w3_button("id-wspr-restart w3-margin-T-16 w3-aqua w3-hide","autorun restart","wspr_autorun_restart_cb"),w3_div("id-wspr-admin-autorun w3-margin-T-16"))));ext_config_html(wspr,"WSPR","WSPR","WSPR configuration",r),r="";for(var e=0;e<rx_chans;){for(var t="",s=0;s<8&&e<rx_chans;s++,e++)t+=w3_select_get_param("w3-margin-right","Autorun "+e,"WSPR band","WSPR.autorun"+e,wspr_autorun_u,"wspr_autorun_select_cb");r+=w3_inline("w3-inline w3-margin-bottom/",t)}w3_innerHTML("id-wspr-admin-autorun",r)}function wspr_autorun_restart_cb(){w3_hide("id-wspr-restart"),ext_send("ADM wspr_autorun_restart")}function wspr_autorun_select_cb(r,e,t){if(admin_select_cb(r,e,t),!t){w3_show("id-wspr-restart");var s=w3_el("id-kiwi-container");s.scrollTop=s.scrollHeight}}function wspr_config_focus(){wspr_check_GPS_update_grid(),wspr.focus_interval=setInterval(function(){wspr_check_GPS_update_grid()},1e4);var r=w3_el("id-wspr-grid-set");r&&(r.onclick=function(){wspr.single_shot_update=!0,ext_send("ADM wspr_gps_info")})}function wspr_config_blur(){kiwi_clearInterval(wspr.focus_interval)}function wspr_check_GPS_update_grid(){w3_get_value("WSPR.grid")!=kiwi.WSPR_rgrid&&(w3_set_value("WSPR.grid",kiwi.WSPR_rgrid),w3_input_change("WSPR.grid")),kiwi.GPS_fixes&&w3_show_inline_block("id-wspr-grid-set"),wspr.single_shot_update=!1}function wspr_gps_info_cb(r){if(cfg.WSPR.GPS_update_grid||wspr.single_shot_update){var e=kiwi_JSON_parse("wspr_gps_info_cb",r);e&&(kiwi.WSPR_rgrid=e.grid,w3_set_value("WSPR.grid",kiwi.WSPR_rgrid),w3_input_change("WSPR.grid","wspr_input_grid_cb")),wspr.single_shot_update=!1}}var wspr_upload_timeout,wspr_pie_interval,wspr_stop_start_state=0;function wspr_stop_start_cb(r,e,t){0==wspr_stop_start_state?wspr_reset():-1!=wspr_init_band&&wspr_freq(wspr_init_band),wspr_stop_start_state^=1,w3_button_text(r,wspr_stop_start_state?"start":"stop")}function wspr_reset(){ext_send("SET capture=0"),wspr_set_status(wspr_status.IDLE),wspr_set_upload_cb(!0)}function wspr_clear_cb(r,e,t){wspr_reset(),html("id-wspr-decode").innerHTML="",html("id-wspr-peaks-labels").innerHTML=""}function wspr_draw_scale(r){wspr_scale_canvas.ct.fillStyle="black",wspr_scale_canvas.ct.fillRect(0,0,wspr_scale_canvas.width,wspr_scale_canvas.height);wspr_scale_canvas.ct.fillStyle="lime";var e,t=Math.round(512/375*50),s=Math.round(512/375*200);for(wspr_scale_canvas.ct.fillRect(wspr_startx+2*t,2,2*s,3),wspr_scale_canvas.ct.fillStyle="red",t=Math.round(512/375*150),wspr_scale_canvas.ct.fillRect(wspr_startx+2*t-2,2,5,3),wspr_scale_canvas.ct.fillStyle="white",wspr_scale_canvas.ct.font="10px Verdana",e=-150;e<=150;e+=50){var _=Math.round((e+150)*(512/375)),a=e+r;a<0&&(a+=1e3);var i=a<10?4:a<100?7:11;wspr_scale_canvas.ct.fillText(a.toFixed(0),wspr_startx+2*_-i,17)}}function wspr_set_upload_cb(r){deleteCookie("wspr_upload"),wspr_config_okay&&!wspr.no_upload||(r=!1),w3_checkbox_set("id-wspr-upload",r),w3_color("id-wspr-upload-bkg",r?"white":"black",r?"inherit":"yellow")}function wspr_upload(r,e){var t=r==wspr_report_e.SPOT?1:0,s=ext_get_cfg_param_string("WSPR.callsign",""),_=kiwi.WSPR_rgrid?kiwi.WSPR_rgrid:cfg.WSPR.grid;if(wspr_rfreq&&wspr_tfreq&&null!=s&&null!=_&&null!=s&&null!=_&&""!=s&&""!=_&&0!=html("id-wspr-upload").checked){var a,i,p;t&&(a=e.replace(/[\s]+/g," ").split(" "));var w=kiwi_GETrequest(t?"spot":"stat","http://wsprnet.org/post");if(kiwi_GETrequest_param(w,"function",t?"wspr":"wsprstat"),kiwi_GETrequest_param(w,"rcall",s),kiwi_GETrequest_param(w,"rgrid",_),kiwi_GETrequest_param(w,"rqrg",wspr_rfreq.toFixed(6)),t){var o=new Date;kiwi_GETrequest_param(w,"date",o.getUTCFullYear().toString().substr(2,2)+(o.getUTCMonth()+1).leadingZeros(2)+o.getUTCDate().leadingZeros(2)),kiwi_GETrequest_param(w,"time",a[0]),kiwi_GETrequest_param(w,"sig",a[1]),kiwi_GETrequest_param(w,"dt",a[2]),kiwi_GETrequest_param(w,"drift",a[4]),i=a[3],p=a[7]}else kiwi_GETrequest_param(w,"tpct","0"),i=wspr_tfreq.toFixed(6),p="0";kiwi_GETrequest_param(w,"tqrg",i),t&&(kiwi_GETrequest_param(w,"tcall",a[5]),kiwi_GETrequest_param(w,"tgrid","no_grid"!=a[6]?a[6]:"")),kiwi_GETrequest_param(w,"dbm",p);if("1.3 Kiwi".length<=10){kiwi_GETrequest_param(w,"version","1.3 Kiwi"),kiwi_GETrequest_submit(w,{gc:kiwi_gc_wspr});var n=new Date;console.log("WSPR "+(t?"SPOT":"STAT")+" "+n.toUTCString()+(t?" <"+e+">":""))}t||(wspr_upload_timeout=setTimeout(function(){wspr_upload(wspr_report_e.STATUS)},36e4))}else wspr_upload_timeout=setTimeout(function(){wspr_upload(wspr_report_e.STATUS)},6e4)}var wspr_cur_status=0,wspr_status={NONE:0,IDLE:1,SYNC:2,RUNNING:3,DECODING:4},wspr_status_text={0:"none",1:"idle",2:"sync",3:"running",4:"decoding"},wspr_status_color={0:"white",1:"lightSkyBlue",2:"violet",3:"cyan",4:"lime"};function wspr_set_status(r){var e=html("id-wspr-status");e.innerHTML=wspr_status_text[r],e.style.backgroundColor=wspr_status_color[r],wspr_cur_status=r}var wspr_server_time_ms=0,wspr_local_time_epoch_ms=0;function wspr_draw_pie(){var r=new Date(wspr_server_time_ms+(Date.now()-wspr_local_time_epoch_ms));html("id-wspr-time").innerHTML=r.toUTCString().substr(17,8)+" UTC";var e=60*(1&r.getUTCMinutes())+r.getUTCSeconds()+1;kiwi_draw_pie("id-wspr-pie",wspr.pie_size,e/120);var t=kiwi.WSPR_rgrid?kiwi.WSPR_rgrid:cfg.WSPR.grid;w3_innerHTML("id-wspr-rgrid","reporter grid<br>"+t+(cfg.WSPR.GPS_update_grid?" (GPS)":""))}var wspr_center_freqs=[137.5,475.7,1838.1,3570.1,3594.1,5288.7,5366.2,7040.1,10140.2,14097.1,18106.1,21096.1,24926.1,28126.1,6781.5,13554.5],wspr_freqs_s={lf:0,mf:1,"160m":2,"80m_ja":3,"80m":4,"60m":5,"60m_eu":6,"40m":7,"30m":8,"20m":9,"17m":10,"15m":11,"12m":12,"10m":13,ISM_6:14,ISM_13:15},wspr_freqs_m=["LF","MF","160m","80m_JA","80m","60m","60m_EU","40m","30m","20m","17m","15m","12m","10m","ISM_6","ISM_13"],wspr_xvtr_center_freqs=[50294.5,70092.5,144490.5,432301.5,1296501.5],wspr_xvtr_freqs_s=["6m","4m","2m","440","1296"],wspr_rfreq=0,wspr_tfreq=0,wspr_bfo=750,wspr_filter_bw=300;function wspr_freq(r){var e=wspr_center_freqs[r];wspr_reset(),w3_el("id-wspr-cf").innerHTML="CF "+e.toFixed(1);var t=Math.round(1e3*(e-Math.floor(e)));wspr_rfreq=wspr_tfreq=e/1e3;var s=e-wspr_bfo/1e3,_=s-ext_get_freq_range().offset_kHz;ext_tune(_,"usb",ext_zoom.MAX_IN),ext_send("SET dialfreq="+s.toFixed(2)+" cf_offset="+t),ext_set_passband(wspr_bfo-wspr_filter_bw/2,wspr_bfo+wspr_filter_bw/2),ext_tune(_,"usb",ext_zoom.MAX_IN),ext_send("SET capture=1"),wspr_draw_scale(t),kiwi_clearTimeout(wspr_upload_timeout),wspr_upload_timeout=setTimeout(function(){wspr_upload(wspr_report_e.STATUS)},1e3)}


