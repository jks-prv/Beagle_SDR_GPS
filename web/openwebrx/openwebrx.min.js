

/* web/openwebrx/openwebrx.min.js (web/openwebrx/openwebrx.js = Fri Jul 22 09:11:24 2022) */
var bandwidth,center_freq,wf_fft_size,cur_mode,wf_fps,wf_fps_max,ws_snd,ws_wf,owrx={debug_drag:!1,height_top_bar_parts:67,hide_bars:0,HIDE_TOPBAR:1,HIDE_BANDBAR:2,HIDE_ALLBARS:3,cfg_loaded:!1,mobile:null,wf_snap:0,wf_cursor:"crosshair",last_pageX:0,last_pageY:0,mouse_freq:{},freq_memory:[],freq_memory_menu_shown:0,override_fmem:null,vfo_ab:0,vfo_first:!0,last_freq:-1,last_mode:"",last_locut:-1,last_hicut:-1,last_lo:[],last_hi:[],last_selected_band:0,last_mode_el:null,dseq:0,sMeter_dBm_biased:0,sMeter_dBm:0,smeter_interval:null,force_no_agc_thresh_smeter:!1,overload_mute:90,squelched_overload:!1,prev_squelched_overload:!1,touch_hold_pressed:!1,tuning_locked:0,dx_click_gid_last:void 0,sam_pll:1,sam_pll_s:["DX","med","fast"],chan_null:0,chan_null_s:["normal","null LSB","null USB"],ovld_mute:0,ovld_mute_s:["off","on"],FSET_NOP:0,FSET_ADD:1,FSET_SET_FREQ:2,FSET_EXT_SET_PB:3,FSET_PB_CHANGE:4,FSET_SCALE_DRAG:5,FSET_SCALE_DRAG_END:6,FSET_SCALE_MOUSE_CLICK:7,FSET_SCALE_TOUCH_DRAG:8,FSET_SCALE_TOUCH_DRAG_END:9,fset_s:["nop","add","fset","extSetPB","pbChg","drag","dragEnd","mouseClick","touchDrag","touchClick"],scale_canvas:{mouse_out:!1,target:null,restore_visibility:[],restore_visibility_delay:500},canvas:{target:null,restore_visibility:[],restore_visibility_delay:500},__last:0},spectrum_show=0,spectrum_param=-1,gen_freq=0,gen_attn=0,squelch_threshold=0,wf_rate="",wf_mm="",wf_compression=1,wf_interp=13,wf_winf=2,debug_v=0,sb_trace=0,kiwi_gc=1,kiwi_gc_snd=0,kiwi_gc_wf=-1,kiwi_gc_recv=-1,kiwi_gc_wspr=-1,override_ext=null,muted_initially=0,peak_initially=null,param_nocache=!1,nocache=!1,param_ctrace=!1,ctrace=!1,no_clk_corr=!1,override_pbw="",override_pbc="",nb_click=!1,no_geoloc=!1,force_mobile=!1,mobile_laptop_test=!1,user_url=null,wf_rates={0:0,off:0,1:1,"1hz":1,s:2,slow:2,m:3,med:3,f:4,fast:4},okay_wf_init=!1;function kiwi_main(){w3_do_when_cond(function(){return owrx.cfg_loaded},function(){kiwi_main_ready()},0,200)}function kiwi_main_ready(){override_freq=parseFloat(readCookie("last_freq")),override_mode=readCookie("last_mode"),override_zoom=parseFloat(readCookie("last_zoom")),override_9_10=parseFloat(readCookie("last_9_10")),override_max_dB=parseFloat(readCookie("last_max_dB")),override_min_dB=parseFloat(readCookie("last_min_dB")),setvolume(!0,readCookie("last_volume",50)),console.log("LAST f="+override_freq+" m="+override_mode+" z="+override_zoom+" 9_10="+override_9_10+" min="+override_min_dB+" max="+override_max_dB);console.log("URL: "+window.location.href);var e=window.location.search&&window.location.search.substr(1),t=[],a=[];for(w=1;w<=16;w++){var _="&win"+(w+1)+"&";t[w]=e&&e.split(_)[0],e=e&&e.split(_)[1],a[w]=function(e){var t={};return e&&e.split("&").forEach(function(e){e=e.split("=");t[e[0]]=e[1]||1}),t}(t[w]),a[w].WID=w}var i=window.location.href.split("?")[0];for(g_qs_idx=2,w=2;w<=16;w++)t[w]&&setTimeout(function(){var e=i+"?"+t[g_qs_idx];g_qs_idx++,null==window.open(e,"_blank")&&alert("Do you have popups blocked for this site? "+e)},2e3*(w-1));var o,n="f";(e=a[1])[n]&&((o=parse_freq_pb_mode_zoom(e[n]))[1]&&(override_freq=o[1].replace(",",".").parseFloatWithUnits("M",.001)),o[1]&&console.log("p="+o[1]+" override_freq="+override_freq),o[2]&&console.log("override_pbw/pbc="+o[2]),o[2]&&"/"==o[2].charAt(0)&&(override_pbw=o[2].substr(1)),o[2]&&":"==o[2].charAt(0)&&(override_pbc=o[2].substr(1)),o[3]&&(override_mode=o[3].toLowerCase()),o[4]&&(override_zoom=+o[4])),e[n="ext"]&&isString(e[n])&&(o=e[n].split(","),override_ext=o[0],extint.param=o.slice(1).join(","),console.log("URL: ext="+override_ext+" ext_p="+extint.param)),e[n="pbw"]&&(override_pbw=e[n]),e[n="pb"]&&(override_pbw=e[n]),e[n="pbc"]&&(override_pbc=e[n]),e[n="z"]&&(override_zoom=+e[n]),e[n="sp"]&&(spectrum_show=e[n]),e[n="spec"]&&(spectrum_show=e[n]),e[n="spp"]&&(spectrum_param=parseFloat(e[n])),e[n="vol"]&&setvolume(!0,parseInt(e[n])),e[n="mute"]&&(muted_initially=parseInt(e[n])),e[n="wf"]&&(wf_rate=e[n]),e[n="wfm"]&&(wf_mm=e[n]),e[n="cmap"]&&(wf.cmap_override=w3_clamp(parseInt(e[n]),0,kiwi.cmap_s.length-1,0)),e[n="sqrt"]&&(wf.sqrt=w3_clamp(parseInt(e[n]),0,4,0)),e[n="wfts"]&&(wf.url_tstamp=w3_clamp(parseInt(e[n]),2,3600,2)),e[n="peak"]&&(peak_initially=parseInt(e[n])),e[n="no_geo"]&&(no_geoloc=!0),e[n="keys"]&&(shortcut.keys=isNonEmptyString(e[n])?e[n].split(""):null),e[n="user"]&&(user_url=e[n]),e[n="u"]&&(user_url=e[n]),e[n="m"]&&(force_mobile=!0),e[n="mobile"]&&(force_mobile=!0),e[n="mem"]&&(owrx.override_fmem=e[n]),e[n="sqth"]&&(squelch_threshold=parseFloat(e[n])),e[n="click"]&&(nb_click=!0),e[n="nocache"]&&(param_nocache=!0,nocache=parseInt(e[n])),e[n="ncc"]&&(no_clk_corr=parseInt(e[n])),e[n="wfdly"]&&(waterfall_delay=parseFloat(e[n])),e[n="wf_comp"]&&(wf_compression=parseInt(e[n])),e[n="wfi"]&&(wf_interp=parseInt(e[n])),e[n="wfw"]&&(wf_winf=parseInt(e[n])),e[n="gen"]&&(gen_freq=e[n].parseFloatWithUnits("kM",.001)),e[n="attn"]&&(gen_attn=Math.abs(parseInt(e[n]))),e[n="blen"]&&(audio_buffer_min_length_sec=parseFloat(e[n])/1e3),e[n="audio"]&&(audio_meas_dly_ena=parseFloat(e[n])),e[n="gc"]&&(kiwi_gc=parseInt(e[n])),e[n="gc_snd"]&&(kiwi_gc_snd=parseInt(e[n])),e[n="gc_wf"]&&(kiwi_gc_wf=parseInt(e[n])),e[n="gc_recv"]&&(kiwi_gc_recv=parseInt(e[n])),e[n="gc_wspr"]&&(kiwi_gc_wspr=parseInt(e[n])),e[n="ctrace"]&&(param_ctrace=!0,ctrace=parseInt(e[n])),e[n="tmobile"]&&(mobile_laptop_test=!0),e[n="v"]&&console.log("URL: debug_v = "+(debug_v=e[n])),-1==kiwi_gc_snd&&(kiwi_gc_snd=kiwi_gc),-1==kiwi_gc_wf&&(kiwi_gc_wf=kiwi_gc),-1==kiwi_gc_recv&&(kiwi_gc_recv=kiwi_gc),-1==kiwi_gc_wspr&&(kiwi_gc_wspr=kiwi_gc),console.log("GC: snd="+kiwi_gc_snd+" wf="+kiwi_gc_wf+" recv="+kiwi_gc_recv+" wspr="+kiwi_gc_wspr),""!=wf_mm&&(wf_mm=wf_mm.split(","),s=parseInt(wf_mm[0]),!isNaN(s)&&-190<=s&&s<=-30&&(override_min_dB=s),2<=wf_mm.length&&(s=parseInt(wf_mm[1]),!isNaN(s)&&-100<=s&&s<=20&&(override_max_dB=s))),kiwi_get_init_settings(),no_geoloc||kiwi_geolocate(),freq_memory_init(),init_top_bar(),init_rx_photo(),right_click_menu_init(),freq_memory_menu_init(),keyboard_shortcut_init(),confirmation_panel_init(),ext_panel_init(),place_panels(),init_panels(),okay_wf_init=!0,confirmation_panel_init2(),smeter_init(),time_display_setup("id-topbar-right-container"),window.setInterval(send_keepalive,5e3),window.addEventListener("resize",openwebrx_resize),param_nocache&&console.log("### nocache="+(nocache?1:0)),param_ctrace&&console.log("### ctrace="+(ctrace?1:0)),snd_send("SERVER DE CLIENT openwebrx.js SND"),snd_send("SET dbug_v="+debug_v),w3_do_when_cond(function(){return isArg(rx_chan)&&owrx.cfg_loaded},function(){var e;0==rx_chan&&(0!=gen_attn&&(e=gen_attn+cfg.waterfall_cal,e=Math.pow(10,-e/20),gen_attn=131071*e),set_gen(gen_freq,gen_attn))},0,500);n=cfg.passbands[init_mode].lo;isNumber(n)||(n=-4e3);var s=cfg.passbands[init_mode].hi;isNumber(s)||(s=4e3),snd_send("SET mod="+init_mode+" low_cut="+n+" high_cut="+s+" freq="+init_frequency),set_agc(),snd_send("SET browser="+navigator.userAgent),wf_send("SERVER DE CLIENT openwebrx.js W/F"),wf_send("SET send_dB=1"),wf_send("SET zoom=0 start=0"),wf_send("SET maxdb=0 mindb=-100"),0==wf_compression&&wf_send("SET wf_comp=0"),0!=wf_interp&&wf_send("SET interp="+wf_interp),0!=wf_winf&&wf_send("SET window_func="+wf_winf),wf_send("SET wf_speed="+(wf_speed=null==(wf_speed=wf_rates[wf_rate])?WF_SPEED_FAST:wf_speed))}var ptype={HIDE:0,POPUP:1,TOGGLE:2},popt={CLOSE:-1,PERSIST:0},visBorder=10,visIcon=24,readme_color="blueViolet",show_news=!1,news_color="#ff00bf";function init_panels(){init_panel_toggle(ptype.TOGGLE,"id-control",!1,popt.PERSIST);var e=updateCookie("readme","seen2");kiwi_isMobile()&&(e=!1),init_panel_toggle(ptype.TOGGLE,"id-readme",!1,e?popt.PERSIST:popt.CLOSE,readme_color);e=null==readCookie("news","seen");init_panel_toggle(ptype.POPUP,"id-news",!1,show_news&&e?popt.PERSIST:popt.CLOSE),init_panel_toggle(ptype.POPUP,"id-ext-controls",!1,popt.CLOSE),init_panel_toggle(ptype.POPUP,"id-confirmation",!1,popt.CLOSE)}function init_panel_toggle(e,t,a,_,i){var o=w3_el(t);o.ptype=e;var n=w3_el(t+"-vis");o.scrollable=1==a;var s=o.scrollable?-kiwi_scrollbar_width():visBorder,r="right"==o.getAttribute("data-panel-pos");o.panelShown=1,e==ptype.TOGGLE?(a=r?"right":"left",l=r?"left":"right",n.innerHTML='<a id="'+t+'-hide" onclick="toggle_panel('+sq(t)+');"><img src="icons/hide'+a+'.24.png" width="24" height="24" /></a><a id="'+t+'-show" class="class-vis-show" onclick="toggle_panel('+sq(t)+');"><img src="icons/hide'+l+'.24.png" width="24" height="24" /></a>'):n.innerHTML='<a id="'+t+'-close" onclick="toggle_panel('+sq(t)+');"><img id='+dq(t+"-close-img")+' src="icons/close.24.png" width="24" height="24" /></a>';var l=o.activeWidth-visIcon;r?n.style.right=px(0):n.style.left=px(l+s),n.style.top=px(visBorder),null!=_&&(0<_?setTimeout(function(){toggle_panel(t)},_):_==popt.CLOSE?toggle_panel(t):e==ptype.POPUP&&(o.style.visibility="visible")),null==i||null!=(e=w3_el(t+"-show"))&&(e.style.backgroundColor=e.style.borderColor=i),o.init=!0}function toggle_panel(e,t){var a=w3_el(e),_=w3_el(e+"-vis");if(isDefined(t)&&(a.panelShown=1^t),a.ptype==ptype.POPUP)return a.style.visibility=a.panelShown?"hidden":"visible",a.panelShown^=1,updateCookie(e,"seen"),void freqset_select();var i=a.activeWidth+30,t="right"==a.getAttribute("data-panel-pos"),i=-i,i=a.panelShown?(o=0,i):(o=i,kiwi_isMobile()?0:kiwi_scrollbar_width());"id-control"==e&&1==a.panel_isScaled&&a.panelShown&&mobile_scale_control_panel(null,!1),animate(a,t?"right":"left","px",o,i,.93,kiwi_isMobile()?1:1e3,60,0),w3_hide(e+"-"+(a.panelShown?"hide":"show")),w3_show_block(e+"-"+(a.panelShown?"show":"hide")),a.panelShown^=1;var o=a.activeWidth-visIcon,i=a.scrollable?-kiwi_scrollbar_width():visBorder;console.log("toggle_panel "+e+" right="+t+" shown="+a.panelShown),t?_.style.right=px(a.panelShown?0:o+visIcon+2*visBorder):_.style.left=px(o+(a.panelShown?i:visIcon+2*visBorder)),"id-control"==e&&1==a.panel_isScaled&&a.panelShown&&mobile_scale_control_panel(null,!0),freqset_select()}function openwebrx_resize(e){e=isString(e)&&e.startsWith("orient")?e:"event",resize_wf_canvases(),resize_waterfall_container(!0),extint_environment_changed({resize:1,passband_screen_location:1}),resize_scale(e),check_top_bar_congestion()}var p_left,p_owner,p_mid,p_right,offsetDiff_init=!1;function offsetDiff(e,t,a,_){var i=w3_el("id-tbar-"+e.toLowerCase()+"-bbox");i.style.left=px(a.x1),i.style.width=px(a.w),i.style.height=px(a.h),i.style.backgroundColor=t,console.log(e+" L/R/W="+a.x1+"/"+a.x2+"/"+a.w+" ("+(_.x1-a.x1)+"/"+(_.x2-a.x2)+"/"+(_.w-a.w)+")")}function check_top_bar_congestion(){var e=w3_boundingBox_children("id-left-info-container"),t=w3_boundingBox_children("id-mid-owner-container"),a=w3_boundingBox_children("id-mid-info-container"),_=w3_boundingBox_children("id-topbar-right-container"),i=e.x2+(a.x1-e.x2)/2-t.w/2;w3_el("id-owner-info").style.left=px(i),t=w3_boundingBox_children("id-mid-owner-container"),w3_visible("id-mid-owner-container",t.x1>=e.x2),w3_visible("id-mid-info-container",a.x1>=e.x2),w3_visible("id-topbar-right-container",_.x1>=e.x2),w3_el("id-rx-details-arrow").style.left=px(e.x2)}function init_top_bar(){w3_append_innerHTML("id-rx-desc",w3_link("id-rx-gmap","","[map]","","dont_toggle_rx_photo")+w3_div("id-rx-snr w3-show-inline"))}var rx_photo_spacer_height=owrx.height_top_bar_parts;function init_rx_photo(){w3_el("id-top-photo-img").style.paddingLeft=RX_PHOTO_LEFT_MARGIN?"50px":0,RX_PHOTO_HEIGHT+=rx_photo_spacer_height,w3_el("id-top-photo-clip").style.maxHeight=px(RX_PHOTO_HEIGHT),dbgUs||kiwi_isMobile()?close_rx_photo():window.setTimeout(function(){close_rx_photo()},3e3)}var scale_ctx,band_ctx,dx_ctx,pb_adj_cf,pb_adj_cf_ttip,pb_adj_lo,pb_adj_lo_ttip,pb_adj_hi,pb_adj_hi_ttip,pb_adj_car,pb_adj_car_ttip,scale_canvas,band_canvas,dx_div,dx_canvas,rx_photo_state=1;function open_rx_photo(){rx_photo_state=1,html("id-rx-photo-desc").style.opacity=1,html("id-rx-photo-title").style.opacity=1,animate_to(html("id-top-photo-clip"),"maxHeight","px",RX_PHOTO_HEIGHT,.93,kiwi_isMobile()?1:1e3,60,function(){resize_waterfall_container(!0)}),w3_hide("id-rx-details-arrow-down"),w3_show_block("id-rx-details-arrow-up")}function close_rx_photo(){rx_photo_state=0,animate_to(html("id-top-photo-clip"),"maxHeight","px",rx_photo_spacer_height,.93,kiwi_isMobile()?1:1e3,60,function(){resize_waterfall_container(!0)}),w3_show_block("id-rx-details-arrow-down"),w3_hide("id-rx-details-arrow-up")}function dont_toggle_rx_photo(){dont_toggle_rx_photo_flag=1}function toggle_rx_photo(){dont_toggle_rx_photo_flag?dont_toggle_rx_photo_flag=0:((rx_photo_state?close_rx_photo:open_rx_photo)(),freqset_select())}function animate(e,t,a,_,i,o,n,s,r){isUndefined(r)&&(r=0),e.style[t]=_.toString()+a,e.anim_i=0,n_of_iters=n/(1e3/s),n_of_iters<1&&(n_of_iters=1),change=(i-_)/n_of_iters,isDefined(e.anim_timer)&&window.clearInterval(e.anim_timer),e.anim_timer=window.setInterval(function(){e.anim_i++<n_of_iters?1==o?e.style[t]=(parseFloat(e.style[t])+change).toString()+a:(remain=parseFloat(e.style[t])-i,new_val=9<Math.abs(remain)||"px"!=a?i+o*remain:Math.abs(remain)<2?i:i+remain-remain/Math.abs(remain),e.style[t]=new_val.toString()+a):(e.style[t]=i.toString()+a,window.clearInterval(e.anim_timer),delete e.anim_timer),0!=r&&r()},1e3/s)}function animate_to(e,t,a,_,i,o,n,s){from=parseFloat(style_value(e,t)),animate(e,t,a,from,_,i,o,n,s)}function style_value(e,t){return(e.currentStyle||(window.getComputedStyle?document.defaultView.getComputedStyle(e,null):e.style))[t]}function demodulators_get_next_color(){return demodulator_color_index>=demodulator_colors.length&&(demodulator_color_index=0),demodulator_colors[demodulator_color_index++]}function demod_envelope_draw(e,t,a,_,i){isUndefined(_)&&(_="lime");var o=scale_px_from_freq(t,e),t=scale_px_from_freq(a,e);t<o&&(a=t,t=o,o=a),pb_adj_cf.style.left=px(o+20),pb_adj_cf.style.width=px(Math.max(0,t-o-40)),pb_adj_lo.style.left=px(o-10-20),pb_adj_lo.style.width=px(50),pb_adj_hi.style.left=px(t-20),pb_adj_hi.style.width=px(50),o-=10,t+=10,scale_ctx.lineWidth=3,scale_ctx.strokeStyle=_,scale_ctx.fillStyle=_;_={envelope_on_screen:!1,line_on_screen:!1,allow_pb_adj:!1};return t<0||o>window.innerWidth||(_.beginning={x1:o-20,x2:o+10+20},_.ending={x1:t-10-20,x2:t+20},_.whole_envelope={x1:o,x2:t},_.envelope_on_screen=!0,_.allow_pb_adj=50<=t-o,_.allow_pb_adj||(scale_ctx.strokeStyle=scale_ctx.fillStyle="yellow"),scale_ctx.beginPath(),scale_ctx.moveTo(o,17),scale_ctx.lineTo(o+5,17),scale_ctx.lineTo(o+10,5),scale_ctx.lineTo(t-5-5,5),scale_ctx.lineTo(t-5,17),scale_ctx.lineTo(t,17),scale_ctx.globalAlpha=.3,scale_ctx.fill(),scale_ctx.globalAlpha=1,scale_ctx.stroke()),isDefined(i)&&(line_px=scale_px_from_freq(i,e),line_px<0||line_px>window.innerWidth||(_.line={x1:line_px-4,x2:line_px+4},_.line_on_screen=!0,scale_ctx.moveTo(line_px,18),scale_ctx.lineTo(line_px,4),scale_ctx.stroke(),pb_adj_car.style.left=px(_.line.x1),pb_adj_car.style.width=px(8))),_}function demod_envelope_where_clicked(e,a,t,_){if(in_range=function(e,t){return t.x1<=e&&t.x2>=e&&a<scale_canvas_h/2},dr=demodulator.draggable_ranges,_.shiftKey){if(t.line_on_screen&&in_range(e,t.line))return dr.bfo;if(t.envelope_on_screen&&in_range(e,t.whole_envelope))return dr.pbs}if(_.altKey){if(t.envelope_on_screen&&in_range(e,t.beginning))return dr.bwlo;if(t.envelope_on_screen&&in_range(e,t.ending))return dr.bwhi}if(t.envelope_on_screen){if(t.allow_pb_adj){if(in_range(e,t.beginning))return dr.beginning;if(in_range(e,t.ending))return dr.ending}if(in_range(e,t.whole_envelope))return dr.anything_else}return dr.none}function demodulator_default_analog(e,t,a,_){null==cfg.passbands[t]&&(t="am"),demodulator.call(this,e),this.subtype=t,this.envelope.dragged_range=demodulator.draggable_ranges.none;e=audio_input_rate?audio_input_rate/2:5e3;this.filter={min_passband:4,high_cut_limit:e,low_cut_limit:-e},this.server_mode=t;isNaN(a)&&(a=owrx.last_lo[t],isNaN(a)&&(a=cfg.passbands[t].lo)),owrx.last_lo[t]=a;var i,o,n,s,r,_=_;switch(isNaN(_)&&(_=owrx.last_hi[t],isNaN(_)&&(_=cfg.passbands[t].hi)),owrx.last_hi[t]=_,""!=override_pbw&&(i=a+(_-a)/2,o=this.filter.min_passband,n=(override_pbw=decodeURIComponent(override_pbw)).split(","),console.log("p.len="+n.length),s=n[0].parseFloatWithUnits("k"),console.log('nlo="'+n[0]+'" '+s),r=NaN,1<n.length&&(r=n[1].parseFloatWithUnits("k"),console.log('nhi="'+n[1]+'" '+s)),1==n.length&&!isNaN(s)&&o<=s?(a=i-s/2,_=i+s/2):2==n.length&&!isNaN(s)&&!isNaN(r)&&s<r&&o<=r-s&&(a=s,_=r),override_pbw="",extint.override_pb=!0),""!=override_pbc&&(i=(_-a)/2,o=this.filter.min_passband,s=(n=(override_pbc=decodeURIComponent(override_pbc)).split(","))[0].parseFloatWithUnits("k"),console.log("pbc="+dq(n[0])+" "+s),r=NaN,1<n.length&&(r=n[1].parseFloatWithUnits("k"),console.log("pbw="+dq(n[1])+" "+r)),1!=n.length||isNaN(s)?2==n.length&&!isNaN(s)&&!isNaN(r)&&o<=r&&(a=s-r/2,_=s+r/2):(a=s-i,_=s+i),override_pbc="",extint.override_pb=!0),this.low_cut=Math.max(a,this.filter.low_cut_limit),this.high_cut=Math.min(_,this.filter.high_cut_limit),this.usePBCenter=!1,this.isCW=!1,t){case"am":case"amn":case"sam":case"sal":case"sau":case"sas":case"qam":case"drm":case"nbfm":case"iq":break;case"lsb":case"lsn":case"usb":case"usn":this.usePBCenter=!0;break;case"cw":case"cwn":this.usePBCenter=!0,this.isCW=!0;break;default:console.log("DEMOD-new: unknown subtype="+t)}this.wait_for_timer=!1,this.set_after=!1,this.set=function(){this.wait_for_timer?this.set_after=!0:(this.doset(),this.set_after=!1,this.wait_for_timer=!0,timeout_this=this,window.setTimeout(function(){timeout_this.wait_for_timer=!1,timeout_this.set_after&&timeout_this.set()},demodulator_response_time))},this.doset=function(){var e=(freq_car_Hz/1e3).toFixed(3),t=this.server_mode,a=this.low_cut.toString(),_=this.high_cut.toString();snd_send("SET mod="+t+" low_cut="+a+" high_cut="+_+" freq="+e+("sam"==t?" param="+owrx.chan_null:""));var i=null;e!=owrx.last_freq&&((i=i||{}).freq=1,owrx.last_freq=e),t!=owrx.last_mode&&((i=i||{}).mode=1,owrx.last_mode=t),a==owrx.last_locut&&_==owrx.last_hicut||((i=i||{}).passband=1,owrx.last_locut=a,owrx.last_hicut=_),null!=i&&(i.passband_screen_location=1,extint_environment_changed(i)),muted_until_freq_set&&(toggle_or_set_mute(muted_initially),muted_until_freq_set=!1),audio_meas_dly_ena&&(audio_meas_dly_start=(new Date).getTime())},(this.envelope.parent=this).envelope.draw=function(e){this.visible_range=e,this.drag_ranges=demod_envelope_draw(g_range,center_freq+this.parent.offset_frequency+this.parent.low_cut,center_freq+this.parent.offset_frequency+this.parent.high_cut,this.color,center_freq+this.parent.offset_frequency);e=Math.abs(this.parent.high_cut-this.parent.low_cut);pb_adj_lo_ttip.innerHTML="lo "+this.parent.low_cut.toString()+", bw "+e.toString(),pb_adj_hi_ttip.innerHTML="hi "+this.parent.high_cut.toString()+", bw "+e.toString(),pb_adj_cf_ttip.innerHTML="cf "+(this.parent.low_cut+Math.abs(this.parent.high_cut-this.parent.low_cut)/2).toString()+", bw "+e.toString();e=(center_freq+this.parent.offset_frequency)/1e3+kiwi.freq_offset_kHz;pb_adj_car_ttip.innerHTML=e.toFixed(freq_field_prec(e))+" kHz"},this.envelope.env_drag_start=function(e,t,a){return this.key_modifiers=a,this.dragged_range=demod_envelope_where_clicked(e,t,this.drag_ranges,a),this.drag_origin={x:e,low_cut:this.parent.low_cut,high_cut:this.parent.high_cut,offset_frequency:this.parent.offset_frequency},this.dragged_range!=demodulator.draggable_ranges.none},this.envelope.drag_move=function(e){var t=demodulator.draggable_ranges;if(this.dragged_range==t.none)return!1;freq_change=Math.round(this.visible_range.hpp*(e-this.drag_origin.x));var a=this.dragged_range==t.bfo,_=this.dragged_range==t.beginning,i=this.dragged_range==t.ending,o=this.dragged_range==t.bwlo,n=this.dragged_range==t.bwhi,s=a||this.dragged_range==t.pbs||o||n,e=a||n?-1:1,n=a||o?-1:1,o=this.drag_origin.low_cut,_=_||s;_&&(o+=e*freq_change);e=this.drag_origin.high_cut,s=i||s;if(s&&(e+=n*freq_change),_){if(o<this.parent.filter.low_cut_limit)return!0;if(e-o<this.parent.filter.min_passband)return!0;if(e<=o)return!0}if(s){if(e>this.parent.filter.high_cut_limit)return!0;if(e-o<this.parent.filter.min_passband)return!0;if(e<=o)return!0}if(_&&(owrx.last_lo[this.parent.server_mode]=this.parent.low_cut=o),s&&(owrx.last_hi[this.parent.server_mode]=this.parent.high_cut=e),this.dragged_range==t.anything_else||a){if(new_value=this.drag_origin.offset_frequency+freq_change,new_value>bandwidth/2||new_value<-bandwidth/2)return!0;this.parent.offset_frequency=new_value}return mkenvelopes(this.visible_range),freqset_car_Hz(this.parent.offset_frequency+center_freq),this.parent.set(),freqset_update_ui(owrx.FSET_PB_CHANGE),!0},this.envelope.drag_end=function(e){return to_return=this.dragged_range!=demodulator.draggable_ranges.none,this.dragged_range=demodulator.draggable_ranges.none,to_return}}function mkenvelopes(e){scale_ctx.clearRect(0,0,scale_ctx.canvas.width,22);for(var t=0;t<demodulators.length;t++)demodulators[t].envelope.draw(e)}function demodulator_remove(e){demodulators[e].stop(),demodulators.splice(e,1)}function demodulator_add(e){demodulators.push(e),waterfall_setup_done&&mkenvelopes(get_visible_freq_range())}function demodulator_analog_replace(e,t){null==cfg.passbands[e]&&(e="am");var a,_=0,i=0,o=!1,n=!1,s=!1;demodulators.length?(o=demodulators[0].isCW,_=demodulators[0].offset_frequency,i=passband_offset(),demodulator_remove(0)):(_=(a=Math.round(1e3*(init_frequency-kiwi.freq_offset_kHz)))<=0||bandwidth<a?0:a-center_freq,e=init_mode),demodulator_add(new demodulator_default_analog(_=isArg(t)?t-center_freq:_,e,NaN,NaN)),!o&&demodulators[0].isCW&&(n=!0),o&&!demodulators[0].isCW&&(s=!0),isArg(t)?(_=(freq_car_Hz=freq_dsp_to_car(t))-center_freq,wf.audioFFT_clear_wf=!0):(t=0,n&&(t=-passband_offset()),_+=t=s?i:t,(n||s)&&(wf.audioFFT_clear_wf=!0)),"drm"!=cur_mode&&(extint.prev_mode=cur_mode),cur_mode=e,(n||s)&&set_agc(),demodulator_set_offset_frequency(owrx.FSET_ADD,_),try_modeset_update_ui(e)}function demodulator_set_offset_frequency(e,t){var a;bandwidth/2<t||t<-bandwidth/2||(freqset_car_Hz((t=Math.round(t))+center_freq),(a=demodulators[0]).offset_frequency=t,a.set(),try_freqset_update_ui(e))}function owrx_cfg(){w3_do_when_rendered("id-rx-gmap",function(){w3_link_set("id-rx-gmap","https://www.google.com/maps/place/"+cfg.index_html_params.RX_GMAP)}),owrx.cfg_loaded=!0}function scale_setup(){w3_el("id-scale-container").addEventListener("mouseout",scale_container_mouseout,!1),scale_canvas=html("id-scale-canvas"),scale_ctx=scale_canvas.getContext("2d"),add_scale_listner(scale_canvas),(pb_adj_car=html("id-pb-adj-car")).innerHTML='<span id="id-pb-adj-car-ttip" class="class-passband-adjust-car-tooltip class-tooltip-text"></span>',pb_adj_car_ttip=html("id-pb-adj-car-ttip"),add_scale_listner(pb_adj_car),(pb_adj_lo=html("id-pb-adj-lo")).innerHTML='<span id="id-pb-adj-lo-ttip" class="class-passband-adjust-cut-tooltip class-tooltip-text"></span>',pb_adj_lo_ttip=html("id-pb-adj-lo-ttip"),add_scale_listner(pb_adj_lo),(pb_adj_hi=html("id-pb-adj-hi")).innerHTML='<span id="id-pb-adj-hi-ttip" class="class-passband-adjust-cut-tooltip class-tooltip-text"></span>',pb_adj_hi_ttip=html("id-pb-adj-hi-ttip"),add_scale_listner(pb_adj_hi),(pb_adj_cf=html("id-pb-adj-cf")).innerHTML='<span id="id-pb-adj-cf-ttip" class="class-passband-adjust-cf-tooltip class-tooltip-text"></span>',pb_adj_cf_ttip=html("id-pb-adj-cf-ttip"),add_scale_listner(pb_adj_cf),band_canvas=html("id-band-canvas"),band_ctx=band_canvas.getContext("2d"),add_canvas_listner(band_canvas),add_canvas_listner(dx_div=html("id-dx-container")),dx_canvas=html("id-dx-canvas"),dx_ctx=dx_canvas.getContext("2d"),add_canvas_listner(dx_canvas),resize_scale("setup")}function add_scale_listner(e){e.addEventListener("mousedown",scale_canvas_mousedown,!1),e.addEventListener("mousemove",scale_canvas_mousemove,!1),e.addEventListener("mouseup",scale_canvas_mouseup,!1),e.addEventListener("contextmenu",scale_canvas_contextmenu,!1),e.addEventListener("wheel",canvas_mousewheel,!1),kiwi_isMobile()&&(e.addEventListener("touchstart",scale_canvas_touchStart,!1),e.addEventListener("touchmove",scale_canvas_touchMove,!1),e.addEventListener("touchend",scale_canvas_touchEnd,!1))}function scale_canvas_contextmenu(e){return cancelEvent(e)}dont_toggle_rx_photo_flag=0,demodulators=[],demodulator_color_index=0,demodulator_colors=["#ffff00","#00ff00","#00ffff","#058cff","#ff9600","#a1ff39","#ff4e39","#ff5dbd"],demodulator=function(e){this.offset_frequency=e,this.has_audio_output=!0,this.has_text_output=!1,this.envelope={},this.color=demodulators_get_next_color(),this.stop=function(){}},demodulator.draggable_ranges={none:0,beginning:1,ending:2,anything_else:3,bfo:4,pbs:5,bwlo:6,bwhi:7},demodulator_response_time=100,demodulator_default_analog.prototype=new demodulator;var scale_canvas_drag_params={mouse_down:!1,drag:!1,start_x:0,last_x:0,start_y:0,last_y:0,key_modifiers:{shiftKey:!1,altKey:!1,ctrlKey:!1}};function scale_canvas_mousedown(e){scale_canvas_drag_params.drag=!1,scale_canvas_drag_params.start_x=e.pageX,scale_canvas_drag_params.start_y=e.pageY,scale_canvas_drag_params.key_modifiers.shiftKey=e.shiftKey,scale_canvas_drag_params.key_modifiers.altKey=e.altKey,scale_canvas_drag_params.key_modifiers.ctrlKey=e.ctrlKey,scale_canvas_start_drag(e,1),e.preventDefault()}function scale_canvas_touchStart(e){scale_canvas_drag_params.drag=!1,scale_canvas_drag_params.last_x=start_x=e.targetTouches[0].pageX,scale_canvas_drag_params.last_y=start_y=e.targetTouches[0].pageY,scale_canvas_drag_params.key_modifiers.shiftKey=!1,scale_canvas_drag_params.key_modifiers.altKey=!1,scale_canvas_drag_params.key_modifiers.ctrlKey=!1,scale_canvas_start_drag(e,0),touch_restore_tooltip_visibility(owrx.scale_canvas),e.preventDefault()}var scale_canvas_ignore_mouse_event=!1;function scale_canvas_start_drag(e,t){if(e.button==mouse.right&&!e.ctrlKey)return right_click_menu(scale_canvas_drag_params.start_x,scale_canvas_drag_params.start_y,1),scale_canvas_drag_params.mouse_down=owrx.scale_canvas.mouse_out=!1,void(scale_canvas_ignore_mouse_event=!0);scale_canvas_drag_params.mouse_down=!0,owrx.scale_canvas.target=e.target,t&&scale_canvas_mousemove(e)}function scale_offset_carfreq_from_px(e,t){isUndefined(t)&&(t=get_visible_freq_range());var a=passband_offset();return t.start+t.bw*(e/wf_container.clientWidth)-center_freq-a}function scale_canvas_drag(e,t,a){if(!scale_canvas_ignore_mouse_event){var _=0;Math.abs(t-scale_canvas_drag_params.start_x);if(scale_canvas_drag_params.mouse_down&&!scale_canvas_drag_params.drag){scale_canvas_drag_params.drag=!0;for(var i=0;i<demodulators.length;i++)_|=demodulators[i].envelope.env_drag_start(t,a,scale_canvas_drag_params.key_modifiers);e.target.style.cursor="move"}if(scale_canvas_drag_params.drag){for(i=0;i<demodulators.length;i++)_|=demodulators[i].envelope.drag_move(t);_||demodulator_set_offset_frequency(owrx.FSET_SCALE_DRAG,scale_offset_carfreq_from_px(t)),scale_canvas_drag_params.last_x=t}}}function scale_canvas_mousemove(e){scale_canvas_drag(e,e.pageX,e.offsetY)}function scale_canvas_touchMove(e){for(var t=0;t<e.touches.length;t++){var a=e.touches[t].pageY-owrx.scale_offsetY;scale_canvas_drag(e,e.touches[t].pageX,a)}e.preventDefault()}function scale_canvas_end_drag(e,t,a){if(scale_canvas_ignore_mouse_event)scale_canvas_ignore_mouse_event=!1;else if(1!=scale_canvas_drag_params.mouse_down||"mouseout"!=e.type){var _=scale_canvas_drag_params.drag=!1;if(1==scale_canvas_drag_params.mouse_down){for(var i=0;i<demodulators.length;i++)_|=demodulators[i].envelope.drag_end(t);_||demodulator_set_offset_frequency(owrx.FSET_SCALE_DRAG_END,scale_offset_carfreq_from_px(t))}scale_canvas_drag_params.mouse_down=!1;e=owrx.scale_canvas.target;e&&e.style&&(e.style.cursor=null)}else owrx.scale_canvas.mouse_out=!0}function scale_canvas_mouseup(e){scale_canvas_end_drag(e,e.pageX)}function touch_hide_tooltip(e,t){var a,_=t.target;w3_contains(_,"class-tooltip")&&(a=_.childNodes[0],w3_contains(a,"class-tooltip-text")&&(t.restore_visibility_timeout=setTimeout(function(){a.style.visibility="hidden",t.restore_visibility.push(a)},t.restore_visibility_delay)))}function touch_restore_tooltip_visibility(e){kiwi_clearTimeout(e.restore_visibility_timeout),e.restore_visibility.forEach(function(e){e.style.visibility=""}),e.restore_visibility=[]}function scale_canvas_touchEnd(e){scale_canvas_end_drag(e,scale_canvas_drag_params.last_x),touch_hide_tooltip(e,owrx.scale_canvas),e.preventDefault()}function scale_container_mouseout(e){var t=e.relatedTarget;(t=isObject(t)&&null!=t&&isDefined(t.id)?t.id:null)&&(t.startsWith("id-pb-adj")||t.startsWith("id-scale"))||scale_canvas_mouseup(e)}function scale_px_from_freq(e,t){return Math.round((e-t.start)/t.bw*wf_container.clientWidth)}function scale_px_from_freq_offset(e,t){return Math.round((e-t.start_offset)/t.bw*wf_container.clientWidth)}function get_visible_freq_range(){var e,t;return out={},wf.audioFFT_active&&cur_mode?(t=Math.round(audio_input_rate||12e3),t=ext_is_IQ_or_stereo_curmode()?(e=0,t):(e=!cur_mode||"ls"!=cur_mode.substr(0,2)&&"sal"!=cur_mode?t/4:0,t/2),out.center=center_freq+demodulators[0].offset_frequency+e,out.start=out.center-t,out.end=out.center+t,x_bin=freq_to_bin(out.start)):(t=bins_at_cur_zoom(),out.start=bin_to_freq(x_bin),out.center=bin_to_freq(x_bin+t/2),out.end=bin_to_freq(x_bin+t)),out.bw=out.end-out.start,out.hpp=out.bw/scale_canvas.clientWidth,out.start_offset=out.start+kiwi.offset_frac,out}var g_range,scale_markers_levels=[{hz_per_large_marker:1e7,estimated_text_width:70,format:"{x} ",pre_divide:1e6,decimals:0},{hz_per_large_marker:5e6,estimated_text_width:70,format:"{x} ",pre_divide:1e6,decimals:0},{hz_per_large_marker:1e6,estimated_text_width:70,format:"{x} ",pre_divide:1e6,decimals:0},{hz_per_large_marker:5e5,estimated_text_width:70,format:"{x} ",pre_divide:1e6,decimals:1},{hz_per_large_marker:1e5,estimated_text_width:70,format:"{x} ",pre_divide:1e6,decimals:1},{hz_per_large_marker:5e4,estimated_text_width:70,format:"{x} ",pre_divide:1e6,decimals:2},{hz_per_large_marker:1e4,estimated_text_width:70,format:"{x} ",pre_divide:1e6,decimals:2},{hz_per_large_marker:5e3,estimated_text_width:70,format:"{x} ",pre_divide:1e6,decimals:3},{hz_per_large_marker:1e3,estimated_text_width:70,format:"{x} ",pre_divide:1e6,decimals:3}],scale_min_space_btwn_texts=50,scale_min_space_btwn_small_markers=7;function get_scale_mark_spacing(t){out={},fcalc=function(e){return out.numlarge=t.bw/e,out.pxlarge=wf_container.clientWidth/out.numlarge,out.ratio=5,out.pxsmall=out.pxlarge/out.ratio,!(out.pxsmall<scale_min_space_btwn_small_markers)&&(out.pxsmall/2>=scale_min_space_btwn_small_markers&&"5"!=e.toString()[0]&&(out.pxsmall/=2,out.ratio*=2),out.smallbw=e/out.ratio,!0)};for(var e=scale_markers_levels.length-1;0<=e&&(mp=scale_markers_levels[e],!(fcalc(mp.hz_per_large_marker)&&out.pxlarge-mp.estimated_text_width>scale_min_space_btwn_texts));e--);return out.params=mp,out}function mk_freq_scale(){mkenvelopes(g_range=get_visible_freq_range()),scale_ctx.clearRect(0,22,scale_ctx.canvas.width,scale_ctx.canvas.height-22),scale_ctx.strokeStyle="#fff",scale_ctx.font="bold 12px sans-serif",scale_ctx.textBaseline="top",scale_ctx.fillStyle="#fff";var _,i=get_scale_mark_spacing(g_range),e=Math.ceil(g_range.start_offset/i.smallbw)*i.smallbw,t=e+kiwi.freq_offset_Hz-kiwi.offset_frac;text_y_pos=32+(kiwi_isFirefox()?3:0);function a(e){var t=e,a=i.params.pre_divide,e=i.params.decimals;(t+=kiwi.freq_offset_Hz-kiwi.offset_frac)<1e6&&(a/=1e3,e=0),_=format_frequency(i.params.format+(t<1e6?"kHz":"MHz"),t,a,e)}for(var o,n,s,r,l,d=0;!(1e3<++d);){if((l=scale_px_from_freq_offset(e,g_range))>window.innerWidth)break;scale_ctx.beginPath(),scale_ctx.moveTo(l,22),t%i.params.hz_per_large_marker==0?(isUndefined(n)&&(n=e),o=e,scale_ctx.lineWidth=3.5,scale_ctx.lineTo(l,33),a(e),s=scale_ctx.measureText(_),scale_ctx.textAlign="center",0==zoom_level&&g_range.start+i.smallbw*i.ratio>e?l<=s.width/2?scale_px_from_freq_offset(e+i.smallbw*i.ratio,g_range)-s.width>=scale_min_space_btwn_texts&&(scale_ctx.textAlign="left",scale_ctx.fillText(_,0,text_y_pos)):scale_ctx.fillText(_,l,text_y_pos):0==zoom_level&&g_range.end-i.smallbw*i.ratio<e&&l>window.innerWidth-s.width/2?window.innerWidth-s.width-scale_px_from_freq_offset(e-i.smallbw*i.ratio,g_range)>=scale_min_space_btwn_texts&&(scale_ctx.textAlign="right",scale_ctx.fillText(_,window.innerWidth,text_y_pos)):scale_ctx.fillText(_,l,text_y_pos)):(scale_ctx.lineWidth=2,scale_ctx.lineTo(l,30)),e+=i.smallbw,t+=i.smallbw,scale_ctx.stroke()}1e3<d&&(console.log("CONV_CT > 1000!!!"),kiwi_trace()),0!=zoom_level&&(scale_ctx.textAlign="center",l=scale_px_from_freq_offset(r=n-i.smallbw*i.ratio,g_range),a(r),0<l+scale_ctx.measureText(_).width/2&&scale_ctx.fillText(_,l,32),l=scale_px_from_freq_offset(r=o+i.smallbw*i.ratio,g_range),a(r),l-scale_ctx.measureText(_).width/2<window.innerWidth&&scale_ctx.fillText(_,l,32))}var window_width,waterfall_width,main_container,wf_container,canvas_annotation,canvas_phantom,annotation_div,dx_car_size=8,dx_car_border=3,dx_car_w=dx_car_h=2*dx_car_border+dx_car_size;function resize_scale(e){band_ctx.canvas.width=window.innerWidth,band_ctx.canvas.height=band_canvas_h,dx_div.style.width=px(window.innerWidth),dx_ctx.canvas.width=dx_car_w,dx_ctx.canvas.height=dx_car_h,dx_canvas.style.top=px(scale_canvas_top-dx_car_h+2),dx_canvas.style.left=0,dx_canvas.style.zIndex=99,dx_ctx.miterLimit=2,dx_ctx.lineJoin="round",dx_ctx.beginPath(),dx_ctx.lineWidth=dx_car_border-1,dx_ctx.strokeStyle="black";var t=dx_car_border,a=dx_car_size;dx_ctx.moveTo(t-1,t),dx_ctx.lineTo(t+a,t),dx_ctx.lineTo(t+a/2,t+a),dx_ctx.lineTo(t,t),dx_ctx.stroke(),dx_ctx.fillStyle="yellow",dx_ctx.fill(),scale_ctx.canvas.width=window.innerWidth,scale_ctx.canvas.height=scale_canvas_h,mkscale(),dx_schedule_update()}function format_frequency(e,t,a,_){return out=e.replace("{x}",(t/a).toFixed(_)),out}function mkscale(){mk_freq_scale(),mk_bands_scale()}function bins_at_zoom(e){return wf_fft_size<<zoom_levels_max-e}function bins_at_cur_zoom(){return bins_at_zoom(zoom_level)}function norm_to_bins(e){return Math.round(e*bins_at_cur_zoom())}function bin_to_freq(e){var t=wf_fft_size<<zoom_levels_max;return Math.round(e/t*bandwidth)}function freq_to_bin(e){var t=wf_fft_size<<zoom_levels_max;return Math.round(e/bandwidth*t)}function bins_to_pixels_frac(e,t,a){var _=t/bins_at_zoom(a);return sb_trace&&console.log("bins_to_pixels_frac bins="+t+" z="+a+" ratio="+_),wf_fft_size*(_=(_=1<_?1:_)<-1?-1:_)}function bins_to_pixels(e,t,a){a=bins_to_pixels_frac(e,t,a);return Math.round(a)}function freq_to_pixel(e){e=freq_to_bin(e)-x_bin;return 0<=e&&e<bins_at_cur_zoom()||(console.log("freq_to_pixel: bins="+e+" bins_at_cur_zoom="+bins_at_cur_zoom()),console.assert("assert fail")),bins_to_pixels(0,e,zoom_level)}function clamp_xbin(e){e<0&&(e=0);var t=(wf_fft_size<<zoom_levels_max)-bins_at_cur_zoom();return e=t<e?t:e}function passband_visible(){if(isUndefined(demodulators[0]))return x_bin;var e=freq_to_bin(freq_passband_center());return e=x_bin<=e&&e<x_bin+bins_at_cur_zoom()?e:-e-1}function create_canvas(e,t,a,_,i){var o=document.createElement("canvas");return o.id=e,o.width=t,o.height=a,_&&(o.style.width=px(_)),i&&(o.style.height=px(i)),o.ctx=o.getContext("2d"),o}function init_wf_container(){window_width=window.innerWidth,wf_container=w3_el("id-waterfall-container"),waterfall_width=wf_container.clientWidth,(canvas_annotation=create_canvas("id-annotation-canvas",wf_fft_size,wf_canvas_default_height,waterfall_width,wf_canvas_default_height)).style.zIndex=1,wf_container.appendChild(canvas_annotation),add_canvas_listner(canvas_annotation),w3_el("id-kiwi-body").addEventListener("keyup",mouse_freq_remove),add_canvas_listner(annotation_div=w3_el("id-annotation-div")),annotation_div.style.pointerEvents="none",add_canvas_listner(canvas_phantom=html("id-phantom-canvas")),canvas_phantom.style.width=px(wf_container.clientWidth),add_wf_canvas(),spec.canvas=create_canvas("id-spectrum-canvas",wf_fft_size,spec.height_spectrum_canvas,waterfall_width,spec.height_spectrum_canvas),html("id-spectrum-container").appendChild(spec.canvas),spec.ctx=spec.canvas.ctx,add_canvas_listner(spec.canvas),spec.ctx.font="10px sans-serif",spec.ctx.textBaseline="middle",spec.ctx.textAlign="left",spec.dB=html("id-spectrum-dB"),spec.dB.style.height=px(spec.height_spectrum_canvas),spec.dB.style.width=px(waterfall_width),spec.dB.innerHTML='<span id="id-spectrum-dB-ttip" class="class-spectrum-dB-tooltip class-tooltip-text"></span>',add_canvas_listner(spec.dB),w3_do_when_rendered("id-spectrum-dB-ttip",function(e){spec.dB_ttip=e}),document.addEventListener("mousemove",mouse_freq_add,!1)}function add_canvas_listner(e){e.addEventListener("mouseover",canvas_mouseover,!1),e.addEventListener("mouseout",canvas_mouseout,!1),e.addEventListener("mousedown",canvas_mousedown,!1),e.addEventListener("mousemove",canvas_mousemove,!1),e.addEventListener("mouseup",canvas_mouseup,!1),e.addEventListener("contextmenu",canvas_contextmenu,!1),e.addEventListener("wheel",canvas_mousewheel,!1),kiwi_isMobile()&&(e.addEventListener("touchstart",canvas_touchStart,!1),e.addEventListener("touchmove",canvas_touchMove,!1),e.addEventListener("touchend",canvas_touchEnd,!1))}function remove_canvas_listner(e){e.removeEventListener("mouseover",canvas_mouseover,!1),e.removeEventListener("mouseout",canvas_mouseout,!1),e.removeEventListener("mousedown",canvas_mousedown,!1),e.removeEventListener("mousemove",canvas_mousemove,!1),e.removeEventListener("mouseup",canvas_mouseup,!1),e.removeEventListener("contextmenu",canvas_contextmenu,!1),e.removeEventListener("wheel",canvas_mousewheel,!1),kiwi_isMobile()&&(e.removeEventListener("touchstart",canvas_touchStart,!1),e.removeEventListener("touchmove",canvas_touchMove,!1),e.removeEventListener("touchend",canvas_touchEnd,!1))}function canvas_contextmenu(e){return e.target.id,e&&e.currentTarget&&"id-dx-container"==e.currentTarget.id&&(dx.ctrl_click=!0,w3_el(e.target.id).click()),cancelEvent(e)}function canvas_mouseover(e){}function canvas_mouseout(e){waterfall_setup_done&&(canvas_dragging&&(e=e.target.id.startsWith("id-spectrum-dB"),owrx.debug_drag&&canvas_log("C-MOUT"+(e?" SPEC-IGNORE":"")),e||canvas_end_drag2()),mouse_freq_remove())}function canvas_get_carfreq_offset(e,t){var a=e/waterfall_width;a=wf.audioFFT_active?center_freq+demodulators[0].offset_frequency+(a-=(e=ext_is_IQ_or_stereo_curmode())?.5:.25)*audio_input_rate*(e?2:1):bin_to_freq(x_bin+a*bins_at_cur_zoom());t=t?passband_offset():0;return Math.round(a-t)-bandwidth/2}function canvas_get_dspfreq(e){return canvas_get_carfreq_offset(e,!1)+center_freq}canvas_dragging=!1,canvas_drag_min_delta=1,canvas_mouse_down_or_touch=!1,canvas_ignore_mouse_event=!1;var mouse={left:0,middle:1,right:2};function canvas_start_drag(e,t,a){return owrx.debug_drag&&canvas_log("CSD"),e.button!=mouse.right||e.ctrlKey?owrx.scale_canvas.mouse_out?(event_dump(e,"CSD-scale"),void console.log("SHOULD NOT OCCUR")):(e.shiftKey&&"id-dx-container"==e.target.id?(canvas_ignore_mouse_event=!0,owrx.debug_drag&&console.log("CSD-DX IME=set-true"),dx_show_edit_panel(e,-1)):e.shiftKey&&(e.ctrlKey||e.altKey)?(canvas_ignore_mouse_event=!0,owrx.debug_drag&&console.log("CSD-lookup IME=set-true"),freq_database_lookup(canvas_get_dspfreq(t),e.ctrlKey?owrx.rcm_lookup:owrx.rcm_cluster)):e.ctrlKey?(canvas_ignore_mouse_event=!0,owrx.debug_drag&&console.log("CSD-pageScroll1 IME=set-true"),page_scroll(-page_scroll_amount)):e.altKey&&(canvas_ignore_mouse_event=!0,owrx.debug_drag&&console.log("CSD-pageScroll2 IME=set-true"),page_scroll(page_scroll_amount)),owrx.drag_count=0,canvas_mouse_down_or_touch=!0,canvas_dragging=!1,owrx.canvas.drag_last_x=owrx.canvas.drag_start_x=t,owrx.canvas.drag_last_y=owrx.canvas.drag_start_y=a,owrx.canvas.target=e.target,cancelEvent(e)):(canvas_ignore_mouse_event=!0,owrx.debug_drag&&console.log("CSD-Rclick IME=set-true"),owrx.debug_drag&&canvas_log("ordinary-RCM"),right_click_menu(t,a,2),canvas_ignore_mouse_event=!1,void(owrx.debug_drag&&console.log("CSD-Rclick IME=set-false")))}function canvas_mousedown(e){owrx.debug_drag&&canvas_log("$C-MD"),canvas_start_drag(e,e.pageX,e.pageY),e.preventDefault()}function canvas_touchStart(e){var t=e.targetTouches.length,a=Math.round(e.targetTouches[0].pageX),_=Math.round(e.targetTouches[0].pageY);owrx.debug_drag&&canvas_log("$C-TS"+t+"-x"+a+"-y"+_),owrx.double_touch_start=!1,1==t?e.target.id.startsWith("id-spectrum")?(owrx.canvas.drag_last_x=owrx.canvas.drag_start_x=a,owrx.canvas.drag_last_y=owrx.canvas.drag_start_y=_,owrx.debug_drag&&canvas_log("*SPEC*")):canvas_start_drag(e,a,_):2<=t&&(canvas_start_drag(e,a,_),canvas_ignore_mouse_event=!0,owrx.debug_drag&&console.log("CTS-doubleTouch IME=set-true"),owrx.touches_first_startx=a,_=e.touches[0].pageX-e.touches[1].pageX,a=e.touches[0].pageY-e.touches[1].pageY,owrx.pinch_distance_first=Math.round(Math.hypot(_,a)),owrx.pinch_distance_last=owrx.pinch_distance_first,owrx.double_touch_swipe=Math.abs(a)<50,owrx.double_touch_start=!0),touch_restore_tooltip_visibility(owrx.canvas),e.preventDefault()}function canvas_drag(e,t,a,_,i,o){var n,s;waterfall_setup_done&&(spectrum_tooltip_update(e,i,o),owrx.drag_count=isNumber(owrx.drag_count)?owrx.drag_count+1:0,owrx.scale_canvas.mouse_out?scale_canvas_drag(e,a,_):(s=canvas_mouse_down_or_touch?owrx.canvas.drag_start_x:a,owrx.debug_drag&&canvas_log("CD#"+owrx.drag_count+" x"+a+" y"+_+" dx"+Math.abs(a-s)+" CMDT"+(canvas_mouse_down_or_touch?1:0)+" IME"+(canvas_ignore_mouse_event?1:0)+" DG"+(canvas_dragging?1:0)),!canvas_mouse_down_or_touch||canvas_ignore_mouse_event&&!owrx.double_touch_start||(i=kiwi_isMobile()?10:1,o=owrx.drag_count>i,s=Math.abs(a-owrx.canvas.drag_start_x)>canvas_drag_min_delta,!canvas_dragging&&o&&s&&(owrx.debug_drag&&canvas_log("### dc="+owrx.drag_count+" >? "+i+" && "+Math.abs(a-owrx.canvas.drag_start_x)+" >? "+canvas_drag_min_delta+" "+(o?"T":"F")+(s?"T":"F")),canvas_dragging=!0,wf_container.style.cursor="move"),canvas_dragging&&(o=owrx.canvas.drag_last_x-a,s=owrx.canvas.drag_last_y-_,owrx.double_touch_start?owrx.double_touch_swipe?0==t&&2<=e.touches.length&&(n=Math.round(Math.abs((e.touches[0].pageX+e.touches[1].pageX)/2)),demodulator_set_offset_frequency(owrx.FSET_SCALE_TOUCH_DRAG,canvas_get_carfreq_offset(n,!0))):(n=Math.round(Math.hypot(o,s)),s=Math.abs(n-owrx.pinch_distance_last),owrx.debug_drag&&canvas_log(n.toFixed(0)+" "+s.toFixed(0)),25<s&&(owrx.debug_drag&&canvas_log("*"),zoom_step((s=n<=owrx.pinch_distance_last)?ext_zoom.OUT:ext_zoom.IN),owrx.debug_drag&&canvas_log(s?"IN":"OUT"),owrx.pinch_distance_last=n)):waterfall_pan_canvases(norm_to_bins(o/waterfall_width)),owrx.canvas.drag_last_x=a,owrx.canvas.drag_last_y=_))))}function mouse_freq_add(e){var t,a,_;isNumber(e.pageX)&&(owrx.last_pageX=e.pageX),isNumber(e.pageY)&&(owrx.last_pageY=e.pageY),kiwi_isMobile()||wf.audioFFT_active||(t=canvas_annotation.ctx,e.target==canvas_annotation&&any_modifier_key(e)?(a=e.offsetX,_=e.offsetY+16,t.font=px(12)+" monospace",owrx.mouse_freq.vis&&t.clearRect(owrx.mouse_freq.tx,owrx.mouse_freq.cy,owrx.mouse_freq.tw,12),e=(canvas_get_dspfreq(a)+kiwi.freq_offset_Hz)/1e3,owrx.mouse_freq.text=format_frequency("{x}",e,1,freq_field_prec(e)),1&(e=Math.ceil(t.measureText(owrx.mouse_freq.text).width))&&e++,owrx.mouse_freq.tw=e,owrx.mouse_freq.th=12,owrx.mouse_freq.tx=a-e/2,t.fillStyle="black",t.fillRect(a-e/2,_,e,12),t.fillStyle="white",t.fillText(owrx.mouse_freq.text,owrx.mouse_freq.tx,_+12-2),owrx.mouse_freq.cx=a,owrx.mouse_freq.cy=_,owrx.mouse_freq.vis=!0):mouse_freq_remove())}function mouse_freq_remove(){owrx.mouse_freq.vis&&(canvas_annotation.ctx.clearRect(owrx.mouse_freq.tx,owrx.mouse_freq.cy,owrx.mouse_freq.tw,owrx.mouse_freq.th),owrx.mouse_freq.vis=!1)}function canvas_mousemove(e){canvas_drag(e,0,e.pageX,e.pageY,e.clientX,e.clientY)}function canvas_touchMove(e){1<=e.touches.length&&(owrx.touches_first_lastx=e.touches[0].pageX);for(var t=0;t<e.touches.length;t++){var a=Math.round(e.touches[t].pageX),_=Math.round(e.touches[t].pageY);canvas_drag(e,t,a,_,a,_)}e.preventDefault()}function canvas_end_drag2(){owrx.debug_drag&&canvas_log("C-ED2"),wf_container.style.cursor=owrx.wf_cursor,canvas_mouse_down_or_touch=!1,canvas_ignore_mouse_event=!1,owrx.debug_drag&&console.log("C-ED2 IME=set-false")}function canvas_end_drag(e,t){var a,_;owrx.scale_canvas.mouse_out&&scale_canvas_end_drag(e,t,!(owrx.scale_canvas.mouse_out=!1)),owrx.debug_drag&&canvas_log("C-ED IME"+(canvas_ignore_mouse_event?1:0)+" CD"+(canvas_dragging?1:0)),waterfall_setup_done&&(canvas_dragging?canvas_end_drag2():(owrx.debug_drag&&canvas_log("CMDT"+(canvas_mouse_down_or_touch?1:0)+" TL"+owrx.tuning_locked),canvas_mouse_down_or_touch&&!canvas_ignore_mouse_event&&(owrx.tuning_locked?((a=w3_el("id-tuning-lock-container")).style.opacity=.8,w3_show(a),(_=w3_el("id-tuning-lock")).style.marginTop=px(w3_center_in_window(_,"TL")),setTimeout(function(){a.style.opacity=0,setTimeout(function(){w3_hide(a)},500)},300)):(owrx.debug_drag&&canvas_log("*click*"),e.shiftKey&&!e.ctrlKey&&!e.altKey||owrx.wf_snap?(_=(_=canvas_get_dspfreq(t))/(e=freq_step_amount(find_band(_)).step_Hz),freqmode_set_dsp_kHz(Math.round(_)*e/1e3,null)):demodulator_set_offset_frequency(owrx.FSET_SCALE_MOUSE_CLICK,canvas_get_carfreq_offset(t,!0))))),canvas_mouse_down_or_touch=!1,canvas_ignore_mouse_event=!1,owrx.debug_drag&&console.log("C-ED IME=set-false"))}function canvas_mouseup(e){owrx.debug_drag&&console.log("C-MU"),owrx.debug_drag&&canvas_log("C-MU"),canvas_end_drag(e,e.pageX)}function canvas_touchEnd(e){var t=owrx.canvas.drag_last_x,a=owrx.canvas.drag_last_y;owrx.debug_drag&&canvas_log("C-TE-x"+t+"-DTS"+(owrx.double_touch_start?1:0)+"-DTSw"+(owrx.double_touch_swipe?1:0)+"-DRAG"+(canvas_dragging?1:0)),canvas_end_drag(e,t),spectrum_tooltip_update(e,t,a),owrx.double_touch_start&&(owrx.debug_drag&&canvas_log("DTS-D="+(canvas_dragging?"T":"F")),demodulator_set_offset_frequency(owrx.FSET_SCALE_TOUCH_DRAG_END,freq_car_Hz-center_freq),canvas_dragging||(kiwi_isMobile()&&owrx.mobile&&owrx.mobile.small&&(t=10),owrx.debug_drag&&canvas_log("*-RCM"),right_click_menu(t,a,3)),canvas_ignore_mouse_event=!1,owrx.debug_drag&&console.log("CTE-doubleTouch IME=set-false"),owrx.double_touch_start=!1),touch_hide_tooltip(e,owrx.canvas),e.preventDefault()}var canvas_mousewheel_rlimit=kiwi_rateLimit(canvas_mousewheel_cb,170);function canvas_mousewheel(e){canvas_mousewheel_rlimit(e),e.preventDefault()}function canvas_mousewheel_cb(e){var t,a;waterfall_setup_done&&(a=e.deltaX,t=e.deltaY,t=a<0||0==a&&t<0,e.target&&e.target.id&&("id-scale-canvas"==e.target.id||e.target.id.startsWith("id-pb-"))?passband_increment(t):(a=e.ctrlKey||0!=a,zoom_step(t?ext_zoom.IN:ext_zoom.OUT,a?void 0:e.pageX)))}function right_click_menu_init(){var e=[];e.push("DX database"),owrx.rcm_db=0,e.push("edit last selected DX label"),owrx.rcm_edit=1,e.push("DX label filter"),owrx.rcm_filter=2,e.push("<hr>"),e.push("database lookup"),owrx.rcm_lookup=4,e.push("DX Cluster lookup"),owrx.rcm_cluster=5,e.push("<hr>"),e.push("snap to nearest"),owrx.rcm_snap=7,e.push("ðŸ”’ lock tuning"),owrx.rcm_lock=8,e.push("restore passband"),owrx.rcm_pb=9,e.push("save waterfall as JPG"),owrx.rcm_save=10,e.push("<hr>"),e.push('<i style="pointer-events:none">cal ADC clock (admin)</i>'),owrx.rcm_cal=12,e.push('<i style="pointer-events:none">set freq offset (admin)</i>'),owrx.rcm_foff=13,e.push('<i style="pointer-events:none">save noise defaults (admin)</i>'),owrx.rcm_noise=14,owrx.right_click_menu_content=e,w3_menu("id-right-click-menu","right_click_menu_cb");e=w3_div("id-tuning-lock-container class-overlay-container w3-hide",w3_div("id-tuning-lock",w3_icon("","fa-lock",192)+"<br>Tuning locked"));w3_create_appendElement("id-main-container","div",e)}function right_click_menu(e,t,a){owrx.debug_drag&&canvas_log("RCM"+a),owrx.right_click_menu_content[owrx.rcm_db]="DX "+dx.db_flip_s[dx.db]+" database";var _=freq_displayed_Hz/1e3,a=band_info(),a=_>=a.NDB_lo&&_<a.NDB_hi?"NDB":_<a.LW_lo?"VLF/LF":_<a.MW_hi?"LW/MW":"SWBC";owrx.right_click_menu_content[owrx.rcm_lookup]=a+" database lookup",owrx.right_click_menu_content[owrx.rcm_snap]=owrx.wf_snap?"no snap":"snap to nearest";a=dx.db==dx.DB_STORED&&isDefined(owrx.dx_click_gid_last);owrx.right_click_menu_content[owrx.rcm_edit]=a?"edit last selected DX label":"open DX label edit panel",w3_menu_items("id-right-click-menu",owrx.right_click_menu_content),w3_menu_popup("id-right-click-menu",function(e,t){return"keyup"==e.type&&"Escape"==e.key||"click"==e.type&&e.button!=mouse.right||"touchend"==e.type&&!t&&!w3_contains(e.target,"w3-menu")},e,t)}function right_click_menu_cb(e,t,a){switch(e=+e){case owrx.rcm_db:dx_database_cb("",dx.db==dx.DB_EiBi?dx.DB_STORED:dx.DB_EiBi);break;case owrx.rcm_lookup:case owrx.rcm_cluster:freq_database_lookup(canvas_get_dspfreq(t),e);break;case owrx.rcm_snap:wf_snap();break;case owrx.rcm_lock:owrx.tuning_locked^=1,owrx.right_click_menu_content[owrx.rcm_lock]=(owrx.tuning_locked?"ðŸ”“ unlock":"ðŸ”’ lock")+" tuning";break;case owrx.rcm_pb:restore_passband(cur_mode),demodulator_analog_replace(cur_mode);break;case owrx.rcm_save:export_waterfall();break;case owrx.rcm_edit:var _=-1;dx.db==dx.DB_STORED&&isDefined(owrx.dx_click_gid_last)&&(_=owrx.dx_click_gid_last),console.log("RCM rcm_edit: gid="+_+" db="+dx.db),dx_show_edit_panel(null,_),dx_schedule_update();break;case owrx.rcm_filter:dx_filter();break;case owrx.rcm_cal:admin_pwd_query(function(){var e=Math.round(freq_displayed_Hz/1e3),t=1e3*e,a=t-freq_displayed_Hz,_=Math.round(a*ext_adc_clock_Hz()/t);console.log("cal ADC clock: dsp="+freq_displayed_Hz+" car="+freq_car_Hz+" r1k_kHz="+e+" clk_diff="+a+" clk_adj="+_);t=cfg.clk_adj+_,_=1e6*t/ext_adc_clock_Hz();console.log("cal ADC clock: prev_adj="+cfg.clk_adj+" new_adj="+t+" ppm="+_.toFixed(1)),cal_adc_dialog(t,a,e,_)});break;case owrx.rcm_foff:admin_pwd_query(function(){set_freq_offset_dialog()});break;case owrx.rcm_noise:admin_pwd_query(function(){w3_call("noise_blank_save_defaults"),w3_call("noise_filter_save_defaults")})}}function freq_database_lookup(e,t){var a,_=e/1e3,i=(Math.round(e/10),Math.round(e/1e3)),o="https://",n=band_info();t==owrx.rcm_lookup?_>=n.NDB_lo&&_<n.NDB_hi?o+="rxx.classaxe.com/en/rww/signals?types=DGPS,NAVTEX,NDB&khz="+(a=i.toFixed(0))+"&limit=-1":_<n.LW_lo?(a=Math.round(e/100)/10,console.log("kHz="+_+" f="+a),o+="www.mwlist.org/vlf.php?kHz="+a.toFixed(1)):_<n.MW_hi?(a=Math.round(i/n._9_10)*n._9_10,console.log("MW kHz="+_+" f="+a),o+="www.mwlist.org/mwlist_quick_and_easy.php?area="+[0,1,3,2][n.ITU_region]+"&kHz="+a.toFixed(0)):o+="www.short-wave.info/index.php?freq="+(a=5*Math.round(i/5)).toFixed(0)+"&timbus=NOW&ip="+client_public_ip+"&porm=4":t==owrx.rcm_cluster&&(o="http://ve3sun.com/KiwiSDR/DX.php?Search="+(a=Math.floor(e)/1e3).toFixed(1)),console.log("LOOKUP "+_+" -> "+a+" "+o);o=window.open(o,"_blank");o&&o.focus()}function export_waterfall(){var e=w3_el("id-scale-canvas"),t=waterfall_width,a=Math.round(e.height),o=50,_=w3_el("id-spectrum-canvas"),n=_&&spec.source_wf?_.height:0,s=document.createElement("canvas"),r=s.getContext("2d"),l=s.width=wf_fft_size,d=s.height=50+a+n+(old_canvases.length+wf_canvases.length)*wf_canvas_default_height;if(r.fillStyle="black",r.fillRect(0,0,l,d),n&&(r.drawImage(_,0,o),o+=n),r.fillStyle="gray",r.fillRect(0,o,l,a),r.drawImage(e,0,0,t,a,0,o,l,a),o+=a,wf_canvases.forEach(function(e,t){var a=e.height,_=0;0==t&&(a+=t=unpx(e.style.top),_=-t),r.drawImage(e,0,_,l,a,0,o,l,a),o+=a}),1<old_canvases.length)for(i=1;i<old_canvases.length;i++)r.drawImage(old_canvases[i],0,o),o+=old_canvases[i].height;r.font="18px Arial",r.fillStyle="lime";t=kiwi_host()+"     "+(new Date).toUTCString()+"     "+freq_displayed_kHz_str+" kHz  "+cur_mode,a=l/2-r.measureText(t).width/2;r.fillText(t,a,35);t=kiwi_host()+"_"+(new Date).toISOString().replace(/:/g,"_").replace(/\.[0-9]+Z$/,"Z")+"_"+w3_el("id-freq-input").value+"_"+cur_mode+".jpg",a=s.toDataURL("image/jpeg",.85),s=document.createElement("a");s.download=t,s.href=a,s.target="_blank",s.dataset.downloadurl=["image/jpeg",s.download,s.href].join(":"),document.body.appendChild(s),s.click(),document.body.removeChild(s)}function zoom_finally(){w3_innerHTML("id-nav-optbar-wf","WF"+zoom_level.toFixed(0)),wf_gnd_value=wf_gnd_value_base-zoomCorrection(),extint_environment_changed({zoom:1,passband_screen_location:1}),freqset_select()}var ZOOM_NOMINAL=10,ZOOM_BAND=6,zoom_nom=0,zoom_old_nom=0,zoom_levels_max=0,zoom_level=0,zoom_level_f=0,zoom_freq=0,zoom_maxin_s=["id-maxin","id-maxin-nom","id-maxin-max"],x_bin=0;function zoom_step(e,t){if(wf.audioFFT_active)audioFFT_update();else{var a,_,o,n=e==ext_zoom.OUT,s=e==ext_zoom.IN,r=e!=ext_zoom.TO_BAND&&e!=ext_zoom.ABS,l=zoom_level,d=x_bin,c=!0;if(e==ext_zoom.WHEEL){if(null==t)return;var f,c=!1;if((f=Math.round(zoom_level_f))==l)return;e=l<f?ext_zoom.IN:ext_zoom.OUT}if(e==ext_zoom.MAX_OUT)n=!0,x_bin=zoom_level=0;else{if(r&&(n&&0==zoom_level||s&&zoom_levels_max<=zoom_level))return void zoom_finally();if(e==ext_zoom.TO_BAND){var w,u=center_freq+demodulators[0].offset_frequency;if(null!=t)a=t.b1,_=t.b2,zoom_level=_.zoom_level,w=_.cfHz,sb_trace&&console.log("ZTB-user f="+u+" cf="+w+" b="+a.name+" z="+_.zoom_level);else{var p=cfg.init.ITU_region+1;for(i=0;i<cfg.bands.length&&(a=cfg.bands[i],_=kiwi.bands[i],!((a.itu==kiwi.BAND_SCALE_ONLY||a.itu==kiwi.ITU_ANY||a.itu==p)&&u>=_.minHz&&u<=_.maxHz));i++);w=i!=cfg.bands.length?(zoom_level=_.zoom_level,_.cfHz):(zoom_level=ZOOM_BAND,u)}n=zoom_level<l,x_bin=freq_to_bin(w),x_bin-=norm_to_bins(.5)}else if(e==ext_zoom.ABS){if(null==t)return void zoom_finally();if((f=t)<0||zoom_levels_max<f||f==zoom_level)return void zoom_finally();n=f<zoom_level,zoom_level=f,x_bin=freq_to_bin(freq_passband_center()),x_bin-=norm_to_bins(.5)}else e==ext_zoom.NOM_IN||e==ext_zoom.MAX_IN?(n=(zoom_level=e==ext_zoom.NOM_IN&&null!=t&&1==t&&zoom_nom<=zoom_level?zoom_level==zoom_levels_max?zoom_nom:zoom_levels_max:e==ext_zoom.NOM_IN?zoom_nom:zoom_levels_max)<l,x_bin=freq_to_bin(freq_passband_center()),x_bin-=norm_to_bins(.5)):(dbgUs&&(sb_trace&&console.log("ZOOM IN/OUT"),sb_trace=0),o=null!=t?t/waterfall_width:0<=(o=passband_visible())?(o-x_bin)/bins_at_cur_zoom():.5,x_bin+=norm_to_bins(o),zoom_level+=e,x_bin-=norm_to_bins(o))}c&&(zoom_level_f=zoom_level);c=zoom_level==zoom_levels_max?2:zoom_nom<=zoom_level?1:0;c!=zoom_old_nom&&(w3_hide(zoom_maxin_s[zoom_old_nom]),w3_show(zoom_maxin_s[c],"w3-show-table-cell"),zoom_old_nom=c),0!=zoom_level&&0!=l||(w3_show_hide("id-maxout",0!=zoom_level,"w3-show-table-cell"),w3_show_hide("id-maxout-max",0==zoom_level,"w3-show-table-cell")),x_bin=clamp_xbin(x_bin);c=n?d-x_bin:x_bin-d,n=bins_to_pixels(1,c,n?zoom_level:l);sb_trace&&console.log("Zs z"+l+">"+zoom_level+" b="+x_bin+"/"+d+"/"+c+" bz="+bins_at_zoom(l)+" r="+c/bins_at_zoom(l)+" px="+n);c=zoom_level-l;sb_trace&&console.log("zoom_step oz="+l+" zl="+zoom_level+" dz="+c+" pdx="+n),waterfall_zoom_canvases(c,n),mkscale(),dx_schedule_update(),sb_trace&&console.log("SET Z"+zoom_level+" xb="+x_bin),wf_send("SET zoom="+zoom_level+" start="+x_bin),need_maxmindb_update=!0,writeCookie("last_zoom",zoom_level),freq_link_update(),vfo_update(),zoom_finally(),dbgUs&&(u=get_visible_freq_range(),console.log("^ZOOM z"+zoom_level+" "+(u.start/1e3).toFixed(0)+"|"+(u.center/1e3).toFixed(0)+"|"+(u.end/1e3).toFixed(0)+" ("+(u.bw/1e3).toFixed(0)+" kHz)"))}}function passband_increment(e){var t=ext_get_passband(),a=Math.abs(t.high-t.low),_=e?(1.25*a-a)/2:(a-.8*a)/2,a=10<_?10:1;_=Math.round(_/a)*a,t.low+=e?-_:_,t.low=Math.round(t.low/a)*a,t.high+=e?_:-_,t.high=Math.round(t.high/a)*a,ext_set_passband(t.low,t.high,!0)}function zoom_click(e,t,a){if(any_alternate_click_event(e)){var _=e.currentTarget,e=w3_contains(_,"id-zoom-in"),_=w3_contains(_,"id-zoom-out");return e||_?void passband_increment(e):void 0}t==ext_zoom.NOM_IN?zoom_step(t,1):zoom_step(t)}function zoom_over(e){var t,a;"IMG"==e.target.nodeName&&(t=e.target,a=e.currentTarget,a=w3_contains(a,"id-zoom-in"),any_alternate_click_event(e)?t.title=a?"passband widen":"passband narrow":t.removeAttribute("title"))}function mobile_init(){var t=owrx.mobile=ext_mobile_info();t.small&&(toggle_or_set_hide_bars(owrx.HIDE_TOPBAR),optbar_focus("optbar-off","init")),t.narrow&&(w3_hide("id-readme"),t.width<600&&toggle_or_set_hide_bars(owrx.HIDE_ALLBARS)),owrx.last_mobile={},owrx.rescale_cnt=owrx.rescale_cnt2=0,setInterval(function(){t=owrx.mobile=ext_mobile_info(owrx.last_mobile),owrx.last_mobile=t;var e;w3_el("id-control");t.orient_unchanged||(owrx.rescale_cnt++,0!=owrx.rescale_cnt2&&toggle_panel("id-control",1),e=t.narrow&&!mobile_laptop_test,mobile_scale_control_panel(t,e))},500)}function mobile_scale_control_panel(e,t){e=e||owrx.mobile;var a=w3_el("id-control");(a.panel_isScaled=t)?(a.style.right="0px",e=e.width/a.uiWidth*.95,a.style.transform="scale("+e.toFixed(2)+")",a.style.transformOrigin="bottom right",owrx.rescale_cnt2++):a.style.transform="none"}var spec={height_spectrum_canvas:200,tooltip_offset:100,source_wf:0,source_audio:0,canvas:null,ctx:null,spectrum_image:null,colormap:null,colormap_transparent:null,dB:null,dB_ttip:null,update:0,last_update:0,need_update:0,need_clear_avg:0,clear_avg:0,avg:[],peak_show:0,peak_clear:0,peak:[],dB_bands:[],redraw_dB_scale:!1};function spectrum_init(){spec.colormap=spec.ctx.createImageData(1,spec.canvas.height),spec.colormap_transparent=spec.ctx.createImageData(1,spec.canvas.height),update_maxmindb_sliders(),spectrum_dB_bands();var e,t,a,_;kiwi_isMobile();setInterval(function(){spec.update++},100),spec.spectrum_image=spec.ctx.createImageData(spec.canvas.width,spec.canvas.height),!wf.audioFFT_active&&rx_chan>=wf_chans&&(e=spec.canvas.width,t=spec.canvas.height,spec.ctx.fillStyle="black",spec.ctx.fillRect(0,0,e,t),spec.ctx.font="18px sans-serif",spec.ctx.fillStyle="white",a=wf_chans?"Spectrum not available for rx"+rx_chan:"Spectrum not allowed on this Kiwi",_=spec.ctx.measureText(a).width,spec.ctx.fillText(a,e/2-_/2,t/2)),kiwi_load_js_dir("extensions/",["waterfall/waterfall.js","colormap/colormap.js"],function(){waterfall_init(),colormap_init()})}function spectrum_dB_bands(){spec.dB_bands=[];var e=0,t=maxdb,a=mindb;t<=a&&(t=-10,a=-110);for(var _=t-a,i=a+-12,o=(o=t-i)||1,n=0,s=0,r=10*Math.floor(t/10);a-r<10;r-=10){var l=1-(r-a)/_;1<l&&(l=1);function d(e){return Math.round(e*spec.canvas.height)}var c=Math.round((r-i)/o*255),f=color_map[c],w=color_map_transparent[c],u="#"+(f>>>8).toString(16).leadingZeros(6),c=d(n),p=d(l);if(0!=c||0!=p){spec.dB_bands[e]={dB:r,y1:c,y2:p,norm:l.toFixed(2),color:u};for(var m=c;m<p;m++){for(var h=0;h<4;h++)spec.colormap.data[4*m+h]=f>>>0>>8*(3-h)&255,spec.colormap_transparent.data[4*m+h]=w>>>0>>8*(3-h)&255;if(8192<s++)break}if(n=l,e++,8192<s++)break}}spec.redraw_dB_scale=!0,w3_call("colormap_aper")}function spectrum_tooltip_update(e,t,a){e.target==spec.dB||e.currentTarget==spec.dB||e.target==spec.dB_ttip||e.currentTarget==spec.dB_ttip?(owrx.debug_drag&&canvas_log("*STTU*"),e=spec.height_spectrum_canvas,0<=a&&a<e&&(t=t-(kiwi_isMobile()?spec.tooltip_offset:0),spec.dB_ttip.style.left=px(t),spec.dB_ttip.style.bottom=px(e+10-a),owrx.debug_drag&&canvas_log("["+t+","+a+"]"),t=format_frequency("{x}",t=(canvas_get_dspfreq(t)+kiwi.freq_offset_Hz)/1e3,1,freq_field_prec(t)),e=(e-a)/e*full_scale+mindb,spec.dB_ttip.innerHTML=t+" kHz<br>"+e.toFixed(0)+" dBm")):owrx.debug_drag&&canvas_log("STTU-ck")}function spectrum_update(e){var t,a;spec.last_update=spec.update;var _=spec.ctx,i=spec.canvas.width-25,o=spec.canvas.height;for(_.fillStyle="black",_.fillRect(0,0,i,o),_.fillStyle="lightGray",c=0;c<spec.dB_bands.length;c++){var n=spec.dB_bands[c],s=Math.round(n.norm*o);_.fillRect(0,s,i,1)}if(spec.clear_avg){for(t=0;t<i;t++)spec.avg[t]=color_index(e[t]);spec.clear_avg=!1,spec.peak_clear=!0}if(spec.peak_clear){for(t=0;t<i;t++)spec.peak[t]=0;spec.peak_clear=!1}if(spec.redraw_dB_scale){for(t=i;t<spec.canvas.width;t++)_.putImageData(spec.colormap_transparent,t,0,0,0,1,o);for(_.fillStyle="white",c=0;c<spec.dB_bands.length;c++){n=spec.dB_bands[c];s=Math.round(n.norm*o),_.fillText(n.dB,3+i,s-4)}spec.redraw_dB_scale=!1}for(_.fillStyle="hsl(180, 100%, 70%)",t=0;t<i;t++){switch(a=color_index(wf_gnd?wf_gnd_value:e[t]),spec_filter){case wf_sp_menu_e.IIR:var r=1-Math.exp(-sp_param*a/255);r<=.01&&(r=.01);var l=spec.avg[t];(l=255<(l+=r*(a-l))?255:l)<0&&(l=0),a=spec.avg[t]=l;break;case wf_sp_menu_e.MMA:(a=255<a?255:a)<0&&(a=0),spec.avg[t]=(spec.avg[t]*(sp_param-1)+a)/sp_param,a=spec.avg[t];break;case wf_sp_menu_e.EMA:(a=255<a?255:a)<0&&(a=0),spec.avg[t]+=(a-spec.avg[t])/sp_param,a=spec.avg[t];break;case wf_sp_menu_e.OFF:default:(a=255<a?255:a)<0&&(a=0)}if(a>spec.peak[t]&&(spec.peak[t]=a),s=Math.round((1-a/255)*o),spectrum_slow_dev)_.fillRect(t,s,1,o-s);else for(var d=!0,c=0;c<spec.dB_bands.length;c++){var f,w=spec.dB_bands[c];d&&s>w.y2||(d=!1,_.fillStyle=w.color,f=w.y2-s,_.fillRect(t,s,1,f),s=w.y2)}}if(spec.peak_show){for(_.lineWidth=1,_.strokeStyle="yellow",_.beginPath(),s=Math.round((1-spec.peak[0]/255)*o)-1,_.moveTo(0,s),t=1;t<i;t++)s=Math.round((1-spec.peak[t]/255)*o)-1,_.lineTo(t,s);_.globalAlpha=.55,_.stroke(),_.globalAlpha=1}}var waterfall_timer,waterfall_ms,waterfall_scrollable_height,wf_canvas_actual_line,waterfall_setup_done=0,wf_canvases=[],old_canvases=[],wf_cur_canvas=null,wf_canvas_default_height=200,wf_canvas_id_seq=1,wf_canvas_maxshift=0;function wf_init(){w3_do_when_cond(function(){return okay_wf_init},function(){wf_init_ready()},0,200)}function wf_init_ready(){init_wf_container(),wf.audioFFT_active=rx_chan>=wf_chans,resize_waterfall_container(!1),resize_wf_canvases(),bands_init(),panels_setup(),scale_setup(),mkcolormap(),mkscale(),spectrum_init(),dx_schedule_update(),users_init({user:1}),ident_init(),stats_init(),check_top_bar_congestion(),spectrum_show&&setTimeout(spec_show,2e3),audioFFT_setup(),waterfall_ms=900/wf_fps_max,waterfall_timer=window.setInterval(waterfall_dequeue,waterfall_ms),isNonEmptyArray(shortcut.keys)&&!override_ext&&setTimeout(keyboard_shortcut_url_keys,5e3),wf_snap(kiwi_storeGet("wf_snap")),kiwi_isMobile()&&mobile_init(),dx_init(),waterfall_setup_done=1}function add_wf_canvas(){var e=create_canvas("id-wf-canvas",wf_fft_size,wf_canvas_default_height,waterfall_width,wf_canvas_default_height);e.id_seq=wf_canvas_id_seq++,wf_canvas_actual_line=wf_canvas_default_height-1,e.style.left=0,e.openwebrx_height=wf_canvas_default_height,e.openwebrx_top=1-wf_canvas_default_height,e.style.top=px(e.openwebrx_top),e.oneline_image=e.ctx.createImageData(wf_fft_size,1),wf_container.appendChild(e),add_canvas_listner(e),wf_canvases.unshift(e),wf_cur_canvas=e,kiwi_gc_wf&&(e=null)}function wf_shift_canvases(){for(wf_canvases.forEach(function(e){e.style.top=px(e.openwebrx_top++)});wf_canvases.length;){var e=wf_canvases[wf_canvases.length-1];if(null==e||e.openwebrx_top<waterfall_scrollable_height){kiwi_gc_wf&&(e=null);break}var t=wf_canvases[wf_canvases.length-2];t&&old_canvases.unshift(t),15<old_canvases.length&&old_canvases.pop(),kiwi_gc_wf&&remove_canvas_listner(e),wf_container.removeChild(e),kiwi_gc_wf&&(e=wf_canvases[wf_canvases.length-1]=null),wf_canvases.pop()}++wf_canvas_maxshift<wf_container.clientHeight?(canvas_phantom.style.top=px(wf_canvas_maxshift),canvas_phantom.style.height=px(wf_container.clientHeight-wf_canvas_maxshift),w3_show_block(canvas_phantom)):canvas_phantom.hidden||(w3_hide(canvas_phantom),canvas_phantom.hidden=!0)}function resize_wf_canvases(){window_width=wf_container.innerWidth,waterfall_width=wf_container.clientWidth,new_width=px(waterfall_width);wf_canvases.forEach(function(e){e.style.width=new_width,e.style.left=0}),canvas_annotation.width=waterfall_width,canvas_annotation.style.width=new_width,canvas_phantom.style.width=new_width,canvas_phantom.style.left=0,spec.canvas.style.width=new_width,wf.audioFFT_active&&w3_innerHTML("id-annotation-div",w3_div("w3-section w3-container",w3_text("w3-large|color:cyan","Audio FFT<br>"),w3_text("w3-small|color:cyan","Zoom waterfall not available<br>"+(wf.no_wf?'when "no_wf" URL option used.<br>':"on channels "+wf_chans_real+"-"+(rx_chans-1)+" of Kiwis<br>configured for "+rx_chans+" channels.<br>")),w3_text("w3-small|color:cyan","For details see the Kiwi forum.")))}function waterfall_timestamp(){var e,t=0==wf.ts_tz?(new Date).toUTCString().substr(17,8):(new Date).toString().substr(16,8),a=wf_canvas_actual_line,_=wf_cur_canvas;w3_fillText_shadow(_,t,12,a+12,"Arial",14,"lime"),a+10>_.height&&((e=wf_canvases[1])&&w3_fillText_shadow(e,t,12,a-_.height+12,"Arial",14,"lime"))}function wf_snap(e){owrx.wf_snap=isUndefined(e)?1^owrx.wf_snap:isNull(e)?0:+e,w3_el("id-waterfall-container").style.cursor=owrx.wf_cursor=owrx.wf_snap?"col-resize":"crosshair",kiwi_storeSet("wf_snap",owrx.wf_snap)}var page_scroll_amount=.8;function page_scroll(e){wf.audioFFT_active||waterfall_pan_canvases(norm_to_bins(e)),freqset_select()}function page_scroll_icon_click(e,t){any_alternate_click_event(e)?dx_label_step(t<0?-1:1):page_scroll(t)}var x_bin_server_last,waterfall_dont_scale=0,need_maxmindb_update=!1,need_clear_wf_sp_avg=!1,need_clear_wfavg=!1,clear_wfavg=!0,wfavg=[],wf_swallow_samples=[2,4,8,18],wf_swallow=0;function waterfall_add(e,t){var a;if(null!=e){var _=wf_cur_canvas;if(null!=_){var i=wf_fft_size;if(0==t){var o=new Uint32Array(e,4,3),n=o[0],s=o[1];kiwi_gc_wf&&(o=null);var r,l,d=65535&s,c=s>>16&65535,f=1,w=2,s=(o=new Uint8Array(e,16)).length;if(need_maxmindb_update&&zoom_level==d&&(update_maxmindb_sliders(),need_maxmindb_update=!1),x_bin==n&&zoom_level==d&&((need_clear_wf_sp_avg||spec.need_clear_avg)&&(spec.clear_avg=!0),(need_clear_wf_sp_avg||need_clear_wfavg)&&(clear_wfavg=!0),need_clear_wf_sp_avg=need_clear_wfavg=spec.need_clear_avg=!1),l=c&f?(r=new Uint8Array(2*s),decode_ima_adpcm_e8_u8(o,r,s,{index:0,previousValue:0}),r.subarray(10)):o,wf.no_sync=c&w,wf_swallow)return void wf_swallow--;n!=x_bin_server_last&&(x_bin_server_last=n,11<=zoom_level&&(wf_swallow=wf_swallow_samples[zoom_level-11],wf_fps!=wf_fps_max&&(wf_swallow=Math.round(wf_swallow*wf_fps/wf_fps_max))))}else l=e,spec.source_wf&&spec.need_clear_avg&&(spec.clear_avg=!0,spec.need_clear_avg=!1);spec.source_wf&&spec.update!=spec.last_update&&spectrum_update(l);for(var u=_.oneline_image,p=0;p<i;p++){switch(a=color_index(wf_gnd?wf_gnd_value:l[p],wf.sqrt),wf_filter){case wf_sp_menu_e.IIR:clear_wfavg&&(wfavg[p]=a);var m=1-Math.exp(-wf_param*a/255);m<=.01&&(m=.01);var h=wfavg[p];(h=255<(h+=m*(a-h))?255:h)<0&&(h=0),wfavg[p]=h,a=Math.round(wfavg[p]);break;case wf_sp_menu_e.MMA:clear_wfavg&&(wfavg[p]=a),wfavg[p]=(wfavg[p]*(wf_param-1)+a)/wf_param,a=Math.round(wfavg[p]);break;case wf_sp_menu_e.EMA:clear_wfavg&&(wfavg[p]=a),wfavg[p]+=(a-wfavg[p])/wf_param,a=Math.round(wfavg[p]);break;case wf_sp_menu_e.OFF:}u.data[4*p]=color_map_r[a],u.data[4*p+1]=color_map_g[a],u.data[4*p+2]=color_map_b[a],u.data[4*p+3]=255}clear_wfavg=clear_wfavg&&!1,_.ctx.putImageData(u,0,wf_canvas_actual_line),0==t&&w3_call("IBP_scan_plot",u),"undefined"!=typeof wfext&&wfext.tstamp&&(x=(60*(g=new Date).getUTCMinutes()+g.getUTCSeconds())%wfext.tstamp==0,0==wf.prev_sec_mark&&1==x&&waterfall_timestamp(),wf.prev_sec_mark=x);var g,x,b,w=!1;if(0!=t||wf.no_sync||(sb_trace&&console.log("WF fixup bin="+x_bin+"/"+n+" z="+zoom_level+"/"+d),zoom_level!=d&&(b=bins_to_pixels(2,t=(x=(g=zoom_level-d)<0)?n-x_bin:x_bin-n,x?zoom_level:d),sb_trace&&console.log("WF Z fix z"+d+">"+zoom_level+" out="+x+" b="+x_bin+"/"+n+"/"+t+" px="+b),waterfall_zoom(_,g,wf_canvas_actual_line,b),n+=x?-t:t,sb_trace&&console.log("WF z fixed"),w=!0),x_bin!=n&&(b=bins_to_pixels(3,x_bin-n,zoom_level),sb_trace&&console.log("WF bin fix L="+wf_canvas_actual_line+" xb="+x_bin+" xbs="+n+" pdx="+b),waterfall_pan(_,wf_canvas_actual_line,b),sb_trace&&console.log("WF bin fixed"),w=!0),sb_trace&&x_bin==n&&zoom_level==d&&(console.log("--WF FIXUP ALL DONE--"),sb_trace=0)),1<wf.need_autoscale&&wf.need_autoscale--,1==wf.need_autoscale&&!w){for(var v=[],k=wf.audioFFT_active?l.slice(256,768):l,y=k.length,q=0,T=0;T<y;T++){var S=dB_wire_to_dBm(k[T]);S<=-190||(v[q]=S,q++)}var E,M,n=v.length;n?(v.sort(function(e,t){return e-t}),E=v[Math.floor(.5*n)],M=v[Math.floor(.95*n)],console_log_dbgUs("# autoscale len="+n+" min="+v[0]+" noise="+E+" signal="+M+" max="+v[n-1]),d=v[Math.floor(.1*n)],w=v[Math.floor(.2*n)],console_log_dbgUs("# autoscale min="+v[0]+" 10%="+d+" 20%="+w+" 50%(noise)="+E+" 95%(signal)="+M+" max="+v[n-1])):(M=-110,E=-120),(M+=30)<-80&&(M=-80),E-=10,wf.audioFFT_active&&(E=dbgUs&&devl.p4?Math.round(devl.p4):-110,console_log_dbgUs("audioFFT_active: force noise = "+E.toFixed(0)+" dBm")),setmaxdb(1,M),setmindb(1,E),update_maxmindb_sliders(),wf.need_autoscale=0}wf_canvas_actual_line--,wf_shift_canvases(),wf_canvas_actual_line<0&&add_wf_canvas(),kiwi_gc_wf&&(_=e=o=r=l=null)}}}function waterfall_pan(e,t,a){function _(e,t,a){return e<t?t:a<e?a:e}var i,o,n=e.ctx,s=e.width,r=-1==t?(i=0,e.height):(i=t,1);try{sb_trace&&console.log("waterfall_pan h="+r+" dx="+a),a<0?(o=s-(a=-a),sb_trace&&console.log("PAN-L w="+o+" dx="+a),0<o&&n.drawImage(e,0,i,o,r,a,i,o,r),n.fillStyle="Black",sb_trace&&(n.fillStyle=-1==t?"Lime":"Red"),fx=_(a,0,s),n.fillRect(0,i,fx,r)):(o=s-a,sb_trace&&console.log("PAN-R w="+o+" dx="+a),0<o&&n.drawImage(e,a,i,o,r,0,i,o,r),n.fillStyle="Black",sb_trace&&(n.fillStyle=-1==t?"Lime":"Red"),fx=_(o,0,s),n.fillRect(fx,i,s,r))}catch(e){console.log("EX WFPAN "+e.toString()+" dx="+a+" y="+i+" w="+o+" h="+r)}}var last_pixels_frac=0;function waterfall_pan_canvases(e){var t,a;e&&(wf.audioFFT_active||(t=x_bin,e=bins_to_pixels_frac(4,(x_bin=clamp_xbin(x_bin+=e))-t,zoom_level)+last_pixels_frac,a=Math.round(e),last_pixels_frac=e-a,sb_trace&&console.log("PAN-CAN z="+zoom_level+" xb="+x_bin+" db="+(x_bin-t)+" f_dx="+e+" i_dx="+a+" lpf="+last_pixels_frac),a&&(wf_canvases.forEach(function(e){waterfall_pan(e,-1,a)}),wf_send("SET zoom="+zoom_level+" start="+x_bin),mkscale(),need_clear_wf_sp_avg=!0,dx_schedule_update(),extint_environment_changed({waterfall_pan:1,passband_screen_location:1}),passband_visible()<0&&check_band(!0))))}function waterfall_zoom(e,t,a,_){function i(e,t,a){return e<t?t:a<e?a:e}var o,n,s,r,l=e.ctx,d=e.width,c=1<<Math.abs(t),f=d/c,w=-1==a?(n=0,e.height):(n=a,1);try{sb_trace&&console.log("waterfall_zoom w="+d+" h="+w+" pw="+f+" zf="+c),t<0?(sb_trace&&console.log("WFZ-out srcX=0/"+d+" dstX="+_+"/"+(_+f)+" (pw="+f+")"),l.drawImage(e,0,n,d,w,_,n,f,w),l.fillStyle="Black",sb_trace&&(console.log("chocolate 0:"+_),l.fillStyle="chocolate"),o=i(_,0,d),l.fillRect(0,n,o,n+w),sb_trace&&(console.log("brown "+(_+f)+":"+d),l.fillStyle="brown"),o=i(_+f,0,d),l.fillRect(o,n,d,n+w)):0!=d&&(sb_trace&&console.log("WFZ-in srcX="+_+"/"+(_+f)+"(pw="+f+") dstX=0/"+d),r=s=!1,d<_+f&&(o=Math.round((d-_)*c),sb_trace&&console.log("CLAMP HI fx="+o),s=!0),_<0&&(o=Math.round(-_*c),sb_trace&&console.log("CLAMP LO fx="+o),r=!0),l.drawImage(e,_,n,f,w,0,n,d,w),l.fillStyle="Black",sb_trace&&(l.fillStyle="deepPink"),s&&l.fillRect(o,n,d,n+w),r&&l.fillRect(0,n,o,n+w))}catch(e){console.log("EX WFZ "+e.toString()+" dz="+t+" x="+_+" y="+n+" w="+d+" h="+w)}}function waterfall_zoom_canvases(t,a){sb_trace&&console.log("ZOOM-CAN z"+zoom_level+" xb="+x_bin+" x="+a),wf_canvases.forEach(function(e){waterfall_zoom(e,t,-1,a)}),need_clear_wf_sp_avg=!0}function waterfall_height(){var e=html("id-top-container").clientHeight,t=html("id-non-waterfall-container").clientHeight,a=html("id-scale-container").clientHeight;return owrx.scale_offsetY=e+t-a,window.innerHeight-e-t}function resize_waterfall_container(e){e&&!waterfall_setup_done||(e=waterfall_height(),waterfall_scrollable_height=0<=e?(canvas_annotation.style.height=wf_container.style.height=px(e),(canvas_annotation.height=e)*wf.scroll_multiple):0)}var waterfall_delay=0,waterfall_queue=[],waterfall_last_add=0;function waterfall_add_queue(e,t,a){if("DAT"!=a){var _=new Uint32Array(e,4,3)[2];kiwi_gc_wf&&0;var i=Date.now(),a=waterfall_last_add?i-waterfall_last_add:0;waterfall_last_add=i,waterfall_queue.push({data:e,audioFFT:0,seq:_,spacing:a}),kiwi_gc_wf&&(e=null)}else{var o=new Uint8Array(e,4),e=o[0];if(0==e){for(var n=0;n<768;n++)downloaded_colormap[n]=o[n+1];mkcolormap(),console.log("W/F DAT downloaded_colormap")}else console.log("W/F DAT unknown cmd="+e)}}var init_zoom_set=!1,waterfall_last_out=0,wf_dq_onesec=0;function waterfall_dequeue(){if(!init_zoom_set&&demodulators[0]&&(init_zoom=parseInt(init_zoom),(init_zoom<0||init_zoom>zoom_levels_max)&&(init_zoom=0),zoom_step(ext_zoom.ABS,init_zoom),init_zoom_set=!0),waterfall_setup_done&&0!=waterfall_queue.length)for(;0!=waterfall_queue.length;){var e=Date.now();if(!wf.no_sync){var t=waterfall_queue[0].seq;if(audio_ext_sequence+waterfall_delay<t)return;if(t==audio_ext_sequence&&e<waterfall_last_out+waterfall_queue[0].spacing)return}waterfall_last_out=e;t=waterfall_queue[0].data;kiwi_gc_wf&&(waterfall_queue[0].data=null);e=waterfall_queue[0].audioFFT;waterfall_queue.shift(),waterfall_add(t,e),kiwi_gc_wf&&0}}var downloaded_colormap=new Uint8Array(768);turbo_colormap_data=[.18995,.07176,.23217,.19483,.08339,.26149,.19956,.09498,.29024,.20415,.10652,.31844,.2086,.11802,.34607,.21291,.12947,.37314,.21708,.14087,.39964,.22111,.15223,.42558,.225,.16354,.45096,.22875,.17481,.47578,.23236,.18603,.50004,.23582,.1972,.52373,.23915,.20833,.54686,.24234,.21941,.56942,.24539,.23044,.59142,.2483,.24143,.61286,.25107,.25237,.63374,.25369,.26327,.65406,.25618,.27412,.67381,.25853,.28492,.693,.26074,.29568,.71162,.2628,.30639,.72968,.26473,.31706,.74718,.26652,.32768,.76412,.26816,.33825,.7805,.26967,.34878,.79631,.27103,.35926,.81156,.27226,.3697,.82624,.27334,.38008,.84037,.27429,.39043,.85393,.27509,.40072,.86692,.27576,.41097,.87936,.27628,.42118,.89123,.27667,.43134,.90254,.27691,.44145,.91328,.27701,.45152,.92347,.27698,.46153,.93309,.2768,.47151,.94214,.27648,.48144,.95064,.27603,.49132,.95857,.27543,.50115,.96594,.27469,.51094,.97275,.27381,.52069,.97899,.27273,.5304,.98461,.27106,.54015,.9893,.26878,.54995,.99303,.26592,.55979,.99583,.26252,.56967,.99773,.25862,.57958,.99876,.25425,.5895,.99896,.24946,.59943,.99835,.24427,.60937,.99697,.23874,.61931,.99485,.23288,.62923,.99202,.22676,.63913,.98851,.22039,.64901,.98436,.21382,.65886,.97959,.20708,.66866,.97423,.20021,.67842,.96833,.19326,.68812,.9619,.18625,.69775,.95498,.17923,.70732,.94761,.17223,.7168,.93981,.16529,.7262,.93161,.15844,.73551,.92305,.15173,.74472,.91416,.14519,.75381,.90496,.13886,.76279,.8955,.13278,.77165,.8858,.12698,.78037,.8759,.12151,.78896,.86581,.11639,.7974,.85559,.11167,.80569,.84525,.10738,.81381,.83484,.10357,.82177,.82437,.10026,.82955,.81389,.0975,.83714,.80342,.09532,.84455,.79299,.09377,.85175,.78264,.09287,.85875,.7724,.09267,.86554,.7623,.0932,.87211,.75237,.09451,.87844,.74265,.09662,.88454,.73316,.09958,.8904,.72393,.10342,.896,.715,.10815,.90142,.70599,.11374,.90673,.69651,.12014,.91193,.6866,.12733,.91701,.67627,.13526,.92197,.66556,.14391,.9268,.65448,.15323,.93151,.64308,.16319,.93609,.63137,.17377,.94053,.61938,.18491,.94484,.60713,.19659,.94901,.59466,.20877,.95304,.58199,.22142,.95692,.56914,.23449,.96065,.55614,.24797,.96423,.54303,.2618,.96765,.52981,.27597,.97092,.51653,.29042,.97403,.50321,.30513,.97697,.48987,.32006,.97974,.47654,.33517,.98234,.46325,.35043,.98477,.45002,.36581,.98702,.43688,.38127,.98909,.42386,.39678,.99098,.41098,.41229,.99268,.39826,.42778,.99419,.38575,.44321,.99551,.37345,.45854,.99663,.3614,.47375,.99755,.34963,.48879,.99828,.33816,.50362,.99879,.32701,.51822,.9991,.31622,.53255,.99919,.30581,.54658,.99907,.29581,.56026,.99873,.28623,.57357,.99817,.27712,.58646,.99739,.26849,.59891,.99638,.26038,.61088,.99514,.2528,.62233,.99366,.24579,.63323,.99195,.23937,.64362,.98999,.23356,.65394,.98775,.22835,.66428,.98524,.2237,.67462,.98246,.2196,.68494,.97941,.21602,.69525,.9761,.21294,.70553,.97255,.21032,.71577,.96875,.20815,.72596,.9647,.2064,.7361,.96043,.20504,.74617,.95593,.20406,.75617,.95121,.20343,.76608,.94627,.20311,.77591,.94113,.2031,.78563,.93579,.20336,.79524,.93025,.20386,.80473,.92452,.20459,.8141,.91861,.20552,.82333,.91253,.20663,.83241,.90627,.20788,.84133,.89986,.20926,.8501,.89328,.21074,.85868,.88655,.2123,.86709,.87968,.21391,.8753,.87267,.21555,.88331,.86553,.21719,.89112,.85826,.2188,.8987,.85087,.22038,.90605,.84337,.22188,.91317,.83576,.22328,.92004,.82806,.22456,.92666,.82025,.2257,.93301,.81236,.22667,.93909,.80439,.22744,.94489,.79634,.228,.95039,.78823,.22831,.9556,.78005,.22836,.96049,.77181,.22811,.96507,.76352,.22754,.96931,.75519,.22663,.97323,.74682,.22536,.97679,.73842,.22369,.98,.73,.22161,.98289,.7214,.21918,.98549,.7125,.2165,.98781,.7033,.21358,.98986,.69382,.21043,.99163,.68408,.20706,.99314,.67408,.20348,.99438,.66386,.19971,.99535,.65341,.19577,.99607,.64277,.19165,.99654,.63193,.18738,.99675,.62093,.18297,.99672,.60977,.17842,.99644,.59846,.17376,.99593,.58703,.16899,.99517,.57549,.16412,.99419,.56386,.15918,.99297,.55214,.15417,.99153,.54036,.1491,.98987,.52854,.14398,.98799,.51667,.13883,.9859,.50479,.13367,.9836,.49291,.12849,.98108,.48104,.12332,.97837,.4692,.11817,.97545,.4574,.11305,.97234,.44565,.10797,.96904,.43399,.10294,.96555,.42241,.09798,.96187,.41093,.0931,.95801,.39958,.08831,.95398,.38836,.08362,.94977,.37729,.07905,.94538,.36638,.07461,.94084,.35566,.07031,.93612,.34513,.06616,.93125,.33482,.06218,.92623,.32473,.05837,.92105,.31489,.05475,.91572,.3053,.05134,.91024,.29599,.04814,.90463,.28696,.04516,.89888,.27824,.04243,.89298,.26981,.03993,.88691,.26152,.03753,.88066,.25334,.03521,.87422,.24526,.03297,.8676,.2373,.03082,.86079,.22945,.02875,.8538,.2217,.02677,.84662,.21407,.02487,.83926,.20654,.02305,.83172,.19912,.02131,.82399,.19182,.01966,.81608,.18462,.01809,.80799,.17753,.0166,.79971,.17055,.0152,.79125,.16368,.01387,.7826,.15693,.01264,.77377,.15028,.01148,.76476,.14374,.01041,.75556,.13731,.00942,.74617,.13098,.00851,.73661,.12477,.00769,.72686,.11867,.00695,.71692,.11268,.00629,.7068,.1068,.00571,.6965,.10102,.00522,.68602,.09536,.00481,.67535,.0898,.00449,.66449,.08436,.00424,.65345,.07902,.00408,.64223,.0738,.00401,.63082,.06868,.00401,.61923,.06367,.0041,.60746,.05878,.00427,.5955,.05399,.00453,.58336,.04931,.00486,.57103,.04474,.00529,.55852,.04028,.00579,.54583,.03593,.00638,.53295,.03169,.00705,.51989,.02756,.0078,.50664,.02354,.00863,.49321,.01963,.00955,.4796,.01583,.01055];var spectrum_scale_color_map_transparency=200,color_map=new Uint32Array(256),color_map_transparent=new Uint32Array(256),color_map_r=new Uint8Array(256),color_map_g=new Uint8Array(256),color_map_b=new Uint8Array(256);function mkcolormap(){var e;wf.cmap>=kiwi.cmap_e.custom_1&&(e=wf.custom_colormaps[wf.cmap-kiwi.cmap_e.custom_1]);for(var t,a,_,i,o,n,s=0;s<256;s++){switch(wf.cmap){case kiwi.cmap_e.kiwi:n=s<32?(o=r=0,255*s/31):s<72?(r=0,o=255*(s-32)/39,255):s<96?(r=0,(o=255)-255*(s-72)/23):s<116?(r=255*(s-96)/19,o=255,0):s<184?(o=(r=255)-255*(s-116)/67,0):(r=255,o=0,128*(s-184)/70);break;case kiwi.cmap_e.CuteSDR:n=s<43?(o=r=0,255*s/43):s<87?(r=0,o=255*(s-43)/43,255):s<120?(r=0,(o=255)-255*(s-87)/32):s<154?(r=255*(s-120)/33,o=255,0):s<217?(o=(r=255)-255*(s-154)/62,0):(r=255,o=0,128*(s-217)/38);break;case kiwi.cmap_e.greyscale:black_level=0,white_level=48;var r=o=n=black_level+(255-black_level+white_level)*s/255;break;case kiwi.cmap_e.linear:r=255*(s/255)+0*((255-s)/255),r*=1+s/255*0,o=0*(s/255)+255*((255-s)/255),o*=1+s/255*0,n=255*(s/255)+0*((255-s)/255),n*=1+s/255*0;break;case kiwi.cmap_e.turbo:r=255*turbo_colormap_data[3*s+0],o=255*turbo_colormap_data[3*s+1],n=255*turbo_colormap_data[3*s+2];break;case kiwi.cmap_e.SdrDx:var l=s<=20?(n=.5,i=o=r=_=a=t=0,20):s<=60?(_=.5,o=r=a=t=0,n=1,i=21,60):s<=150?(o=r=_=1,n=a=t=0,i=61,150):s<=180?(r=a=t=1,n=o=_=0,i=151,180):s<=210?(_=a=0,n=o=r=t=1,i=181,210):(n=o=r=_=a=t=1,i=211,255),l=(s-i)/(l-i);r=255*(t+(r-t)*l),o=255*(a+(o-a)*l),n=255*(_+(n-_)*l);break;default:r=e[3*s+0],o=e[3*s+1],n=e[3*s+2]}r=Math.round(r),r=w3_clamp(r,0,255),o=Math.round(o),o=w3_clamp(o,0,255),n=Math.round(n),n=w3_clamp(n,0,255),color_map[s]=r<<24|o<<16|n<<8|255,color_map_transparent[s]=r<<24|o<<16|n<<8|spectrum_scale_color_map_transparency,color_map_r[s]=r,color_map_g[s]=o,color_map_b[s]=n}}function dB_wire_to_dBm(e){return-(255-(e=255<(e=e<0?0:e)?255:e))+cfg.waterfall_cal}function color_index(e,t){var e=dB_wire_to_dBm(e),a=((e=maxdb<(e=e<mindb?mindb:e)?maxdb:e)-mindb)/full_scale,_=a;if(isDefined(t))try{switch(+t){case 0:default:break;case 1:_=Math.sqrt(a);break;case 2:.21<a&&a<.5&&(_=.2+.09*(4+Math.log10(a-.2)));break;case 3:.31<a&&a<.6&&(_=.3+.07*(5+Math.log10(a-.3)));break;case 4:.41<a&&a<.7&&(_=.4+.055*(6+Math.log10(a-.4)))}}catch(e){_=a}e=255*_;return e=255<(e=(e=Math.round(e))<0?0:e)?255:e}function waterfall_color_index_max_min(e,t,a){var _=t-a,_=255*(((e=t<(e=(e=-(255-e))<a?a:e)?t:e)-a)/(_=_||1));return _=255<(_=(_=Math.round(_))<0?0:_)?255:_}function color_index_max_min(e,t,a){var _=t-a,_=255*(((e=t<(e=e<a?a:e)?t:e)-a)/(_=_||1));return _=255<(_=(_=Math.round(_))<0?0:_)?255:_}var freq_displayed_Hz,freq_displayed_kHz_str,freq_displayed_kHz_str_with_freq_offset,freq_car_Hz,freqset_tout,freq_dsp_set_last,afft={init:!1,comp_1x:!1,prev_lsb:!1,audioFFT_dynload:{},offt:0,i_re:0,i_im:0,o_re:0,o_im:0,window_512:[],window_1k:[],window_2k:[],pwr_dB:[],dBi:[],CUTESDR_MAX_VAL:32767};function audioFFT_setup(){if(wf.audioFFT_active){var e,t;zoom_level=0,wf.aper!=kiwi.aper_e.auto&&(e=readCookie("last_AF_max_dB",maxdb),t=readCookie("last_AF_min_dB",mindb_un),setmaxdb(1,e),setmindb(1,t),update_maxmindb_sliders());function a(e,t){return.5-.5*Math.cos(2*Math.PI*e/(t-1))}for(i=0;i<512;i++)afft.window_512[i]=a(i,512);for(i=0;i<1024;i++)afft.window_1k[i]=a(i,1024);for(i=0;i<2048;i++)afft.window_2k[i]=a(i,2048)}}function audioFFT_update(){mkscale(),dx_schedule_update(),freq_link_update(),w3_innerHTML("id-nav-optbar-wf","WF"),freqset_select(),wf.audioFFT_clear_wf&&(wf_canvases.forEach(function(e){e.ctx.fillStyle="Black",e.ctx.fillRect(0,0,e.width,e.height)}),spec.need_clear_avg=!0,wf.audioFFT_clear_wf=!1,wf.aper==kiwi.aper_e.auto&&wf.audioFFT_active&&(wf.need_autoscale=16))}function wf_audio_FFT(e,t){if(wf.audioFFT_active&&isDefined(cur_mode)&&kiwi_load_js_polled(afft.audioFFT_dynload,["pkgs/js/Ooura_FFT32.js"])){var a,_,i,o,n=ext_is_IQ_or_stereo_curmode(),s="ls"==cur_mode.substr(0,2)||"sal"==cur_mode,r=!afft.init||n!=afft.iq||audio_compression!=afft.comp;if(r&&(console.log("audio_FFT: SWITCHING iq="+n+" comp="+audio_compression),n?(afft.size=1024,afft.offt=ooura32.FFT(afft.size,{type:"complex",radix:4}),afft.i_re=ooura32.vectorArrayFactory(afft.offt),afft.i_im=ooura32.vectorArrayFactory(afft.offt)):(afft.size=audio_compression?afft.comp_1x?2048:1024:512,afft.offt=ooura32.FFT(afft.size,{type:"real",radix:4}),afft.i_re=ooura32.scalarArrayFactory(afft.offt)),afft.o_re=ooura32.vectorArrayFactory(afft.offt),afft.o_im=ooura32.vectorArrayFactory(afft.offt),afft.scale=20/(afft.size*afft.size*afft.size*afft.CUTESDR_MAX_VAL*afft.CUTESDR_MAX_VAL),afft.init||wf.aper==kiwi.aper_e.auto||(wf.need_autoscale=16),afft.iq=n,afft.comp=audio_compression,afft.init=!0),r||s!=afft.prev_lsb){for(a=0;a<1024;a++)afft.pwr_dB[a]=0;afft.prev_lsb=s}if(afft.iq){for(_=a=0;a<1024;a+=2,_++)afft.i_re[_]=e[a]*afft.window_512[_],afft.i_im[_]=e[a+1]*afft.window_512[_];for(afft.offt.fft(afft.offt,afft.i_re.buffer,afft.i_im.buffer,afft.o_re.buffer,afft.o_im.buffer),_=0,i=512;_<256;_++,i++){var l=(c=afft.o_re[_])*c+(f=afft.o_im[_])*f,d=10*Math.log10(l*afft.scale+1e-30);d=Math.round(255+d),afft.pwr_dB[i]=d}for(i=_=256;_<512;_++,i++){l=(c=afft.o_re[_])*c+(f=afft.o_im[_])*f,d=10*Math.log10(l*afft.scale+1e-30);d=Math.round(255+d),afft.pwr_dB[i]=d}waterfall_queue.push({data:afft.pwr_dB,audioFFT:1,seq:0,spacing:0})}else if(audio_compression){if(afft.comp_1x){for(a=0;a<2048;a++)afft.i_re[a]=e[a]*afft.window_2k[a];for(afft.offt.fft(afft.offt,afft.i_re.buffer,afft.o_re.buffer,afft.o_im.buffer),o=s?(i=512,-1):(i=256,1),_=0;_<1024;_++){l=(c=afft.o_re[_])*c+(f=afft.o_im[_])*f;afft.dBi[1&_]=Math.round(255+10*Math.log10(l*afft.scale+1e-30)),1&_&&(afft.pwr_dB[i]=Math.max(afft.dBi[0],afft.dBi[1]),i+=o)}}else{for(a=0;a<1024;a++)afft.i_re[a]=e[a]*afft.window_1k[a];for(afft.offt.fft(afft.offt,afft.i_re.buffer,afft.o_re.buffer,afft.o_im.buffer),o=s?(i=512,-1):(i=256,1),_=0;_<512;_++,i+=o){l=(c=afft.o_re[_])*c+(f=afft.o_im[_])*f;afft.pwr_dB[i]=Math.round(255+10*Math.log10(l*afft.scale+1e-30))}for(waterfall_queue.push({data:afft.pwr_dB,audioFFT:1,seq:0,spacing:0}),a=1024;a<2048;a++)afft.i_re[a]=e[a]*afft.window_2k[a-1024];for(afft.offt.fft(afft.offt,afft.i_re.buffer,afft.o_re.buffer,afft.o_im.buffer),o=s?(i=512,-1):(i=256,1),_=0;_<512;_++,i+=o){l=(c=afft.o_re[_])*c+(f=afft.o_im[_])*f;afft.pwr_dB[i]=Math.round(255+10*Math.log10(l*afft.scale+1e-30))}}waterfall_queue.push({data:afft.pwr_dB,audioFFT:1,seq:0,spacing:0})}else{for(a=0;a<512;a++)afft.i_re[a]=e[a]*afft.window_512[a];for(afft.offt.fft(afft.offt,afft.i_re.buffer,afft.o_re.buffer,afft.o_im.buffer),o=s?(i=512,-2):(i=256,2),_=0;_<256;_++,i+=o){var c,f,l=(c=afft.o_re[_])*c+(f=afft.o_im[_])*f;afft.pwr_dB[i]=afft.pwr_dB[i+1]=Math.round(255+10*Math.log10(l*afft.scale+1e-30))}waterfall_queue.push({data:afft.pwr_dB,audioFFT:1,seq:0,spacing:0})}}}function freq_dsp_to_car(e){var t=demodulators[0];if(isUndefined(t))return console.log("freq_dsp_to_car no demod?"),e;var a=t.low_cut+(t.high_cut-t.low_cut)/2;return fcar=t.isCW?e-a:e,fcar<0&&(fcar=0),fcar>bandwidth&&(fcar=bandwidth),fcar}function freq_car_to_dsp(e){var t=demodulators[0];if(isUndefined(t))return e;var a=t.low_cut+(t.high_cut-t.low_cut)/2;return fdsp=t.isCW?e+a:e,fdsp}function passband_offset(){var e=0,t=demodulators[0];return e=isDefined(t)?t.usePBCenter?t.low_cut+(t.high_cut-t.low_cut)/2:0:e}function freq_passband_center(){var e=0,t=demodulators[0];return isDefined(t)&&(e=center_freq+t.offset_frequency,e+=t.low_cut+(t.high_cut-t.low_cut)/2),e}function passband_offset_dxlabel(e){var t=cfg.passbands[e],e=e.substr(0,2);return"us"==e||"ls"==e?t.lo+(t.hi-t.lo)/2:0}function freqmode_set_dsp_kHz(e,t,a){var _=w3_opt(a,"dont_clear_wf",!1),i=w3_opt(a,"open_ext",!1),o=w3_opt(a,"no_set_freq",0);e*=1e3,0==_&&(wf.audioFFT_clear_wf=!0),!isArg(t)||t==cur_mode&&1!=i?(freq_car_Hz=freq_dsp_to_car(e),o||demodulator_set_offset_frequency(owrx.FSET_SET_FREQ,freq_car_Hz-center_freq)):ext_set_mode(t,e,a)}function freqset_car_Hz(e){freq_car_Hz=e}function freq_field_prec(e){var t=1e5-(cfg.max_freq?32e3:3e4);return!(kiwi.freq_offset_kHz>=t)&&cfg.show_1Hz?3:2}function freq_field_width(){var e=1e5-(cfg.max_freq?32e3:3e4);return(kiwi.freq_offset_kHz>=e||cfg.show_1Hz?6.25:5.75)+"em"}function freqset_update_ui(e){var t,a=(freq_displayed_Hz=freq_car_to_dsp(freq_car_Hz))/1e3;freq_displayed_kHz_str=a.toFixed(freq_field_prec(a)),waterfall_setup_done&&(t=w3_el("id-freq-input"),isUndefined(t)||null==t||(a=(freq_displayed_Hz+kiwi.freq_offset_Hz)/1e3,freq_displayed_kHz_str_with_freq_offset=a.toFixed(freq_field_prec(a)),t.value=freq_displayed_kHz_str_with_freq_offset,freqset_select(),0<=(t=-passband_visible()-1)&&waterfall_pan_canvases(t-(x_bin+bins_at_cur_zoom()/2)),check_band(),writeCookie("last_freq",freq_displayed_kHz_str_with_freq_offset),freq_dsp_set_last=freq_displayed_kHz_str_with_freq_offset,freq_step_update_ui(),freq_link_update(),vfo_update(),e!=owrx.FSET_NOP&&e!=owrx.FSET_SCALE_DRAG&&e!=owrx.FSET_SCALE_TOUCH_DRAG&&freq_memory_update(freq_displayed_kHz_str_with_freq_offset),kiwi_clearTimeout(owrx.popup_keyboard_active_timeout),owrx.popup_keyboard_active_timeout=setTimeout(function(){owrx.popup_keyboard_active=!1},2e3)))}function vfo_update(){var e;owrx.vfo_first&&(t=freq_displayed_kHz_str_with_freq_offset+cur_mode+"z"+zoom_level,e=parseInt(initCookie("last_vfo_A",t)),t=parseInt(initCookie("last_vfo_B",t)),freq_displayed_kHz_str_with_freq_offset!=e&&freq_displayed_kHz_str_with_freq_offset==t&&(owrx.vfo_ab=1,w3_flip_colors("id-freq-vfo","w3-aqua w3-orange",owrx.vfo_ab),w3_innerHTML("id-freq-vfo","AB"[owrx.vfo_ab])),owrx.vfo_first=!1);var t=freq_displayed_kHz_str_with_freq_offset+cur_mode+"z"+zoom_level;writeCookie("last_vfo_"+"AB"[owrx.vfo_ab],t)}function popup_keyboard_touchstart(e){owrx.popup_keyboard_active=!0}function freqset_select(){var e=document.activeElement,t=e&&w3_contains(e,"w3-ext-retain-input-focus")&&!extint.displayed,a=e&&(w3_contains(e,"w3-retain-input-focus")||w3_contains(e,"w3-ext-retain-input-focus"));extint.scanning||e&&a&&!t||w3_field_select("id-freq-input",{mobile:1,log:1})}function modeset_update_ui(e){null!=owrx.last_mode_el&&(owrx.last_mode_el.style.color="white");var t=e.substr(0,2);"qa"==t&&(t="sa");var a=w3_el("id-mode-"+t);a.innerHTML=e.toUpperCase(),a&&a.style&&(a.style.color="lime"),owrx.last_mode_el=a,squelch_setup(toggle_e.FROM_COOKIE),writeCookie("last_mode",e),freq_link_update(),vfo_update();var _=ext_is_IQ_or_stereo_mode(e);w3_els("id-button-compression",function(e){w3_set_props(e,"w3-disabled",_)}),w3_hide2("id-sam-carrier-container","sa"!=t),w3_hide2("id-chan-null","sam"!=e)}function try_freqset_update_ui(e){waterfall_setup_done?(freqset_update_ui(e),wf.audioFFT_active?(cur_mode!=wf.audioFFT_prev_mode&&(wf.audioFFT_clear_wf=!0),audioFFT_update(),wf.audioFFT_prev_mode=cur_mode):mkenvelopes(get_visible_freq_range())):setTimeout(try_freqset_update_ui,1e3,e)}function try_modeset_update_ui(e){waterfall_setup_done?modeset_update_ui(e):setTimeout(function(){try_modeset_update_ui(e)},1e3)}function freq_link_update(){var e=kiwi_url_origin()+"/?f="+freq_displayed_kHz_str_with_freq_offset+cur_mode+"z"+zoom_level;w3_innerHTML("id-freq-link",w3_icon("w3-text-css-lime||title="+dq("copy to clipboard:\n"+e),"fa-external-link-square",15,"","freq_link_update_cb",e))}function freq_link_update_cb(e,t,a){a||w3_copy_to_clipboard(t)}function freqset_complete(e){var t=w3_el("id-freq-input");if(kiwi_clearTimeout(freqset_tout),!isUndefined(t)&&null!=t){var a,_=t.value.split(/[\/\+\:\;]/),i=t.value.includes("/")||t.value.includes("+"),o=_[0].replace(",",".").parseFloatWithUnits("M",.001),n=!0;if("/"==t.value||"+"==t.value)return restore_passband(cur_mode),demodulator_analog_replace(cur_mode),void freqset_update_ui(owrx.FSET_NOP);0<o&&!isNaN(o)&&0<(o-=kiwi.freq_offset_kHz)&&!isNaN(o)&&(freqmode_set_dsp_kHz(o,null),w3_field_select(t,{mobile:1,log:2}),n=!1),n&&freqset_update_ui(owrx.FSET_NOP),_[1]&&(p2=_[1].split(","),o=p2[0].parseFloatWithUnits("k"),t=NaN,1<p2.length&&(t=p2[1].parseFloatWithUnits("k")),_=((n=ext_get_passband()).high-n.low)/2,n=n.low+_,i?1==p2.length&&(o=n-(a=o/2),t=n+a):(n=o,t=1==p2.length?(o=n-_,n+_):(o=n-(a=Math.abs(t/2)),n+a)),ext_set_passband(o,t,!0))}}var ignore_next_keyup_event=!1;function freqset_keyup(e,t){if(kiwi_clearTimeout(freqset_tout),null!=t&&null!=t.key){var a=t.key.length;if(any_alternate_click_event_except_shift(t)||1!=a&&"Backspace"!=t.key)return"Escape"==t.key&&freqset_update_ui(owrx.FSET_NOP),void(ignore_next_keyup_event=!1)}ignore_next_keyup_event?ignore_next_keyup_event=!1:kiwi_isMobile()||(freqset_tout=setTimeout(function(){freqset_complete("t/o")},3e3))}var freq_step_last_mode,freq_step_last_band,num_step_buttons=6,up_down={am:[0,-1,-.1,.1,1,0],amn:[0,-1,-.1,.1,1,0],sam:[0,-1,-.1,.1,1,0],sal:[0,-1,-.1,.1,1,0],sau:[0,-1,-.1,.1,1,0],sas:[0,-1,-.1,.1,1,0],qam:[0,-1,-.1,.1,1,0],drm:[0,-1,-.1,.1,1,0],usb:[0,-.1,-.01,.01,.1,0],usn:[0,-.1,-.01,.01,.1,0],lsb:[0,-.1,-.01,.01,.1,0],lsn:[0,-.1,-.01,.01,.1,0],cw:[0,-.1,-.01,.01,.1,0],cwn:[0,-.1,-.01,.01,.1,0],nbfm:[-5,-1,-.1,.1,1,5],iq:[0,-1,-.1,.1,1,0]},NDB_400_1000_mode=1;function freq_step_amount(e){var t=cur_mode.substr(0,2),a="ls"==t||"us"==t||"cw"==t,_=a?1e3:5e3,i=a?" 1k default":" 5k default",o="am"==t||"sa"==t||"qa"==t||"ls"==t||"us"==t||"iq"==t||"dr"==t,a=2==cfg.init.ITU_region+1&&e&&"75m"==e.name;return e&&"NDB"==e.name?("cw"==t&&(_=NDB_400_1000_mode),i=" NDB"):!e||"LW"!=e.name&&"MW"!=e.name?(t=e?band_svc_lookup(e.svc):null)&&t.o.name.includes("Broadcast")&&!a?o&&(_=5e3,i=" SWBC 5k"):e&&0!=e.chan&&(_=1e3*e.chan,i=" band="+e.name+" chan_kHz="+e.chan):(o&&(_=step_9_10?9e3:1e4),i=" LW/MW"),{step_Hz:_,s:i}}function special_step(e,t,a){a=freq_step_amount(e),e=a.step_Hz;return a.s,e=t<num_step_buttons/2?-e:e,e}function freqstep(e,t){var a=1e3*up_down[cur_mode][e];0==a&&(a=special_step(find_band(freq_displayed_Hz),e,"freqstep"));var _=freq_displayed_Hz,i=Math.abs(a),o=0<=a?1:0,e=_/i;e=(o?Math.ceil(e):Math.floor(e))*i,i==NDB_400_1000_mode?1!=t?(i=_%1e3,i=o?i<400?400:i<600?600:1e3:0==i?-400:i<=400?0:i<=600?400:600,_=(e=1e3*Math.floor(_/1e3))+i):_+=1e3*Math.sign(a):1!=t&&freq_displayed_Hz!=e?_=e:_+=a,freqmode_set_dsp_kHz(_/1e3,null,{dont_clear_wf:!0})}function freq_step_update_ui(e){if(!isUndefined(cur_mode)&&null!=cfg.passbands[cur_mode]){var t=find_band(freq_displayed_Hz);if(e||freq_step_last_mode!=cur_mode||freq_step_last_band!=t){e=cur_mode.substr(0,2),e="am"==e||"sa"==e||"qa"==e||"iq"==e||"dr"==e,e=!(!t||"LW"!=t.name&&"MW"!=t.name||!e);kiwi_isMobile()?w3_hide2("id-9-10-cell",!e):(w3_hide2("id-9-10-cell",!1),w3_disable("id-9-10-cell",!e));for(var a=0;a<num_step_buttons;a++){var _=1e3*up_down[cur_mode][a];0==_&&(_=special_step(t,a,"freq_step_update_ui"));var i=Math.abs(_),o=0<=_?1:0,o=1e3<=i?(o?"+":"")+(_/1e3).toString()+"k":i!=NDB_400_1000_mode?(o?"+":"")+_.toString():(o?"+":"-")+"400/"+(o?"+":"-")+"1000";html("id-step-"+a).title=o}freq_step_last_mode=cur_mode,freq_step_last_band=t}}}function freq_memory_init(){var a,_;isNonEmptyString(owrx.override_fmem)?(a=owrx.override_fmem.split(","),_=cfg.show_1Hz?3:2,a.forEach(function(e,t){e=(e=isNumber(e)?e.toString():e).parseFloatWithUnits("kM",.001);isNumber(e)&&(a[t]=w3_clamp(e,1,cfg.max_freq?32e3:3e4).toFixed(_))})):a=kiwi_JSON_parse("freq_memory_init",readCookie("freq_memory")),a&&(owrx.freq_memory=kiwi_dedup_array(a,function(e){var t={err:!1};return e=+e,!isNumber(e)||e<=0?t.err=!0:t.v=e.toString(),t}))}function freq_memory_menu_init(){w3_menu("id-freq-memory-menu","freq_memory_menu_cb")}function freq_memory_menu_show(e){var t,a;w3_isVisible("id-freq-memory-menu")?owrx.freq_memory_menu_shown=0:(owrx.freq_memory_menu_shown=1,t=owrx.last_pageX,a=owrx.last_pageY,1!=e&&(t+=0<=t-128?-128:16),(e=kiwi_dup_array(owrx.freq_memory)).push("clear all"),w3_menu_items("id-freq-memory-menu",e,Math.min(e.length,10)),w3_menu_popup("id-freq-memory-menu",function(e,t){var a="keyup"==e.type&&("m"!=e.key||!owrx.freq_memory_menu_shown),_=w3_contains(e.target,"w3-menu"),i=w3_contains(e.target,"w3-menu-button"),o=owrx.freq_memory_menu_shown,e="click"==e.type||("mousedown"==e.type||"touchstart"==e.type)&&!i||"touchend"==e.type;return a||!(!e||t||_&&o)},t,a))}function freq_memory_update(e){isNumber(+e)&&((e=e<1?"1":e)!=owrx.freq_memory[0]&&(owrx.freq_memory.unshift(e),owrx.freq_memory=kiwi_dedup_array(owrx.freq_memory)),25<owrx.freq_memory.length&&owrx.freq_memory.pop(),writeCookie("freq_memory",JSON.stringify(owrx.freq_memory)))}function freq_memory_menu_cb(e,t){var a;-1!=(e=+e)&&(e>=owrx.freq_memory.length?(a=owrx.freq_memory[0],owrx.freq_memory=[a]):(a=owrx.freq_memory[e],owrx.freq_memory.unshift(a),owrx.freq_memory=kiwi_dedup_array(owrx.freq_memory),25<owrx.freq_memory.length&&owrx.freq_memory.pop()),freqmode_set_dsp_kHz(a-kiwi.freq_offset_kHz))}function band_info(){var e,t,a=+cfg.init.AM_BCB_chan?10:9,_=cfg.init.ITU_region+1,i=1==_?(e=283.5,t=526.5,1606.5):2==_?(e=190.5,t=540-a/2,1700+a/2):(e=190.5,t=540-a/2,1602+a/2);return{ITU_region:_,_9_10:a,LW_lo:148.5,NDB_lo:e,NDB_hi:t,MW_hi:i}}function band_svc_lookup(a){var _=null;return cfg.band_svc.forEach(function(e,t){e.key==a&&(_=t)}),null==_?(console.log("$$$ band_svc_lookup NO KEY MATCH for <"+a+">"),null):{o:cfg.band_svc[_],i:_}}function bands_init(){var e,t,a,_;if(cfg.bands&&cfg.band_svc&&cfg.dx_type)return console.log("BANDS: using stored cfg.bands"),bands_addl_info(),void dx_color_init();console.log("BANDS: using old config.js::bands"),cfg.dx_type=[];var i=-1;for(dx.legacy_stored_types.forEach(function(e,t){cfg.dx_type[t]={key:t,name:dx.legacy_stored_types[t],color:dx.legacy_stored_colors[t]},i=t}),t=dx_type2idx(dx.DX_MASKED),e=i+1;e<t;e++)cfg.dx_type[e]={key:e,name:"",color:""};for(cfg.dx_type[t]={key:e,name:"masked",color:"lightGrey"},dx_color_init(),cfg.band_svc=[],w3_obj_enum(svc,function(e,t,a){"X"==e&&"Beacons"==a.name&&(svc.L=svc.X,e="L",delete svc.X),console.log("key="+e),svc[e].key=e,cfg.band_svc[t]={key:e,name:a.name,color:a.color},"Industrial/Scientific"==a.name&&(cfg.band_svc[t].name="ISM",cfg.band_svc[t].longName="Industrial/Scientific")}),kiwi.cfg_bands_new=[],e=t=0;e<bands.length;e++){if("LW"==(s=bands[e]).name&&"E"==s.region&&(s.region="1"),"LW"==s.name&&">"==s.region&&(s.region="23"),"MW"!=s.name||"3"!=s.region&&">3"!=s.region||(s.region="13"),"NDB"==s.name&&"E"==s.region&&(s.region="1"),"NDB"==s.name&&"U"==s.region&&(s.region="2"),"NDB"==s.name&&">"==s.region&&(s.region="3"),"MF"==s.name&&">23"==s.region&&(s.region="*"),s.name.startsWith("Time ")&&"*"==s.region&&(s.region="m"),s.region){var o=s.region.length;if(1==o){kiwi.cfg_bands_new[t]=kiwi_shallow_copy(s),_=kiwi.cfg_bands_new[t],t++;var n=_.region.charAt(0);_.itu="1"<=n&&n<="3"?ord(n,"1")+1:"*"==n||">"==n?kiwi.ITU_ANY:"m"==n?kiwi.BAND_MENU_ONLY:kiwi.BAND_SCALE_ONLY,console.log("R"+n+"="+_.itu+" "+dq(s.name)),console.log(_)}else for(a=0;a<o;a++)">"!=(n=s.region.charAt(a))&&(kiwi.cfg_bands_new[t]=kiwi_shallow_copy(s),_=kiwi.cfg_bands_new[t],t++,_.itu="1"<=n&&n<="3"?ord(n,"1")+1:kiwi.BAND_SCALE_ONLY,console.log("R"+n+"="+_.itu+" "+dq(s.name)),console.log(_))}else kiwi.cfg_bands_new[t]=kiwi_shallow_copy(s),(_=kiwi.cfg_bands_new[t]).itu=kiwi.ITU_ANY,t++,console.log("DEFAULT ITU_ANY="+_.itu+" "+dq(s.name)),console.log(_);isNumber(_.sel)&&(_.sel=_.sel.toFixed(2)),isUndefined(_.s)&&(_.s=svc.L),"L"!=_.s.key&&"X"!=_.s.key||!_.sel.includes("cw")||"m"!=_.region||(_.name.includes("IBP")||(_.name="IBP "+_.name),_.sel.includes("cwn")||(_.sel=_.sel.replace("cw","cwn"))),_.name.includes("IBP")&&(_.s="L")}for(e=0;e<kiwi.cfg_bands_new.length;e++)_=kiwi.cfg_bands_new[e],isString(_.s)?_.svc=_.s:isObject(_.s)?_.svc=_.s.key:console.log("$$$ t/o(bnew.svc)="+typeof _.s),delete _.s,delete _.region;for(cfg.bands=[],e=0;e<kiwi.cfg_bands_new.length;e++){var s,r=(s=kiwi.cfg_bands_new[e]).sel||"";cfg.bands.push({min:s.min,max:s.max,name:s.name,svc:s.svc,itu:s.itu,sel:r,chan:s.chan})}console.log("kiwi.cfg_bands_new"),console.log(kiwi.cfg_bands_new),bands_addl_info()}function bands_addl_info(){var e,t,a,_=kiwi.freq_offset_kHz;for(console.log("BANDS: creating additional info in kiwi.bands"),kiwi.bands=[],e=0;e<cfg.bands.length;e++){t=cfg.bands[e],a=kiwi.bands[e]={},cfg.bands[e].chan=isUndefined(t.chan)?0:t.chan;var i=t.min,o=t.max;_&&t.min>=_?(i-=_,o-=_,a.isOffset=!0):32e3<t.min?a.isOffset=!0:1!=a.isOffset&&(a.isOffset=!1),a.minHz=1e3*i,a.maxHz=1e3*o,a.chanHz=1e3*t.chan;for(var n=a.maxHz-a.minHz,s=zoom_nom;0<=s;s--)if(n<=.8*(bandwidth/(1<<s)))break;a.zoom_level=s,a.cfHz=a.minHz+(a.maxHz-a.minHz)/2;o=band_svc_lookup(t.svc);null!=o?(o=o.o.longName||o.o.name,a.longName=t.name+" "+o):a.longName=t.name}}var maxdb,mindb_un,mindb,full_scale,band_menu=[];function setup_band_menu(){var e=0,t=null,a='<option value="0" selected disabled>select band</option>';band_menu[e++]=null;for(var _=cfg.init.ITU_region+1,i=0;i<cfg.bands.length;i++){var o=cfg.bands[i],n=kiwi.bands[i];if(kiwi.isOffset){if(!n.isOffset)continue}else if(n.isOffset)continue;if(o.itu==kiwi.BAND_MENU_ONLY||o.itu==kiwi.ITU_ANY||o.itu==_){if(t!=o.svc){var t=o.svc,s=band_svc_lookup(o.svc);if(!s)continue;a+="<option value="+dq(e)+" disabled>"+s.o.name.toUpperCase()+"</option>",band_menu[e++]=null}a+="<option value="+dq(e)+">"+o.name+"</option>",band_menu[e]={},band_menu[e].b1=o,band_menu[e].b2=n,e++}}return a}function mk_band_menu(){band_menu=[],owrx.last_selected_band=0,w3_innerHTML("id-select-band",setup_band_menu())}function find_band(e){for(var t=cfg.init.ITU_region+1,a=0;a<cfg.bands.length;a++){var _=cfg.bands[a],i=kiwi.bands[a];if(_.itu==kiwi.BAND_SCALE_ONLY||_.itu==kiwi.ITU_ANY||_.itu==t){var o="MW"==_.name?171e4:i.maxHz;if(e>=i.minHz&&e<=o)return _}}return null}function mk_bands_scale(){var e=band_ctx.canvas.width,t=band_scale_top,a=band_scale_h,_=t+band_scale_text_top,i=g_range.start,o=g_range.end;band_ctx.globalAlpha=1,band_ctx.fillStyle="White",band_ctx.fillRect(0,band_canvas_top,e,band_canvas_h);for(var n=cfg.init.ITU_region+1,s=0;s<cfg.bands.length;s++){var r,l,d,c,f,w,u=cfg.bands[s],p=kiwi.bands[s];if(kiwi.isOffset){if(!p.isOffset)continue}else if(p.isOffset)continue;u.itu!=kiwi.BAND_SCALE_ONLY&&u.itu!=kiwi.ITU_ANY&&u.itu!=n||(c=-1,f=p.minHz,d=i<=(w=p.maxHz)&&w<=o?1:0,(l=i<=f&&f<=o?1:0)&&d?(c=f,r=w):!l&&d?(c=i,r=w):l&&!d?(c=f,r=o):f<i&&o<w&&(c=i,r=o),-1!=c&&(f=scale_px_from_freq(c,g_range),(w=scale_px_from_freq(r,g_range)-f)<3||(c=band_svc_lookup(u.svc),band_ctx.fillStyle=c?c.o.color:"grey",band_ctx.globalAlpha=.2,band_ctx.fillRect(f,t,w,a),band_ctx.globalAlpha=1,band_ctx.font="bold 12px sans-serif",band_ctx.textBaseline="top",c=f+w/2,f=p.longName,w>=(p=band_ctx.measureText(f)).width+4||(f=u.name,w>=(p=band_ctx.measureText(f)).width+4||(f=null)),f&&band_ctx.fillText(f,c-p.width/2,_))))}}function parse_freq_pb_mode_zoom(e){return new RegExp("([0-9.,kM]*)([/:][-0-9.,k]*)?([^z]*)?z?([0-9]*)").exec(e)}function band_scroll(e){for(var t,a=owrx.last_selected_band;(a=(a+=e)<0?band_menu.length-1:a)>=band_menu.length&&(a=0),t=band_menu[a],null==t;);select_band(a),w3_set_value("id-select-band",a)}function select_band(e,t){var a,_,i,o,n=+e;if(isNumber(n))null!=(o=band_menu[n])?(a=o.b1,_=o.b2,dbgUs&&(console.log(o),console.log(a),console.log(_)),""!=a.sel?(i=parseFloat(a.sel),isUndefined(t)&&(t=-1==(t=a.sel.search(/[a-z]/i))?null:a.sel.slice(t))):i=_.cfHz/1e3,owrx.last_selected_band=n,dbgUs&&(sb_trace=0),freqmode_set_dsp_kHz(i,t),zoom_step(ext_zoom.TO_BAND,o)):check_band(!0);else{for(var s=0;s<band_menu.length-1&&(!band_menu[s]||band_menu[s].b1.name!=e);s++);s<band_menu.length-1&&select_band(s,t)}}function check_band(e){var t,a,_;owrx.last_selected_band&&((_=band_menu[owrx.last_selected_band]).b1,t=_.b2,a=freq_car_Hz,_=freq_passband_center(),(null!=e&&-1==e||(a<t.minHz||a>t.maxHz)&&(_<t.minHz||_>t.maxHz))&&(w3_select_value("id-select-band",0),owrx.last_selected_band=0))}function tune(e,t,a,_){ext_tune(e,t,ext_zoom.ABS,a,_)}function init_scale_dB(){maxdb=init_max_dB,mindb_un=init_min_dB,mindb=mindb_un-zoomCorrection(),full_scale=(full_scale=maxdb-mindb)||1,wf.save_maxdb=maxdb,wf.save_mindb_un=mindb_un,wf.auto_ceil.val=+initCookie("last_ceil_dB",cfg.init.ceil_dB),wf.auto_floor.val=+initCookie("last_floor_dB",cfg.init.floor_dB)}band_canvas_h=30,band_canvas_top=0,band_scale_h=20,band_scale_top=5,band_scale_text_top=5,dx_container_h=80,dx_container_top=band_canvas_h,dx_label_top=5,dx_line_h=dx_container_h-dx_label_top,scale_canvas_h=47,scale_canvas_top=band_canvas_h+dx_container_h,scale_container_h=band_canvas_h+dx_container_h+scale_canvas_h;var cal_adc_new_adj,confirmation={displayed:!1,close_cb:null};function confirmation_panel_init(){w3_el("id-panels-container").innerHTML+=w3_div('id-confirmation class-panel|border: 1px solid white|data-panel-name="confirmation" data-panel-pos="center" data-panel-order="0" data-panel-size="600,100"'),w3_innerHTML("id-confirmation",w3_divs("id-confirmation-container/class-panel-inner")+w3_div("id-confirmation-vis class-vis"))}function confirmation_panel_set_close_func(e){w3_el("id-confirmation-close").onclick=e,confirmation.close_cb=e}function confirmation_panel_init2(){confirmation_panel_set_close_func(confirmation_panel_close),w3_el("id-kiwi-body").addEventListener("keyup",function(e){"Escape"==e.key&&(confirmation.close_cb(),toggle_or_set_hide_panels(0))},!0)}function confirmation_show_content(e,t,a,_,i){confirmation.displayed&&w3_color("id-confirmation",null,""),w3_innerHTML("id-confirmation-container",e),w3_color("id-confirmation",null,i),_&&confirmation_panel_set_close_func(_),confirmation_panel_show(t,a),toggle_or_set_hide_panels(0)}function confirmation_panel_show(e,t){el=w3_el("id-confirmation"),el.style.zIndex=1020,confirmation_panel_resize(e=null==e?525:e,t=null==t?80:t),confirmation.displayed=!confirmation.displayed,toggle_panel("id-confirmation")}function confirmation_panel_resize(e,t){var a=w3_el("id-confirmation");panel_set_width_height("id-confirmation",e,t),a.style.left=px(window.innerWidth/2-a.activeWidth/2),a.style.bottom=px(window.innerHeight/2-a.uiHeight/2)}function confirmation_panel_close(){confirmation.displayed&&(w3_color("id-confirmation",null,""),toggle_panel("id-confirmation"),confirmation_panel_set_close_func(confirmation_panel_close),confirmation.displayed=!1)}function set_freq_offset_dialog(){confirmation_show_content(w3_col_percent("/w3-text-aqua",w3_input_get("","Frequency scale offset (kHz, 1 Hz resolution)","cfg.freq_offset","w3_float_set_cfg_cb|3"),80),525,80),w3_field_select("id-cfg.freq_offset",{mobile:1})}function cal_adc_dialog(e,t,a,_){var i;confirmation_show_content((cfg.ADC_clk_corr&&3<ext_adc_gps_clock_corr()?1:0)?w3_col_percent("/w3-valign",w3_div("w3-show-inline-block","GPS is automatically correcting ADC clock. <br> No manual calibration available.")+w3_button("w3-red w3-margin-left","Close","confirmation_panel_close"),80):(cal_adc_new_adj=e)<-(i=100*ext_adc_clock_nom_Hz()/1e6)||i<e?(console.log("cal ADC clock: ADJ TOO LARGE"),w3_col_percent("/w3-valign",w3_div("w3-show-inline-block","ADC clock adjustment too large: "+t+" Hz<br>(ADC clock "+_.toFixed(1)+" ppm, limit is +/- 100 ppm)")+w3_button("w3-red w3-margin-left","Close","confirmation_panel_close"),80)):w3_col_percent("/w3-valign",w3_div("w3-show-inline-block","ADC clock will be adjusted by<br>"+t+" Hz to "+a+" kHz<br>(ADC clock "+_.toFixed(1)+" ppm)")+w3_button("w3-green w3-margin-left","Confirm","cal_adc_confirm")+w3_button("w3-red w3-margin-left","Cancel","confirmation_panel_close"),80),525,70)}function cal_adc_confirm(){ext_send("SET clk_adj="+cal_adc_new_adj),ext_set_cfg_param("cfg.clk_adj",cal_adc_new_adj,!0),confirmation_panel_close()}function admin_pwd_query(e){ext_hasCredential("admin",admin_pwd_cb,e,ws_wf)}function admin_pwd_cb(e,t){console.log("admin_pwd_cb badp="+e),e?(confirmation_show_content(w3_col_percent("/w3-text-aqua",w3_input("kiwi-pw","Admin password","admin.pwd","","admin_pwd_cb2"),80),525,80),w3_field_select("id-admin.pwd",{mobile:1})):t()}function admin_pwd_cb2(e,t){w3_string_cb(e,t),confirmation_panel_close(),ext_valpwd("admin",t,ws_wf)}var dx={DB_STORED:0,DB_EiBi:1,db:0,db_s:["stored (writeable)","EiBi-B21 (read-only)"],db_flip_s:["EiBi","stored"],url_p:null,help:!1,ignore_dx_update:!1,DX_STEP:2,DX_JSON:0,DX_CSV:1,IDX_USER:null,UPD_MOD:0,UPD_ADD:1,o:{},legacy_stored_types:["active","watch-list","sub-band","DGPS","special event","interference"],legacy_stored_colors:["cyan","lightPink","aquamarine","lavender","violet","violet","lightGrey"],stored_colors_light:[],stored_lightness:.95,stored_filter_tod:1,dow_colors:["lightCoral","lightSalmon","gold","yellowGreen","springGreen","deepSkyBlue","violet"],eibi_colors:[],eibi_hue:["cyan",300,"deepSkyBlue","silver",50,"peachPuff","mediumAquaMarine",270,180,70,"springGreen",0],eibi_light:[0,80,0,0,70,0,0,80,80,45,0,75],eibi_colors_light:[],eibi_lightness:.9,eibi_svc_s:["Bcast","Utility","Time","ALE","HFDL","Milcom","CW","FSK","Fax","Aero","Maritime","Spy"],eibi_ext:["","","time","ale","hfdl","","cw","fsk","fax","","",""],eibi_filter_tod:1,DX_MODE:15,DX_TYPE:496,DX_TYPE_SFT:4,DX_N_STORED:16,DX_STORED:0,DX_QUICK_0:0,DX_QUICK_1:16,DX_MASKED:240,DX_N_EiBi:12,DX_EiBi:256,DX_BCAST:256,DX_UTIL:272,DX_TIME:288,DX_ALE:304,DX_HFDL:320,DX_MILCOM:336,DX_CW:352,DX_FSK:368,DX_FAX:384,DX_AERO:400,DX_MARINE:416,DX_SPY:432,DX_DOW_SFT:9,DX_DOW:65024,DX_MON:32768,DX_FLAGS:4294901760,DX_FILTERED:65536,DX_HAS_EXT:131072,eibi_types_mask:4294967295,list:[],displayed:[],filter_ident:"",filter_notes:"",filter_case:0,filter_wild:0,filter_grep:0,ctrl_click:!1};function dx_init(){dx.DX_DOW_BASE=dx.DX_DOW>>dx.DX_DOW_SFT,null!=(dx.url_p=kiwi_url_param("dx","",null))&&(dx.db=dx.DB_EiBi,w3_do_when_cond(function(){var e=w3_el("id-ext-controls");return!!e&&e.init},function(){var a;console.log('DX url_p="'+dx.url_p+'"'),""!=dx.url_p&&dx.url_p.split(",").forEach(function(e,t){console.log("DX url_p=<"+e+">"),w3_ext_param("help",e).match?dx.help=!0:0==t&&0==e?(dx.db=dx.DB_STORED,dx.stored_filter_tod=0,freq_displayed_kHz_str="0",cur_mode="am"):w3_ext_param("none",e).match?(dx.eibi_types_mask=0,console.log("SET none dx.eibi_types_mask="+dx.eibi_types_mask)):(a=w3_ext_param("filter",e)).match?dx.db==dx.DB_STORED?(dx.stored_filter_tod=a.has_value?a.num:1,console.log("SET stored_filter_tod="+dx.eibi_filter_tod+" r.has_value="+a.has_value+" r.num="+a.num)):(dx.eibi_filter_tod=a.has_value?a.num:1,console.log("SET eibi_filter_tod="+dx.eibi_filter_tod+" r.has_value="+a.has_value+" r.num="+a.num)):w3_ext_param_array_match_str(dx.eibi_svc_s,e,function(e,t){var a=dx.eibi_types_mask&1<<e;a?dx.eibi_types_mask&=~(1<<e):dx.eibi_types_mask|=1<<e,console.log("MATCH "+t+" v="+a.toHex(8)+"("+e+") dx.eibi_types_mask="+dx.eibi_types_mask.toHex(8))})}),console.log("FINAL dx.eibi_types_mask="+dx.eibi_types_mask.toHex(8)+" dx.help="+dx.help),dx_show_edit_panel(null,-1),dx_schedule_update()},0,500))}function dx_type2idx(e){return(e=e&dx.DX_TYPE)>=dx.DX_EiBi&&(e-=dx.DX_EiBi),e>>dx.DX_TYPE_SFT}function dx_eibi_type2mask(e){return 1<<dx_type2idx(e)}function dx_set_type(e){dx.eibi_types_mask=dx_eibi_type2mask(e)}function dx_is_single_type(e){return dx.db==dx.DB_EiBi&&dx.eibi_types_mask==dx_eibi_type2mask(e)}function dx_color_init(){for(var e=0;e<cfg.dx_type.length;e++){var t=cfg.dx_type[e],t=""==t.color?"white":t.color,t=w3color(t);t.valid&&(t.lightness=dx.stored_lightness,dx.stored_colors_light[e]=t.toHslString())}dx.eibi_hue.forEach(function(e,t){isString(e)?dx.eibi_colors[t]=e:dx.eibi_colors[t]="hsl("+e+",100%,"+dx.eibi_light[t]+"%)";e=w3color(dx.eibi_colors[t]);e.lightness=dx.eibi_lightness,dx.eibi_colors_light[t]=e.toHslString()});for(e=0;e<dx.DX_N_EiBi;e++)w3_color("eibi-cbox"+e+"-label","black",dx.eibi_colors[e])}function dx_update_request(){w3_do_when_cond(function(){return waterfall_setup_done},function(){dx_update(),bands_init(),mk_bands_scale(),mk_band_menu()},0,200)}var dx_update_timeout,dx_update_delay=350,dx_seq=0;function dx_schedule_update(){kiwi_clearTimeout(dx_update_timeout),dx_div.innerHTML="",dx_update_timeout=setTimeout(dx_update,dx_update_delay)}function dx_update(){var e=dx.db==dx.DB_EiBi;dx_seq++;var t=ext_panel_displayed("HFDL")&&dx_is_single_type(dx.DX_HFDL)&&4<=zoom_level?0:1;wf_send("SET MARKER db="+dx.db+" min="+(g_range.start/1e3).toFixed(3)+" max="+(g_range.end/1e3).toFixed(3)+" zoom="+zoom_level+" width="+waterfall_width+" eibi_types_mask="+dx.eibi_types_mask.toHex()+" filter_tod="+(e?dx.eibi_filter_tod:dx.stored_filter_tod)+" anti_clutter="+t),kiwi_clearTimeout(dx.dx_refresh_timeout),(e&&dx.eibi_filter_tod||!e&&dx.stored_filter_tod)&&(e=3e5-Date.now()%3e5,dx.dx_refresh_timeout=setTimeout(function(){dx_div.innerHTML="",dx_update()},2e3+e))}var dx_ibp_list,dx_ibp_interval,dx_ibp_server_time_ms,dx_keys,dx_z_save,dx_bg_color_save,smeter_width,dx_ibp_local_time_epoch_ms=0,dx_ibp_freqs={14:0,18:1,21:2,24:3,28:4},dx_ibp_lastsec=0,dx_ibp_stations={"4U1UN":{value:0,text:"New York"},VE8AT:{value:1,text:"Nunavut"},W6WX:{value:2,text:"California"},KH6RS:{value:3,text:"Hawaii"},ZL6B:{value:4,text:"New Zealand"},VK6RBP:{value:5,text:"Australia"},JA2IGY:{value:6,text:"Japan"},RR9O:{value:7,text:"Siberia"},VR2B:{value:8,text:"Hong Kong"},"4S7B":{value:9,text:"Sri Lanka"},ZS6DN:{value:10,text:"South Africa"},"5Z4B":{value:11,text:"Kenya"},"4X6TU":{value:12,text:"Israel"},OH2B:{value:13,text:"Finland"},CS3B:{value:14,text:"Madeira"},LU4AA:{value:15,text:"Argentina"},OA4B:{value:16,text:"Peru"},YV5B:{value:17,text:"Venezuela"}};function dx_label_cb(s){var e=s[0],t=dx.db==dx.DB_EiBi,r=t?40:35;if(dx_color_init(),e.t!=dx.DX_STEP){if(kiwi_clearInterval(dx_ibp_interval),dx_ibp_list=[],dx_ibp_server_time_ms=1e3*e.s+ +e.m,dx_ibp_local_time_epoch_ms=Date.now(),t)for(l=0;l<dx.DX_N_EiBi;l++)isDefined(e.ec[l])&&w3_innerHTML("eibi-cbox"+l+"-label",dx.eibi_svc_s[l]+" ("+e.ec[l]+")");dx.types_n=e.tc,dx_filter_field_err(+e.f);var a=120;dx_div.innerHTML="",dx.displayed=[],dx.last_ident="",dx.last_freq=-1,dx.post_render=[],dx.color_fixup=[],dx.f_same=[];function _(e,t,a){var _,i=Math.ceil(r/6);for(dx.font&&(dx.f_same.forEach(function(e,t){e=s[++e];e.di=kiwi_decodeURIComponent("",e.i),e.tw=getTextWidth(e.di,dx.font)}),dx.f_same.sort(function(e,t){e=s[e+1];return s[t+1].tw-e.tw})),_=0;_<=dx.f_same.length;_++){var o=dx.f_same[_],n=_%(i+1);dx.post_render[o]={top:dx_label_top+6*n,ltop:dx_label_top,x:e+5*n,z:t+_},n==i&&(e+=r)}}for(var i,o=0,n=[],l=1;l<s.length;l++){var d,c,f,w,u,p,m,h,g=l-1,x=(d=s[l]).fl,b=x&dx.DX_TYPE,v=dx_type2idx(b),k=x&dx.DX_FILTERED,y=d.i;t&&y==dx.last_ident?0==k&&(dx.color_fixup[dx.last_idx]=dx.eibi_colors[v]):(dx.last_idx=g,dx.last_ident=y,c=d.g,A=d.f,f=d.o,E=isDefined(d.n)?d.n:"",w=isDefined(d.p)?d.p:"",t&&x&dx.DX_HAS_EXT&&(w=dx.eibi_ext[dx_type2idx(b)]),p=scale_px_from_freq(u=(m=1e3*A)+passband_offset_dxlabel(kiwi.modes_l[x&dx.DX_MODE]),g_range)-1,b=0,m=m-f,f&&(b=scale_px_from_freq(m,g_range)),t&&u==dx.last_freq?(dx.f_same.push(g),i=p,0==o&&(o=a)):t&&(2<dx.f_same.length&&_(i,o,dx.last_freq),dx.f_same=[],dx.f_same.push(g),o=0),D=dx_label_top+r*(1&g),dx.post_render[g]={top:D,ltop:D,x:p},dx.last_freq=u,h=t?(k?dx.eibi_colors_light:dx.eibi_colors)[v]:(""==(h=cfg.dx_type[v].color)&&(h="white"),k?dx.stored_colors_light[v]:h),t||0!=v||"IBP"!=y&&"IARU%2fNCDXF"!=y||(h="aquamarine"),m/=1e3,dx.list[c]={gid:c,carrier:m,lo:d.lo,hi:d.hi,freq:A,moff:f,flags:x,begin:d.b,end:d.e,ident:y,notes:E,params:w},dx.displayed[g]=dx.list[c],x=""!=w?" id-has-ext":"",n[g]='<div id="'+g+'-id-dx-label" class="cl-dx-label '+(k?"cl-dx-label-filtered":"")+" "+c+"-id-dx-gid"+x+'" style="left:'+(p-10)+"px; z-index:"+a+"; background-color:"+h+';" onmouseenter="dx_enter(this,'+b+', event)" onmouseleave="dx_leave(this,'+b+')" onmousedown="ignore(event)" onmousemove="ignore(event)" onmouseup="ignore(event)" ontouchmove="ignore(event)" ontouchend="ignore(event)" onclick="dx_click(event,'+c+')" ontouchstart="dx_click(event,'+c+')" name="'+(""==w?0:1)+'"></div><div class="cl-dx-line" id="'+g+'-id-dx-line" style="left:'+p+'px; z-index:110"></div>',a++)}t&&2<dx.f_same.length&&_(i,o);var q="";for(l=0;l<s.length-1;l++)isDefined(n[l])&&(q+=n[l]);dx_div.innerHTML=q,dx.last_ident="",dx.font||(S=w3_el("0-id-dx-label"))&&(dx.font=css_style(S,"font-size")+" "+css_style(S,"font-family"),console_log_dbgUs("dx.font=<"+dx.font+">"));function T(e,t){var a="",_=e.fl&dx.DX_DOW;if(_==dx.DX_DOW&&(_=0),0==e.b&&0==e.e&&(e.e=2400,kiwi_trace("$SHOULD NOT OCCUR")),_)for(var i=0;i<7;i++)a+=dx.DX_MON>>i&_?"MTWTFSS"[i]:"_";else a="7-days";var o=e.b.leadingZeros(4)+"-"+e.e.leadingZeros(4)+" "+a;return t||(o+=(t=(t="")!=e.l&&"-"!=e.l.charAt(0)?" lang: "+e.l:t)+" target: "+e.t),o}var S;for(l=1;l<s.length;l++){g=l-1;var E,M,z,D,F,C,y=(d=s[l]).i,A=d.f;t&&y==dx.last_ident?(S=w3_el(dx.last_dx_idx+"-id-dx-label")).title+="\n"+T(d):(dx.last_dx_idx=g,dx.last_ident=y,E=isDefined(d.n)?d.n:"",(S=w3_el(g+"-id-dx-label"))&&(""==(z=kiwi_decodeURIComponent("dx_ident2",y).trim())&&(z="&nbsp;&nbsp;"),S.innerHTML=z.replace(/\\n/g,"<br>"),M=dx_type2idx(d.fl&dx.DX_TYPE),z=t&&""!=dx.eibi_ext[M]?"\nshift-click to open extension":"",t?S.title=dx.eibi_svc_s[M]+" // home country: "+d.c+z+"\n"+T(d):(z=(z=(z=kiwi_decodeURIComponent("dx_notes",E)).replace(/<br>/g,"\n")).replace(/\\n/g,"\n"),(d.fl&dx.DX_DOW)==dx.DX_DOW&&0==d.b&&0==d.b&&2400==d.e||(z=z+(""!=z?"\n":"")+T(d,!0)),S.title=z),g<dx.post_render.length&&(F=dx.post_render[g])&&(D=F.top,C=F.x-10,S.style.top=px(D),S.style.left=px(C),isDefined(F.z)&&(S.style.zIndex=F.z),C=w3_el(g+"-id-dx-line"),D=F.ltop,C.style.top=px(D),C.style.height=px(dx_container_h-D)),g<dx.color_fixup.length&&(F=dx.color_fixup[g])&&(S.style.backgroundColor=F),t||"IBP"!=y&&"IARU%2fNCDXF"!=y||(C=dx_ibp_freqs[Math.trunc(A/1e3)],dx_ibp_list.push({idx:g,off:C}),kiwi_clearInterval(dx_ibp_interval),dx_ibp_interval=setInterval(function(){var e=new Date(dx_ibp_server_time_ms+(Date.now()-dx_ibp_local_time_epoch_ms)),t=e.getMinutes(),a=e.getSeconds(),e=a%10;if(0==e&&9==dx_ibp_lastsec)for(var _=t%3*6+Math.trunc(a/10),i=0;i<dx_ibp_list.length;i++){var o,n,s=_-dx_ibp_list[i].off;s<0&&(s=18+s),S=w3_el(dx_ibp_list[i].idx+"-id-dx-label"),w3_obj_enum(dx_ibp_stations,function(e,t,a){t==s&&(o=e,n=a.text)}),S&&(S.innerHTML="IBP: "+o+" "+n)}dx_ibp_lastsec=e},500))))}}else{var B,I=s[1];I&&(B=kiwi.modes_l[I.fl&dx.DX_MODE],freqmode_set_dsp_kHz(I.f,B),0!=I.lo&&0!=I.hi?ext_set_passband(I.lo,I.hi):(B=cfg.passbands[B],ext_set_passband(B.lo,B.hi)))}}function dx_filter(){confirmation_show_content(w3_div("w3-medium w3-text-aqua w3-bold","DX label filter")+w3_divs("w3-text-aqua",w3_col_percent("",w3_divs("/w3-margin-T-8",w3_input("w3-label-inline/id-dx-filter-ident w3-retain-input-focus w3-input-any-change w3-padding-small","Ident","dx.filter_ident",dx.filter_ident,"dx_filter_cb"),w3_input("w3-label-inline/id-dx-filter-notes w3-retain-input-focus w3-input-any-change w3-padding-small","Notes","dx.filter_notes",dx.filter_notes,"dx_filter_cb")),90),w3_inline("w3-halign-space-around w3-margin-T-8 w3-text-white/",w3_checkbox("w3-retain-input-focus w3-label-inline w3-label-not-bold","case sensitive","dx.filter_case",dx.filter_case,"dx_filter_opt_cb"),w3_inline("",w3_text("","pattern match:"),w3_checkbox("w3-margin-left w3-retain-input-focus w3-label-inline w3-label-not-bold","grep","dx.filter_grep",dx.filter_grep,"dx_filter_opt_cb")))),450,140,dx_filter_panel_close),w3_field_select("id-dx-filter-ident",{mobile:1})}function dx_filter_panel_close(){var e=document.activeElement;e&&e.id&&(e.id.startsWith("id-dx-filter")||e.id.startsWith("id-dx.filter"))&&e.blur(),confirmation_panel_close()}function dx_filter_cb(e,t,a,_){a||(w3_string_cb(e,t),t=""!=dx.filter_ident||""!=dx.filter_notes,wf_send("SET DX_FILTER i="+encodeURIComponent(dx.filter_ident+"x")+" n="+encodeURIComponent(dx.filter_notes+"x")+" c="+dx.filter_case+" w="+dx.filter_wild+" g="+dx.filter_grep),w3_remove_then_add("id-dx-container","whiteSmoke cl-dx-filtered",t?"cl-dx-filtered":"whiteSmoke"),t||_||dx_filter_panel_close())}function dx_filter_opt_cb(e,t,a){a||(t=+t,w3_bool_cb(e,t),dx_filter_cb("dx.filter_ident",dx.filter_ident,!1,!0),w3_checkbox_set(e,t),t&&"dx.filter_case"!=e&&dx_filter_opt_cb("dx.filter_wild"==e?"dx.filter_grep":"dx.filter_wild",0),w3_field_select("id-dx-filter-ident",{mobile:1}))}function dx_filter_field_err(e){w3_set_props("id-dx-filter-ident","w3-pink",1&e),w3_set_props("id-dx-filter-notes","w3-pink",2&e)}function dx_label_step(e){var t;if(1==e){for(t=0;t<dx.displayed.length;t++)if(_=dx.displayed[t]){var a=Math.round(1e3*_.freq);if(freq_displayed_Hz<a)break}if(t==dx.displayed.length)return void wf_send("SET MARKER db="+dx.db+" dir=1 freq="+(freq_displayed_Hz/1e3).toFixed(3))}else{for(t=dx.displayed.length-1;0<=t;t--){var _=dx.displayed[t];if(_)if((a=Math.round(1e3*_.freq))<freq_displayed_Hz)break}if(t<0)return void wf_send("SET MARKER db="+dx.db+" dir=-1 freq="+(freq_displayed_Hz/1e3).toFixed(3))}e=kiwi.modes_l[_.flags&dx.DX_MODE];freqmode_set_dsp_kHz(_.freq,e),0!=_.lo&&0!=_.hi?ext_set_passband(_.lo,_.hi):(e=cfg.passbands[e],ext_set_passband(e.lo,e.hi))}function dx_admin_pwd_cb(e,t){w3_string_cb(e,t),ext_valpwd("admin",t,ws_wf)}function dx_show_edit_panel(e,t,a){dx_keys=e?{shift:e.shiftKey,alt:e.altKey,ctrl:e.ctrlKey,meta:e.metaKey}:{shift:0,alt:0,ctrl:0,meta:0},dx.o.gid=t,dx.db==dx.DB_STORED?(dx.badp=-1,ext_hasCredential("admin",function(e){(dx.badp=e)?(extint_panel_hide(),e=w3_inline("",w3_div("w3-medium w3-text-aqua w3-bold","DX label edit"),w3_select("w3-margin-L-64/w3-label-inline w3-text-white /w3-text-red","database","","dx.db",dx.db,dx.db_s,"dx_database_cb"))+w3_div("",w3_input("w3-margin-T-16//w3-margin-T-8 w3-padding-small|width:80%","Admin password","dx.pwd","","dx_admin_pwd_cb"),w3_text("w3-margin-T-4","editing the stored DX labels of this Kiwi requires admin privileges")),ext_panel_set_name("dx"),ext_panel_show(e,null,null,null,!0),ext_set_controls_width_height(550,260),1!=a&&w3_field_select("id-dx.pwd",{mobile:1})):dx_show_edit_panel2()},null,ws_wf),dx.badp):dx_show_edit_panel2()}function dx_show_edit_panel2(){var e,t=dx.o.gid;if(-1==t?(dx.o.fr=freq_displayed_kHz_str,dx.o.lo=dx.o.hi=dx.o.o=0,dx.o.fm=kiwi.modes_s[cur_mode],dx.o.ft=dx.DX_QUICK_0,dx.o.fd=dx.DX_DOW_BASE,dx.o.begin=0,dx.o.end=0,dx.o.i=dx.o.n=dx.o.p=""):(e=dx.list[t],dx.o.fr=e.carrier.toFixed(2),dx.o.lo=e.lo,dx.o.hi=e.hi,dx.o.o=e.moff,dx.o.fm=e.flags&dx.DX_MODE,dx.o.ft=(e.flags&dx.DX_TYPE)>>dx.DX_TYPE_SFT,dx.o.fd=(e.flags&dx.DX_DOW)>>dx.DX_DOW_SFT,0==dx.o.fd&&(dx.o.fd=dx.DX_DOW_BASE,kiwi_trace("$SHOULD NOT OCCUR")),dx.o.begin=e.begin,dx.o.end=e.end,dx.o.i=kiwi_decodeURIComponent("dx_ident",e.ident),dx.o.n=kiwi_decodeURIComponent("dx_notes",e.notes),dx.o.p=kiwi_decodeURIComponent("dx_params",e.params)),dx.db==dx.DB_STORED&&-1!=t&&dx_keys.shift&&dx_keys.alt){var a=(a=dx.o.ft)==dx.DX_QUICK_0?dx.DX_QUICK_1:dx.DX_QUICK_0;dx.o.ft=a;a=dx.o.fd<<dx.DX_DOW_SFT|a<<dx.DX_TYPE_SFT|dx.o.fm;wf_send("SET DX_UPD g="+dx.o.gid+" f="+dx.o.fr+" lo="+dx.o.lo.toFixed(0)+" hi="+dx.o.hi.toFixed(0)+" o="+dx.o.o.toFixed(0)+" fl="+a+" b="+dx.o.begin+" e="+dx.o.end+" i="+encodeURIComponent(dx.o.i+"x")+" n="+encodeURIComponent(dx.o.n+"x")+" p="+encodeURIComponent(dx.o.p+"x"))}else{extint_panel_hide(),dx.o.fr=(parseFloat(dx.o.fr)+kiwi.freq_offset_kHz).toFixed(2),dx.o.pb="",(dx.o.lo||dx.o.hi)&&(dx.o.lo==-dx.o.hi?dx.o.pb=(2*Math.abs(dx.o.hi)).toFixed(0):dx.o.pb=dx.o.lo.toFixed(0)+", "+dx.o.hi.toFixed(0));a=w3_inline("",w3_div("w3-medium w3-text-aqua w3-bold","DX label edit"),w3_select("w3-margin-L-64/w3-label-inline w3-text-white /w3-text-red","database","","dx.db",dx.db,dx.db_s,"dx_database_cb",0));if(dx.db==dx.DB_STORED){var _="",i=dx.o.fd;0==i&&(i=dx.o.fd=dx.DX_DOW_BASE),console.log("DX g="+t+" dow="+i+"|"+i.toHex(2)+" f="+(+dx.o.fr).toFixed(2)+" b="+dx.o.begin+" e="+dx.o.end+" "+dx.o.i);for(var o=0;o<7;o++){var n=i&1<<6-o,s=n?"black":"white",n=n?dx.dow_colors[o]:"darkGrey";_+=w3_button("w3-dummy//w3-round w3-padding-tiny"+(o?" w3-margin-L-4":"")+"|color:"+s+"; background:"+n,"MTWTFSS"[o],"dx_dow_button",o)}var _=w3_inline("",_),t=+dx.o.begin,r=+dx.o.end;0!=t||0!=r&&2400!=r?(d=t.toFixed(0).leadingZeros(4),c=r.toFixed(0).leadingZeros(4)):d=c="";var l=kiwi_deep_copy(cfg.dx_type);if(dx.types_n)for(o=0;o<dx.DX_N_STORED;o++)0!=dx.types_n[o]&&""==l[o].name&&(l[o].name="(T"+o+")");r=w3_divs("w3-text-white/w3-margin-T-8",w3_inline("w3-halign-space-between/",w3_input("w3-padding-small||size=8","Freq","dx.o.fr",dx.o.fr,"dx_num_cb"),w3_select("w3-text-red","Mode","","dx.o.fm",dx.o.fm,kiwi.modes_u,"dx_sel_cb"),w3_input("w3-padding-small||size=10","Passband","dx.o.pb",dx.o.pb,"dx_passband_cb"),w3_select("w3-text-red","Type","","dx.o.ft",dx.o.ft,l,"dx_sel_cb"),w3_input("w3-padding-small||size=8","Offset","dx.o.o",dx.o.o,"dx_num_cb")),w3_input("w3-label-inline/w3-padding-small","Ident","dx.o.i","","dx_string_cb"),w3_input("w3-label-inline/w3-padding-small","Notes","dx.o.n","","dx_string_cb"),w3_input("w3-label-inline/w3-padding-small","Extension","dx.o.p","","dx_string_cb"),w3_inline("w3-hspace-16",w3_text("w3-text-white w3-bold","Schedule (UTC)"),_,w3_input("w3-label-inline/w3-padding-small","Begin","dx.o.begin",d,"dx_sched_time_cb"),w3_input("w3-label-inline/w3-padding-small","End","dx.o.end",c,"dx_sched_time_cb")),w3_inline("w3-hspace-16",w3_button("w3-yellow","Modify","dx_modify_cb"),w3_button("w3-green","Add","dx_add_cb"),w3_button("w3-red","Delete","dx_delete_cb"),w3_div("w3-margin-T-4",w3_checkbox("/w3-label-inline w3-label-not-bold w3-text-white/","filter by time/day-of-week","dx.stored_filter_tod",dx.stored_filter_tod,"dx_time_dow_cb"),w3_text("w3-margin-T-4","Create new label with Add button"))))}else var d="w3-halign-space-around/|flex-basis:130px",c=function(e){var t=dx_type2idx(e),e=dx.eibi_types_mask&1<<t?1:0;return w3_checkbox("/w3-label-inline w3-label-not-bold w3-round w3-padding-small/",dx.eibi_svc_s[t],"eibi-cbox"+t,e,"dx_eibi_svc_cb",t)},r=w3_inline("",w3_checkbox("w3-margin-TB-16/w3-label-inline w3-label-not-bold w3-text-white/w3-hspace-32","select all","eibi-all",4294967295==dx.eibi_types_mask,"dx_eibi_all_cb"),w3_checkbox("/w3-label-inline w3-label-not-bold w3-text-white/w3-margin-L-32","filter by time/day-of-week","dx.eibi_filter_tod",dx.eibi_filter_tod,"dx_time_dow_cb"))+w3_div("w3-valign-col w3-round w3-padding-TB-10 w3-gap-10|background:whiteSmoke",w3_inline(d,c(dx.DX_BCAST),c(dx.DX_UTIL),c(dx.DX_TIME)),w3_inline(d,c(dx.DX_ALE),c(dx.DX_HFDL),c(dx.DX_MILCOM)),w3_inline(d,c(dx.DX_CW),c(dx.DX_FSK),c(dx.DX_FAX)),w3_inline(d,c(dx.DX_AERO),c(dx.DX_MARINE),c(dx.DX_SPY)));ext_panel_set_name("dx"),ext_panel_show(a+r,null,function(){if(dx.db==dx.DB_STORED)w3_el("dx.o.i").value=dx.o.i,w3_el("dx.o.n").value=dx.o.n,w3_el("dx.o.p").value=dx.o.p;else for(var e=0;e<dx.DX_N_EiBi;e++)w3_color("eibi-cbox"+e+"-label","black",dx.eibi_colors[e])},function(){},!0),ext_set_controls_width_height(550,290),dx.help&&(extint_help_click_now(),dx.help=!1)}}function dx_database_cb(e,t,a,_,i){a||(dx.db=+t,dx.list=[],console_log_dbgUs("DX DB-SWITCHED db="+dx.db),_?dx_show_edit_panel(null,-1,i):ext_panel_displayed("dx")&&dx_close_edit_panel(),dx_schedule_update())}function dx_eibi_all_cb(e,t,a){if(!a)for(var _=t?1:0,i=0;i<dx.DX_N_EiBi;i++)dx_eibi_svc_cb("eibi-cbox"+i,_,!1,i)}function dx_time_dow_cb(e,t,a){a||(setVarFromString(e,t?1:0),dx_schedule_update())}function dx_eibi_svc_cb(e,t,a,_){a||(a=+_,_=t?1:0,w3_checkbox_set(e,t),_?dx.eibi_types_mask|=1<<a:dx.eibi_types_mask&=~(1<<a),dx_schedule_update())}function dx_close_edit_panel(e){e&&w3_radio_unhighlight(e),extint_panel_hide()}function dx_modify_cb(e,t){var a;console_log_dbgUs("DX COMMIT modify entry #"+dx.o.gid+" f="+dx.o.fr),console_log_dbgUs(dx.o),-1!=dx.o.gid&&(a=dx.o.fd<<dx.DX_DOW_SFT|dx.o.ft<<dx.DX_TYPE_SFT|dx.o.fm,dx.o.fr-=kiwi.freq_offset_kHz,dx.o.fr<0&&(dx.o.fr=0),wf_send("SET DX_UPD g="+dx.o.gid+" f="+dx.o.fr+" lo="+dx.o.lo.toFixed(0)+" hi="+dx.o.hi.toFixed(0)+" o="+dx.o.o.toFixed(0)+" fl="+a+" b="+dx.o.begin+" e="+dx.o.end+" i="+encodeURIComponent(dx.o.i+"x")+" n="+encodeURIComponent(dx.o.n+"x")+" p="+encodeURIComponent(dx.o.p+"x")),setTimeout(function(){dx_close_edit_panel(e)},250))}function dx_add_cb(e,t){var a=dx.o.fd<<dx.DX_DOW_SFT|dx.o.ft<<dx.DX_TYPE_SFT|dx.o.fm;dx.o.fr-=kiwi.freq_offset_kHz,dx.o.fr<0&&(dx.o.fr=0),wf_send("SET DX_UPD g=-1 f="+dx.o.fr+" lo="+dx.o.lo.toFixed(0)+" hi="+dx.o.hi.toFixed(0)+" o="+dx.o.o.toFixed(0)+" fl="+a+" b="+dx.o.begin+" e="+dx.o.end+" i="+encodeURIComponent(dx.o.i+"x")+" n="+encodeURIComponent(dx.o.n+"x")+" p="+encodeURIComponent(dx.o.p+"x")),setTimeout(function(){dx_close_edit_panel(e)},250),owrx.dx_click_gid_last=void 0}function dx_delete_cb(e,t){-1!=dx.o.gid&&(wf_send("SET DX_UPD g="+dx.o.gid+" f=-1"),setTimeout(function(){dx_close_edit_panel(e)},250),owrx.dx_click_gid_last=void 0)}function dx_click(e,t){var a,_,i,o,n,s;return e.shiftKey&&dx.db==dx.DB_STORED?dx_show_edit_panel(e,t):(w3_menu_close("dx_click"),owrx.dx_click_gid_last=dx.db==dx.DB_STORED?t:void 0,s=(a=dx.list[t]).freq,_=kiwi.modes_l[a.flags&dx.DX_MODE],i=a.lo,o=a.hi,t=a.params,extint.extname=extint.param=null,isArg(t)&&(n=""==t?[]:decodeURIComponent(t).split(","),"drm"==_?(extint.extname="drm",n.push("lo:"+i),n.push("hi:"+o),extint.param=n.join(",")):(extint.extname=n[0],extint.param=n.slice(1).join(","))),n=extint.extname||"",console_log_dbgUs("dx_click f="+a.freq+" mode="+_+" cur_mode="+cur_mode+" lo="+i+" hi="+o+" params=<"+t+"> extname=<"+n+"> param=<"+extint.param+">"),dx.db,dx.DB_EiBi,freqmode_set_dsp_kHz(s,_,{open_ext:!0}),(i||o)&&ext_set_passband(i,o,!1,s),s=dx.db==dx.DB_STORED?!any_alternate_click_event(e):e.shiftKey,"drm"!=_&&s&&!dx.ctrl_click&&t&&(console_log_dbgUs("dx_click ext="+extint.extname+" <"+extint.param+">"),extint_open(extint.extname,250)),dx.ctrl_click=!1),cancelEvent(e)}function dx_enter(e,t,a){dx_z_save=e.style.zIndex,e.style.zIndex=999,dx_bg_color_save=e.style.backgroundColor,e.style.backgroundColor=w3_contains(e,"cl-dx-label-filtered")?"lightGrey":w3_contains(e,"id-has-ext")?"magenta":"yellow";e=w3_el(parseInt(e.id)+"-id-dx-line");e.zIndex=998,e.style.width="3px",t&&(dx_canvas.style.left=px(t-dx_car_w/2),dx_canvas.style.zIndex=100)}function dx_leave(e,t){e.style.zIndex=dx_z_save,e.style.backgroundColor=dx_bg_color_save;e=w3_el(parseInt(e.id)+"-id-dx-line");e.zIndex=110,e.style.width="1px",t&&(dx_canvas.style.zIndex=99)}function dx_help(e){return e&&(confirmation_show_content(w3_text("w3-medium w3-bold w3-text-aqua","DX label edit help")+w3_div("w3-margin-T-8 w3-scroll-y|height:90%",w3_div("w3-margin-R-8",'There are two types of DX labels seen in the area above the frequency scale: <br>1) Labels from a stored database, editable by the Kiwi owner/admin. <br>2) Labels from a read-only copy of the <a href="http://www.eibispace.de" target="_blank">EiBi database</a> that cannot be modified.<br><br>The DX label edit control panel has a <i>database</i> menu to select between the two. Similarly, there are two selection entries in the right-click menu (double-finger tap on mobile devices). The keyboard shortcut keys "\\" and "|" also switch between the two databases with the later also opening the control panel.<br><br>When zoomed out the number of labels shown is limited to prevent overwhelming the display. This is why some labels will only appear as you zoom in. The same is true if too many categories are selected enabling a large number of labels.<br><br>Information about using the editing controls for the stored labels can be found <a href="http://kiwisdr.com/quickstart/index.html#id-user-marker" target="_blank">here</a>.<br><br>Because there are so many EiBi labels (about 17000) they are organized into 12 categories with visibility selected by checkboxes on the control panel. In addition labels from either database can be filtered by their schedule (UTC time & day-of-week) specified in the database. If filtering is disabled labels outside their scheduled time appear with a lighter category color and a dashed border. When filtering is enabled the label display will refresh every 5 minutes so it reflects the current schedule.<br><br>Labels that have an extension specified turn magenta when moused-over as opposed to the usual yellow. And labels outside their scheduled time (if any) will mouse-over grey. For stored labels the extension is set per-label in the label edit panel and the extension opened when the label is clicked (a shift-click opens that label in the edit panel). For EiBi labels an extension is automatically assumed for the ALE, CW, FSK, Fax and Time categories, but is only opened if the label is shift-clicked (note difference from stored label behavior, a non-shift click simply selects the frequency/mode).<br><br>When a label is moused-over a popup is shown with optional information (stored labels) or database information (EiBi labels). On Safari and Chrome the popups take a few second to appear. EiBi information includes the station\'s home country, transmission schedule, language and target area (if any). Information about the EiBi database, including descriptions of the language and target codes seen in the mouse-over popups, <a href="http://kiwisdr.com/files/EiBi/README.txt" target="_blank">can be found here.</a><br><br>EiBi URL parameters: (use "dx=..." in the browser URL)<br>'+w3_text("|color:orange","none bcast utility time ale hfdl milcom cw fsk fax aero maritime spy filter[:0]")+'<br>By default all the category checkboxes and "<i>filter by time/day-of-week</i>" are checked. <br>Specifying <i>none</i> will uncheck all the categories. Specifying the individual category names will then toggle the checkbox state.<br><br>For example, to select only the ALE and Fax categories: <i>dx=none,ale,fax</i> <br>To select all except the CW and Time categories: <i>dx=cw,time</i> <br>To just bring up the EiBi control panel: <i>dx</i> (e.g. <i>my_kiwi:8073/?spec&dx</i>)<br>Keywords are case-insensitive and can be abbreviated. For example: <br><i>dx=n,bc,f:0</i> (show all broadcast stations without time/day filtering) <br>')),610,375),w3_el("id-confirmation-container").style.height="100%"),!0}var sMeter_ctx,smeter_ovfl,SMETER_RHS=38,SMETER_SCALE_HEIGHT=29,SMETER_BIAS=127,SMETER_INPUT_MAX=3.4,SMETER_INPUT_RANGE=SMETER_BIAS+SMETER_INPUT_MAX,SMETER_DISPLAY_MAX=-6,SMETER_DISPLAY_RANGE=SMETER_BIAS+SMETER_DISPLAY_MAX,bars={dBm:[-121,-109,-97,-85,-73,-63,-53,-33,-13],text:["S1","S3","S5","S7","S9","+10","+20","+40","+60"]};function smeter_dBm_biased_to_x(e){return SMETER_DISPLAY_RANGE<e&&(e=SMETER_DISPLAY_RANGE),Math.round(e/SMETER_DISPLAY_RANGE*smeter_width)}function smeter_init(e){owrx.force_no_agc_thresh_smeter=e;var t=w3_el("id-control-smeter");if(t){w3_innerHTML(t,'<canvas id="id-smeter-scale" class="class-smeter-scale" width="0" height="0"></canvas>',w3_div("id-smeter-ovfl w3-hide","OV"),w3_div("id-smeter-dbm-value"),w3_div("id-smeter-dbm-units","dBm"));var a=w3_el("id-smeter-scale");smeter_ovfl=w3_el("smeter-ovfl");var _=divControl?divControl.activeWidth:350,i=html_LR_border_pad(a),o=smeter_width=_-SMETER_RHS-i,e=SMETER_SCALE_HEIGHT,n=e-8,_=o+SMETER_RHS;t.style.width=px(_+i),(sMeter_ctx=a.getContext("2d")).canvas.width=_,sMeter_ctx.canvas.height=e,sMeter_ctx.fillStyle="gray",sMeter_ctx.globalAlpha=1,sMeter_ctx.fillRect(0,0,_,e),sMeter_ctx.font="11px Verdana",sMeter_ctx.textBaseline="middle",sMeter_ctx.textAlign="center",sMeter_ctx.fillStyle="white";for(var s=0;s<bars.text.length;s++){var r=smeter_dBm_biased_to_x(bars.dBm[s]+SMETER_BIAS);line_stroke(sMeter_ctx,1,3,"white",r,n-8,r,8+n),sMeter_ctx.fillText(bars.text[s],r,n-15)}line_stroke(sMeter_ctx,0,5,"black",0,n,o,n),kiwi_clearInterval(owrx.smeter_interval),owrx.smeter_interval=setInterval(update_smeter,100)}}var ident_tout,sm_px=0,sm_timeout=0,sm_interval=10,sm_ovfl_showing=!1;function update_smeter(){var e,t=smeter_dBm_biased_to_x(owrx.sMeter_dBm_biased),a=SMETER_SCALE_HEIGHT-8,_=smeter_width;sMeter_ctx.globalAlpha=1,line_stroke(sMeter_ctx,0,5,"lime",0,a,t,a),cfg.agc_thresh_smeter&&1!=owrx.force_no_agc_thresh_smeter&&(e=smeter_dBm_biased_to_x(-(cur_mode&&"cw"==cur_mode.substr(0,2)?threshCW:thresh)),line_stroke(sMeter_ctx,0,2,"white",0,a-3,_-e,a-3),line_stroke(sMeter_ctx,0,2,"black",_-e,a-3,_,a-3)),0==sm_timeout--?(sm_timeout=sm_interval,t<sm_px&&line_stroke(sMeter_ctx,0,5,"black",t,a,sm_px,a),sm_px=t):t<sm_px?line_stroke(sMeter_ctx,0,5,"red",t,a,sm_px,a):(sm_px=t,sm_timeout=sm_interval),audio_ext_adc_ovfl&&!sm_ovfl_showing?(w3_hide("id-smeter-dbm-units"),w3_show("id-smeter-ovfl"),w3_call("S_meter_adc_ovfl",!0),sm_ovfl_showing=!0):!audio_ext_adc_ovfl&&sm_ovfl_showing&&(w3_hide("id-smeter-ovfl"),w3_show("id-smeter-dbm-units"),w3_call("S_meter_adc_ovfl",!1),sm_ovfl_showing=!1),w3_innerHTML("id-smeter-dbm-value",owrx.sMeter_dBm.toFixed(0))}var ident_user="",send_ident=!1;function ident_init(){var e=Math.max(cfg.ident_len,kiwi.ident_min);user_url&&(user_url=kiwi_decodeURIComponent("user_url",user_url),user_url=kiwi_strip_tags(user_url,"").substring(0,e),writeCookie("ident",user_url));var t=initCookie("ident",""),t=kiwi_strip_tags(t,"").substring(0,e);t=kiwi_strip_tags(t,"").substring(0,e);var a=w3_el("id-ident-input1"),_=w3_el("id-ident-input2");w3_attribute(a,"maxlength",e),w3_attribute(_,"maxlength",e),a.value=t,_.value=t,ident_user=t,send_ident=!0}function ident_complete(e,t){var a=w3_el("id-ident-input"+t),_=w3_el("id-ident-input"+(1==t?2:1)),i=a.value,t=Math.max(cfg.ident_len,kiwi.ident_min),i=kiwi_strip_tags(i,"").substring(0,t);a.value=i,_.value=i,kiwi_clearTimeout(ident_tout),w3_schedule_highlight(a),w3_schedule_highlight(_),freqset_select(),writeCookie("ident",i),ident_user=i,send_ident=!0}function ident_keyup(e,t,a){if(kiwi_clearTimeout(ident_tout),null!=t&&null!=t.key){var _=t.key.length;if(any_alternate_click_event_except_shift(t)||1!=_&&"Backspace"!=t.key&&"Shift"!=t.key)return void("Enter"==t.key&&ident_complete("Enter",a))}send_ident||(ident_tout=setTimeout(function(){ident_complete("t/o",a)},5e3))}var shortcut={nav_off:0,keys:null,SHIFT:1,CTL_OR_ALT:2,SHIFT_PLUS_CTL_OR_ALT:3,KEYCODE_ALT:18};function keyboard_shortcut_init(){kiwi_isMobile()&&!mobile_laptop_test||kiwi_isFirefox()<47||kiwi_isChrome()<=49||kiwi_isOpera()<=36||(shortcut.help=w3_div("",w3_inline_percent("w3-padding-tiny w3-bold w3-text-aqua","Keys",25,"Function"),w3_inline_percent("w3-padding-tiny","g =",25,"select frequency entry field"),w3_inline_percent("w3-padding-tiny","j i LR-arrow-keys",25,"frequency step down/up, add shift or alt/ctrl for faster<br>shift plus alt/ctrl to step to next/prev DX label"),w3_inline_percent("w3-padding-tiny","m n",25,"toggle frequency memory menu, VFO A/B"),w3_inline_percent("w3-padding-tiny","b B",25,"scroll band menu"),w3_inline_percent("w3-padding-tiny","e E",25,"scroll extension menu"),w3_inline_percent("w3-padding-tiny","a A d l u c f q",25,"toggle modes: AM SAM DRM LSB USB CW NBFM IQ<br>add alt/ctrl to toggle backwards (e.g. SAM modes)"),w3_inline_percent("w3-padding-tiny","p P ctrl-p",25,"passband narrow/widen, restore default"),w3_inline_percent("w3-padding-tiny","r",25,"toggle audio recording"),w3_inline_percent("w3-padding-tiny","z Z",25,"zoom in/out, add alt/ctrl for max in/out"),w3_inline_percent("w3-padding-tiny","< >",25,"waterfall page down/up"),w3_inline_percent("w3-padding-tiny","w W",25,"waterfall min dB slider -/+ 1 dB, add alt/ctrl for -/+ 10 dB"),w3_inline_percent("w3-padding-tiny","S",25,"waterfall auto-scale"),w3_inline_percent("w3-padding-tiny","s D",25,"spectrum on/off toggle, slow device mode"),w3_inline_percent("w3-padding-tiny","v V space",25,"volume less/more, mute"),w3_inline_percent("w3-padding-tiny","o",25,'toggle between option bar "off" and "stats" mode,<br>others selected by related shortcut key'),w3_inline_percent("w3-padding-tiny","!",25,"toggle aperture manual/auto menu"),w3_inline_percent("w3-padding-tiny","@",25,"DX label filter"),w3_inline_percent("w3-padding-tiny","\\ |",25,"toggle (toggle & open) DX stored/EiBi database"),w3_inline_percent("w3-padding-tiny","x y",25,"toggle visibility of control panels, top bar"),w3_inline_percent("w3-padding-tiny","esc",25,"close/cancel action"),w3_inline_percent("w3-padding-tiny","? h",25,"toggle this help list"),w3_inline_percent("w3-padding-tiny w3-bold w3-text-aqua","",25,"Windows, Linux: use alt, not ctrl"),w3_inline_percent("w3-padding-tiny w3-bold w3-text-aqua","",25,"Mac: use ctrl or alt")),w3_el("id-kiwi-body").addEventListener("keydown",keyboard_shortcut_event,!0))}function keyboard_shortcut_help(){confirmation_show_content(shortcut.help,550,565)}function keyboard_shortcut_nav(e){w3_el("id-nav-optbar-"+e).click(),shortcut.nav_click=!0}function keyboard_shortcut_url_keys(){var e;isNonEmptyArray(shortcut.keys)?(e=shortcut.keys.shift(),console.log("URL shortcut key="+e),keyboard_shortcut(e,0,0),setTimeout(keyboard_shortcut_url_keys,200)):shortcut.keys=null}function keyboard_shortcut(e,t,a,_){var i=a?-1:1;switch(shortcut.nav_click=!1,e){case"a":mode_button(null,w3_el("id-button-am"),i);break;case"A":mode_button(null,w3_el("id-button-sam"),i);break;case"d":ext_set_mode("drm",null,{open_ext:!0});break;case"l":mode_button(null,w3_el("id-button-lsb"),i);break;case"u":mode_button(null,w3_el("id-button-usb"),i);break;case"c":mode_button(null,w3_el("id-button-cw"),i);break;case"f":ext_set_mode("nbfm");break;case"q":ext_set_mode("iq");break;case"j":case"J":case"ArrowLeft":t!=shortcut.SHIFT_PLUS_CTL_OR_ALT?freqstep(owrx.wf_snap?t:2-t):dx_label_step(-1);break;case"i":case"I":case"ArrowRight":t!=shortcut.SHIFT_PLUS_CTL_OR_ALT?freqstep(owrx.wf_snap?5-t:3+t):dx_label_step(1);break;case"p":case"P":t==shortcut.CTL_OR_ALT?(restore_passband(cur_mode),demodulator_analog_replace(cur_mode)):passband_increment("P"==e);break;case"v":setvolume(1,kiwi.volume-10),toggle_or_set_mute(0),keyboard_shortcut_nav("audio");break;case"V":setvolume(1,kiwi.volume+10),toggle_or_set_mute(0),keyboard_shortcut_nav("audio");break;case" ":toggle_or_set_mute(),shortcut.nav_click=!0;break;case"g":case"=":freqset_select();break;case"m":freq_memory_menu_show(!0);break;case"b":band_scroll(1);break;case"B":band_scroll(-1);break;case"n":freq_vfo_cb();break;case"<":page_scroll(-page_scroll_amount);break;case">":page_scroll(+page_scroll_amount);break;case"z":zoom_step(a?ext_zoom.NOM_IN:ext_zoom.IN);break;case"Z":zoom_step(a?ext_zoom.MAX_OUT:ext_zoom.OUT);break;case"w":incr_mindb(1,a?-10:-1),keyboard_shortcut_nav("wf");break;case"W":incr_mindb(1,a?10:1),keyboard_shortcut_nav("wf");break;case"s":toggle_or_set_spec(),keyboard_shortcut_nav("wf");break;case"S":wf_autoscale_cb(),keyboard_shortcut_nav("wf");break;case"D":toggle_or_set_slow_dev(),keyboard_shortcut_nav("wf");break;case"!":keyboard_shortcut_nav("wf"),wf_aper_cb("wf.aper",1^wf.aper,!1);break;case"#":dbgUs&&extint_open("prefs");break;case"o":keyboard_shortcut_nav(shortcut.nav_off?"status":"off"),shortcut.nav_off^=1;break;case"r":toggle_or_set_rec();break;case"x":toggle_or_set_hide_panels();break;case"y":toggle_or_set_hide_bars();break;case"@":dx_filter(),shortcut.nav_click=!0;break;case"e":extension_scroll(1);break;case"E":extension_scroll(-1);break;case"\\":case"|":dx_database_cb("",dx.db==dx.DB_STORED?dx.DB_EiBi:dx.DB_STORED,!1,"|"==e,!0);break;case"?":case"h":keyboard_shortcut_help();break;default:1==e.length&&_!=shortcut.KEYCODE_ALT&&console.log("no shortcut key <"+e+">")}ignore_next_keyup_event=!0}function keyboard_shortcut_event(e){if(e.target){var t=e.key;if("Escape"!=t&&!t.match(/F[1-9][12]?/)){var a=e.target.id;""==a&&w3_iterate_classList(e.target,function(e,t){e.startsWith("id-")&&(a=e)});var _=e.shiftKey,i=e.ctrlKey,o=e.altKey,n=e.metaKey,s=i||o,r=_&&!s?shortcut.SHIFT:!_&s?shortcut.CTL_OR_ALT:_&&s?shortcut.SHIFT_PLUS_CTL_OR_ALT:0,l="0"<=t&&t<="9"&&!i||"."==t||","==t||"/"==t||":"==t||"-"==t||"+"==t||";"==t||"k"==t||"M"==t||"Enter"==t||"ArrowUp"==t||"ArrowDown"==t||"Backspace"==t||"Delete"==t;if("INPUT"!=e.target.nodeName||"id-freq-input"==a&&!l){if(kiwi_isMacOS()){if(n)return}else if(i)return;o&&!t.startsWith("Arrow")&&(t=String.fromCharCode(e.keyCode).toLowerCase(),_&&(t=t.toUpperCase())),keyboard_shortcut(t,r,s,e.keyCode),cancelEvent(e)}}}}function extension_scroll(e){console.log("extension_scroll dir="+e),console.log(extint_names);var t=w3_el("id-select-ext");console.log(t);var a,_=t.childNodes;console.log(_);var i=+t.value+1;for(console.log("extension_scroll initial i="+i);a=_[i=(i=(i+=e)<1?_.length-1:i)>=_.length?1:i],a.disabled;);var o=+a.value,t=+a.getAttribute("kiwi_idx");console.log("extension_scroll i="+i+" val="+o+" idx="+t+" "+a.innerHTML),w3_select_value("id-select-ext",o),owrx.sel_ext_to&&kiwi_clearTimeout(owrx.sel_ext_to),owrx.sel_ext_to=setTimeout(function(){extint_select(o)},2e3)}var ac_play_button,panel_margin=10;function check_suspended_audio_state(){try{if(window.AudioContext=window.AudioContext||window.webkitAudioContext,ac_play_button=new AudioContext,kiwi_isSafari()){var t=ac_play_button.createBufferSource();t.connect(ac_play_button.destination);try{t.start(0)}catch(e){t.noteOn(0)}}setTimeout(test_audio_suspended,500)}catch(e){console.log("#### no AudioContext?")}}function test_audio_suspended(){var e;"running"!=ac_play_button.state&&(e=w3_div('id-play-button-container class-overlay-container||onclick="play_button()"',w3_div("id-play-button",'<img src="gfx/openwebrx-play-button.png" width="150" height="150" /><br><br>'+(kiwi_isMobile()?"Tap to":"Click to")+" start OpenWebRX")),w3_create_appendElement("id-kiwi-body","div",e),el=w3_el("id-play-button"),el.style.marginTop=px(w3_center_in_window(el)))}function play_button(){try{if(kiwi_is_iOS()){var e=audio_context,t=e.createBufferSource();t.connect(e.destination);try{t.start(0)}catch(e){t.noteOn(0)}}else try{audio_context&&audio_context.resume()}catch(e){console.log("#### audio_context.resume() FAILED")}}catch(e){add_problem("audio start")}w3_el("id-play-button-container").style.opacity=0,setTimeout(function(){w3_hide("id-play-button-container")},1100),audio_reset(),freqset_select()}function panels_setup(){var o;w3_el("id-ident").innerHTML=w3_input('w3-label-not-bold/w3-custom-events|padding:1px|size=20 onchange="ident_complete(\'el\', 1)" onkeyup="ident_keyup(this, event, 1)"',"Your name or callsign:","ident-input1");var e=kiwi_isMobile()?" inputmode="+dq(kiwi_is_iOS()?"decimal":"tel")+' ontouchstart="popup_keyboard_touchstart(event)" onclick="this.select()"':"";w3_el("id-control-freq1").innerHTML=w3_inline("w3-halign-space-between/",w3_div("id-freq-cell",'<form id="id-freq-form" name="form_freq" action="#" onsubmit="freqset_complete(0); return false;">'+w3_input("w3-custom-events w3-font-16px|margin: 2px 0 0 2px; padding:0 4px; width:"+freq_field_width()+'|type="text"'+e+' onchange="freqset_complete(1)" onkeyup="freqset_keyup(this, event)"',"","id-freq-input")+"</form>")+'<select id="id-select-band" class="w3-pointer w3-select-menu" onchange="select_band(this.value)">'+setup_band_menu()+'</select><select id="id-select-ext" class="w3-pointer w3-select-menu" onchange="freqset_select(); extint_select(this.value)"><option value="-1" selected disabled>extension</option>'+extint_select_build_menu()+"</select>"),check_suspended_audio_state(),w3_el("id-control-freq2").innerHTML=w3_inline("w3-halign-space-between w3-margin-T-4/",w3_icon("id-freq-menu w3-menu-button","fa-bars w3-text-white",20,"","freq_memory_menu_show"),w3_button('id-freq-vfo w3-text-in-circle w3-wh-20px w3-aqua||title="VFO A&slash;B"',"A","freq_vfo_cb"),kiwi_isMobile()?null:w3_div("id-freq-link|padding-left:0px"),w3_div("id-9-10-cell w3-hide",w3_div('id-button-9-10 class-button-small||title="LW/MW 9/10 kHz tuning step" onclick="button_9_10()"',"10")),w3_div("id-step-freq",'<img id="id-step-0" src="icons/stepdn.20.png" onclick="freqstep(0, event.shiftKey)" />','<img id="id-step-1" src="icons/stepdn.18.png" onclick="freqstep(1, event.shiftKey)" style="padding-bottom:1px" />','<img id="id-step-2" src="icons/stepdn.16.png" onclick="freqstep(2, event.shiftKey)" style="padding-bottom:2px" />','<img id="id-step-3" src="icons/stepup.16.png" onclick="freqstep(3, event.shiftKey)" style="padding-bottom:2px" />','<img id="id-step-4" src="icons/stepup.18.png" onclick="freqstep(4, event.shiftKey)" style="padding-bottom:1px" />','<img id="id-step-5" src="icons/stepup.20.png" onclick="freqstep(5, event.shiftKey)" />'),w3_div("",w3_button('id-button-spectrum class-button||title="toggle spectrum display"',"Spec","toggle_or_set_spec")),w3_div("",w3_div('fa-stack||title="record"',w3_icon("id-rec1","fa-repeat fa-stack-1x w3-text-pink",22,"","toggle_or_set_rec"))),w3_div('|width:8%|title="mute"',w3_div("id-mute-no fa-stack|width:100%; color:lime",w3_icon("","fa-volume-up fa-stack-2x",24,"inherit","toggle_or_set_mute")),w3_div("id-mute-yes fa-stack w3-hide|width:100%;color:magenta;",w3_icon("","fa-volume-off fa-stack-2x fa-nudge-left",24,"","toggle_or_set_mute"),w3_icon("","fa-times fa-right",12,"","toggle_or_set_mute")),w3_div("id-mute-exclaim fa-stack w3-hide|width:100%; color:yellow",w3_icon("","fa-exclamation-triangle fa-stack-1x",20,"inherit","freqset_select")))),button_9_10(step_9_10=isNaN(override_9_10)?null==(n=ext_get_cfg_param("init.AM_BCB_chan"))||null==n||n?0:1:override_9_10),o="",mode_buttons.forEach(function(e,t){var a=e.s[0],_=a.toLowerCase(),i=e.dis||"drm"==_&&!kiwi.DRM_enable,e=i?"":' onclick="mode_button(event, this)"';e+=' onmouseover="mode_over(event, this)"',o+=w3_div("id-button-"+_+" id-mode-"+_.substr(0,2)+" class-button"+(i?" class-button-disabled":"")+' ||id="'+t+'-id-mode-col"'+e+' onmousedown="cancelEvent(event)"',a)}),w3_el("id-control-mode").innerHTML=w3_inline("w3-halign-space-between/",o);var t=wf.audioFFT_active?" w3-disabled":"",a=wf.audioFFT_active?' w3-disabled||onclick="audioFFT_update()"':"";w3_el("id-control-zoom").innerHTML=w3_inline("w3-halign-space-between/",w3_div("id-zoom-in class-icon"+t+'||onclick="zoom_click(event,1)" onmouseover="zoom_over(event)" title="zoom in"','<img src="icons/zoomin.png" width="32" height="32" />'),w3_div("id-zoom-out class-icon"+t+'||onclick="zoom_click(event,-1)" onmouseover="zoom_over(event)" title="zoom out"','<img src="icons/zoomout.png" width="32" height="32" />'),w3_div("id-maxin"+a,w3_div('class-icon||onclick="zoom_click(event,8)" title="max in"','<img src="icons/maxin.png" width="32" height="32" />')),w3_div("id-maxin-nom w3-hide"+a,w3_div('class-icon||onclick="zoom_click(event,8)" title="max in"','<img src="icons/maxin.nom.png" width="32" height="32" />')),w3_div("id-maxin-max w3-hide"+a,w3_div('class-icon||onclick="zoom_click(event,8)" title="max in"','<img src="icons/maxin.max.png" width="32" height="32" />')),w3_div("id-maxout"+a,w3_div('class-icon||onclick="zoom_click(event,-9)" title="max out"','<img src="icons/maxout.png" width="32" height="32" />')),w3_div("id-maxout-max w3-hide"+a,w3_div('class-icon||onclick="zoom_click(event,-9)" title="max out"','<img src="icons/maxout.max.png" width="32" height="32" />')),w3_div("class-icon"+t+'||onclick="zoom_click(event,0)" title="zoom to band"','<img src="icons/zoomband.png" width="32" height="16" style="padding-top:13px; padding-bottom:13px;"/>'),w3_div("class-icon"+t+'||onclick="page_scroll_icon_click(event,'+-page_scroll_amount+')" title="page down\nalt: label step"','<img src="icons/pageleft.png" width="32" height="32" />'),w3_div("class-icon"+t+'||onclick="page_scroll_icon_click(event,'+page_scroll_amount+')" title="page up\nalt: label step"','<img src="icons/pageright.png" width="32" height="32" />'));var _,i=["w3-pink","w3-blue","w3-purple","w3-aqua","w3-yellow","w3-black","w3-red","w3-amber","w3-green","w3-orange","w3-lime","w3-indigo","w3-brown","w3-teal"],e=0,n=" w3-center|width:15.2%",a=n+";margin-right:6px";w3_el("id-optbar").innerHTML=w3_navbar("cl-optbar",w3_navdef(i[e++]+a,"WF","optbar-wf","optbar"),w3_nav(i[e++]+a,"Audio","optbar-audio","optbar"),w3_nav(i[e++]+a,"AGC","optbar-agc","optbar"),w3_nav(i[e++]+a,"Users","optbar-users","optbar"),w3_nav(i[+e]+a,"Stats","optbar-status","optbar"),w3_nav(i[5]+n,"Off","optbar-off","optbar")),wf_filter=readCookie("last_wf_filter",wf_sp_menu_e.OFF),spec_filter=readCookie("last_spec_filter",wf_sp_menu_e.IIR),isString(spectrum_show)&&(_=spectrum_show.toLowerCase(),wf_sp_menu_s.forEach(function(e,t){_==e.toLowerCase()&&(spec_filter=t)})),wf.max_min_sliders=w3_col_percent("w3-valign/class-slider",w3_text(optbar_prefix_color,"WF max"),19,'<input id="id-input-maxdb" type="range" min="-100" max="20" value="'+maxdb+'" step="1" onchange="setmaxdb(1,this.value)" oninput="setmaxdb(0,this.value)">',60,w3_div("id-field-maxdb class-slider"),19)+w3_col_percent("w3-valign/class-slider",w3_text(optbar_prefix_color,"WF min"),19,'<input id="id-input-mindb" type="range" min="-190" max="-30" value="'+mindb+'" step="1" onchange="setmindb(1,this.value)" oninput="setmindb(0,this.value)">',60,w3_div("id-field-mindb class-slider"),19),wf.floor_ceil_sliders=w3_col_percent("w3-valign/class-slider",w3_text(optbar_prefix_color,"WF ceil"),19,'<input id="id-input-ceildb" type="range" min="-30" max="30" value="'+wf.auto_ceil.val+'" step="5" onchange="setceildb(1,this.value)" oninput="setceildb(0,this.value)">',60,w3_div("id-field-ceildb class-slider"),19)+w3_col_percent("w3-valign/class-slider",w3_text(optbar_prefix_color,"WF floor"),19,'<input id="id-input-floordb" type="range" min="-30" max="30" value="'+wf.auto_floor.val+'" step="5" onchange="setfloordb(1,this.value)" oninput="setfloordb(0,this.value)">',60,w3_div("id-field-floordb class-slider"),19),w3_el("id-optbar-wf").innerHTML=w3_div("id-aper-data w3-hide w3-margin-B-5|left:0px; width:256px; height:16px; background-color:#575757; overflow:hidden; position:relative;",'<canvas id="id-aper-canvas" width="256" height="16" style="position:absolute"></canvas>')+w3_col_percent("",w3_div("",w3_div("id-wf-sliders",wf.max_min_sliders),w3_col_percent("w3-valign/class-slider",w3_text(optbar_prefix_color,"WF rate"),19,'<input id="slider-rate" class="'+t+'" type="range" min="0" max="4" value="'+wf_speed+'" step="1" onchange="setwfspeed(1,this.value)" oninput="setwfspeed(0,this.value)">',60,w3_div("slider-rate-field class-slider"),19),w3_col_percent("w3-valign/class-slider",w3_button("id-wf-sp-button class-button w3-font-12px","Spec &Delta;","toggle_or_set_wf_sp_button"),19,w3_slider("id-wf-sp-slider","","wf_sp_param",wf_sp_param,0,10,1,"wf_sp_slider_cb"),60,w3_div("id-wf-sp-slider-field class-slider"),19)),85,w3_divs("/w3-tspace-4 w3-hcenter w3-font-11_25px",w3_button('id-button-wf-autoscale class-button||title="waterfall auto scale"',"Auto<br>Scale","wf_autoscale_cb"),w3_button('id-button-slow-dev class-button||title="slow device mode"',"Slow<br>Dev","toggle_or_set_slow_dev"),w3_inline("",w3_button('id-button-spec-peak class-button||title="toggle peak hold"',"Pk","toggle_or_set_spec_peak"),w3_icon("id-wf-gnd w3-margin-L-4 w3-momentary","fa-caret-down",22,"white","wf_gnd_cb",1))),15)+w3_inline("w3-halign-space-between w3-margin-T-2/",w3_select('w3-text-red||title="colormap selection"',"","colormap","wf.cmap",wf.cmap,kiwi.cmap_s,"wf_cmap_cb"),w3_select('w3-text-red||title="aperture selection"',"","aper","wf.aper",wf.aper,kiwi.aper_s,"wf_aper_cb"),w3_select('w3-text-red||title="waterfall filter selection"',"","wf","wf_filter",wf_filter,wf_sp_menu_s,"wf_sp_menu_cb",1),w3_select('w3-text-red||title="spectrum filter selection"',"","spec","spec_filter",spec_filter,wf_sp_menu_s,"wf_sp_menu_cb",0),w3_button('id-button-wf-more class-button w3-text-orange||onclick="extint_open(\'waterfall\'); freqset_select();" title="more waterfall params"',"More")),setwfspeed(1,wf_speed),toggle_or_set_slow_dev(toggle_e.FROM_COOKIE|toggle_e.SET,0),toggle_or_set_spec_peak(toggle_e.FROM_COOKIE|toggle_e.SET_URL,peak_initially),toggle_or_set_wf_sp_button(toggle_e.FROM_COOKIE|toggle_e.SET,0);de_emphasis=readCookie("last_de_emphasis",0),de_emphasis=w3_clamp(de_emphasis,0,1,0),pan=readCookie("last_pan",0),w3_el("id-optbar-audio").innerHTML=w3_inline_percent("w3-valign/w3-last-halign-end",w3_text(optbar_prefix_color+" cl-closer-spaced-label-text","Noise"),17,w3_select_conditional('w3-text-red||title="noise blanker selection"',"","blanker","nb_algo",0,[["off",1],["std",1],["Wild",1]],"nb_algo_cb","m"),24,w3_div("w3-hcenter",w3_div('class-button w3-text-orange||onclick="extint_open(\'noise_blank\'); freqset_select();" title="noise blanker parameters"',"More")),19,w3_div("w3-hcenter ",w3_select_conditional('w3-text-red||title="noise filter selection"',"","filter","nr_algo",0,[["off",1],["wdsp",1],["LMS",1],["spec",1]],"nr_algo_cb","m")),27,w3_div('class-button w3-text-orange||onclick="extint_open(\'noise_filter\'); freqset_select();" title="noise filter parameters"',"More"))+w3_inline_percent("id-vol w3-valign w3-margin-T-2 w3-hide/class-slider w3-last-halign-end",w3_text(optbar_prefix_color,"Volume"),17,'<input id="id-input-volume" type="range" min="0" max="200" value="'+kiwi.volume+'" step="1" onchange="setvolume(1, this.value)" oninput="setvolume(0, this.value)">',50,"&nbsp;",8,w3_select('w3-text-red||title="de-emphasis selection"',"","de-emp","de_emphasis",de_emphasis,de_emphasis_s,"de_emp_cb"))+w3_inline_percent("id-vol-comp w3-valign w3-margin-T-2/class-slider w3-last-halign-end",w3_text(optbar_prefix_color,"Volume"),17,'<input id="id-input-volume" type="range" min="0" max="200" value="'+kiwi.volume+'" step="1" onchange="setvolume(1, this.value)" oninput="setvolume(0, this.value)">',40,w3_select("w3-text-red","","de-emp","de_emphasis",de_emphasis,de_emphasis_s,"de_emp_cb"),28,w3_button('id-button-compression class-button w3-hcenter||title="compression"',"Comp","toggle_or_set_compression"))+w3_inline_percent("id-pan w3-valign w3-hide/class-slider w3-last-halign-end",w3_text(optbar_prefix_color,"Pan"),17,'<input id="id-pan-value" type="range" min="-1" max="1" value="'+pan+'" step="0.01" onchange="setpan(1,this.value)" oninput="setpan(0,this.value)">',50,"&nbsp;",3,w3_div("id-pan-field"),8,"&nbsp;",7,w3_button('id-button-compression class-button w3-hcenter||title="compression"',"Comp","toggle_or_set_compression"))+w3_inline_percent("id-squelch w3-valign/class-slider w3-last-halign-end",w3_text("id-squelch-label","Squelch"),17,w3_slider("","","squelch-value",squelch,0,99,1,"set_squelch_cb"),50,"&nbsp;",3,w3_div("id-squelch-field class-slider"),14,w3_select('id-squelch-tail w3-hide w3-text-red||title="squelch tail length"',"","tail","squelch_tail",squelch_tail,squelch_tail_s,"squelch_tail_cb"))+w3_inline_percent("id-sam-carrier-container w3-hide w3-valign/",w3_inline("w3-halign-space-between/w3-last-halign-end",w3_text(optbar_prefix_color,"SAM"),w3_text("id-sam-carrier")),50,w3_div(),5,w3_inline("w3-halign-space-between/w3-last-halign-end",w3_select("w3-text-red","","PLL","owrx.sam_pll",owrx.sam_pll,owrx.sam_pll_s,"sam_pll_cb"),w3_button("class-button w3-hcenter","Reset","sam_pll_reset_cb")))+w3_inline_percent("w3-margin-T-2 w3-valign/",w3_div(""),55,w3_inline("w3-halign-space-between/w3-last-halign-end",w3_select("id-chan-null w3-text-red w3-hide","","channel<br>null","owrx.chan_null",owrx.chan_null,owrx.chan_null_s,"chan_null_cb"),w3_select("id-ovld-mute w3-text-red","","ovld<br>mute","owrx.ovld_mute",owrx.ovld_mute,owrx.ovld_mute_s,"ovld_mute_cb"))),kiwi_load_js_dir("extensions/",["noise_blank/noise_blank.js","noise_filter/noise_filter.js"],function(){noise_blank_init(),noise_filter_init()}),toggle_or_set_compression(toggle_e.FROM_COOKIE|toggle_e.SET,1),squelch_setup(toggle_e.FROM_COOKIE),audio_panner_ui_init(),w3_el("id-optbar-agc").innerHTML=w3_col_percent("w3-valign w3-margin-B-4/class-slider",'<div id="id-button-agc" class="class-button" onclick="toggle_agc(event)" onmousedown="cancelEvent(event)" onmouseover="agc_over(event)">AGC</div>',13,'<div id="id-button-hang" class="class-button" onclick="toggle_or_set_hang();">Hang</div>',17,w3_divs("w3-show-inline-block/id-label-man-gain cl-closer-spaced-label-text","Manual<br>gain"),15,'<input id="input-man-gain" type="range" min="0" max="120" value="'+manGain+'" step="1" onchange="setManGain(1,this.value)" oninput="setManGain(0,this.value)">',40,w3_div("field-man-gain w3-show-inline-block",manGain.toString())+" dB",15)+w3_div("",w3_col_percent("w3-valign/class-slider",w3_div("label-threshold w3-show-inline-block","Threshold"),20,'<input id="input-threshold" type="range" min="-130" max="0" value="'+thresh+'" step="1" onchange="setThresh(1,this.value)" oninput="setThresh(0,this.value)">',52,w3_div("field-threshold w3-show-inline-block",thresh.toString())+" dBm"),w3_col_percent("w3-valign/class-slider",w3_div("label-threshCW w3-show-inline-block","Thresh CW"),20,'<input id="input-threshCW" type="range" min="-130" max="0" value="'+threshCW+'" step="1" onchange="setThreshCW(1,this.value)" oninput="setThreshCW(0,this.value)">',52,w3_div("field-threshCW w3-show-inline-block",threshCW.toString())+" dBm"),w3_col_percent("w3-valign/class-slider",w3_div("label-slope w3-show-inline-block","Slope"),20,'<input id="input-slope" type="range" min="0" max="10" value="'+slope+'" step="1" onchange="setSlope(1,this.value)" oninput="setSlope(0,this.value)">',52,w3_div("field-slope w3-show-inline-block",slope.toString())+" dB"),w3_col_percent("w3-valign/class-slider",w3_div("label-decay w3-show-inline-block","Decay"),20,'<input id="input-decay" type="range" min="20" max="5000" value="'+decay+'" step="1" onchange="setDecay(1,this.value)" oninput="setDecay(0,this.value)">',52,w3_div("field-decay w3-show-inline-block",decay.toString())+" msec")),setup_agc(toggle_e.FROM_COOKIE|toggle_e.SET),w3_click_nav(kiwi_toggle(toggle_e.FROM_COOKIE|toggle_e.SET,"optbar-wf","optbar-wf","last_optbar"),"optbar","init"),w3_el("id-news").style.backgroundColor=news_color,w3_el("id-news-inner").innerHTML='<span style="font-size: 14pt; font-weight: bold;">KiwiSDR now available on <a href="https://www.kickstarter.com/projects/1575992013/kiwisdr-beaglebone-software-defined-radio-sdr-with" target="_blank"><img class="class-KS" src="icons/kickstarter-logo-light.150x18.png" /></a></span>',w3_el("id-readme").style.backgroundColor=readme_color,w3_el("id-readme-inner").innerHTML='<span style="font-size: 15pt; font-weight: bold;">Welcome!</span>&nbsp;&nbsp;&nbsp;Project website: <a href="http://kiwisdr.com" target="_blank">kiwisdr.com</a>&nbsp;&nbsp;&nbsp;&nbsp;Here are some tips:<ul style="padding-left: 12px;"><li> Windows: Firefox, Chrome & Edge work; IE does not work. </li><li> Mac & Linux: Safari, Firefox, Chrome & Opera should work fine. </li><li> Open and close the panels by using the circled arrows at the top right corner. </li><li> You can click and/or drag almost anywhere on the page to change settings. </li><li> Enter a numeric frequency in the box marked "kHz" at right. </li><li> Or use the "select band" menu to jump to a pre-defined band. </li><li> Use the zoom icons to control the waterfall span. </li><li> Tune by clicking on the waterfall, spectrum or the cyan/red-colored station labels. </li><li> Ctrl-shift or alt-shift click in the waterfall to lookup frequency in online databases. </li><li> Control or option/alt click to page spectrum down and up in frequency. </li><li> Adjust the "WF min" slider for best waterfall colors or use the "Auto Scale" button. </li><li> Type \'h\' or \'?\' to see the list of keyboard shortcuts. </li><li> See the <a href="http://www.kiwisdr.com/quickstart/" target="_blank">Operating information</a> pageand <a href="http://kiwisdr.com/docs/KiwiSDR/KiwiSDR.design.review.pdf" target="_blank">Design review document</a>. </li></ul>';n=ext_get_cfg_param("contact_admin");isUndefined(n)&&(n=!0);t=ext_get_cfg_param("admin_email");null!=(t="undefined"!=n&&null!=n&&1==n&&"undefined"!=t&&null!=t?t:null)&&(t=encodeURIComponent(encodeURIComponent(enc(t)))),w3_el("id-optbar-status").innerHTML=w3_div("id-status-msg")+w3_div("",w3_text(optbar_prefix_color,"Links"),w3_text("",(t?"<a href=\"javascript:sendmail('"+t+"');\">Owner/Admin</a> | ":"")+'<a href="http://kiwisdr.com" target="_blank">KiwiSDR</a> | <a href="http://forum.kiwisdr.com/discussions" target="_blank">Forum</a> | <a href="https://kiwiirc.com/client/chat.freenode.net/#kiwisdr" target="_blank">Chat</a> '))+w3_div("id-status-adc")+w3_div("id-status-config")+w3_div("id-status-gps")+w3_inline("w3-valign",w3_div("id-status-audio")," ",w3_div("id-status-problems"))+w3_div("id-status-stats-cpu")+w3_div("id-status-stats-xfer"),setTimeout(function(){setInterval(status_periodic,5e3)},1e3)}var prev_optbar=null;function optbar_focus(e,t){writeCookie("last_optbar",e),"optbar-off"==e?("init"!=t&&"optbar-off"==prev_optbar&&toggle_or_set_hide_bars(),w3_hide("id-optbar-content"),w3_el("id-control-top").style.paddingBottom="8px"):(w3_show_block("id-optbar-content"),w3_el("id-control-top").style.paddingBottom=""),w3_el("id-control").style.height="",prev_optbar=e,freqset_select()}function optbar_blur(e){}function zoomCorrection(){return 3*zoom_level}var WF_SPEED_OFF=0,WF_SPEED_1HZ=1,WF_SPEED_SLOW=2,WF_SPEED_MED=3,WF_SPEED_FAST=4,wf_speed=WF_SPEED_FAST,wf_speeds=["off","1 Hz","slow","med","fast"],wf={no_wf:!1,url_tstamp:0,ts_tz:0,scroll_multiple:3,no_sync:!1,cmap:0,cmap_override:-1,custom_colormaps:[new Uint8Array(768),new Uint8Array(768),new Uint8Array(768),new Uint8Array(768)],aper:0,aper_algo:3,aper_param:0,sqrt:0,contr:0,last_zoom:-1,need_autoscale:0,auto_ceil:{min:0,val:5,max:30},auto_floor:{min:-30,val:0,max:0},auto_maxdb:0,auto_mindb:0,audioFFT_active:!1,audioFFT_prev_mode:"",audioFFT_clear_wf:!1},wf_contr_s={0:"normal",1:"scheme 1",2:"scheme 2",3:"scheme 3",4:"scheme 4"};function wf_contr_cb(e,t,a){}var wf_gnd=0,wf_gnd_value_base=150,wf_gnd_value=wf_gnd_value_base;function wf_gnd_cb(e,t,a){t=+t,w3_color(e,t?"white":"lime"),wf_gnd=!t,0==t&&freqset_select()}var wf_sp_param=0,wf_param=0,sp_param=0,wf_sp_which=0,wf_filter=0,spec_filter=0,wf_sp_menu_s=["IIR","MMA","EMA","off"],wf_sp_menu_e={IIR:0,MMA:1,EMA:2,OFF:3},wf_sp_slider_s=["gain","avgs","avgs",""],wf_sp_filter_p=[{IIR_min:0,IIR_max:1,IIR_step:.1,IIR_def:.2,IIR_val:void 0,MMA_min:1,MMA_max:32,MMA_step:1,MMA_def:8,MMA_val:void 0,EMA_min:1,EMA_max:32,EMA_step:1,EMA_def:8,EMA_val:void 0,off_min:0,off_max:0,off_step:0,off_def:0,off_val:void 0},{IIR_min:0,IIR_max:2,IIR_step:.1,IIR_def:.8,IIR_val:void 0,MMA_min:1,MMA_max:16,MMA_step:1,MMA_def:2,MMA_val:void 0,EMA_min:1,EMA_max:16,EMA_step:1,EMA_def:2,EMA_val:void 0,off_min:0,off_max:0,off_step:0,off_def:0,off_val:void 0}];function spec_show(){toggle_or_set_spec(toggle_e.SET,1);var e=-1;spectrum_param=parseFloat(spectrum_param),isNaN(spectrum_param)||-1==spectrum_param||(e=spectrum_param),wf_sp_which=0;var t=wf_sp_menu_s[spec_filter],a=wf_sp_filter_p[0];e>=a[t+"_min"]&&e<=a[t+"_max"]&&(wf_sp_slider_cb("id-wf-sp-slider",e,!0,!1),toggle_or_set_wf_sp_button(toggle_e.SET,0))}function wf_sp_menu_cb(e,t,a,_){t=+t,(wf_sp_which=+_)?wf_filter=t:spec_filter=t;_=wf_sp_which?wf_filter:spec_filter,t=wf_sp_menu_s[_];wf_sp_slider_cb("id-wf-sp-slider",wf_sp_filter_p[wf_sp_which][t+"_val"],!0,!1),toggle_or_set_wf_sp_button(toggle_e.SET,wf_sp_which),writeCookie(wf_sp_which?"last_wf_filter":"last_spec_filter",_.toString()),wf_sp_which?need_clear_wfavg=!0:spec.need_clear_avg=!0,freqset_select()}function spectrum_filter(e){wf_sp_menu_cb("",e,!1,0)}function toggle_or_set_wf_sp_button(e,t){isNumber(e)?wf_sp_which=+kiwi_toggle(e,+t,+t,"last_wf_sp_filter"):wf_sp_which^=1,w3_innerHTML("id-wf-sp-button",wf_sp_which?"WF &Delta;":"Spec &Delta;");t=wf_sp_menu_s[wf_sp_which?wf_filter:spec_filter];wf_sp_slider_cb("id-wf-sp-slider",wf_sp_filter_p[wf_sp_which][t+"_val"],!0,!1),freqset_select()}function wf_sp_slider_cb(e,t,a,_){var i,o,n,s;_||(t=+t,o=wf_sp_menu_s[i=wf_sp_which?wf_filter:spec_filter],n=wf_sp_filter_p[wf_sp_which],null!=t&&!isNaN(t)||(t=n[o+"_def"],s=parseFloat(readCookie(wf_sp_which?"last_wf_filter":"last_spec_filter")),_=parseFloat(readCookie(wf_sp_which?"last_wf_filter_param":"last_spec_filter_param")),s!=i||isNaN(_)||(t=_)),wf_sp_which?wf_param=t:sp_param=t,n[o+"_val"]=t,w3_slider_setup("id-wf-sp-slider",n[o+"_min"],n[o+"_max"],n[o+"_step"],t),w3_el("id-wf-sp-slider-field").innerHTML=i==wf_sp_menu_e.OFF?"":t+" "+wf_sp_slider_s[i],a&&(writeCookie(wf_sp_which?"last_wf_filter_param":"last_spec_filter_param",t.toFixed(2)),freqset_select()))}function wf_cmap_cb(e,t,a){a||(t=+t,wf.cmap=w3_clamp(t,0,kiwi.cmap_s.length-1,0),w3_select_value(e,t,{all:1}),writeCookie("last_cmap",t),mkcolormap(),spectrum_dB_bands(),update_maxmindb_sliders(),wf_send("SET cmap="+wf.cmap),w3_call("colormap_select"),freqset_select())}function wf_aper_cb(e,t,a){a||(t=+t,wf.aper=w3_clamp(t,0,kiwi.aper_s.length-1,0),w3_select_value(e,t),writeCookie("last_aper",t),t=wf.aper==kiwi.aper_e.auto,w3_innerHTML("id-wf-sliders",t?wf.floor_ceil_sliders:wf.max_min_sliders),w3_color("id-button-wf-autoscale",null,t?w3_selection_green:""),t?(wf.save_maxdb=maxdb,wf.save_mindb_un=mindb_un,wf.audioFFT_active&&(wf.need_autoscale=16)):(setmaxdb(1,wf.save_maxdb),setmindb(1,wf.save_mindb_un-zoomCorrection())),spectrum_dB_bands(),update_maxmindb_sliders(),w3_show_hide_inline("id-wfext-maxmin",t),w3_show_hide_inline("id-wfext-maxmin-spacer",!t),colormap_update(),freqset_select())}function setwfspeed(e,t){wf.audioFFT_active?freqset_select():(wf_speed=+t,w3_set_value("slider-rate",wf_speed),w3_el("slider-rate-field").innerHTML=wf_speeds[wf_speed],w3_el("slider-rate-field").style.color=wf_speed?"white":"orange",wf_send("SET wf_speed="+wf_speed.toFixed(0)),e&&freqset_select())}function setmaxdb(e,t,a){var _=parseFloat(t),i=!1;if(wf.aper==kiwi.aper_e.auto)maxdb=_+wf.auto_ceil.val;else{var o=w3_el("id-input-maxdb"),n=w3_el("id-field-maxdb"),t=w3_el("id-field-mindb");if(!o||!n||!t)return;i=!0,_<=mindb?(maxdb=mindb+1,html(o).value=maxdb,html(n).innerHTML=maxdb.toFixed(0)+" dB",html(n).style.color="red"):(maxdb=_,html(n).innerHTML=_.toFixed(0)+" dB",html(n).style.color="white",html(t).style.color="white")}setmaxmindb(e,i,a)}function incr_mindb(e,t){wf.aper==kiwi.aper_e.man&&(t=+mindb+t,setmindb(e,Math.max(-190,Math.min(-30,t)).toFixed(0)))}function setmindb(e,t,a){var _=parseFloat(t),i=!1;if(wf.aper==kiwi.aper_e.auto)mindb=_+wf.auto_floor.val;else{var o=w3_el("id-input-mindb"),n=w3_el("id-field-maxdb"),t=w3_el("id-field-mindb");if(!o||!n||!t)return;i=!0,maxdb<=_?(mindb=maxdb-1,html(o).value=mindb,html(t).innerHTML=mindb.toFixed(0)+" dB",html(t).style.color="red"):(mindb=_,html(o).value=mindb,html(t).innerHTML=_.toFixed(0)+" dB",html(t).style.color="white",html(n).style.color="white")}mindb_un=mindb+zoomCorrection(),setmaxmindb(e,i,a)}function setmaxmindb(e,t,a){full_scale=(full_scale=maxdb-mindb)||1,spectrum_dB_bands(),wf_send("SET maxdb="+maxdb.toFixed(0)+" mindb="+mindb.toFixed(0)),need_clear_wf_sp_avg=!0,e&&(1!=a&&freqset_select(),t&&(writeCookie(wf.audioFFT_active?"last_AF_max_dB":"last_max_dB",maxdb.toFixed(0)),writeCookie(wf.audioFFT_active?"last_AF_min_dB":"last_min_dB",mindb_un.toFixed(0))))}function update_maxmindb_sliders(){var e,t,a,_,i,o=wf.aper==kiwi.aper_e.auto;o||(mindb=mindb_un-zoomCorrection()),full_scale=(full_scale=maxdb-mindb)||1,spectrum_dB_bands(),i=o?(e=wf.auto_ceil.val,i=wf.auto_floor.val,t=e.toFixed(0).positiveWithSign(),a=i.toFixed(0).positiveWithSign(),w3_el("id-input-ceildb").value=e,w3_el("id-input-floordb").value=i,_=w3_el("id-field-ceildb"),w3_el("id-field-floordb")):(i=mindb,t=(e=maxdb).toFixed(0),a=i.toFixed(0),w3_el("id-input-maxdb").value=e,w3_el("id-input-mindb").value=i,_=w3_el("id-field-maxdb"),w3_el("id-field-mindb")),_.innerHTML=t+" dB",i.innerHTML=a+" dB"}function setceildb(e,t){var a=w3_el("id-input-ceildb"),_=w3_el("id-field-ceildb");a&&_&&(t=parseFloat(t),w3_innerHTML(_,t.toFixed(0).positiveWithSign()+" dB"),wf.auto_ceil.val=t,set_ceilfloordb(e))}function setfloordb(e,t){var a=w3_el("id-input-floordb"),_=w3_el("id-field-floordb");a&&_&&(t=parseFloat(t),w3_innerHTML(_,t.toFixed(0).positiveWithSign()+" dB"),wf.auto_floor.val=t,set_ceilfloordb(e))}function set_ceilfloordb(e){maxdb=wf.auto_maxdb+wf.auto_ceil.val,mindb=wf.auto_mindb+wf.auto_floor.val,mindb_un=mindb+zoomCorrection(),setmaxmindb(e,!1),w3_call("waterfall_maxmin_cb"),e&&(freqset_select(),writeCookie("last_ceil_dB",wf.auto_ceil.val.toFixed(0)),writeCookie("last_floor_dB",wf.auto_floor.val.toFixed(0)))}function wf_autoscale_cb(){wf.need_autoscale=1,colormap_update(),freqset_select()}var spectrum_slow_dev=0;function toggle_or_set_slow_dev(e,t){isNumber(e)?spectrum_slow_dev=kiwi_toggle(e,t,spectrum_slow_dev,"last_slow_dev"):spectrum_slow_dev^=1,w3_color("id-button-slow-dev",spectrum_slow_dev?"lime":"white"),freqset_select(),writeCookie("last_slow_dev",spectrum_slow_dev.toString()),spectrum_slow_dev&&wf_speed==WF_SPEED_FAST&&setwfspeed(1,WF_SPEED_MED)}function toggle_or_set_spec_peak(e,t){isNumber(e)?spec.peak_show=kiwi_toggle(e,t,spec.peak_show,"last_spec_peak"):spec.peak_show^=1,spec.peak_show&&(spec.peak_clear=!0),w3_color("id-button-spec-peak",spec.peak_show?"lime":"white"),freqset_select(),writeCookie("last_spec_peak",spec.peak_show.toString())}var muted_until_freq_set=!0,recording=!1;function setvolume(e,t){kiwi.volume=+t,isNumber(kiwi.volume)||(kiwi.volume=50),kiwi.volume=w3_clamp3(kiwi.volume,0,200,0,50,50),kiwi.volume_f=kiwi.muted||0==kiwi.volume?1e-6:kiwi.volume/100,e&&(w3_set_value("id-input-volume",kiwi.volume),writeCookie("last_volume",kiwi.volume),freqset_select())}function toggle_or_set_mute(e){isNumber(e)?kiwi.muted=e:kiwi.muted^=1,console.log("$toggle_or_set_mute set="+e+" muted="+kiwi.muted),owrx.squelched_overload||(w3_show_hide("id-mute-no",!kiwi.muted),w3_show_hide("id-mute-yes",kiwi.muted)),kiwi.volume_f=kiwi.muted||0==kiwi.volume?1e-6:kiwi.volume/100,freqset_select(),canvas_log_clear(),owrx.debug_drag&&(owrx.drag_count=0)}var de_emphasis=0,de_emphasis_s=["off","on"];function de_emp_cb(e,t,a){snd_send("SET de_emp="+(de_emphasis=+t)),writeCookie("last_de_emphasis",de_emphasis.toString())}var pan=0;function setpan(e,t){t=+t;-.1<t&&t<.1&&(t=0),w3_set_value("id-pan-value",t),w3_color("id-pan-value",null,t<0?"rgba(255,0,0,0.3)":t?"rgba(0,255,0,0.2)":""),w3_innerHTML("id-pan-field",t?(100*Math.abs(t)).toFixed(0)+" "+(t<0?"L":"R"):"L=R"),audio_set_pan(t),e&&(writeCookie("last_pan",t.toString()),freqset_select())}function audio_panner_ui_init(){audio_panner&&(w3_hide2("id-vol-comp"),w3_hide2("id-vol",!1),w3_hide2("id-pan",!1),setpan(1,pan))}function toggle_or_set_hide_bars(e){isNumber(e)?owrx.hide_bars=e:(owrx.hide_bars=owrx.hide_bars+1&owrx.HIDE_ALLBARS,owrx.hide_bars&owrx.HIDE_TOPBAR&&(extint.using_data_container||spec.source_wf||spec.source_audio)&&(owrx.hide_bars=owrx.hide_bars+1&owrx.HIDE_ALLBARS)),w3_set_props("id-top-container","w3-panel-override-hide",owrx.hide_bars&owrx.HIDE_TOPBAR),w3_set_props("id-band-container","w3-panel-override-hide",owrx.hide_bars&owrx.HIDE_BANDBAR),openwebrx_resize()}var test_button,hide_panels=0;function toggle_or_set_hide_panels(e){isNumber(e)?hide_panels=e:hide_panels^=1,w3_iterate_children("id-panels-container",function(e){w3_contains(e,"class-panel")&&w3_set_props(e,"w3-panel-override-hide",hide_panels)})}function toggle_or_set_test(e){isNumber(e)?test_button=e:test_button^=1,console.log("toggle_or_set_test set="+e+" test_button="+test_button),w3_color("id-button-test",test_button?"lime":"white"),snd_send("SET test="+(test_button?1:0)),freqset_select()}function toggle_or_set_rec(e){var t,a,_;console.log("toggle_or_set_rec set="+e+" recording="+recording),recording=isBoolean(e)||isNumber(e)?e:!recording,w3_remove_then_add("id-rec1","fa-spin",recording?"fa-spin":""),w3_remove_then_add("id-rec2","fa-spin",recording?"fa-spin":""),w3_remove_then_add("id-rec1","w3-text-white","w3-text-pink"),w3_remove_then_add("id-rec2","w3-text-white","w3-text-pink"),recording?(window.recording_meta={buffers:[],data:null,offset:0,total_size:0,filename:kiwi_host()+"_"+(new Date).toISOString().replace(/:/g,"_").replace(/\.[0-9]+Z$/,"Z")+"_"+w3_el("id-freq-input").value+"_"+cur_mode+".wav"},window.recording_meta.buffers.push(new ArrayBuffer(65536)),window.recording_meta.data=new DataView(window.recording_meta.buffers[0])):window.recording_meta&&(_=new ArrayBuffer(44),(a=new DataView(_)).setUint32(0,1380533830),a.setUint32(4,window.recording_meta.total_size+36,!0),a.setUint32(8,1463899717),a.setUint32(12,1718449184),a.setUint32(16,16,!0),a.setUint16(20,1,!0),t=ext_is_IQ_or_stereo_curmode()?2:1,a.setUint16(22,t,!0),e=Math.round(audio_input_rate||12e3),a.setUint32(24,e,!0),a.setUint32(28,e*t*2,!0),a.setUint16(32,2*t,!0),a.setUint16(34,16,!0),a.setUint32(36,1684108385),a.setUint32(40,window.recording_meta.total_size,!0),window.recording_meta.buffers.unshift(_),a=new Blob(window.recording_meta.buffers,{type:"octet/stream"}),(_=document.createElement("a")).style="display: none",_.href=window.URL.createObjectURL(a),_.download=window.recording_meta.filename,document.body.appendChild(_),_.click(),window.URL.revokeObjectURL(_.href),document.body.removeChild(_),delete window.recording_meta)}var squelched=0,squelch=0,squelch_tail=0,squelch_tail_s=["0",".2s",".5s","1s","2s"],squelch_tail_v=[0,.2,.5,1,2];function squelch_action(e){var t=(squelched=e)?"white":kiwi.unmuted_color,e=t;owrx.squelched_overload=owrx.sMeter_dBm>=cfg.overload_mute,owrx.prev_squelched_overload!=owrx.squelched_overload&&(w3_show_hide("id-mute-exclaim",owrx.squelched_overload),w3_show_hide("id-mute-no",!owrx.squelched_overload&&!kiwi.muted),w3_show_hide("id-mute-yes",!owrx.squelched_overload&&kiwi.muted),owrx.prev_squelched_overload=owrx.squelched_overload),w3_color("id-squelch-label",e),w3_color("id-mute-no",t),recording&&(t=squelched||owrx.squelched_overload,w3_remove_then_add("id-rec1","fa-spin",t?"":"fa-spin"),w3_remove_then_add("id-rec2","fa-spin",t?"":"fa-spin"),w3_remove_then_add("id-rec1","w3-text-white w3-text-pink",t?"w3-text-white":"w3-text-pink"),w3_remove_then_add("id-rec2","w3-text-white w3-text-pink",t?"w3-text-white":"w3-text-pink"))}function squelch_setup(e){var t="nbfm"==cur_mode;e&toggle_e.FROM_COOKIE&&(e=readCookie("last_squelch"+(t?"":"_efm")),squelch=e?+e:0,w3_el("id-squelch-value").max=t?99:40,w3_set_value("id-squelch-value",squelch),e=kiwi_storeGet("last_tail",0),squelch_tail=e?+e:0,w3_select_value("id-squelch-tail",squelch_tail)),set_squelch_cb("",squelch,!0,!1,!0),squelch_tail_cb("",squelch_tail,!1,!0),t?squelch_action(squelched):w3_color("id-mute-no",kiwi.unmuted_color),w3_hide2("id-squelch-tail",t),w3_hide2("id-squelch","drm"==cur_mode)}function send_squelch(){var e="nbfm"==cur_mode;snd_send("SET squelch="+squelch.toFixed(0)+" param="+(e?squelch_threshold:squelch_tail_v[squelch_tail]).toFixed(2))}function set_squelch_cb(e,t,a,_,i){var o="nbfm"==cur_mode;_||(squelch=parseFloat(t),w3_el("id-squelch-field").innerHTML=squelch?t+(o?"":" dB"):"off",w3_color("id-squelch-value",null,squelch?"":"rgba(255,0,0,0.3)"),a&&(send_squelch(),1!=i&&writeCookie("last_squelch"+(o?"":"_efm"),t),freqset_select()))}function squelch_tail_cb(e,t,a,_){a||(squelch_tail=+t,send_squelch(),1!=_&&"nbfm"!=cur_mode&&kiwi_storeSet("last_tail",squelch_tail))}function sam_pll_reset_cb(e,t,a){snd_send("SET sam_pll=-1")}function sam_pll_cb(e,t,a){owrx.sam_pll=+t,snd_send("SET sam_pll="+owrx.sam_pll)}function chan_null_cb(e,t,a){a||(owrx.chan_null=+t,ext_set_mode(cur_mode))}function ovld_mute_cb(e,t,a){a||(owrx.ovld_mute=+t,snd_send("SET ovld_mute="+(owrx.ovld_mute?1:0)))}var btn_less_buffering=0;function toggle_or_set_audio(e,t){isNumber(e)?btn_less_buffering=kiwi_toggle(e,t,btn_less_buffering,"last_audio"):btn_less_buffering^=1;t=w3_el("id-button-buffering");t&&(t.style.color=btn_less_buffering?"lime":"white",t.style.visibility="visible",freqset_select()),writeCookie("last_audio",btn_less_buffering.toString()),isNumber(e)||window.location.reload(!0)}var btn_compression=0;function toggle_or_set_compression(e,t){recording||(isNumber(e)?btn_compression=kiwi_toggle(e,t,btn_compression,"last_compression"):btn_compression^=1,w3_els("id-button-compression",function(e){e.style.color=btn_compression?"lime":"white",e.style.visibility="visible",freqset_select()}),writeCookie("last_compression",btn_compression.toString()),snd_send("SET compression="+btn_compression.toFixed(0)))}function set_agc(){var e=cur_mode&&"cw"==cur_mode.substr(0,2);w3_color("label-threshold",!e&&agc?"orange":"white"),w3_color("label-threshCW",e&&agc?"orange":"white"),snd_send("SET agc="+agc+" hang="+hang+" thresh="+(e?threshCW:thresh)+" slope="+slope+" decay="+decay+" manGain="+manGain)}var agc=0;function toggle_agc(e){return any_alternate_click_event(e)?setup_agc(toggle_e.SET):toggle_or_set_agc(),cancelEvent(e)}function agc_over(e){w3_el("id-button-agc").title=any_alternate_click_event(e)?"restore AGC params":""}var default_agc=1,default_hang=0,default_manGain=50,default_thresh=-100,default_threshCW=-130,default_slope=6,default_decay=1e3;function setup_agc(e){toggle_or_set_agc(agc=kiwi_toggle(e,default_agc,agc,"last_agc")),toggle_or_set_hang(hang=kiwi_toggle(e,default_hang,hang,"last_hang")),setManGain(!0,manGain=kiwi_toggle(e,default_manGain,manGain,"last_manGain")),setThresh(!0,thresh=kiwi_toggle(e,default_thresh,thresh,"last_thresh")),setThreshCW(!0,threshCW=kiwi_toggle(e,default_threshCW,threshCW,"last_threshCW")),setSlope(!0,slope=kiwi_toggle(e,default_slope,slope,"last_slope")),setDecay(!0,decay=kiwi_toggle(e,default_decay,decay,"last_decay"))}function toggle_or_set_agc(e){null!=e?agc=e:agc^=1,html("id-button-agc").style.color=agc?"lime":"white",agc?(html("id-label-man-gain").style.color="white",html("id-button-hang").style.borderColor=html("label-slope").style.color=html("label-decay").style.color="orange"):(html("id-label-man-gain").style.color="orange",html("id-button-hang").style.borderColor=html("label-slope").style.color=html("label-decay").style.color="white"),set_agc(),writeCookie("last_agc",agc.toString()),freqset_select()}var hang=0;function toggle_or_set_hang(e){null!=e?hang=e:hang^=1,html("id-button-hang").style.color=hang?"lime":"white",set_agc(),writeCookie("last_hang",hang.toString()),freqset_select()}var manGain=0;function setManGain(e,t){manGain=parseFloat(t),html("input-man-gain").value=manGain,html("field-man-gain").innerHTML=t,set_agc(),writeCookie("last_manGain",manGain.toString()),e&&freqset_select()}var thresh=0;function setThresh(e,t){thresh=parseFloat(t),html("input-threshold").value=thresh,html("field-threshold").innerHTML=t,set_agc(),writeCookie("last_thresh",thresh.toString()),e&&freqset_select()}var threshCW=0;function setThreshCW(e,t){threshCW=parseFloat(t),html("input-threshCW").value=threshCW,html("field-threshCW").innerHTML=t,set_agc(),writeCookie("last_threshCW",threshCW.toString()),e&&freqset_select()}var slope=0;function setSlope(e,t){slope=parseFloat(t),html("input-slope").value=slope,html("field-slope").innerHTML=t,set_agc(),writeCookie("last_slope",slope.toString()),e&&freqset_select()}var decay=0;function setDecay(e,t){decay=parseFloat(t),html("input-decay").value=decay,html("field-decay").innerHTML=t,set_agc(),writeCookie("last_decay",decay.toString()),e&&freqset_select()}function users_setup(){for(var e="",t=0;t<rx_chans;t++)e+=w3_div("",w3_div("w3-show-inline-block w3-left w3-margin-R-5 "+(t==rx_chan?"w3-text-css-lime":optbar_prefix_color),"RX"+t),w3_div("id-optbar-user-"+t+" w3-show-inline-block"));var a=kiwi_isMobile()?" w3-font-16px":"";e+=w3_input("w3-margin-TB-4 w3-width-half/w3-label-not-bold/w3-custom-events"+a+'|padding:1px|size=20 onchange="ident_complete(\'el\', 2)" onkeyup="ident_keyup(this, event, 2)" ontouchstart="popup_keyboard_touchstart(event)"',"Your name or callsign:","ident-input2"),w3_innerHTML("id-optbar-users",w3_div("w3-nowrap",e))}function freq_vfo_cb(){owrx.vfo_ab^=1,w3_flip_colors("id-freq-vfo","w3-aqua w3-orange",owrx.vfo_ab),w3_innerHTML("id-freq-vfo","AB"[owrx.vfo_ab]);var e=parse_freq_pb_mode_zoom(readCookie("last_vfo_"+"AB"[owrx.vfo_ab])),t=void 0,a=0;e[3]&&(t=e[3].toLowerCase()),e[4]&&(a=+e[4]),ext_tune(e[1],t,ext_zoom.ABS,a)}function toggle_or_set_spec(e,t){console.log("toggle_or_set_spec set="+e+" val="+t),isNumber(e)&&e&toggle_e.SET?spec.source_wf=t:spec.source_wf^=1,extint.using_data_container&&spec.source_wf&&extint_panel_hide(),html("id-button-spectrum").style.color=spec.source_wf?"lime":"white",w3_show_hide("id-spectrum-container",spec.source_wf),w3_show_hide("id-top-container",!spec.source_wf),freqset_select()}function mode_over(e,t){var a;switch(t.innerHTML.toLowerCase()){case"sam":a="synchronous AM";break;case"sal":a="synchronous AM LSB";break;case"sau":a="synchronous AM USB";break;case"sas":a="synchronous AM stereo";break;case"qam":a="C-QUAM AM stereo";break;default:a=""}t.title=e.shiftKey?"restore passband":a}function any_alternate_click_event(e){return e&&(e.shiftKey||e.ctrlKey||e.altKey||e.button==mouse.middle||e.button==mouse.right)}function any_alternate_click_event_except_shift(e){return e&&(e.ctrlKey||e.altKey||e.button==mouse.middle||e.button==mouse.right)}function any_modifier_key(e){return e&&(e.shiftKey||e.ctrlKey||e.altKey)}function restore_passband(e){owrx.last_lo[e]=cfg.passbands[e].lo,owrx.last_hi[e]=cfg.passbands[e].hi}var step_9_10,divControl,mode_buttons=[{s:["AM","AMN"],dis:0},{s:["SAM","SAL","SAU","SAS","QAM"],dis:0},{s:["DRM"],dis:0},{s:["LSB","LSN"],dis:0},{s:["USB","USN"],dis:0},{s:["CW","CWN"],dis:0},{s:["NBFM"],dis:0},{s:["IQ"],dis:0}];function mode_button(e,t,a){var _=t.innerHTML.toLowerCase();if(isUndefined(a)&&(a=1),any_alternate_click_event(e)){if(e.shiftKey||e.button==mouse.middle)return restore_passband(_),void ext_set_mode(_,null,{open_ext:!0});a=-1}var i=parseInt(t.id);if(isUndefined(owrx.last_mode_col)&&(owrx.last_mode_col=parseInt(owrx.last_mode_el.id)),owrx.last_mode_col!=i){if(recording)if((ext_is_IQ_or_stereo_curmode()?1:0)^(ext_is_IQ_or_stereo_mode(_)?1:0)||"drm"==_)return;owrx.last_mode_col=i}else{e=mode_buttons[i].s,i=_.toUpperCase(),a=e.indexOf(i)+a;if(a<=-1&&(a=e.length-1),a>=e.length&&(a=0),i=e[a],_=i.toLowerCase(),recording)if((ext_is_IQ_or_stereo_curmode()?1:0)^(ext_is_IQ_or_stereo_mode(_)?1:0)||"drm"==_)return;t.innerHTML=i}ext_set_mode(_,null,{open_ext:!0})}function button_9_10(e){null!=e?step_9_10=e:step_9_10^=1,writeCookie("last_9_10",step_9_10),freq_step_update_ui(!0),w3_el("id-button-9-10").innerHTML=step_9_10?"9":"10",freqset_select()}function pop_bottommost_panel(e){min_order=parseInt(e[0].getAttribute("data-panel-order"));for(var t=min_index=0;t<e.length;t++)actual_order=parseInt(e[t].getAttribute("data-panel-order")),actual_order<min_order&&(min_index=t,min_order=actual_order);return to_return=e[min_index],e.splice(min_index,1),to_return}function place_panels(){for(var e=[],t=[],a=html("id-panels-container").children,_=0;_<a.length;_++){var i,o,n=a[_];!n.classList.contains("class-panel")||(i=n.getAttribute("data-panel-pos"))&&(o=n.getAttribute("data-panel-size").split(","),"left"==i?e.push(n):"right"==i&&t.push(n),n.idName=n.id.replace("id-",""),n.style.width=o[0]+"px",n.style.height=o[1]+"px",n.style.margin=px(panel_margin),n.uiWidth=parseInt(o[0]),n.uiHeight=parseInt(o[1]),n.defaultWidth=parseInt(o[0]),n.defaultHeight=parseInt(o[1]),o=html_LR_border_pad(n),n.activeWidth=n.uiWidth-o,"center"==i&&(n.style.left=px(window.innerWidth/2-n.activeWidth/2),n.style.bottom=px(window.innerHeight/2-n.uiHeight/2),n.style.visibility="hidden"),"bottom-left"==i&&(n.style.left=0,n.style.bottom=0,n.style.visibility="hidden"))}for(y=0;0<e.length;)p=pop_bottommost_panel(e),p.style.left=0,p.style.bottom=px(y),p.style.visibility="visible",y+=p.uiHeight+3*panel_margin,w3_call("panel_setup_"+p.idName,p);for(y=0;0<t.length;)p=pop_bottommost_panel(t),p.style.right=kiwi_isMobile()?0:px(kiwi_scrollbar_width()),p.style.bottom=px(y),p.style.visibility="visible",y+=p.uiHeight+3*panel_margin,w3_call("panel_setup_"+p.idName,p)}var OPTBAR_CONTENT_HEIGHT=150;function panel_setup_control(e){(divControl=e).style.marginBottom="0",w3_el("id-control-inner").innerHTML=w3_div("id-control-top",w3_div("id-control-freq1"),w3_div("id-control-freq2"),w3_div("id-control-mode w3-margin-T-6"),w3_div("id-control-zoom w3-margin-T-6"),w3_div("id-optbar w3-margin-T-4"))+w3_div("id-optbar-content w3-margin-T-6 w3-scroll-y|height:"+px(OPTBAR_CONTENT_HEIGHT),w3_div("id-optbar-wf w3-hide"),w3_div("id-optbar-audio w3-hide"),w3_div("id-optbar-agc w3-hide"),w3_div("id-optbar-users w3-hide w3-scroll-x"),w3_div("id-optbar-status w3-hide"))+w3_div("id-control-smeter"),w3_el("id-control-freq1").style.width=px(e.activeWidth-visIcon-6),w3_show_hide("id-mute-no",!kiwi.muted),w3_show_hide("id-mute-yes",kiwi.muted)}function panel_set_vis_button(e){var t=w3_el(e),e=w3_el(e+"-vis"),t=t.activeWidth-visIcon;e.style.left=px(t+visBorder)}function panel_set_width_height(e,t,a){var _=w3_el(e);null==t&&(t=_.defaultWidth),_.style.width=px(t),_.uiWidth=t,null==a&&(a=_.defaultHeight),_.style.height=px(a),_.uiHeight=a;a=html_LR_border_pad(_);_.activeWidth=_.uiWidth-a,panel_set_vis_button(e)}function add_problem(e,t,a,_){if(el=w3_el(_||"id-status-problems"),el){if(isDefined(el.children)){for(var i=0;i<el.children.length;i++)if(el.children[i].innerHTML==e)return;if(0==t)for(;el.firstChild;)el.removeChild(el.firstChild)}t=w3_create_appendElement(el,"span",e);1!=a&&window.setTimeout(function(e,t){try{e.removeChild(t)}catch(e){}},1e3,el,t)}}function set_gen(e,t){snd_send("SET genattn="+t.toFixed(0)),snd_send("SET gen="+e+" mix=-1")}var bin_server=0,zoom_server=0;function owrx_msg_cb(e,t){switch(e[0]){case"wf_setup":wf_init();break;case"extint_list_json":extint_list_json(e[1]),override_ext&&extint_open(override_ext,3e3);break;case"bandwidth":bandwidth=parseInt(e[1]);break;case"center_freq":center_freq=parseInt(e[1]);break;case"wf_fft_size":wf_fft_size=parseInt(e[1]);break;case"wf_fps_max":wf_fps_max=parseInt(e[1]);break;case"wf_fps":wf_fps=parseInt(e[1]);break;case"start":bin_server=parseInt(e[1]);break;case"zoom":zoom_server=parseInt(e[1]);break;case"zoom_max":zoom_levels_max=parseInt(e[1]),zoom_nom=Math.min(ZOOM_NOMINAL,zoom_levels_max);break;case"audio_init":toggle_or_set_audio(toggle_e.FROM_COOKIE|toggle_e.SET,1),audio_init(+e[1],btn_less_buffering,kiwi_toggle(toggle_e.FROM_COOKIE|toggle_e.SET,1,1,"last_compression"));break;case"audio_camp":var a=e[1].split(",");audio_camp(+a[0],+a[1],btn_less_buffering,kiwi_toggle(toggle_e.FROM_COOKIE|toggle_e.SET,1,1,"last_compression"));break;case"audio_rate":audio_rate(parseFloat(e[1]));break;case"audio_adpcm_state":a=e[1].split(",");audio_adpcm_state(+a[0],+a[1]);break;case"audio_passband":a=e[1].split(",");audio_recompute_LPF(1,+a[0],+a[1]);break;case"audio_flags2":audio_recv_flags2(e[1]);break;case"kiwi_up":kiwi_up(parseInt(e[1]));break;case"gps":toggle_or_set_spec(toggle_e.SET,1);break;case"fft_mode":kiwi_fft_mode();break;case"maxdb":wf.auto_maxdb=+e[1],setmaxdb(1,wf.auto_maxdb,!0);break;case"mindb":wf.auto_mindb=+e[1],setmindb(1,wf.auto_mindb,!0),w3_call("waterfall_maxmin_cb"),update_maxmindb_sliders(!0);break;case"max_thr":owrx.overload_mute=Math.round(+e[1]);break;default:return!1}return!0}function owrx_ws_open_snd(e,t){return ws_snd=open_websocket("SND",e,t,owrx_msg_cb,audio_recv,on_ws_error,owrx_close_cb)}function owrx_ws_open_wf(e,t){return ws_wf=open_websocket("W/F",e,t,owrx_msg_cb,waterfall_add_queue,on_ws_error)}function owrx_close_cb(){toggle_or_set_rec(0)}function on_ws_error(){console.log("WebSocket error")}function snd_send(t){try{return ws_snd.send(t),0}catch(e){return console.log("CATCH snd_send('"+t+"') ex="+e),kiwi_trace(),-1}}function wf_send(t){try{return ws_wf.send(t),0}catch(e){return console.log("CATCH wf_send('"+t+"') ex="+e),kiwi_trace(),-1}}function ws_any(){return ws_snd||ws_wf||null}var need_geo=!0,need_status=!0;function send_keepalive(){for(var e=0;e<1&&(ws_snd.up&&!(snd_send("SET keepalive")<0));e++){if(need_geo&&""!=kiwi_geo()){if(msg_send("SET geoloc="+kiwi_geo())<0)break;if(msg_send("SET geojson="+kiwi_geojson())<0)break;need_geo=!1}if(send_ident){if(ident_user=ident_user||"",snd_send("SET ident_user="+encodeURIComponent(ident_user))<0)break;send_ident=!1}if(need_status){if(snd_send("SET need_status=1")<0)break;need_status=!1}}ws_wf.up&&wf_send("SET keepalive")}



