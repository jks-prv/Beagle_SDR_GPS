var owrx={last_freq:-1,last_mode:"",last_locut:-1,last_hicut:-1},bandwidth,center_freq,wf_fft_size,height_top_bar_parts=67,height_spectrum_canvas=200,cur_mode,wf_fps,wf_fps_max,ws_snd,ws_wf,spectrum_show=0,spectrum_param=-1,gen_freq=0,gen_attn=0,squelch_threshold=0,wf_rate="",wf_mm="",wf_compression=1,debug_v=0,sb_trace=0,kiwi_gc=1,kiwi_gc_snd=0,kiwi_gc_wf=-1,kiwi_gc_recv=-1,kiwi_gc_wspr=-1,override_ext=null,muted_initially=0,peak_initially=null,param_nocache=!1,nocache=!1,param_ctrace=!1,ctrace=!1,no_clk_corr=!1,override_pbw="",override_pbc="",nb_click=!1,no_geoloc=!1,freq_memory=[],freq_memory_pointer=-1,wf_rates={0:0,off:0,1:1,"1hz":1,s:2,slow:2,m:3,med:3,f:4,fast:4},okay_waterfall_init=!1;function kiwi_main(){override_freq=parseFloat(readCookie("last_freq")),override_mode=readCookie("last_mode"),override_zoom=parseFloat(readCookie("last_zoom")),override_9_10=parseFloat(readCookie("last_9_10")),override_max_dB=parseFloat(readCookie("last_max_dB")),override_min_dB=parseFloat(readCookie("last_min_dB"));var e=readCookie("freq_memory");e&&(freq_memory=JSON.parse(e),freq_memory_pointer=freq_memory.length-1),console.log("LAST f="+override_freq+" m="+override_mode+" z="+override_zoom+" 9_10="+override_9_10+" min="+override_min_dB+" max="+override_max_dB);console.log("URL: "+window.location.href);var t=function(e){var t={};return e&&e.split("&").forEach(function(e){var a=e.split("=");t[a[0]]=a[1]?a[1]:1}),t},a=window.location.search&&window.location.search.substr(1),n=[],_=[];for(w=1;w<=4;w++){var i="&win"+(w+1)+"&";n[w]=a&&a.split(i)[0],a=a&&a.split(i)[1],_[w]=t(n[w]),_[w].WID=w}var o=window.location.href.split("?")[0];for(g_qs_idx=2,w=2;w<=4;w++)n[w]&&setTimeout(function(){var e=o+"?"+n[g_qs_idx];g_qs_idx++,null==window.open(e,"_blank")&&alert("Do you have popups blocked for this site? "+e)},2e3*(w-1));a=_[1];if(s="f",a[s]){var r=new RegExp("([0-9.,kM]*)([/:][-0-9.,k]*)?([^z]*)?z?([0-9]*)").exec(a[s]);r[1]&&(override_freq=r[1].replace(",",".").parseFloatWithUnits("M",.001)),r[1]&&console.log("p="+r[1]+" override_freq="+override_freq),r[2]&&console.log("override_pbw/pbc="+r[2]),r[2]&&"/"==r[2].charAt(0)&&(override_pbw=r[2].substr(1)),r[2]&&":"==r[2].charAt(0)&&(override_pbc=r[2].substr(1)),r[3]&&(override_mode=r[3].toLowerCase()),r[4]&&(override_zoom=r[4])}if(s="ext",a[s]){var l=a[s].split(",");override_ext=l[0],extint.param=l.slice(1).join(","),console.log("URL: ext="+override_ext+" ext_p="+extint.param)}if(s="pbw",a[s]&&(override_pbw=a[s]),s="pb",a[s]&&(override_pbw=a[s]),s="pbc",a[s]&&(override_pbc=a[s]),s="sp",a[s]&&(spectrum_show=a[s]),s="spp",a[s]&&(spectrum_param=parseFloat(a[s])),s="vol",a[s]&&(volume=parseInt(a[s]),volume=Math.max(0,volume),volume=Math.min(400,volume)),s="mute",a[s]&&(muted_initially=parseInt(a[s])),s="wf",a[s]&&(wf_rate=a[s]),s="wfm",a[s]&&(wf_mm=a[s]),s="cmap",a[s]&&(colormap_select=parseInt(a[s])),s="sqrt",a[s]&&(colormap_sqrt=parseInt(a[s])),s="peak",a[s]&&(peak_initially=parseInt(a[s])),s="no_geo",a[s]&&(no_geoloc=!0),s="keys",a[s]&&(shortcut.keys=a[s]),s="sqth",a[s]&&(squelch_threshold=parseFloat(a[s])),s="click",a[s]&&(nb_click=!0),s="nocache",a[s]&&(param_nocache=!0,nocache=parseInt(a[s])),s="ncc",a[s]&&(no_clk_corr=parseInt(a[s])),s="wfdly",a[s]&&(waterfall_delay=parseFloat(a[s])),s="wf_comp",a[s]&&(wf_compression=parseInt(a[s])),s="gen",a[s]&&(gen_freq=parseFloat(a[s])),s="attn",a[s]&&(gen_attn=parseInt(a[s])),s="blen",a[s]&&(audio_buffer_min_length_sec=parseFloat(a[s])/1e3),s="audio",a[s]&&(audio_meas_dly_ena=parseFloat(a[s])),s="gc",a[s]&&(kiwi_gc=parseInt(a[s])),s="gc_snd",a[s]&&(kiwi_gc_snd=parseInt(a[s])),s="gc_wf",a[s]&&(kiwi_gc_wf=parseInt(a[s])),s="gc_recv",a[s]&&(kiwi_gc_recv=parseInt(a[s])),s="gc_wspr",a[s]&&(kiwi_gc_wspr=parseInt(a[s])),s="ctrace",a[s]&&(param_ctrace=!0,ctrace=parseInt(a[s])),s="v",a[s]&&console.log("URL: debug_v = "+(debug_v=a[s])),-1==kiwi_gc_snd&&(kiwi_gc_snd=kiwi_gc),-1==kiwi_gc_wf&&(kiwi_gc_wf=kiwi_gc),-1==kiwi_gc_recv&&(kiwi_gc_recv=kiwi_gc),-1==kiwi_gc_wspr&&(kiwi_gc_wspr=kiwi_gc),console.log("GC: snd="+kiwi_gc_snd+" wf="+kiwi_gc_wf+" recv="+kiwi_gc_recv+" wspr="+kiwi_gc_wspr),""!=wf_mm){wf_mm=wf_mm.split(",");var d=parseInt(wf_mm[0]);!isNaN(d)&&d>=-190&&d<=-30&&(override_min_dB=d),wf_mm.length>=2&&(d=parseInt(wf_mm[1]),!isNaN(d)&&d>=-100&&d<=20&&(override_max_dB=d))}if(kiwi_xdLocalStorage_init(),kiwi_get_init_settings(),no_geoloc||kiwi_geolocate(),init_rx_photo(),right_click_menu_init(),keyboard_shortcut_init(),confirmation_panel_init(),ext_panel_init(),place_panels(),init_panels(),okay_waterfall_init=!0,confirmation_panel_init2(),smeter_init(),time_display_setup("id-topbar-right-container"),window.setTimeout(function(){window.setInterval(send_keepalive,5e3)},5e3),window.addEventListener("resize",openwebrx_resize),param_nocache&&console.log("### nocache="+(nocache?1:0)),param_ctrace&&console.log("### ctrace="+(ctrace?1:0)),snd_send("SERVER DE CLIENT openwebrx.js SND"),snd_send("SET debug_v="+debug_v),snd_send("SET squelch=0 max="+squelch_threshold.toFixed(0)),snd_send("SET lms_denoise=0"),snd_send("SET lms_autonotch=0"),0!=gen_attn){var c=gen_attn,f=Math.pow(10,-c/20);gen_attn=131071*f,console.log("### GEN dB="+c+" ampl_gain="+f+" attn="+gen_attn+" / "+gen_attn.toHex())}set_gen(gen_freq,gen_attn),snd_send("SET mod=am low_cut=-4000 high_cut=4000 freq=1000"),set_agc(),snd_send("SET browser="+navigator.userAgent),wf_send("SERVER DE CLIENT openwebrx.js W/F"),wf_send("SET send_dB=1"),wf_send("SET zoom=0 start=0"),wf_send("SET maxdb=0 mindb=-100"),0==wf_compression&&wf_send("SET wf_comp=0"),null==(wf_speed=wf_rates[wf_rate])&&(wf_speed=WF_SPEED_FAST),wf_send("SET wf_speed="+wf_speed),nb_click&&nb_send(-1,noiseThresh)}var ptype={HIDE:0,POPUP:1,TOGGLE:2},popt={CLOSE:-1,PERSIST:0},visBorder=10,visIcon=24,readme_color="blueViolet",show_news=!1,news_color="#ff00bf";function init_panels(){init_panel_toggle(ptype.TOGGLE,"id-control",!1,popt.PERSIST);var e=updateCookie("readme","seen2");kiwi_isMobile()&&(e=!1),init_panel_toggle(ptype.TOGGLE,"id-readme",!1,e?popt.PERSIST:popt.CLOSE,readme_color);var t=null==readCookie("news","seen");init_panel_toggle(ptype.POPUP,"id-news",!1,show_news&&t?popt.PERSIST:popt.CLOSE),init_panel_toggle(ptype.POPUP,"id-ext-controls",!1,popt.CLOSE),init_panel_toggle(ptype.POPUP,"id-confirmation",!1,popt.CLOSE)}function init_panel_toggle(e,t,a,n,_){var i=w3_el(t);i.ptype=e;var o=w3_el(t+"-vis");i.scrollable=1==a;var s=i.scrollable?-kiwi_scrollbar_width():visBorder,r="right"==i.getAttribute("data-panel-pos");if(i.panelShown=1,e==ptype.TOGGLE){var l=r?"right":"left",d=r?"left":"right";o.innerHTML='<a id="'+t+'-hide" onclick="toggle_panel('+sq(t)+');"><img src="icons/hide'+l+'.24.png" width="24" height="24" /></a><a id="'+t+'-show" class="class-vis-show" onclick="toggle_panel('+sq(t)+');"><img src="icons/hide'+d+'.24.png" width="24" height="24" /></a>'}else o.innerHTML='<a id="'+t+'-close" onclick="toggle_panel('+sq(t)+');"><img src="icons/close.24.png" width="24" height="24" /></a>';var c=i.activeWidth-visIcon;if(r?o.style.right=px(0):o.style.left=px(c+s),o.style.top=px(visBorder),null!=n&&(n?setTimeout(function(){toggle_panel(t)},n):n==popt.CLOSE?toggle_panel(t):e==ptype.POPUP&&(i.style.visibility="visible")),null!=_){var f=w3_el(t+"-show");null!=f&&(f.style.backgroundColor=f.style.borderColor=_)}}function toggle_panel(e){var t=w3_el(e),a=w3_el(e+"-vis");if(t.ptype==ptype.POPUP)return t.style.visibility=t.panelShown?"hidden":"visible",t.panelShown^=1,updateCookie(e,"seen"),void freqset_select();var n,_,i=t.activeWidth+30,o="right"==t.getAttribute("data-panel-pos");i=-i,t.panelShown?(n=0,_=i):(n=i,_=kiwi_scrollbar_width()),animate(t,o?"right":"left","px",n,_,.93,kiwi_isMobile()?1:1e3,60,0),w3_hide(e+"-"+(t.panelShown?"hide":"show")),w3_show_block(e+"-"+(t.panelShown?"show":"hide")),t.panelShown^=1;var s=t.activeWidth-visIcon,r=t.scrollable?-kiwi_scrollbar_width():visBorder;console.log("toggle_panel "+e+" right="+o+" shown="+t.panelShown),o?a.style.right=px(t.panelShown?0:s+visIcon+2*visBorder):a.style.left=px(s+(t.panelShown?r:visIcon+2*visBorder)),freqset_select()}function openwebrx_resize(e){e="string"==typeof e&&e.startsWith("orient")?e:"event",resize_canvases(),resize_waterfall_container(!0),extint_environment_changed({resize:1}),resize_scale(e),check_top_bar_congestion()}function orientation_change(){}try{window.onorientationchange=orientation_change}catch(e){}var offsetDiff_init=!1,p_left,p_owner,p_mid,p_right;function offsetDiff(e,t,a,n){var _=w3_el("id-tbar-"+e.toLowerCase()+"-bbox");_.style.left=px(a.x1),_.style.width=px(a.w),_.style.height=px(a.h),_.style.backgroundColor=t,console.log(e+" L/R/W="+a.x1+"/"+a.x2+"/"+a.w+" ("+(n.x1-a.x1)+"/"+(n.x2-a.x2)+"/"+(n.w-a.w)+")")}function check_top_bar_congestion(){var e=w3_boundingBox_children("id-left-info-container"),t=w3_boundingBox_children("id-mid-owner-container"),a=w3_boundingBox_children("id-mid-info-container"),n=w3_boundingBox_children("id-topbar-right-container"),_=e.x2+(a.x1-e.x2)/2-t.w/2;w3_el("id-owner-info").style.left=px(_),t=w3_boundingBox_children("id-mid-owner-container"),w3_visible("id-mid-owner-container",t.x1>=e.x2),w3_visible("id-mid-info-container",a.x1>=e.x2),w3_visible("id-topbar-right-container",n.x1>=e.x2),w3_el("id-rx-details-arrow").style.left=px(e.x2)}var rx_photo_spacer_height=height_top_bar_parts;function init_rx_photo(){w3_el("id-top-photo-img").style.paddingLeft=RX_PHOTO_LEFT_MARGIN?"50px":0,RX_PHOTO_HEIGHT+=rx_photo_spacer_height,w3_el("id-top-photo-clip").style.maxHeight=px(RX_PHOTO_HEIGHT),dbgUs||kiwi_isMobile()?close_rx_photo():window.setTimeout(function(){close_rx_photo()},3e3)}var rx_photo_state=1;function open_rx_photo(){rx_photo_state=1,html("id-rx-photo-desc").style.opacity=1,html("id-rx-photo-title").style.opacity=1,animate_to(html("id-top-photo-clip"),"maxHeight","px",RX_PHOTO_HEIGHT,.93,kiwi_isMobile()?1:1e3,60,function(){resize_waterfall_container(!0)}),w3_hide("id-rx-details-arrow-down"),w3_show_block("id-rx-details-arrow-up")}function close_rx_photo(){rx_photo_state=0,animate_to(html("id-top-photo-clip"),"maxHeight","px",rx_photo_spacer_height,.93,kiwi_isMobile()?1:1e3,60,function(){resize_waterfall_container(!0)}),w3_show_block("id-rx-details-arrow-down"),w3_hide("id-rx-details-arrow-up")}function dont_toggle_rx_photo(){dont_toggle_rx_photo_flag=1}function toggle_rx_photo(){dont_toggle_rx_photo_flag?dont_toggle_rx_photo_flag=0:(rx_photo_state?close_rx_photo():open_rx_photo(),freqset_select())}function animate(e,t,a,n,_,i,o,s,r){void 0===r&&(r=0),e.style[t]=n.toString()+a,e.anim_i=0,n_of_iters=o/(1e3/s),n_of_iters<1&&(n_of_iters=1),change=(_-n)/n_of_iters,void 0!==e.anim_timer&&window.clearInterval(e.anim_timer),e.anim_timer=window.setInterval(function(){e.anim_i++<n_of_iters?1==i?e.style[t]=(parseFloat(e.style[t])+change).toString()+a:(remain=parseFloat(e.style[t])-_,Math.abs(remain)>9||"px"!=a?new_val=_+i*remain:Math.abs(remain)<2?new_val=_:new_val=_+remain-remain/Math.abs(remain),e.style[t]=new_val.toString()+a):(e.style[t]=_.toString()+a,window.clearInterval(e.anim_timer),delete e.anim_timer),0!=r&&r()},1e3/s)}function animate_to(e,t,a,n,_,i,o,s){from=parseFloat(style_value(e,t)),animate(e,t,a,from,n,_,i,o,s)}function style_value(e,t){return e.currentStyle?e.currentStyle[t]:window.getComputedStyle?document.defaultView.getComputedStyle(e,null)[t]:e.style[t]}function demodulators_get_next_color(){return demodulator_color_index>=demodulator_colors.length&&(demodulator_color_index=0),demodulator_colors[demodulator_color_index++]}function demod_envelope_draw(e,t,a,n,_){void 0===n&&(n="#ffff00"),env_bounding_line_w=5,env_att_w=5,env_h1=17,env_h2=5,env_lineplus=1,env_line_click_area=8,env_slop=5,from_px=scale_px_from_freq(t,e),to_px=scale_px_from_freq(a,e),to_px<from_px&&(temp_px=to_px,to_px=from_px,from_px=temp_px),pb_adj_cf.style.left=from_px+"px",pb_adj_cf.style.width=to_px-from_px+"px",pb_adj_lo.style.left=from_px-env_bounding_line_w-2*env_slop+"px",pb_adj_lo.style.width=env_bounding_line_w+env_att_w+2*env_slop+"px",pb_adj_hi.style.left=to_px-env_bounding_line_w+"px",pb_adj_hi.style.width=env_bounding_line_w+env_att_w+2*env_slop+"px",from_px-=env_att_w+env_bounding_line_w,to_px+=env_att_w+env_bounding_line_w,scale_ctx.lineWidth=3,scale_ctx.strokeStyle=n,scale_ctx.fillStyle=n;var i={envelope_on_screen:!1,line_on_screen:!1};return to_px<0||from_px>window.innerWidth||(i.beginning={x1:from_px,x2:from_px+env_bounding_line_w+env_att_w+env_slop},i.ending={x1:to_px-env_bounding_line_w-env_att_w-env_slop,x2:to_px},i.whole_envelope={x1:from_px,x2:to_px},i.envelope_on_screen=!0,scale_ctx.beginPath(),scale_ctx.moveTo(from_px,env_h1),scale_ctx.lineTo(from_px+env_bounding_line_w,env_h1),scale_ctx.lineTo(from_px+env_bounding_line_w+env_att_w,env_h2),scale_ctx.lineTo(to_px-env_bounding_line_w-env_att_w,env_h2),scale_ctx.lineTo(to_px-env_bounding_line_w,env_h1),scale_ctx.lineTo(to_px,env_h1),scale_ctx.globalAlpha=.3,scale_ctx.fill(),scale_ctx.globalAlpha=1,scale_ctx.stroke()),void 0!==_&&(line_px=scale_px_from_freq(_,e),line_px<0||line_px>window.innerWidth||(i.line={x1:line_px-env_line_click_area/2,x2:line_px+env_line_click_area/2},i.line_on_screen=!0,scale_ctx.moveTo(line_px,env_h1+env_lineplus),scale_ctx.lineTo(line_px,env_h2-env_lineplus),scale_ctx.stroke(),pb_adj_car.style.left=i.line.x1+"px",pb_adj_car.style.width=env_line_click_area+"px")),i}function demod_envelope_where_clicked(e,t,a){if(in_range=function(e,t){return t.x1<=e&&t.x2>=e},dr=demodulator.draggable_ranges,a.shiftKey){if(t.line_on_screen&&in_range(e,t.line))return dr.bfo;if(t.envelope_on_screen&&in_range(e,t.whole_envelope))return dr.pbs}if(a.altKey){if(t.envelope_on_screen&&in_range(e,t.beginning))return dr.bwlo;if(t.envelope_on_screen&&in_range(e,t.ending))return dr.bwhi}if(t.envelope_on_screen){if(in_range(e,t.beginning))return dr.beginning;if(in_range(e,t.ending))return dr.ending;if(in_range(e,t.whole_envelope))return dr.anything_else}return dr.none}dont_toggle_rx_photo_flag=0,demodulators=[],demodulator_color_index=0,demodulator_colors=["#ffff00","#00ff00","#00ffff","#058cff","#ff9600","#a1ff39","#ff4e39","#ff5dbd"],demodulator=function(e){this.offset_frequency=e,this.has_audio_output=!0,this.has_text_output=!1,this.envelope={},this.color=demodulators_get_next_color(),this.stop=function(){}},demodulator.draggable_ranges={none:0,beginning:1,ending:2,anything_else:3,bfo:4,pbs:5,bwlo:6,bwhi:7},demodulator_response_time=100;var passbands={am:{lo:-4900,hi:4900},amn:{lo:-2500,hi:2500},lsb:{lo:-2700,hi:-300},usb:{lo:300,hi:2700},cw:{lo:300,hi:700},cwn:{lo:470,hi:530},nbfm:{lo:-6e3,hi:6e3},iq:{lo:-5e3,hi:5e3},s4285:{lo:600,hi:3e3}},scale_ctx,band_ctx,dx_ctx,pb_adj_cf,pb_adj_cf_ttip,pb_adj_lo,pb_adj_lo_ttip,pb_adj_hi,pb_adj_hi_ttip,pb_adj_car,pb_adj_car_ttip,scale_canvas,band_canvas,dx_div,dx_canvas;function demodulator_default_analog(e,t,a,n){null==passbands[t]&&(t="am"),demodulator.call(this,e),this.subtype=t,this.envelope.dragged_range=demodulator.draggable_ranges.none;var _=audio_input_rate?audio_input_rate/2:5e3;this.filter={min_passband:4,high_cut_limit:_,low_cut_limit:-_},this.server_mode=t;var i=isNaN(a)?passbands[t].last_lo:a,o=isNaN(n)?passbands[t].last_hi:n;if("undefined"!=i&&null!=i||(i=passbands[t].last_lo=passbands[t].lo),"undefined"!=o&&null!=o||(o=passbands[t].last_hi=passbands[t].hi),""!=override_pbw){var s=i+(o-i)/2,r=this.filter.min_passband,l=(override_pbw=decodeURIComponent(override_pbw)).split(",");console.log("p.len="+l.length);var d=l[0].parseFloatWithUnits("k");console.log('nlo="'+l[0]+'" '+d);var c=NaN;l.length>1&&(c=l[1].parseFloatWithUnits("k"),console.log('nhi="'+l[1]+'" '+d)),1==l.length&&!isNaN(d)&&d>=r?(i=s-d/2,o=s+d/2):2==l.length&&!isNaN(d)&&!isNaN(c)&&d<c&&c-d>=r&&(i=d,o=c),override_pbw=""}if(""!=override_pbc){var f=(o-i)/2,p=(r=this.filter.min_passband,(l=(override_pbc=decodeURIComponent(override_pbc)).split(","))[0].parseFloatWithUnits("k"));console.log('pbc="'+l[0]+'" '+d);var u=NaN;l.length>1&&(u=l[1].parseFloatWithUnits("k"),console.log('pbw="'+l[1]+'" '+d)),1!=l.length||isNaN(p)?2==l.length&&!isNaN(p)&&!isNaN(u)&&u>=r&&(i=p-u/2,o=p+u/2):(i=p-f,o=p+f),override_pbc=""}this.low_cut=Math.max(i,this.filter.low_cut_limit),this.high_cut=Math.min(o,this.filter.high_cut_limit),this.usePBCenter=!1,this.isCW=!1,"am"==t||"amn"==t||("lsb"==t?this.usePBCenter=!0:"usb"==t?this.usePBCenter=!0:"cw"==t?(this.usePBCenter=!0,this.isCW=!0):"cwn"==t?(this.usePBCenter=!0,this.isCW=!0):"nbfm"==t||"iq"==t||("s4285"==t?(this.usePBCenter=!0,this.server_mode="usb"):console.log("DEMOD-new: unknown subtype="+t))),this.wait_for_timer=!1,this.set_after=!1,this.set=function(){this.wait_for_timer?this.set_after=!0:(this.doset(),this.set_after=!1,this.wait_for_timer=!0,timeout_this=this,window.setTimeout(function(){timeout_this.wait_for_timer=!1,timeout_this.set_after&&timeout_this.set()},demodulator_response_time))},this.doset=function(){var e=(freq_car_Hz/1e3).toFixed(3),t=this.server_mode,a=this.low_cut.toString(),n=this.high_cut.toString();snd_send("SET mod="+t+" low_cut="+a+" high_cut="+n+" freq="+e);var _=null;e!=owrx.last_freq&&((_=_||{}).freq=1,owrx.last_freq=e),t!=owrx.last_mode&&((_=_||{}).mode=1,owrx.last_mode=t),a==owrx.last_locut&&n==owrx.last_hicut||((_=_||{}).passband=1,owrx.last_locut=a,owrx.last_hicut=n),null!=_&&extint_environment_changed(_),muted_until_freq_set&&(toggle_or_set_mute(muted_initially),muted_until_freq_set=!1),audio_meas_dly_ena&&(audio_meas_dly_start=(new Date).getTime())},this.envelope.parent=this,this.envelope.draw=function(e){this.visible_range=e,this.drag_ranges=demod_envelope_draw(g_range,center_freq+this.parent.offset_frequency+this.parent.low_cut,center_freq+this.parent.offset_frequency+this.parent.high_cut,this.color,center_freq+this.parent.offset_frequency);var t=Math.abs(this.parent.high_cut-this.parent.low_cut);pb_adj_lo_ttip.innerHTML="lo "+this.parent.low_cut.toString()+", bw "+t.toString(),pb_adj_hi_ttip.innerHTML="hi "+this.parent.high_cut.toString()+", bw "+t.toString(),pb_adj_cf_ttip.innerHTML="cf "+(this.parent.low_cut+Math.abs(this.parent.high_cut-this.parent.low_cut)/2).toString(),pb_adj_car_ttip.innerHTML=((center_freq+this.parent.offset_frequency)/1e3+cfg.freq_offset).toFixed(2)+" kHz"},this.envelope.drag_start=function(e,t){return this.key_modifiers=t,this.dragged_range=demod_envelope_where_clicked(e,this.drag_ranges,t),this.drag_origin={x:e,low_cut:this.parent.low_cut,high_cut:this.parent.high_cut,offset_frequency:this.parent.offset_frequency},this.dragged_range!=demodulator.draggable_ranges.none},this.envelope.drag_move=function(e){var t=demodulator.draggable_ranges;if(this.dragged_range==t.none)return!1;freq_change=Math.round(this.visible_range.hpp*(e-this.drag_origin.x));var a=this.dragged_range==t.bfo,n=this.dragged_range==t.beginning,_=this.dragged_range==t.ending,i=this.dragged_range==t.bwlo,o=this.dragged_range==t.bwhi,s=a||this.dragged_range==t.pbs||i||o,r=a||o?-1:1,l=a||i?-1:1,d=this.drag_origin.low_cut,c=n||s;c&&(d+=r*freq_change);var f=this.drag_origin.high_cut,p=_||s;if(p&&(f+=l*freq_change),c){if(d<this.parent.filter.low_cut_limit)return!0;if(f-d<this.parent.filter.min_passband)return!0;if(d>=f)return!0}if(p){if(f>this.parent.filter.high_cut_limit)return!0;if(f-d<this.parent.filter.min_passband)return!0;if(f<=d)return!0}if(c&&(passbands[this.parent.server_mode].last_lo=this.parent.low_cut=d),p&&(passbands[this.parent.server_mode].last_hi=this.parent.high_cut=f),this.dragged_range==t.anything_else||a){if(new_value=this.drag_origin.offset_frequency+freq_change,new_value>bandwidth/2||new_value<-bandwidth/2)return!0;this.parent.offset_frequency=new_value}return mkenvelopes(this.visible_range),freqset_car_Hz(this.parent.offset_frequency+center_freq),this.parent.set(),freqset_update_ui(),!0},this.envelope.drag_end=function(e){return to_return=this.dragged_range!=demodulator.draggable_ranges.none,this.dragged_range=demodulator.draggable_ranges.none,to_return}}function mkenvelopes(e){scale_ctx.clearRect(0,0,scale_ctx.canvas.width,22);for(var t=0;t<demodulators.length;t++)demodulators[t].envelope.draw(e)}function demodulator_remove(e){demodulators[e].stop(),demodulators.splice(e,1)}function demodulator_add(e){demodulators.push(e),waterfall_setup_done&&mkenvelopes(get_visible_freq_range())}function demodulator_analog_replace(e,t){null==passbands[e]&&(e="am");var a=0,n=0,_=!1,i=!1,o=!1;if(demodulators.length?(_=demodulators[0].isCW,a=demodulators[0].offset_frequency,n=passband_offset(),demodulator_remove(0)):(a=(1e3*init_frequency).toFixed(0)-center_freq,e=init_mode),null!=t&&(a=t-center_freq),demodulator_add(new demodulator_default_analog(a,e,NaN,NaN)),!_&&demodulators[0].isCW&&(i=!0),_&&!demodulators[0].isCW&&(o=!0),null!=t)a=(freq_car_Hz=freq_dsp_to_car(t))-center_freq,audioFFT_clear_wf=!0;else{var s=0;i&&(s=-passband_offset()),o&&(s=n),a+=s,(i||o)&&(audioFFT_clear_wf=!0)}cur_mode=e,demodulator_set_offset_frequency(0,a),try_modeset_update_ui(e)}function demodulator_set_offset_frequency(e,t){if(!(t>bandwidth/2||t<-bandwidth/2)){freqset_car_Hz((t=Math.round(t))+center_freq);var a=demodulators[0];a.offset_frequency=t,a.set(),try_freqset_update_ui()}}function scale_setup(){scale_canvas=html("id-scale-canvas"),scale_ctx=scale_canvas.getContext("2d"),add_scale_listner(scale_canvas),(pb_adj_car=html("id-pb-adj-car")).innerHTML='<span id="id-pb-adj-car-ttip" class="class-passband-adjust-car-tooltip class-tooltip-text"></span>',pb_adj_car_ttip=html("id-pb-adj-car-ttip"),add_scale_listner(pb_adj_car),(pb_adj_lo=html("id-pb-adj-lo")).innerHTML='<span id="id-pb-adj-lo-ttip" class="class-passband-adjust-cut-tooltip class-tooltip-text"></span>',pb_adj_lo_ttip=html("id-pb-adj-lo-ttip"),add_scale_listner(pb_adj_lo),(pb_adj_hi=html("id-pb-adj-hi")).innerHTML='<span id="id-pb-adj-hi-ttip" class="class-passband-adjust-cut-tooltip class-tooltip-text"></span>',pb_adj_hi_ttip=html("id-pb-adj-hi-ttip"),add_scale_listner(pb_adj_hi),(pb_adj_cf=html("id-pb-adj-cf")).innerHTML='<span id="id-pb-adj-cf-ttip" class="class-passband-adjust-cf-tooltip class-tooltip-text"></span>',pb_adj_cf_ttip=html("id-pb-adj-cf-ttip"),add_scale_listner(pb_adj_cf),band_canvas=html("id-band-canvas"),band_ctx=band_canvas.getContext("2d"),add_canvas_listner(band_canvas),add_canvas_listner(dx_div=html("id-dx-container")),dx_canvas=html("id-dx-canvas"),dx_ctx=dx_canvas.getContext("2d"),add_canvas_listner(dx_canvas),resize_scale("setup")}function add_scale_listner(e){e.addEventListener("mousedown",scale_canvas_mousedown,!1),e.addEventListener("mousemove",scale_canvas_mousemove,!1),e.addEventListener("mouseup",scale_canvas_mouseup,!1),e.addEventListener("contextmenu",scale_canvas_contextmenu,!1),kiwi_isMobile()&&(e.addEventListener("touchstart",scale_canvas_touchStart,!1),e.addEventListener("touchmove",scale_canvas_touchMove,!1),e.addEventListener("touchend",scale_canvas_touchEnd,!1))}function scale_canvas_contextmenu(e){return cancelEvent(e)}demodulator_default_analog.prototype=new demodulator;var scale_canvas_drag_params={mouse_down:!1,drag:!1,start_x:0,last_x:0,start_y:0,last_y:0,key_modifiers:{shiftKey:!1,altKey:!1,ctrlKey:!1}};function scale_canvas_mousedown(evt){with(scale_canvas_drag_params)drag=!1,start_x=evt.pageX,start_y=evt.pageY,key_modifiers.shiftKey=evt.shiftKey,key_modifiers.altKey=evt.altKey,key_modifiers.ctrlKey=evt.ctrlKey;scale_canvas_start_drag(evt),evt.preventDefault()}function scale_canvas_touchStart(evt){if(1==evt.targetTouches.length){with(scale_canvas_drag_params)drag=!1,last_x=start_x=evt.targetTouches[0].pageX,last_y=start_y=evt.targetTouches[0].pageY,key_modifiers.shiftKey=!1,key_modifiers.altKey=!1,key_modifiers.ctrlKey=!1;scale_canvas_start_drag(evt)}evt.preventDefault()}var scale_canvas_ignore_mouse_event=!1;function scale_canvas_start_drag(e){if(e.button==mouse.right&&!e.ctrlKey)return!0,right_click_menu(scale_canvas_drag_params.start_x,scale_canvas_drag_params.start_y),scale_canvas_drag_params.mouse_down=!1,void(scale_canvas_ignore_mouse_event=!0);scale_canvas_drag_params.mouse_down=!0}function scale_offset_carfreq_from_px(e,t){void 0===t&&(t=get_visible_freq_range());var a=passband_offset();return t.start+t.bw*(e/canvas_container.clientWidth)-center_freq-a}function scale_canvas_drag(e,t){if(!scale_canvas_ignore_mouse_event){var a=0,n=Math.abs(t-scale_canvas_drag_params.start_x);if(scale_canvas_drag_params.mouse_down&&!scale_canvas_drag_params.drag&&n>canvas_drag_min_delta){scale_canvas_drag_params.drag=!0;for(var _=0;_<demodulators.length;_++)a|=demodulators[_].envelope.drag_start(t,scale_canvas_drag_params.key_modifiers);e.target.style.cursor="move"}else if(scale_canvas_drag_params.drag){for(_=0;_<demodulators.length;_++)a|=demodulators[_].envelope.drag_move(t);a||demodulator_set_offset_frequency(0,scale_offset_carfreq_from_px(t)),scale_canvas_drag_params.last_x=t}}}function scale_canvas_mousemove(e){scale_canvas_drag(e,e.pageX)}function scale_canvas_touchMove(e){for(var t=0;t<e.touches.length;t++)scale_canvas_drag(e,e.touches[t].pageX);e.preventDefault()}function scale_canvas_end_drag(e,t){if(scale_canvas_ignore_mouse_event)scale_canvas_ignore_mouse_event=!1;else{scale_canvas_drag_params.drag=!1,scale_canvas_drag_params.mouse_down=!1;for(var a=!1,n=0;n<demodulators.length;n++)a|=demodulators[n].envelope.drag_end(t);a||demodulator_set_offset_frequency(0,scale_offset_carfreq_from_px(t)),e.target.style.cursor=null}}function scale_canvas_mouseup(e){scale_canvas_end_drag(e,e.pageX)}function scale_canvas_touchEnd(e){scale_canvas_end_drag(e,scale_canvas_drag_params.last_x),e.preventDefault()}function scale_px_from_freq(e,t){return Math.round((e-t.start)/t.bw*canvas_container.clientWidth)}function get_visible_freq_range(){if(out={},audioFFT_active&&null!=cur_mode){var e,t,a=Math.round(audio_input_rate||12e3);"iq"==cur_mode?(e=0,t=a):(e=a/4,t=a/2),out.center=center_freq+demodulators[0].offset_frequency+e,out.start=out.center-t,out.end=out.center+t,x_bin=freq_to_bin(out.start),out.bw=out.end-out.start,out.hpp=out.bw/scale_canvas.clientWidth}else{var n=bins_at_cur_zoom();out.start=bin_to_freq(x_bin),out.center=bin_to_freq(x_bin+n/2),out.end=bin_to_freq(x_bin+n),out.bw=out.end-out.start,out.hpp=out.bw/scale_canvas.clientWidth}return out}var scale_markers_levels=[{hz_per_large_marker:1e7,estimated_text_width:70,format:"{x} ",pre_divide:1e6,decimals:0},{hz_per_large_marker:5e6,estimated_text_width:70,format:"{x} ",pre_divide:1e6,decimals:0},{hz_per_large_marker:1e6,estimated_text_width:70,format:"{x} ",pre_divide:1e6,decimals:0},{hz_per_large_marker:5e5,estimated_text_width:70,format:"{x} ",pre_divide:1e6,decimals:1},{hz_per_large_marker:1e5,estimated_text_width:70,format:"{x} ",pre_divide:1e6,decimals:1},{hz_per_large_marker:5e4,estimated_text_width:70,format:"{x} ",pre_divide:1e6,decimals:2},{hz_per_large_marker:1e4,estimated_text_width:70,format:"{x} ",pre_divide:1e6,decimals:2},{hz_per_large_marker:5e3,estimated_text_width:70,format:"{x} ",pre_divide:1e6,decimals:3},{hz_per_large_marker:1e3,estimated_text_width:70,format:"{x} ",pre_divide:1e6,decimals:3}],scale_min_space_btwn_texts=50,scale_min_space_btwn_small_markers=7,g_range;function get_scale_mark_spacing(e){out={},fcalc=function(t){return out.numlarge=e.bw/t,out.pxlarge=canvas_container.clientWidth/out.numlarge,out.ratio=5,out.pxsmall=out.pxlarge/out.ratio,!(out.pxsmall<scale_min_space_btwn_small_markers)&&(out.pxsmall/2>=scale_min_space_btwn_small_markers&&"5"!=t.toString()[0]&&(out.pxsmall/=2,out.ratio*=2),out.smallbw=t/out.ratio,!0)};for(var t=scale_markers_levels.length-1;t>=0&&(mp=scale_markers_levels[t],!(fcalc(mp.hz_per_large_marker)&&out.pxlarge-mp.estimated_text_width>scale_min_space_btwn_texts));t--);return out.params=mp,out}function mk_freq_scale(){mkenvelopes(g_range=get_visible_freq_range()),scale_ctx.clearRect(0,22,scale_ctx.canvas.width,scale_ctx.canvas.height-22),scale_ctx.strokeStyle="#fff",scale_ctx.font="bold 12px sans-serif",scale_ctx.textBaseline="top",scale_ctx.fillStyle="#fff";var e,t=get_scale_mark_spacing(g_range);marker_hz=Math.ceil(g_range.start/t.smallbw)*t.smallbw,text_y_pos=32+(kiwi_isFirefox()?3:0);for(var a,n=function(a){var n=t.params.pre_divide,_=t.params.decimals;(a+=1e3*cfg.freq_offset)<1e6&&(n/=1e3,_=0),e=format_frequency(t.params.format+(a<1e6?"kHz":"MHz"),a,n,_)},_=0;!(++_>1e3);){if((r=scale_px_from_freq(marker_hz,g_range))>window.innerWidth)break;if(scale_ctx.beginPath(),scale_ctx.moveTo(r,22),marker_hz%t.params.hz_per_large_marker==0){if(void 0===i)var i=marker_hz;a=marker_hz,scale_ctx.lineWidth=3.5,scale_ctx.lineTo(r,33),n(marker_hz);var o=scale_ctx.measureText(e);scale_ctx.textAlign="center",0==zoom_level&&g_range.start+t.smallbw*t.ratio>marker_hz?r<o.width/2&&scale_px_from_freq(marker_hz+t.smallbw*t.ratio,g_range)-o.width>=scale_min_space_btwn_texts&&(scale_ctx.textAlign="left",scale_ctx.fillText(e,0,text_y_pos)):0==zoom_level&&g_range.end-t.smallbw*t.ratio<marker_hz&&r>window.innerWidth-o.width/2?window.innerWidth-o.width-scale_px_from_freq(marker_hz-t.smallbw*t.ratio,g_range)>=scale_min_space_btwn_texts&&(scale_ctx.textAlign="right",scale_ctx.fillText(e,window.innerWidth,text_y_pos)):scale_ctx.fillText(e,r,text_y_pos)}else scale_ctx.lineWidth=2,scale_ctx.lineTo(r,30);marker_hz+=t.smallbw,scale_ctx.stroke()}if(_>1e3&&(console.log("CONV_CT > 1000!!!"),kiwi_trace()),0!=zoom_level){scale_ctx.textAlign="center";var s=i-t.smallbw*t.ratio,r=scale_px_from_freq(s,g_range);n(s);var l=scale_ctx.measureText(e).width;r+l/2>0&&scale_ctx.fillText(e,r,32),r=scale_px_from_freq(s=a+t.smallbw*t.ratio,g_range),n(s),r-(l=scale_ctx.measureText(e).width)/2<window.innerWidth&&scale_ctx.fillText(e,r,32)}}var dx_car_size=8,dx_car_border=3,dx_car_w=dx_car_h=2*dx_car_border+dx_car_size;function resize_scale(e){band_ctx.canvas.width=window.innerWidth,band_ctx.canvas.height=band_canvas_h,dx_div.style.width=window.innerWidth+"px",dx_ctx.canvas.width=dx_car_w,dx_ctx.canvas.height=dx_car_h,dx_canvas.style.top=scale_canvas_top-dx_car_h+"px",dx_canvas.style.left=0,dx_canvas.style.zIndex=99,dx_ctx.beginPath(),dx_ctx.lineWidth=dx_car_border-1,dx_ctx.strokeStyle="black";var t=dx_car_border,a=dx_car_size;dx_ctx.moveTo(t,t),dx_ctx.lineTo(t+a,t),dx_ctx.lineTo(t+a/2,t+a),dx_ctx.lineTo(t,t),dx_ctx.stroke(),dx_ctx.fillStyle="yellow",dx_ctx.fill(),scale_ctx.canvas.width=window.innerWidth,scale_ctx.canvas.height=scale_canvas_h,mkscale(),dx_schedule_update()}function format_frequency(e,t,a,n){return out=e.replace("{x}",(t/a).toFixed(n)),out}function mkscale(){mk_freq_scale(),mk_bands_scale()}function bins_at_zoom(e){return wf_fft_size<<zoom_levels_max-e}function bins_at_cur_zoom(){return bins_at_zoom(zoom_level)}function norm_to_bins(e){return Math.round(e*bins_at_cur_zoom())}function bin_to_freq(e){var t=wf_fft_size<<zoom_levels_max;return Math.round(e/t*bandwidth)}function freq_to_bin(e){var t=wf_fft_size<<zoom_levels_max;return Math.round(e/bandwidth*t)}function bins_to_pixels_frac(e,t,a){var n=t/bins_at_zoom(a);return sb_trace&&console.log("bins_to_pixels_frac bins="+t+" z="+a+" ratio="+n),n>1&&(n=1),n<-1&&(n=-1),wf_fft_size*n}function bins_to_pixels(e,t,a){var n=bins_to_pixels_frac(e,t,a);return Math.round(n)}function freq_to_pixel(e){var t=freq_to_bin(e)-x_bin;return t>=0&&t<bins_at_cur_zoom()||(console.log("freq_to_pixel: bins="+t+" bins_at_cur_zoom="+bins_at_cur_zoom()),console.assert("assert fail")),bins_to_pixels(0,t,zoom_level)}function clamp_xbin(e){e<0&&(e=0);var t=(wf_fft_size<<zoom_levels_max)-bins_at_cur_zoom();return e>t&&(e=t),e}function passband_visible(){if(void 0===demodulators[0])return x_bin;var e=freq_to_bin(freq_passband_center());return e=e>=x_bin&&e<x_bin+bins_at_cur_zoom()?e:-e-1}function canvas_contextmenu(e){return e.target.id,e&&e.currentTarget&&"id-dx-container"==e.currentTarget.id&&(dx.ctrl_click=!0,w3_el(e.target.id).click()),cancelEvent(e)}function canvas_mouseover(e){}function canvas_mouseout(e){}function canvas_get_carfreq_offset(e,t){var a,n=e/waterfall_width;audioFFT_active?a=center_freq+demodulators[0].offset_frequency+(n-="iq"==cur_mode?.5:.25)*audio_input_rate*("iq"==cur_mode?2:1):a=bin_to_freq(x_bin+n*bins_at_cur_zoom());var _=t?passband_offset():0;return Math.round(a-_)-bandwidth/2}function canvas_get_dspfreq(e){return canvas_get_carfreq_offset(e,!1)+center_freq}canvas_dragging=!1,canvas_drag_min_delta=1,canvas_mouse_down=!1,canvas_ignore_mouse_event=!1;var mouse={left:0,middle:1,right:2};function right_click_menu_init(){w3_menu("id-right-click-menu","right_click_menu_cb")}function right_click_menu(e,t){var a,n=freq_displayed_Hz/1e3,_=band_info();a=n>=_.NDB_lo&&n<_.NDB_hi?"NDB":n<_.LW_lo?"VLF/LF":n<_.MW_hi?"LW/MW":"SWBC",w3_menu_items("id-right-click-menu",a+" database lookup","Utility database lookup","DX Cluster lookup","<hr>","restore passband","save waterfall as JPG","DX label filter","<hr>","<i>cal ADC clock (admin)</i>"),w3_menu_popup("id-right-click-menu",e,t)}function right_click_menu_cb(e,t){switch(e){case 0:case 1:case 2:freq_database_lookup(canvas_get_dspfreq(t),e);break;case 3:restore_passband(cur_mode),demodulator_analog_replace(cur_mode);break;case 4:export_waterfall(canvas_get_dspfreq(t));break;case 5:dx_filter();break;case 6:admin_pwd_query(function(){var e=Math.round(freq_displayed_Hz/1e3),t=1e3*e,a=t-freq_displayed_Hz,n=Math.round(a*ext_adc_clock_Hz()/t);console.log("cal ADC clock: dsp="+freq_displayed_Hz+" car="+freq_car_Hz+" r1k_kHz="+e+" clk_diff="+a+" clk_adj="+n);var _=cfg.clk_adj+n,i=1e6*_/ext_adc_clock_Hz();console.log("cal ADC clock: prev_adj="+cfg.clk_adj+" new_adj="+_+" ppm="+i.toFixed(1)),cal_adc_dialog(_,a,e,i)})}}function freq_database_lookup(e,t){var a,n=e/1e3,_=(Math.round(e/10),Math.round(e/1e3)),i="http://",o=band_info();if(1==t&&(i+="qrg.globaltuners.com/?q="+(a=Math.floor(e/100)/1e4).toFixed(4)),0==t)if(n>=o.NDB_lo&&n<o.NDB_hi)i+="www.classaxe.com/dx/ndb/rww/signal_list/?mode=signal_list&submode=&targetID=&sort_by=khz&limit=-1&offset=0&show=list&type_DGPS=1&type_NAVTEX=1&type_NDB=1&filter_id=&filter_khz_1="+(a=_.toFixed(0))+"&filter_khz_2="+a+"&filter_channels=&filter_sp=&filter_sp_itu_clause=AND&filter_itu=&filter_continent=&filter_dx_gsq=&region=&filter_listener=&filter_heard_in=&filter_date_1=&filter_date_2=&offsets=&sort_by_column=khz";else if(n<o.LW_lo)a=Math.round(e/100)/10,console.log("kHz="+n+" f="+a),i+="www.mwlist.org/vlf.php?kHz="+a.toFixed(1);else if(n<o.MW_hi){a=Math.round(_/o._9_10)*o._9_10,console.log("MW kHz="+n+" f="+a);i+="www.mwlist.org/mwlist_quick_and_easy.php?area="+[0,1,3,2][o.ITU_region]+"&kHz="+a.toFixed(0)}else i+="www.short-wave.info/index.php?freq="+(a=5*Math.round(_/5)).toFixed(0)+"&timbus=NOW&ip="+client_public_ip+"&porm=4";2==t&&(i+="ve3sun.com/KiwiSDR/DX.php?Search="+(a=Math.floor(e)/1e3).toFixed(1)),console.log("LOOKUP "+n+" -> "+a+" "+i);var s=window.open(i,"_blank");s&&s.focus()}function export_waterfall(e){f=get_visible_freq_range();var t=Math.floor(f.center/100)/10+"+-"+Math.floor((f.end-f.center)/100)/10+"KHz.jpg",a=document.createElement("canvas");a.width=wf_fft_size,a.height=(old_canvases.length+wf_canvases.length)*wf_canvas_default_height,a.ctx=a.getContext("2d"),a.ctx.fillStyle="black",a.ctx.fillRect(0,0,a.width,a.height),a.ctx.strokeStyle="red";var n,_=0;if(wf_canvases.forEach(function(e){a.ctx.drawImage(e,0,_),_+=e.height}),old_canvases.length>1)for(i=1;i<old_canvases.length;i++)a.ctx.drawImage(old_canvases[i],0,_),_+=old_canvases[i].height;e||(e=f.center),n=wf_fft_size*(e-f.start)/(f.end-f.start),a.ctx.moveTo(n,0),a.ctx.lineTo(n,50),a.ctx.stroke();var o=Math.floor(e/100)/10;o+=" KHz ",a.ctx.font="18px Arial",a.ctx.fillStyle="lime",o=(o+=window.location.href.substring(7)).substring(0,o.indexOf(":")),a.ctx.fillText(o,n+10,35);var s=(new Date).toUTCString();a.ctx.fillText(s,n-a.ctx.measureText(s).width-10,35);var r=a.toDataURL("image/jpeg",.85),l=document.createElement("a");l.download=t,l.href=r,l.dataset.downloadurl=["image/jpeg",l.download,l.href].join(":"),document.body.appendChild(l),l.click(),document.body.removeChild(l)}function canvas_start_drag(e,t,a){if(e.button==mouse.right&&!e.ctrlKey)return!0,canvas_ignore_mouse_event=!0,void right_click_menu(t,a);if(e.shiftKey&&"id-dx-container"==e.target.id)canvas_ignore_mouse_event=!0,dx_show_edit_panel(e,-1);else if(!e.shiftKey||e.ctrlKey||e.altKey)e.shiftKey&&(e.ctrlKey||e.altKey)?(canvas_ignore_mouse_event=!0,freq_database_lookup(canvas_get_dspfreq(t),e.altKey)):e.ctrlKey?(canvas_ignore_mouse_event=!0,page_scroll(-page_scroll_amount)):e.altKey&&(canvas_ignore_mouse_event=!0,page_scroll(page_scroll_amount));else{canvas_ignore_mouse_event=!0;var n=1e3,_=canvas_get_dspfreq(t),i=find_band(_);null==i||"LW"!=i.name&&"MW"!=i.name?null!=i&&i.s==svc.B&&("am"!=cur_mode&&"amn"!=cur_mode&&"lsb"!=cur_mode&&"usb"!=cur_mode||(n=5e3)):"am"!=cur_mode&&"amn"!=cur_mode&&"lsb"!=cur_mode&&"usb"!=cur_mode||(n=step_9_10?9e3:1e4);var o=_/n;freqmode_set_dsp_kHz(Math.round(o)*n/1e3,null)}canvas_mouse_down=!0,canvas_dragging=!1,canvas_drag_last_x=canvas_drag_start_x=t,canvas_drag_last_y=canvas_drag_start_y=a}function canvas_mousedown(e){canvas_start_drag(e,e.pageX,e.pageY),e.preventDefault()}function canvas_touchStart(e){1==e.targetTouches.length&&canvas_start_drag(e,e.targetTouches[0].pageX,e.targetTouches[0].pageY),e.preventDefault()}function spectrum_tooltip_update(e,t,a){if((e.target==spectrum_dB||e.currentTarget==spectrum_dB||e.target==spectrum_dB_ttip||e.currentTarget==spectrum_dB_ttip)&&a>=0&&a<height_spectrum_canvas){spectrum_dB_ttip.style.left=px(t),spectrum_dB_ttip.style.bottom=px(210-a);var n=(height_spectrum_canvas-a)/height_spectrum_canvas*full_scale+mindb;spectrum_dB_ttip.innerHTML=n.toFixed(0)+" dBm"}}function canvas_drag(e,t,a,n,_){if(waterfall_setup_done){var i=t;if(spectrum_tooltip_update(e,n,_),canvas_mouse_down&&!canvas_ignore_mouse_event){if(!canvas_dragging&&Math.abs(t-canvas_drag_start_x)>canvas_drag_min_delta&&(canvas_dragging=!0,canvas_container.style.cursor="move"),canvas_dragging){var o=canvas_drag_last_x-t;canvas_drag_last_y;waterfall_pan_canvases(norm_to_bins(o/waterfall_width)),canvas_drag_last_x=t,canvas_drag_last_y=a}}else w3_innerHTML("id-mouse-unit",format_frequency("{x}",canvas_get_dspfreq(i)+1e3*cfg.freq_offset,1e3,2))}}function canvas_mousemove(e){canvas_drag(e,e.pageX,e.pageY,e.clientX,e.clientY)}function canvas_touchMove(e){for(var t=0;t<e.touches.length;t++){var a=e.touches[t].pageX,n=e.touches[t].pageY;canvas_drag(e,a,n,a,n)}e.preventDefault()}function canvas_end_drag2(){canvas_container.style.cursor="crosshair",canvas_mouse_down=!1,canvas_ignore_mouse_event=!1}function canvas_container_mouseout(e){canvas_end_drag2()}function canvas_end_drag(e,t){if(waterfall_setup_done){var a=t;canvas_ignore_mouse_event||(canvas_dragging?canvas_end_drag2():demodulator_set_offset_frequency(0,canvas_get_carfreq_offset(a,!0))),canvas_mouse_down=!1,canvas_ignore_mouse_event=!1}}function canvas_mouseup(e){canvas_end_drag(e,e.pageX)}function canvas_touchEnd(e){canvas_end_drag(e,canvas_drag_last_x),spectrum_tooltip_update(e,canvas_drag_last_x,canvas_drag_last_y),e.preventDefault()}var canvas_mousewheel_rlimit=kiwi_rateLimit(canvas_mousewheel_cb,170);function canvas_mousewheel(e){canvas_mousewheel_rlimit(e),e.preventDefault()}function canvas_mousewheel_cb(e){waterfall_setup_done&&zoom_step(e.deltaY<0?ext_zoom.IN:ext_zoom.OUT,e.pageX)}function zoom_finally(){w3_innerHTML("id-nav-optbar-wf","WF"+zoom_level.toFixed(0)),wf_gnd_value=wf_gnd_value_base-zoomCorrection(),extint_environment_changed({zoom:1}),freqset_select()}var ZOOM_NOMINAL=10,ZOOM_BAND=6,zoom_nom=0,zoom_old_nom=0,zoom_levels_max=0,zoom_level=0,zoom_level_f=0,zoom_freq=0,zoom_maxin_s=["id-maxin","id-maxin-nom","id-maxin-max"],x_bin=0;function zoom_step(e,t){if(audioFFT_active)audioFFT_update();else{var a,n=e==ext_zoom.OUT,_=e==ext_zoom.IN,o=e!=ext_zoom.TO_BAND&&e!=ext_zoom.ABS,s=zoom_level,r=x_bin,l=!0;if(e==ext_zoom.WHEEL){if(null==t)return;if(l=!1,(p=Math.round(zoom_level_f))==s)return;e=p>s?ext_zoom.IN:ext_zoom.OUT}if(e==ext_zoom.MAX_OUT)n=!0,zoom_level=0,x_bin=0;else{if(o&&(n&&0==zoom_level||_&&zoom_level>=zoom_levels_max))return void zoom_finally();if(e==ext_zoom.TO_BAND){var d,c=center_freq+demodulators[0].offset_frequency,f=t;if(null!=f)zoom_level=f.zoom_level,d=f.cf,sb_trace&&console.log("ZTB-user f="+c+" cf="+d+" b="+f.name+" z="+f.zoom_level);else{for(i=0;i<bands.length&&!(c>=(f=bands[i]).min&&c<=f.max);i++);i!=bands.length?(zoom_level=f.zoom_level,d=f.cf):(zoom_level=ZOOM_BAND,d=c)}n=zoom_level<s,x_bin=freq_to_bin(d),x_bin-=norm_to_bins(.5)}else if(e==ext_zoom.ABS){if(null==t)return void zoom_finally();var p;if((p=t)<0||p>zoom_levels_max||p==zoom_level)return void zoom_finally();n=p<zoom_level,zoom_level=p,x_bin=freq_to_bin(freq_passband_center()),x_bin-=norm_to_bins(.5)}else if(e==ext_zoom.NOM_IN||e==ext_zoom.MAX_IN)n=(zoom_level=e==ext_zoom.NOM_IN&&null!=t&&1==t&&zoom_level>=zoom_nom?zoom_level==zoom_levels_max?zoom_nom:zoom_levels_max:e==ext_zoom.NOM_IN?zoom_nom:zoom_levels_max)<s,x_bin=freq_to_bin(freq_passband_center()),x_bin-=norm_to_bins(.5);else{if(dbgUs&&(sb_trace&&console.log("ZOOM IN/OUT"),sb_trace=0),null!=t){a=t/waterfall_width}else{var u=passband_visible();a=u>=0?(u-x_bin)/bins_at_cur_zoom():.5}x_bin+=norm_to_bins(a),zoom_level+=e,x_bin-=norm_to_bins(a)}}l&&(zoom_level_f=zoom_level);var m=zoom_level==zoom_levels_max?2:zoom_level>=zoom_nom?1:0;m!=zoom_old_nom&&(w3_hide(zoom_maxin_s[zoom_old_nom]),w3_show(zoom_maxin_s[m],"w3-show-table-cell"),zoom_old_nom=m),0!=zoom_level&&0!=s||(w3_show_hide("id-maxout",0!=zoom_level,"w3-show-table-cell"),w3_show_hide("id-maxout-max",0==zoom_level,"w3-show-table-cell")),x_bin=clamp_xbin(x_bin);var w=n?r-x_bin:x_bin-r,h=bins_to_pixels(1,w,n?zoom_level:s);sb_trace&&console.log("Zs z"+s+">"+zoom_level+" b="+x_bin+"/"+r+"/"+w+" bz="+bins_at_zoom(s)+" r="+w/bins_at_zoom(s)+" px="+h);var v=zoom_level-s;sb_trace&&console.log("zoom_step oz="+s+" zl="+zoom_level+" dz="+v+" pdx="+h),waterfall_zoom_canvases(v,h),mkscale(),dx_schedule_update(),sb_trace&&console.log("SET Z"+zoom_level+" xb="+x_bin),wf_send("SET zoom="+zoom_level+" start="+x_bin),need_maxmindb_update=!0,writeCookie("last_zoom",zoom_level),freq_link_update(),zoom_finally()}}function passband_increment(e){var t,a=ext_get_passband(),n=Math.abs(a.high-a.low),_=(t=e?(1.25*n-n)/2:(n-.8*n)/2)>10?10:1;t=Math.round(t/_)*_,a.low+=e?-t:t,a.low=Math.round(a.low/_)*_,a.high+=e?t:-t,a.high=Math.round(a.high/_)*_,ext_set_passband(a.low,a.high,!0)}function zoom_click(e,t,a){if(any_alternate_click_event(e)){var n=e.currentTarget,_=w3_contains(n,"id-zoom-in"),i=w3_contains(n,"id-zoom-out");if(!_&&!i)return;passband_increment(_)}else t==ext_zoom.NOM_IN?zoom_step(t,1):zoom_step(t)}function zoom_over(e){if("IMG"==e.target.nodeName){var t=e.target,a=e.currentTarget,n=w3_contains(a,"id-zoom-in");any_alternate_click_event(e)?t.title=n?"passband widen":"passband narrow":t.removeAttribute("title")}}var page_scroll_amount=.8,window_width,waterfall_width,waterfall_scrollable_height,canvas_container,canvas_annotation,canvas_phantom,annotation_div;function page_scroll(e){audioFFT_active||waterfall_pan_canvases(norm_to_bins(e));freqset_select()}function page_scroll_icon_click(e,t){any_alternate_click_event(e)?dx_label_step(t<0?-1:1):page_scroll(t)}var wf_canvases=[],old_canvases=[],wf_cur_canvas=null,wf_canvas_default_height=200,wf_canvas_actual_line,wf_canvas_id_seq=1,spectrum_canvas,spectrum_ctx,spectrum_dB,spectrum_dB_ttip,mobile_cur_portrait;function create_canvas(e,t,a,n,_){var i=document.createElement("canvas");return i.id=e,i.width=t,i.height=a,n&&(i.style.width=px(n)),_&&(i.style.height=px(_)),i.ctx=i.getContext("2d"),i}function add_canvas(){var e=create_canvas("id-wf-canvas",wf_fft_size,wf_canvas_default_height,waterfall_width,wf_canvas_default_height);e.id_seq=wf_canvas_id_seq++,wf_canvas_actual_line=wf_canvas_default_height-1,e.style.left=0,e.openwebrx_height=wf_canvas_default_height,e.openwebrx_top=1-wf_canvas_default_height,e.style.top=px(e.openwebrx_top),e.oneline_image=e.ctx.createImageData(wf_fft_size,1),canvas_container.appendChild(e),add_canvas_listner(e),wf_canvases.unshift(e),wf_cur_canvas=e,kiwi_gc_wf&&(e=null)}function init_canvas_container(){window_width=window.innerWidth,canvas_container=html("id-waterfall-container"),waterfall_width=canvas_container.clientWidth,canvas_container.addEventListener("mouseout",canvas_container_mouseout,!1),(canvas_annotation=create_canvas("id-annotation-canvas",wf_fft_size,wf_canvas_default_height,waterfall_width,wf_canvas_default_height)).style.zIndex=1,canvas_container.appendChild(canvas_annotation),add_canvas_listner(canvas_annotation),add_canvas_listner(annotation_div=w3_el("id-annotation-div")),add_canvas_listner(canvas_phantom=html("id-phantom-canvas")),canvas_phantom.style.width=px(canvas_container.clientWidth),add_canvas(),spectrum_canvas=create_canvas("id-spectrum-canvas",wf_fft_size,height_spectrum_canvas,waterfall_width,height_spectrum_canvas),html("id-spectrum-container").appendChild(spectrum_canvas),spectrum_ctx=spectrum_canvas.ctx,add_canvas_listner(spectrum_canvas),spectrum_ctx.font="10px sans-serif",spectrum_ctx.textBaseline="middle",spectrum_ctx.textAlign="left",(spectrum_dB=html("id-spectrum-dB")).style.height=px(height_spectrum_canvas),spectrum_dB.style.width=px(waterfall_width),spectrum_dB.innerHTML='<span id="id-spectrum-dB-ttip" class="class-spectrum-dB-tooltip class-tooltip-text"></span>',add_canvas_listner(spectrum_dB),spectrum_dB_ttip=html("id-spectrum-dB-ttip")}function add_canvas_listner(e){e.addEventListener("mouseover",canvas_mouseover,!1),e.addEventListener("mouseout",canvas_mouseout,!1),e.addEventListener("mousedown",canvas_mousedown,!1),e.addEventListener("mousemove",canvas_mousemove,!1),e.addEventListener("mouseup",canvas_mouseup,!1),e.addEventListener("contextmenu",canvas_contextmenu,!1),e.addEventListener("wheel",canvas_mousewheel,!1),kiwi_isMobile()&&(e.addEventListener("touchstart",canvas_touchStart,!1),e.addEventListener("touchmove",canvas_touchMove,!1),e.addEventListener("touchend",canvas_touchEnd,!1))}function remove_canvas_listner(e){e.removeEventListener("mouseover",canvas_mouseover,!1),e.removeEventListener("mouseout",canvas_mouseout,!1),e.removeEventListener("mousedown",canvas_mousedown,!1),e.removeEventListener("mousemove",canvas_mousemove,!1),e.removeEventListener("mouseup",canvas_mouseup,!1),e.removeEventListener("contextmenu",canvas_contextmenu,!1),e.removeEventListener("wheel",canvas_mousewheel,!1),kiwi_isMobile()&&(e.removeEventListener("touchstart",canvas_touchStart,!1),e.removeEventListener("touchmove",canvas_touchMove,!1),e.removeEventListener("touchend",canvas_touchEnd,!1))}function wf_shift_canvases(){for(wf_canvases.forEach(function(e){e.style.top=px(e.openwebrx_top++)});wf_canvases.length;){var e=wf_canvases[wf_canvases.length-1];if(null==e||e.openwebrx_top<waterfall_scrollable_height){kiwi_gc_wf&&(e=null);break}var t=wf_canvases[wf_canvases.length-2];t&&old_canvases.unshift(t),old_canvases.length>15&&old_canvases.pop(),kiwi_gc_wf&&remove_canvas_listner(e),canvas_container.removeChild(e),kiwi_gc_wf&&(e=wf_canvases[wf_canvases.length-1]=null),wf_canvases.pop()}wf_canvas_maxshift++,wf_canvas_maxshift<canvas_container.clientHeight?(canvas_phantom.style.top=px(wf_canvas_maxshift),canvas_phantom.style.height=px(canvas_container.clientHeight-wf_canvas_maxshift),w3_show_block(canvas_phantom)):canvas_phantom.hidden||(w3_hide(canvas_phantom),canvas_phantom.hidden=!0)}function resize_canvases(e){window_width=canvas_container.innerWidth,waterfall_width=canvas_container.clientWidth,new_width=px(waterfall_width);wf_canvases.forEach(function(e){e.style.width=new_width,e.style.left=0}),canvas_annotation.width=waterfall_width,canvas_annotation.style.width=new_width,canvas_phantom.style.width=new_width,canvas_phantom.style.left=0,spectrum_canvas.style.width=new_width,rx_chan>=wf_chans&&w3_innerHTML("id-annotation-div",w3_div("w3-section w3-container",w3_text("w3-large|color:cyan","Audio FFT<br>"),w3_text("w3-small|color:cyan","Zoom waterfall not available<br>on channels 2-6 of Kiwis<br>configured for 8 channels.<br>"),w3_text("w3-small|color:cyan","For details see: "+w3_link("w3-small","valentfx.com/vanilla/discussion/1309","forum post")+".")))}function mobile_poll_orientation(){var e=screen.width<screen.height;if(e!=mobile_cur_portrait){mobile_cur_portrait=e;var t=w3_el("id-control");if(e&&screen.width<=600){var a=screen.width/t.uiWidth*.95;t.style.transform="scale("+a.toFixed(2)+")",t.style.transformOrigin="bottom right",t.style.right="0px"}else t.style.transform="none",t.style.right="10px"}}function mobile_init(){var e=screen.width<screen.height;mobile_cur_portrait=void 0,e&&screen.width<768&&(toggle_or_set_hide_topbar(1),optbar_focus("optbar-off","init")),e&&screen.width<=600&&(w3_hide("id-readme"),screen.width<600&&toggle_or_set_hide_topbar(3)),setInterval(mobile_poll_orientation,500)}wf_canvas_maxshift=0;var waterfall_setup_done=0,waterfall_timer,waterfall_ms,audioFFT_active,audioFFT_prev_mode,audioFFT_clear_wf;function waterfall_init(){okay_waterfall_init&&(init_canvas_container(),audioFFT_active=rx_chan>=wf_chans,resize_waterfall_container(!1),resize_canvases(),panels_setup(),ident_init(),scale_setup(),mkcolormap(),bands_init(),spectrum_init(),dx_schedule_update(),users_init(!1),stats_init(),check_top_bar_congestion(),spectrum_show&&setTimeout(spec_show,2e3),audioFFT_setup(),waterfall_ms=900/wf_fps_max,waterfall_timer=window.setInterval(waterfall_dequeue,waterfall_ms),console.log("waterfall_dequeue @ "+waterfall_ms+" msec"),""!=shortcut.keys&&setTimeout(keyboard_shortcut_url_keys,3e3),kiwi_isMobile()&&mobile_init(),waterfall_setup_done=1)}var dB_bands=[],redraw_spectrum_dB_scale=!1,spectrum_colormap,spectrum_colormap_transparent,spectrum_update=0,spectrum_last_update=0,spectrum_image;function spectrum_init(){spectrum_colormap=spectrum_ctx.createImageData(1,spectrum_canvas.height),spectrum_colormap_transparent=spectrum_ctx.createImageData(1,spectrum_canvas.height),update_maxmindb_sliders(),spectrum_dB_bands();var e=(kiwi_isMobile(),10);if(setInterval(function(){spectrum_update++},1e3/e),spectrum_image=spectrum_ctx.createImageData(spectrum_canvas.width,spectrum_canvas.height),!audioFFT_active&&rx_chan>=wf_chans){var t=spectrum_canvas.width,a=spectrum_canvas.height;spectrum_ctx.fillStyle="black",spectrum_ctx.fillRect(0,0,t,a),spectrum_ctx.font="18px sans-serif",spectrum_ctx.fillStyle="white";var n=wf_chans?"Spectrum not available for rx"+rx_chan:"Spectrum not allowed on this Kiwi",_=spectrum_ctx.measureText(n).width;spectrum_ctx.fillText(n,t/2-_/2,a/2)}}function spectrum_dB_bands(){dB_bands=[];var e=0,t=maxdb,a=mindb,n=t-a,_=a+-8,i=t-_;i=i||1;for(var o=0,s=10*Math.floor(t/10);a-s<10;s-=10){var r=1-(s-a)/n,l=Math.round((s-_)/i*255),d=color_map[l],c=color_map_transparent[l],f="#"+(d>>>8).toString(16).leadingZeros(6);dB_bands[e]={dB:s,norm:r,color:f};for(var p=function(e){return Math.round(e*spectrum_canvas.height)},u=p(o);u<p(r);u++)for(var m=0;m<4;m++)spectrum_colormap.data[4*u+m]=d>>>0>>8*(3-m)&255,spectrum_colormap_transparent.data[4*u+m]=c>>>0>>8*(3-m)&255;o=r,e++}redraw_spectrum_dB_scale=!0}var waterfall_dont_scale=0,need_maxmindb_update=!1,need_clear_specavg=!1,clear_specavg=!0,specavg=[],specpeak=[],wf_swallow_samples=[2,4,8,18],x_bin_server_last,wf_swallow=0;function waterfall_add(e,t){var a,n;if(null!=e){var _=wf_cur_canvas;if(null!=_){var i,o,s,r=wf_fft_size;if(0==t){var l=new Uint32Array(e,4,3),d=l[0],c=l[1];kiwi_gc_wf&&(l=null);var f=65535&c,p=c>>16&65535,u=(i=new Uint8Array(e,16)).length;if(need_maxmindb_update&&zoom_level==f&&(update_maxmindb_sliders(),need_maxmindb_update=!1),need_clear_specavg&&x_bin==d&&zoom_level==f&&(clear_specavg=!0,need_clear_specavg=!1),1&p){s=new Uint8Array(2*u);decode_ima_adpcm_e8_u8(i,s,u,{index:0,previousValue:0});o=s.subarray(10)}else o=i;if(wf_swallow)return void wf_swallow--;d!=x_bin_server_last&&(x_bin_server_last=d,zoom_level>=11&&(wf_swallow=wf_swallow_samples[zoom_level-11],wf_fps!=wf_fps_max&&(wf_swallow=Math.round(wf_swallow*wf_fps/wf_fps_max))))}else o=e,need_clear_specavg&&(clear_specavg=!0,need_clear_specavg=!1);var m,w,h=!1;if(spectrum_display&&spectrum_update!=spectrum_last_update){spectrum_last_update=spectrum_update,h=!0,m=spectrum_canvas.width-25,w=spectrum_canvas.height,spectrum_ctx.fillStyle="black",spectrum_ctx.fillRect(0,0,m,w),spectrum_ctx.fillStyle="lightGray";for(var v=0;v<dB_bands.length;v++){var g=dB_bands[v];n=Math.round(g.norm*w),spectrum_ctx.fillRect(0,n,m,1)}if(clear_specavg){for(a=0;a<m;a++)specavg[a]=spectrum_color_index(o[a]);clear_specavg=!1,spectrum_peak_clear=!0}if(spectrum_peak_clear){for(a=0;a<m;a++)specpeak[a]=0;spectrum_peak_clear=!1}if(redraw_spectrum_dB_scale){for(a=m;a<spectrum_canvas.width;a++)spectrum_ctx.putImageData(spectrum_colormap_transparent,a,0,0,0,1,w);spectrum_ctx.fillStyle="white";for(v=0;v<dB_bands.length;v++){g=dB_bands[v];n=Math.round(g.norm*w),spectrum_ctx.fillText(g.dB,m+3,n-4)}redraw_spectrum_dB_scale=!1}}var b,x=_.oneline_image;if(spectrum_display&&h){for(spectrum_ctx.fillStyle="hsl(180, 100%, 70%)",a=0;a<m;a++){var y=spectrum_color_index(wf_gnd?wf_gnd_value:o[a]);switch(spec_filter){case spec_filter_e.IIR:var k=1-Math.exp(-sp_param*y/255);k<=.01&&(k=.01);var q=specavg[a];(q+=k*(y-q))>255&&(q=255),q<0&&(q=0),specavg[a]=q;break;case spec_filter_e.MMA:(q=y)>255&&(q=255),q<0&&(q=0),specavg[a]=(specavg[a]*(sp_param-1)+q)/sp_param,q=specavg[a];break;case spec_filter_e.EMA:(q=y)>255&&(q=255),q<0&&(q=0),specavg[a]+=(q-specavg[a])/sp_param,q=specavg[a];break;case spec_filter_e.OFF:default:(q=y)>255&&(q=255),q<0&&(q=0)}q>specpeak[a]&&(specpeak[a]=q),n=Math.round((1-q/255)*w),spectrum_slow_dev?spectrum_ctx.fillRect(a,n,1,w-n):spectrum_ctx.putImageData(spectrum_colormap,a,0,0,n,1,w-n+1)}if(spectrum_peak){for(spectrum_ctx.lineWidth=1,spectrum_ctx.strokeStyle="yellow",spectrum_ctx.beginPath(),n=Math.round((1-specpeak[0]/255)*w)-1,spectrum_ctx.moveTo(0,n),a=1;a<m;a++)n=Math.round((1-specpeak[a]/255)*w)-1,spectrum_ctx.lineTo(a,n);spectrum_ctx.globalAlpha=.55,spectrum_ctx.stroke(),spectrum_ctx.globalAlpha=1}}for(a=0;a<r;a++)b=waterfall_color_index(wf_gnd?wf_gnd_value:o[a]),x.data[4*a]=color_map_r[b],x.data[4*a+1]=color_map_g[b],x.data[4*a+2]=color_map_b[b],x.data[4*a+3]=255;if(_.ctx.putImageData(x,0,wf_canvas_actual_line),0==t&&"undefined"!=typeof IBP_scan_plot&&IBP_scan_plot(x),need_wf_autoscale){var T=[],z=audioFFT_active?o.slice(256,768):o,M=z.length;for(v=0;v<M;v++)T[v]=dB_wire_to_dBm(z[v]);T.sort(function(e,t){return e-t});var S=T[Math.floor(.5*M)];setmaxdb(1,T[Math.floor(.98*M)]+30),setmindb(1,S-10),update_maxmindb_sliders(),need_wf_autoscale=!1}if(0==t){if(sb_trace&&console.log("WF fixup bin="+x_bin+"/"+d+" z="+zoom_level+"/"+f),zoom_level!=f){var E=zoom_level-f,F=E<0,C=F?d-x_bin:x_bin-d,I=bins_to_pixels(2,C,F?zoom_level:f);sb_trace&&console.log("WF Z fix z"+f+">"+zoom_level+" out="+F+" b="+x_bin+"/"+d+"/"+C+" px="+I),waterfall_zoom(_,E,wf_canvas_actual_line,I),d+=F?-C:C,sb_trace&&console.log("WF z fixed")}x_bin!=d&&(I=bins_to_pixels(3,x_bin-d,zoom_level),sb_trace&&console.log("WF bin fix L="+wf_canvas_actual_line+" xb="+x_bin+" xbs="+d+" pdx="+I),waterfall_pan(_,wf_canvas_actual_line,I),sb_trace&&console.log("WF bin fixed")),sb_trace&&x_bin==d&&zoom_level==f&&(console.log("--WF FIXUP ALL DONE--"),sb_trace=0)}wf_canvas_actual_line--,wf_shift_canvases(),wf_canvas_actual_line<0&&add_canvas(),kiwi_gc_wf&&(_=e=i=s=o=null)}}}function waterfall_pan(e,t,a){var n,_,i,o=e.ctx,s=e.width;-1==t?(n=0,i=e.height):(n=t,i=1);var r=function(e,t,a){return e<t?t:e>a?a:e};try{sb_trace&&console.log("waterfall_pan h="+i+" dx="+a),a<0?(_=s-(a=-a),sb_trace&&console.log("PAN-L w="+_+" dx="+a),_>0&&o.drawImage(e,0,n,_,i,a,n,_,i),o.fillStyle="Black",sb_trace&&(o.fillStyle=-1==t?"Lime":"Red"),fx=r(a,0,s),o.fillRect(0,n,fx,i)):(_=s-a,sb_trace&&console.log("PAN-R w="+_+" dx="+a),_>0&&o.drawImage(e,a,n,_,i,0,n,_,i),o.fillStyle="Black",sb_trace&&(o.fillStyle=-1==t?"Lime":"Red"),fx=r(_,0,s),o.fillRect(fx,n,s,i))}catch(e){console.log("EX WFPAN "+e.toString()+" dx="+a+" y="+n+" w="+_+" h="+i)}}var last_pixels_frac=0;function waterfall_pan_canvases(e){if(e&&!audioFFT_active){var t=x_bin,a=bins_to_pixels_frac(4,(x_bin=clamp_xbin(x_bin+=e))-t,zoom_level)+last_pixels_frac,n=Math.round(a);last_pixels_frac=a-n,sb_trace&&console.log("PAN-CAN z="+zoom_level+" xb="+x_bin+" db="+(x_bin-t)+" f_dx="+a+" i_dx="+n+" lpf="+last_pixels_frac),n&&(wf_canvases.forEach(function(e){waterfall_pan(e,-1,n)}),wf_send("SET zoom="+zoom_level+" start="+x_bin),mkscale(),need_clear_specavg=!0,dx_schedule_update(),extint_environment_changed({waterfall_pan:1}),passband_visible()<0&&check_band(!0))}}function waterfall_zoom(e,t,a,n){var _,i,o,s=e.ctx,r=e.width,l=1<<Math.abs(t),d=r/l,c=function(e,t,a){return e<t?t:e>a?a:e};-1==a?(i=0,o=e.height):(i=a,o=1);try{if(sb_trace&&console.log("waterfall_zoom w="+r+" h="+o+" pw="+d+" zf="+l),t<0)sb_trace&&console.log("WFZ-out srcX=0/"+r+" dstX="+n+"/"+(n+d)+" (pw="+d+")"),s.drawImage(e,0,i,r,o,n,i,d,o),s.fillStyle="Black",sb_trace&&(console.log("chocolate 0:"+n),s.fillStyle="chocolate"),_=c(n,0,r),s.fillRect(0,i,_,i+o),sb_trace&&(console.log("brown "+(n+d)+":"+r),s.fillStyle="brown"),_=c(n+d,0,r),s.fillRect(_,i,r,i+o);else if(0!=r){sb_trace&&console.log("WFZ-in srcX="+n+"/"+(n+d)+"(pw="+d+") dstX=0/"+r);var f=!1,p=!1;n+d>r&&(_=Math.round((r-n)*l),sb_trace&&console.log("CLAMP HI fx="+_),f=!0),n<0&&(_=Math.round(-n*l),sb_trace&&console.log("CLAMP LO fx="+_),p=!0),s.drawImage(e,n,i,d,o,0,i,r,o),s.fillStyle="Black",sb_trace&&(s.fillStyle="deepPink"),f&&s.fillRect(_,i,r,i+o),p&&s.fillRect(0,i,_,i+o)}}catch(e){console.log("EX WFZ "+e.toString()+" dz="+t+" x="+n+" y="+i+" w="+r+" h="+o)}}function waterfall_zoom_canvases(e,t){sb_trace&&console.log("ZOOM-CAN z"+zoom_level+" xb="+x_bin+" x="+t),wf_canvases.forEach(function(a){waterfall_zoom(a,e,-1,t)}),need_clear_specavg=!0}function waterfall_height(){var e=html("id-top-container").clientHeight,t=html("id-non-waterfall-container").clientHeight;return window.innerHeight-e-t}function resize_waterfall_container(e){if(!e||waterfall_setup_done){var t=waterfall_height();t>=0?(canvas_container.style.height=px(t),waterfall_scrollable_height=3*t):waterfall_scrollable_height=0}}var waterfall_delay=0,waterfall_queue=[],waterfall_last_add=0;function waterfall_add_queue(e){var t=new Uint32Array(e,4,3),a=t[2];kiwi_gc_wf&&(t=null);var n=Date.now(),_=waterfall_last_add?n-waterfall_last_add:0;waterfall_last_add=n,waterfall_queue.push({data:e,audioFFT:0,seq:a,spacing:_}),kiwi_gc_wf&&(e=null)}var init_zoom_set=!1,waterfall_last_out=0,wf_dq_onesec=0;function waterfall_dequeue(){if(!init_zoom_set&&demodulators[0]&&(init_zoom=parseInt(init_zoom),(init_zoom<0||init_zoom>zoom_levels_max)&&(init_zoom=0),zoom_step(ext_zoom.ABS,init_zoom),init_zoom_set=!0),waterfall_setup_done&&0!=waterfall_queue.length)for(;0!=waterfall_queue.length;){var e=waterfall_queue[0].seq;if(e>audio_ext_sequence+waterfall_delay)return;var t=Date.now();if(e==audio_ext_sequence&&t<waterfall_last_out+waterfall_queue[0].spacing)return;waterfall_last_out=t;var a=waterfall_queue[0].data;kiwi_gc_wf&&(waterfall_queue[0].data=null);var n=waterfall_queue[0].audioFFT;waterfall_queue.shift(),waterfall_add(a,n),kiwi_gc_wf&&(a=null)}}var colormap_select=1,colormap_sqrt=0,spectrum_scale_color_map_transparency=200,color_map=new Uint32Array(256),color_map_transparent=new Uint32Array(256),color_map_r=new Uint8Array(256),color_map_g=new Uint8Array(256),color_map_b=new Uint8Array(256);function mkcolormap(){for(var e=0;e<256;e++){var t,a,n;switch(colormap_select){case 1:e<32?(t=0,a=0,n=255*e/31):e<72?(t=0,a=255*(e-32)/39,n=255):e<96?(t=0,a=255,n=255-255*(e-72)/23):e<116?(t=255*(e-96)/19,a=255,n=0):e<184?(t=255,a=255-255*(e-116)/67,n=0):(t=255,a=0,n=128*(e-184)/70);break;case 2:black_level=0,white_level=48;var _=black_level+Math.round((255-black_level+white_level)*e/255);_>255&&(_=255),t=a=n=_;break;case 3:var i={r:255,g:0,b:255},o={r:0,g:255,b:0};t=i.r*(e/255)+o.r*((255-e)/255),t=Math.round(t*(1+e/255*0)),a=i.g*(e/255)+o.g*((255-e)/255),a=Math.round(a*(1+e/255*0)),n=i.b*(e/255)+o.b*((255-e)/255),n=Math.round(n*(1+e/255*0));break;case 0:default:e<43?(t=0,a=0,n=255*e/43):e<87?(t=0,a=255*(e-43)/43,n=255):e<120?(t=0,a=255,n=255-255*(e-87)/32):e<154?(t=255*(e-120)/33,a=255,n=0):e<217?(t=255,a=255-255*(e-154)/62,n=0):(t=255,a=0,n=128*(e-217)/38)}color_map[e]=t<<24|a<<16|n<<8|255,color_map_transparent[e]=t<<24|a<<16|n<<8|spectrum_scale_color_map_transparency,color_map_r[e]=t,color_map_g[e]=a,color_map_b[e]=n}}function dB_wire_to_dBm(e){return e<0&&(e=0),e>255&&(e=255),-(255-e)+cfg.waterfall_cal}function do_waterfall_index(e,t){var a=dB_wire_to_dBm(e);a<mindb&&(a=mindb),a>maxdb&&(a=maxdb);var n=(a-mindb)/full_scale,_=n;try{switch(+t){case 0:default:break;case 1:_=Math.sqrt(n);break;case 2:n>.21&&n<.5&&(_=.2+.09*(4+Math.log10(n-.2)));break;case 3:n>.31&&n<.6&&(_=.3+.07*(5+Math.log10(n-.3)));break;case 4:n>.41&&n<.7&&(_=.4+.055*(6+Math.log10(n-.4)))}}catch(e){_=n}var i=255*_;return(i=Math.round(i))<0&&(i=0),i>255&&(i=255),i}function spectrum_color_index(e){return do_waterfall_index(e,0)}function waterfall_color_index(e){return do_waterfall_index(e,colormap_sqrt)}function waterfall_color_index_max_min(e,t,a){(e=-(255-e))<a&&(e=a),e>t&&(e=t);var n=t-a,_=255*((e-a)/(n=n?full_scale:1));return(_=Math.round(_))<0&&(_=0),_>255&&(_=255),_}function color_index_max_min(e,t,a){e<a&&(e=a),e>t&&(e=t);var n=t-a,_=255*((e-a)/(n=n?full_scale:1));return(_=Math.round(_))<0&&(_=0),_>255&&(_=255),_}var fft={init:!1,comp_1x:!1,audioFFT_dynload:{},offt:0,i_re:0,i_im:0,o_re:0,o_im:0,window_512:[],window_1k:[],window_2k:[],pwr_dB:[],dBi:[],CUTESDR_MAX_VAL:32767},freq_displayed_Hz,freq_displayed_kHz_str,freq_car_Hz,freqset_tout,freq_dsp_set_last;function audioFFT_setup(){if(audioFFT_active){zoom_level=0;var e=readCookie("last_AF_max_dB");null==e&&(e=maxdb);var t=readCookie("last_AF_min_dB");null==t&&(t=mindb_un),setmaxdb(1,e),setmindb(1,t),update_maxmindb_sliders();var a=function(e,t){return.5-.5*Math.cos(2*Math.PI*e/(t-1))};for(i=0;i<512;i++)fft.window_512[i]=a(i,512);for(i=0;i<1024;i++)fft.window_1k[i]=a(i,1024);for(i=0;i<2048;i++)fft.window_2k[i]=a(i,2048)}}function audioFFT_update(){mkscale(),dx_schedule_update(),freq_link_update(),w3_innerHTML("id-nav-optbar-wf","WF"),freqset_select(),audioFFT_clear_wf&&(wf_canvases.forEach(function(e){e.ctx.fillStyle="Black",e.ctx.fillRect(0,0,e.width,e.height)}),need_clear_specavg=!0,audioFFT_clear_wf=!1)}function wf_audio_FFT(e,t){if(audioFFT_active&&kiwi_load_js_polled(fft.audioFFT_dynload,["pkgs/js/Ooura_FFT32.js"])){var a,n,_,i="iq"==ext_get_mode();if(!fft.init||i!=fft.iq||audio_compression!=fft.comp){for(console.log("audio_FFT: SWITCHING iq="+i+" comp="+audio_compression),i?("complex",fft.size=1024,fft.offt=ooura32.FFT(fft.size,{type:"complex",radix:4}),fft.i_re=ooura32.vectorArrayFactory(fft.offt),fft.i_im=ooura32.vectorArrayFactory(fft.offt)):("real",fft.size=audio_compression?fft.comp_1x?2048:1024:512,fft.offt=ooura32.FFT(fft.size,{type:"real",radix:4}),fft.i_re=ooura32.scalarArrayFactory(fft.offt)),fft.o_re=ooura32.vectorArrayFactory(fft.offt),fft.o_im=ooura32.vectorArrayFactory(fft.offt),fft.scale=20/(fft.size*fft.size*fft.size*fft.CUTESDR_MAX_VAL*fft.CUTESDR_MAX_VAL),a=0;a<1024;a++)fft.pwr_dB[a]=0;fft.iq=i,fft.comp=audio_compression,fft.init=!0}if(fft.iq){for(a=0,n=0;a<1024;a+=2,n++)fft.i_re[n]=e[a]*fft.window_512[n],fft.i_im[n]=e[a+1]*fft.window_512[n];for(fft.offt.fft(fft.offt,fft.i_re.buffer,fft.i_im.buffer,fft.o_re.buffer,fft.o_im.buffer),n=0,_=512;n<256;n++,_++){var o=(r=fft.o_re[n])*r+(l=fft.o_im[n])*l,s=10*Math.log10(o*fft.scale+1e-30);s=Math.round(255+s),fft.pwr_dB[_]=s}for(n=256,_=256;n<512;n++,_++){o=(r=fft.o_re[n])*r+(l=fft.o_im[n])*l,s=10*Math.log10(o*fft.scale+1e-30);s=Math.round(255+s),fft.pwr_dB[_]=s}waterfall_queue.push({data:fft.pwr_dB,audioFFT:1,seq:0,spacing:0})}else if(audio_compression){if(fft.comp_1x){for(a=0;a<2048;a++)fft.i_re[a]=e[a]*fft.window_2k[a];for(fft.offt.fft(fft.offt,fft.i_re.buffer,fft.o_re.buffer,fft.o_im.buffer),n=0,_=256;n<1024;n++){o=(r=fft.o_re[n])*r+(l=fft.o_im[n])*l;fft.dBi[1&n]=Math.round(255+10*Math.log10(o*fft.scale+1e-30)),1&n&&(fft.pwr_dB[_]=Math.max(fft.dBi[0],fft.dBi[1]),_++)}}else{for(a=0;a<1024;a++)fft.i_re[a]=e[a]*fft.window_1k[a];for(fft.offt.fft(fft.offt,fft.i_re.buffer,fft.o_re.buffer,fft.o_im.buffer),n=0,_=256;n<512;n++,_++){o=(r=fft.o_re[n])*r+(l=fft.o_im[n])*l;fft.pwr_dB[_]=Math.round(255+10*Math.log10(o*fft.scale+1e-30))}for(waterfall_queue.push({data:fft.pwr_dB,audioFFT:1,seq:0,spacing:0}),a=1024;a<2048;a++)fft.i_re[a]=e[a]*fft.window_2k[a-1024];for(fft.offt.fft(fft.offt,fft.i_re.buffer,fft.o_re.buffer,fft.o_im.buffer),n=0,_=256;n<512;n++,_++){o=(r=fft.o_re[n])*r+(l=fft.o_im[n])*l;fft.pwr_dB[_]=Math.round(255+10*Math.log10(o*fft.scale+1e-30))}}waterfall_queue.push({data:fft.pwr_dB,audioFFT:1,seq:0,spacing:0})}else{for(a=0;a<512;a++)fft.i_re[a]=e[a]*fft.window_512[a];for(fft.offt.fft(fft.offt,fft.i_re.buffer,fft.o_re.buffer,fft.o_im.buffer),n=0,_=256;n<256;n++,_+=2){var r,l;o=(r=fft.o_re[n])*r+(l=fft.o_im[n])*l;fft.pwr_dB[_]=fft.pwr_dB[_+1]=Math.round(255+10*Math.log10(o*fft.scale+1e-30))}waterfall_queue.push({data:fft.pwr_dB,audioFFT:1,seq:0,spacing:0})}}}function freq_dsp_to_car(e){var t=demodulators[0];if(void 0===t)return console.log("freq_dsp_to_car no demod?"),e;var a=t.low_cut+(t.high_cut-t.low_cut)/2;return fcar=t.isCW?e-a:e,fcar<0&&(fcar=0),fcar>bandwidth&&(fcar=bandwidth),fcar}function freq_car_to_dsp(e){var t=demodulators[0];if(void 0===t)return e;var a=t.low_cut+(t.high_cut-t.low_cut)/2;return fdsp=t.isCW?e+a:e,fdsp}function passband_offset(){var e=0,t=demodulators[0];return void 0!==t&&(e=t.usePBCenter?t.low_cut+(t.high_cut-t.low_cut)/2:0),e}function freq_passband_center(){var e=0,t=demodulators[0];return void 0!==t&&(e=center_freq+t.offset_frequency,e+=t.low_cut+(t.high_cut-t.low_cut)/2),e}function passband_offset_dxlabel(e){var t=passbands[e];return"usb"==e||"lsb"==e?t.lo+(t.hi-t.lo)/2:0}function freqmode_set_dsp_kHz(e,t,a){e*=1e3,1!=a&&(audioFFT_clear_wf=!0),null!=t&&null!=t&&t!=cur_mode?demodulator_analog_replace(t,e):demodulator_set_offset_frequency(0,(freq_car_Hz=freq_dsp_to_car(e))-center_freq)}function freqset_car_Hz(e){freq_car_Hz=e}function freqset_update_ui(){if(freq_displayed_Hz=freq_car_to_dsp(freq_car_Hz),freq_displayed_kHz_str=(freq_displayed_Hz/1e3).toFixed(2),waterfall_setup_done){var e=w3_el("id-freq-input");if(void 0!==e&&null!=e){var t=freq_displayed_Hz+1e3*cfg.freq_offset;e.value=(t/1e3).toFixed(t>1e8?1:2),freqset_select();var a=-passband_visible()-1;if(a>=0)waterfall_pan_canvases(a-(x_bin+bins_at_cur_zoom()/2));check_band(),writeCookie("last_freq",freq_displayed_kHz_str),freq_dsp_set_last=freq_displayed_kHz_str,freq_step_update_ui(),freq_link_update(),freq_displayed_kHz_str!=freq_memory[freq_memory_pointer]&&freq_memory.push(freq_displayed_kHz_str),freq_memory.length>25&&freq_memory.shift(),freq_memory_pointer=freq_memory.length-1,writeCookie("freq_memory",JSON.stringify(freq_memory))}}}function freqset_keydown(e){"38"==e.keyCode?freq_memory_up_down(1):"40"==e.keyCode&&freq_memory_up_down(0)}var freq_up_down_timeout=-1;function freq_memory_up_down(e){kiwi_clearTimeout(freq_up_down_timeout);var t=w3_el("id-freq-input");if(e)freq_memory_pointer>0&&--freq_memory_pointer,freq_memory[freq_memory_pointer]&&(t.value=freq_memory[freq_memory_pointer]);else{if(!(freq_memory_pointer<freq_memory.length-1))return;freq_memory[++freq_memory_pointer]&&(t.value=freq_memory[freq_memory_pointer])}freq_up_down_timeout=setTimeout(function(){kiwi_isMobile()||(freq_memory_pointer=freq_memory.length-1,w3_el("id-freq-input").value=freq_dsp_set_last),freqset_complete(2)},kiwi_isMobile()?2e3:3e3)}function freqset_select(e){var t=document.activeElement;t&&w3_contains(t,"w3-retain-input-focus")||w3_field_select("id-freq-input",{mobile:1})}var last_mode_obj=null;function modeset_update_ui(e){null!=last_mode_obj&&(last_mode_obj.style.color="white");var t=w3_el("id-button-"+e);t&&t.style&&(t.style.color="lime"),last_mode_obj=t,squelch_setup(0),writeCookie("last_mode",e),freq_link_update(),w3_set_props("id-button-compression","w3-disabled","iq"==e)}function try_freqset_update_ui(){waterfall_setup_done?(freqset_update_ui(),audioFFT_active?(!audioFFT_clear_wf&&("iq"==cur_mode&&"iq"!=audioFFT_prev_mode||"iq"!=cur_mode&&"iq"==audioFFT_prev_mode)&&(audioFFT_clear_wf=!0),audioFFT_update(),audioFFT_prev_mode=cur_mode):mkenvelopes(get_visible_freq_range())):setTimeout(try_freqset_update_ui,1e3)}function try_modeset_update_ui(e){waterfall_setup_done?modeset_update_ui(e):setTimeout(function(){try_modeset_update_ui(e)},1e3)}function freq_link_update(){var e=kiwi_url_origin()+"/?f="+freq_displayed_kHz_str+cur_mode+"z"+zoom_level;w3_innerHTML("id-freq-link",w3_icon("w3-text-css-lime||title="+dq("copy to clipboard:\n"+e),"fa-external-link-square",15,"","freq_link_update_cb",e))}function freq_link_update_cb(e,t,a){a||w3_copy_to_clipboard(t)}function freqset_complete(e){var t=w3_el("id-freq-input");if(kiwi_clearTimeout(freqset_tout),kiwi_clearTimeout(freq_up_down_timeout),void 0!==t&&null!=t){var a=t.value.split(/[\/:]/),n=t.value.includes("/"),_=a[0].replace(",",".").parseFloatWithUnits("M",.001),i=!0;if(_>0&&!isNaN(_)&&(_-=cfg.freq_offset)>0&&!isNaN(_)&&(freqmode_set_dsp_kHz(_,null),w3_field_select(t,{mobile:1}),i=!1),i&&freqset_update_ui(),a[1]){p2=a[1].split(",");var o=p2[0].parseFloatWithUnits("k"),s=NaN;p2.length>1&&(s=p2[1].parseFloatWithUnits("k"));var r=ext_get_passband(),l=(r.high-r.low)/2,d=r.low+l;if(n){if(1==p2.length)o=d-(c=o/2),s=d+c}else{var c,f=o;if(1==p2.length)o=f-l,s=f+l;else o=f-(c=Math.abs(s/2)),s=f+c}ext_set_passband(o,s)}}}var ignore_next_keyup_event=!1;function freqset_keyup(e,t){if(kiwi_clearTimeout(freqset_tout),null!=t&&null!=t.key){var a=t.key.length;if(any_alternate_click_event(t)||1!=a&&"Backspace"!=t.key)return"Escape"==t.key&&freqset_update_ui(),void(ignore_next_keyup_event=!1)}ignore_next_keyup_event?ignore_next_keyup_event=!1:freqset_tout=setTimeout(function(){freqset_complete(1)},3e3)}var num_step_buttons=6,up_down={am:[0,-1,-.1,.1,1,0],amn:[0,-1,-.1,.1,1,0],usb:[0,-1,-.1,.1,1,0],lsb:[0,-1,-.1,.1,1,0],cw:[0,-.1,-.01,.01,.1,0],cwn:[0,-.1,-.01,.01,.1,0],nbfm:[-5,-1,-.1,.1,1,5],iq:[-5,-1,-.1,.1,1,5],s4285:[-5,-1,-.1,.1,1,5]},up_down_default={am:[5,0,0,0,0,5],amn:[5,0,0,0,0,5],usb:[5,0,0,0,0,5],lsb:[5,0,0,0,0,5],cw:[1,0,0,0,0,1],cwn:[1,0,0,0,0,1]},NDB_400_1000_mode=1,freq_step_last_mode,freq_step_last_band;function special_step(e,t,a){var n;return null!=e&&"NDB"==e.name?(n="cw"==cur_mode||"cwn"==cur_mode?NDB_400_1000_mode:-1," NDB"):null==e||"LW"!=e.name&&"MW"!=e.name?null!=e&&0!=e.chan?(n=e.chan," band="+e.name+" "):(n=-1," no band chan found, use default"):(n="am"==cur_mode||"amn"==cur_mode||"lsb"==cur_mode||"usb"==cur_mode?step_9_10?9e3:1e4:-1," LW/MW"),-1==n&&(n=1e3*up_down_default[cur_mode][t]),t<num_step_buttons/2&&(n=-n)," "+n,n}function freqstep(e){var t=1e3*up_down[cur_mode][e];0==t&&(t=special_step(find_band(freq_displayed_Hz),e,"freqstep"));var a=freq_displayed_Hz,n=Math.abs(t),_=t>=0?1:0,i=a/n;if(i=(_?Math.ceil(i):Math.floor(i))*n,n==NDB_400_1000_mode){var o=a%1e3;o=_?o<400?400:o<600?600:1e3:0==o?-400:o<=400?0:o<=600?400:600,a=(i=1e3*Math.floor(a/1e3))+o,"400/1000"}else freq_displayed_Hz!=i?(a=i,"TRUNC"):(a+=t,"INC");freqmode_set_dsp_kHz(a/1e3,null,!0)}function freq_step_update_ui(e){if(void 0!==cur_mode&&null!=passbands[cur_mode]){var t=find_band(freq_displayed_Hz);if(e||freq_step_last_mode!=cur_mode||freq_step_last_band!=t){var a=!(null==t||"LW"!=t.name&&"MW"!=t.name||"am"!=cur_mode&&"amn"!=cur_mode&&"lsb"!=cur_mode&&"usb"!=cur_mode);w3_visible("id-9-10-cell",a);for(var n=0;n<num_step_buttons;n++){var _,i=1e3*up_down[cur_mode][n];0==i&&(i=special_step(t,n,"freq_step_update_ui"));var o=Math.abs(i),s=i>=0?1:0;_=o>=1e3?(s?"+":"")+(i/1e3).toString()+"k":o!=NDB_400_1000_mode?(s?"+":"")+i.toString():(s?"+":"-")+"400/"+(s?"+":"-")+"1000",html("id-step-"+n).title=_}freq_step_last_mode=cur_mode,freq_step_last_band=t}}}function band_info(){var e,t,a,n=+cfg.init.AM_BCB_chan?10:9,_=cfg.init.ITU_region+1;return 1==_?(e=283.5,t=526.5,a=1606.5):2==_?(e=190.5,t=540-n/2,a=1700+n/2):(e=190.5,t=540-n/2,a=1602+n/2),{ITU_region:_,_9_10:n,LW_lo:148.5,NDB_lo:e,NDB_hi:t,MW_hi:a}}function bands_init(){var e,t,a=band_info();for(e=0;e<bands.length;e++){var n=bands[e];bands[e].chan=void 0===n.chan?0:n.chan,n.min-=n.chan/2,n.max+=n.chan/2,"LW"==n.name&&(n.min=a.LW_lo,n.max=a.NDB_lo,n.chan=9),"NDB"==n.name&&(n.min=a.NDB_lo,n.max=a.NDB_hi,n.chan=0),"MW"==n.name&&(n.min=a.NDB_hi,n.max=a.MW_hi,n.chan=a._9_10),n.min*=1e3,n.max*=1e3,n.chan*=1e3;var _=n.max-n.min;for(t=zoom_nom;t>=0&&!(_<=bandwidth/(1<<t));t--);bands[e].zoom_level=t,bands[e].cf=n.min+(n.max-n.min)/2,bands[e].longName=n.name+" "+n.s.name,n.s!=svc.L&&n.s!=svc.X||"m"!=n.region||n.sel.includes("cwn")||(n.sel=n.sel.replace("cw","cwn"))}mkscale()}function find_band(e){for(var t,a=0;a<bands.length;a++)if(("-"==(t=bands[a]).region||"*"==t.region||">"==t.region.charAt(0))&&e>=t.min&&e<=t.max)return t;return null}function mk_bands_scale(){var e,t,a,n=g_range,_=band_ctx.canvas.width,i=band_scale_top,o=band_scale_h,s=i+band_scale_text_top;for(band_ctx.globalAlpha=1,band_ctx.fillStyle="White",band_ctx.fillRect(0,band_canvas_top,_,band_canvas_h),e=0;e<bands.length;e++){var r=bands[e];if("-"==r.region||"*"==r.region||">"==r.region.charAt(0)){var l,d=0,c=r.min>=n.start&&r.min<=n.end?1:0,f=r.max>=n.start&&r.max<=n.end?1:0;if(c&&f?(d=r.min,l=r.max):!c&&f?(d=n.start,l=r.max):c&&!f?(d=r.min,l=n.end):r.min<n.start&&r.max>n.end&&(d=n.start,l=n.end),d)if(t=scale_px_from_freq(d,g_range),(a=scale_px_from_freq(l,g_range)-t)>=3){band_ctx.fillStyle=r.s.color,band_ctx.globalAlpha=.2,band_ctx.fillRect(t,i,a,o),band_ctx.globalAlpha=1,band_ctx.font="bold 12px sans-serif",band_ctx.textBaseline="top";var p=t+a/2,u=r.longName,m=band_ctx.measureText(u);a>=m.width+4||(u=r.name,a>=(m=band_ctx.measureText(u)).width+4||(u=null)),u&&band_ctx.fillText(u,p-m.width/2,s)}}}}function mk_spurs(){scale_ctx.fillStyle="red";for(var e=scale_canvas_h-12,t=0;t<=zoom_level&&t<spurs.length;t++)for(var a=0;a<spurs[t].length;a++){var n=scale_px_from_freq(1e3*spurs[t][a],g_range);if(n>window.innerWidth)break;n<0||scale_ctx.fillRect(n-1,e,2,12)}}function parse_freq_mode(e){new RegExp("([0-9.]*)([^&#]*)").exec(e)}band_canvas_h=30,band_canvas_top=0,band_scale_h=20,band_scale_top=5,band_scale_text_top=5,dx_container_h=80,dx_container_top=band_canvas_h,dx_label_top=5,dx_line_h=dx_container_h-dx_label_top,scale_canvas_h=47,scale_canvas_top=band_canvas_h+dx_container_h,scale_container_h=band_canvas_h+dx_container_h+scale_canvas_h;var last_selected_band=0,maxdb,mindb_un,mindb,full_scale;function select_band(e,t){var a=+e;if(isNaN(a)){var n;for(n=0;n<band_menu.length-1&&(!band_menu[n]||band_menu[n].name!=e);n++);n<band_menu.length-1&&select_band(n,t)}else{var _;if(b=band_menu[a],null!=b)void 0!==b.sel?(_=parseFloat(b.sel),void 0===t&&"string"==typeof b.sel&&(t=-1==(t=b.sel.search(/[a-z]/i))?null:b.sel.slice(t))):_=b.cf/1e3,last_selected_band=a,dbgUs&&(sb_trace=0),freqmode_set_dsp_kHz(_,t),zoom_step(ext_zoom.TO_BAND,b);else check_band(!0)}}function check_band(e){if(last_selected_band){band=band_menu[last_selected_band];var t=freq_car_Hz,a=freq_passband_center();(null!=e&&-1==e||(t<band.min||t>band.max)&&(a<band.min||a>band.max))&&(w3_select_value("id-select-band",0),last_selected_band=0)}}function tune(e,t,a,n){ext_tune(e,t,ext_zoom.ABS,a,n)}function init_scale_dB(){maxdb=init_max_dB,mindb_un=init_min_dB,mindb=mindb_un-zoomCorrection(),full_scale=(full_scale=maxdb-mindb)||1}var confirmation={displayed:!1,close_cb:null},cal_adc_new_adj;function confirmation_panel_init(){w3_el("id-panels-container").innerHTML+=w3_div('id-confirmation class-panel|border: 1px solid white|data-panel-name="confirmation" data-panel-pos="center" data-panel-order="0" data-panel-size="600,100"'),w3_innerHTML("id-confirmation",w3_divs("id-confirmation-container/class-panel-inner")+w3_div("id-confirmation-vis class-vis"))}function confirmation_panel_set_close_func(e){w3_el("id-confirmation-close").onclick=e,confirmation.close_cb=e}function confirmation_panel_init2(){confirmation_panel_set_close_func(confirmation_panel_close),w3_el("id-kiwi-body").addEventListener("keyup",function(e){"Escape"==e.key&&(confirmation.close_cb(),toggle_or_set_hide_panels(0))},!0)}function confirmation_show_content(e,t,a,n){w3_innerHTML("id-confirmation-container",e),n&&confirmation_panel_set_close_func(n),confirmation_panel_show(t,a),toggle_or_set_hide_panels(0)}function confirmation_panel_show(e,t){el=w3_el("id-confirmation"),el.style.zIndex=1020,null==e&&(e=525),null==t&&(t=80),confirmation_panel_resize(e,t),confirmation.displayed=!confirmation.displayed,toggle_panel("id-confirmation")}function confirmation_panel_resize(e,t){var a=w3_el("id-confirmation");panel_set_width_height("id-confirmation",e,t),a.style.left=px(window.innerWidth/2-a.activeWidth/2),a.style.bottom=px(window.innerHeight/2-a.uiHeight/2)}function confirmation_panel_close(){confirmation.displayed&&(toggle_panel("id-confirmation"),confirmation.displayed=!1)}function cal_adc_dialog(e,t,a,n){var _;if(cfg.ADC_clk_corr&&ext_adc_gps_clock_corr()>3?1:0)_=w3_col_percent("/w3-valign",w3_div("w3-show-inline-block","GPS is automatically correcting ADC clock. <br> No manual calibration available.")+w3_button("w3-red w3-margin-left","Close","confirmation_panel_close"),80);else{cal_adc_new_adj=e;var i=100*ext_adc_clock_nom_Hz()/1e6;e<-i||e>i?(console.log("cal ADC clock: ADJ TOO LARGE"),_=w3_col_percent("/w3-valign",w3_div("w3-show-inline-block","ADC clock adjustment too large: "+t+" Hz<br>(ADC clock "+n.toFixed(1)+" ppm, limit is +/- 100 ppm)")+w3_button("w3-red w3-margin-left","Close","confirmation_panel_close"),80)):_=w3_col_percent("/w3-valign",w3_div("w3-show-inline-block","ADC clock will be adjusted by<br>"+t+" Hz to "+a+" kHz<br>(ADC clock "+n.toFixed(1)+" ppm)")+w3_button("w3-green w3-margin-left","Confirm","cal_adc_confirm")+w3_button("w3-red w3-margin-left","Cancel","confirmation_panel_close"),80)}confirmation_show_content(_,525,70)}function cal_adc_confirm(){ext_send("SET clk_adj="+cal_adc_new_adj),ext_set_cfg_param("cfg.clk_adj",cal_adc_new_adj,!0),confirmation_panel_close()}function admin_pwd_query(e){ext_hasCredential("admin",admin_pwd_cb,e,ws_wf)}function admin_pwd_cb(e,t){(console.log("admin_pwd_cb badp="+e),e)?(confirmation_show_content(w3_col_percent("/w3-text-aqua",w3_input("kiwi-pw","Admin password","admin.pwd","","admin_pwd_cb2"),80),525,80),w3_field_select("id-admin.pwd",{mobile:1})):t()}function admin_pwd_cb2(e,t){w3_string_cb(e,t),confirmation_panel_close(),ext_valpwd("admin",t,ws_wf)}var dx={filter_ident:"",filter_notes:"",filter_case:0,filter_wild:0,filter_grep:0,ctrl_click:!1,displayed:[]},dx_update_delay=350,dx_update_timeout,dx_seq=0;function dx_schedule_update(){kiwi_clearTimeout(dx_update_timeout),dx_div.innerHTML="",dx_update_timeout=setTimeout(dx_update,dx_update_delay)}function dx_update(){dx_seq++,wf_send("SET MKR min="+(g_range.start/1e3).toFixed(3)+" max="+(g_range.end/1e3).toFixed(3)+" zoom="+zoom_level+" width="+waterfall_width)}var dx_ibp_list,dx_ibp_interval,dx_ibp_server_time_ms,dx_ibp_local_time_epoch_ms=0,dx_ibp_freqs={14:0,18:1,21:2,24:3,28:4},dx_ibp_lastsec=0,dx_ibp=["4U1UN","New York","VE8AT","Nunavut","W6WX","California","KH6RS","Hawaii","ZL6B","New Zealand","VK6RBP","Australia","JA2IGY","Japan","RR9O","Siberia","VR2B","Hong Kong","4S7B","Sri Lanka","ZS6DN","South Africa","5Z4B","Kenya","4X6TU","Israel","OH2B","Finland","CS3B","Madeira","LU4AA","Argentina","OA4B","Peru","YV5B","Venezuela"],dx_list=[];function dx_label_cb(e){var t,a=e[0];if(2!=a.t){kiwi_clearInterval(dx_ibp_interval),dx_ibp_list=[],dx_ibp_server_time_ms=1e3*a.s+ +a.m,dx_ibp_local_time_epoch_ms=Date.now(),dx_filter_field_err(+a.f);var n,_=120;dx_div.innerHTML="";var i="";for(dx.displayed=[],t=1;t<e.length;t++){n=t-1;var o=(a=e[t]).g,s=a.f,r=a.o,l=a.b,d=a.i,c=void 0!==a.n?a.n:"",f=void 0!==a.p?a.p:"",p=1e3*s,u=scale_px_from_freq(p+passband_offset_dxlabel(modes_l[l&DX_MODE]),g_range)-1,m=0,w=p-r;r&&(m=scale_px_from_freq(w,g_range));var h=dx_label_top+30*(1&n),v=dx_container_h-h,g=type_colors[l&DX_TYPE];"IBP"!=d&&"IARU%2fNCDXF"!=d||(g=type_colors[32]),w/=1e3,dx_list[o]={gid:o,carrier:w,lo:a.lo,hi:a.hi,freq:s,moff:r,flags:l,ident:d,notes:c,params:f},dx.displayed[n]=dx_list[o],i+='<div id="'+n+'-id-dx-label" class="class-dx-label '+o+"-id-dx-gid"+(""!=f?" id-has-ext":"")+'" style="left:'+(u-10)+"px; top:"+h+"px; z-index:"+_+"; background-color:"+g+';" onmouseenter="dx_enter(this,'+m+', event)" onmouseleave="dx_leave(this,'+m+')" onmousedown="ignore(event)" onmousemove="ignore(event)" onmouseup="ignore(event)" ontouchmove="ignore(event)" ontouchend="ignore(event)" onclick="dx_click(event,'+o+')" ontouchstart="dx_click(event,'+o+')" name="'+(""==f?0:1)+'"></div><div class="class-dx-line" id="'+n+'-id-dx-line" style="left:'+u+"px; top:"+h+"px; height:"+v+'px; z-index:110"></div>',_++}for(dx_div.innerHTML=i,t=1;t<e.length;t++){n=t-1;d=(a=e[t]).i,c=void 0!==a.n?a.n:"";var b=w3_el(n+"-id-dx-label");try{b.innerHTML=decodeURIComponent(d)}catch(e){b.innerHTML="bad URI decode"}try{b.title=decodeURIComponent(c)}catch(e){b.title="bad URI decode"}if("IBP"==d||"IARU%2fNCDXF"==d){var x=dx_ibp_freqs[Math.trunc(s/1e3)];dx_ibp_list.push({idx:n,off:x}),kiwi_clearInterval(dx_ibp_interval),dx_ibp_interval=setInterval(function(){var e=new Date(dx_ibp_server_time_ms+(Date.now()-dx_ibp_local_time_epoch_ms)),t=e.getMinutes(),a=e.getSeconds(),n=a%10;if(0==n&&9==dx_ibp_lastsec)for(var _=t%3*6+Math.trunc(a/10),i=0;i<dx_ibp_list.length;i++){var o=_-dx_ibp_list[i].off;o<0&&(o=18+o);var s=w3_el(dx_ibp_list[i].idx+"-id-dx-label");s&&(s.innerHTML="IBP: "+dx_ibp[2*o]+" "+dx_ibp[2*o+1])}dx_ibp_lastsec=n},500)}}}else{var y=e[1];if(y){var k=modes_l[y.b&DX_MODE];if(freqmode_set_dsp_kHz(y.f,k),0!=y.lo&&0!=y.hi)ext_set_passband(y.lo,y.hi);else{var q=passbands[k];ext_set_passband(q.lo,q.hi)}}}}function dx_filter(){confirmation_show_content(w3_div("w3-medium w3-text-aqua w3-bold","DX label filter")+w3_divs("w3-text-aqua",w3_col_percent("",w3_divs("/w3-margin-T-8",w3_input("w3-label-inline/id-dx-filter-ident w3-retain-input-focus w3-input-any-change w3-padding-small","Ident","dx.filter_ident",dx.filter_ident,"dx_filter_cb"),w3_input("w3-label-inline/id-dx-filter-notes w3-retain-input-focus w3-input-any-change w3-padding-small","Notes","dx.filter_notes",dx.filter_notes,"dx_filter_cb")),90),w3_inline("w3-halign-space-around w3-margin-T-8 w3-text-white/",w3_checkbox("w3-retain-input-focus w3-label-inline w3-label-not-bold","case sensitive","dx.filter_case",dx.filter_case,"dx_filter_opt_cb"),w3_inline("",w3_text("","pattern match:"),w3_checkbox("w3-margin-left w3-retain-input-focus w3-label-inline w3-label-not-bold","grep","dx.filter_grep",dx.filter_grep,"dx_filter_opt_cb")))),450,140,dx_filter_panel_close),w3_field_select("id-dx-filter-ident",{mobile:1})}function dx_filter_panel_close(){var e=document.activeElement;e&&e.id&&(e.id.startsWith("id-dx-filter")||e.id.startsWith("id-dx.filter"))&&e.blur(),confirmation_panel_set_close_func(confirmation_panel_close),confirmation_panel_close()}function dx_filter_cb(e,t,a,n){if(!a){w3_string_cb(e,t);var _=""!=dx.filter_ident||""!=dx.filter_notes;wf_send("SET DX_FILTER i="+encodeURIComponent(dx.filter_ident+"x")+" n="+encodeURIComponent(dx.filter_notes+"x")+" c="+dx.filter_case+" w="+dx.filter_wild+" g="+dx.filter_grep),w3_remove_then_add("id-dx-container","whiteSmoke cl-dx-filtered",_?"cl-dx-filtered":"whiteSmoke"),_||n||dx_filter_panel_close()}}function dx_filter_opt_cb(e,t,a){a||(t=+t,w3_bool_cb(e,t),dx_filter_cb("dx.filter_ident",dx.filter_ident,!1,!0),w3_checkbox_set(e,t),t&&"dx.filter_case"!=e&&dx_filter_opt_cb("dx.filter_wild"==e?"dx.filter_grep":"dx.filter_wild",0),w3_field_select("id-dx-filter-ident",{mobile:1}))}function dx_filter_field_err(e){w3_set_props("id-dx-filter-ident","w3-pink",1&e),w3_set_props("id-dx-filter-notes","w3-pink",2&e)}function dx_label_step(e){var t,a;if(1==e){for(t=0;t<dx.displayed.length;t++){if(a=dx.displayed[t],Math.round(1e3*a.freq)>freq_displayed_Hz)break}if(t==dx.displayed.length)return void wf_send("SET MKR dir=1 freq="+(freq_displayed_Hz/1e3).toFixed(3))}else{for(t=dx.displayed.length-1;t>=0;t--){if(a=dx.displayed[t],Math.round(1e3*a.freq)<freq_displayed_Hz)break}if(t<0)return void wf_send("SET MKR dir=-1 freq="+(freq_displayed_Hz/1e3).toFixed(3))}var n=modes_l[a.flags&DX_MODE];if(freqmode_set_dsp_kHz(a.freq,n),0!=a.lo&&0!=a.hi)ext_set_passband(a.lo,a.hi);else{var _=passbands[n];ext_set_passband(_.lo,_.hi)}}var dx_panel_customize=!1,dx_keys,dx_z_save,dx_bg_color_save,smeter_width;function dx_show_edit_panel(e,t){dx_keys={shift:e.shiftKey,alt:e.altKey,ctrl:e.ctrlKey,meta:e.metaKey},dxo.gid=t,dx_panel_customize||(html("id-ext-controls").className="class-panel class-dx-panel",dx_panel_customize=!0),admin_pwd_query(function(){dx_show_edit_panel2()})}function dx_show_edit_panel2(){var e=dxo.gid;if(-1==e)dxo.f=freq_displayed_kHz_str,dxo.lo=dxo.hi=dxo.o=0,dxo.m=modes_s[cur_mode],dxo.y=types_s.active,dxo.i=dxo.n=dxo.p="";else{dxo.f=dx_list[e].carrier.toFixed(2),dxo.lo=dx_list[e].lo,dxo.hi=dx_list[e].hi,dxo.o=dx_list[e].moff,dxo.m=dx_list[e].flags&DX_MODE,dxo.y=(dx_list[e].flags&DX_TYPE)>>DX_TYPE_SFT;try{dxo.i=decodeURIComponent(dx_list[e].ident)}catch(e){dxo.i="bad URI decode"}try{dxo.n=decodeURIComponent(dx_list[e].notes)}catch(e){dxo.n="bad URI decode"}try{dxo.p=decodeURIComponent(dx_list[e].params)}catch(e){dxo.p="bad URI decode"}}if(-1!=e&&dx_keys.shift&&dx_keys.alt){var t=dxo.y;t=t==types_s.active?types_s.watch_list:types_s.active,dxo.y=t;var a=dxo.m;return a|=t<<DX_TYPE_SFT,void wf_send("SET DX_UPD g="+dxo.gid+" f="+dxo.f+" lo="+dxo.lo.toFixed(0)+" hi="+dxo.hi.toFixed(0)+" o="+dxo.o.toFixed(0)+" m="+a+" i="+encodeURIComponent(dxo.i+"x")+" n="+encodeURIComponent(dxo.n+"x")+" p="+encodeURIComponent(dxo.p+"x"))}extint_panel_hide(),dxo.f=(parseFloat(dxo.f)+cfg.freq_offset).toFixed(2),dxo.pb="",(dxo.lo||dxo.hi)&&(dxo.lo==-dxo.hi?dxo.pb=(2*Math.abs(dxo.hi)).toFixed(0):dxo.pb=dxo.lo.toFixed(0)+", "+dxo.hi.toFixed(0));var n=w3_div("w3-medium w3-text-aqua w3-bold","DX label edit")+w3_divs("w3-text-aqua/w3-margin-T-8",w3_inline("w3-hspace-16",w3_input("w3-padding-small","Freq","dxo.f",dxo.f,"dx_num_cb"),w3_select("","Mode","","dxo.m",dxo.m,modes_u,"dx_sel_cb"),w3_input("w3-padding-small","Passband","dxo.pb",dxo.pb,"dx_passband_cb"),w3_select("","Type","","dxo.y",dxo.y,types,"dx_sel_cb"),w3_input("w3-padding-small","Offset","dxo.o",dxo.o,"dx_num_cb")),w3_input("w3-label-inline/w3-padding-small w3-retain-input-focus","Ident","dxo.i","","dx_string_cb"),w3_input("w3-label-inline/w3-padding-small","Notes","dxo.n","","dx_string_cb"),w3_input("w3-label-inline/w3-padding-small","Extension","dxo.p","","dx_string_cb"),w3_inline("w3-hspace-16",w3_button("w3-yellow","Modify","dx_modify_cb"),w3_button("w3-green","Add","dx_add_cb"),w3_button("w3-red","Delete","dx_delete_cb")));ext_panel_show(n,null,function(){var e=w3_el("dxo.i");e.value=dxo.i,w3_el("dxo.n").value=dxo.n,w3_el("dxo.p").value=dxo.p,w3_field_select(e,{mobile:1})}),ext_set_controls_width_height(525,260)}function dx_close_edit_panel(e){w3_radio_unhighlight(e),extint_panel_hide()}function dx_modify_cb(e,t){if(-1!=dxo.gid){var a=dxo.m;a|=dxo.y<<DX_TYPE_SFT,dxo.f-=cfg.freq_offset,dxo.f<0&&(dxo.f=0),wf_send("SET DX_UPD g="+dxo.gid+" f="+dxo.f+" lo="+dxo.lo.toFixed(0)+" hi="+dxo.hi.toFixed(0)+" o="+dxo.o.toFixed(0)+" m="+a+" i="+encodeURIComponent(dxo.i+"x")+" n="+encodeURIComponent(dxo.n+"x")+" p="+encodeURIComponent(dxo.p+"x")),setTimeout(function(){dx_close_edit_panel(e)},250)}}function dx_add_cb(e,t){var a=dxo.m;a|=dxo.y<<DX_TYPE_SFT,dxo.f-=cfg.freq_offset,dxo.f<0&&(dxo.f=0),wf_send("SET DX_UPD g=-1 f="+dxo.f+" lo="+dxo.lo.toFixed(0)+" hi="+dxo.hi.toFixed(0)+" o="+dxo.o.toFixed(0)+" m="+a+" i="+encodeURIComponent(dxo.i+"x")+" n="+encodeURIComponent(dxo.n+"x")+" p="+encodeURIComponent(dxo.p+"x")),setTimeout(function(){dx_close_edit_panel(e)},250)}function dx_delete_cb(e,t){-1!=dxo.gid&&(wf_send("SET DX_UPD g="+dxo.gid+" f=-1"),setTimeout(function(){dx_close_edit_panel(e)},250))}function dx_click(e,t){if(e.shiftKey)dx_show_edit_panel(e,t);else{var a=dx_list[t].freq,n=modes_l[dx_list[t].flags&DX_MODE],_=dx_list[t].lo,i=dx_list[t].hi;if(freqmode_set_dsp_kHz(a,n),(_||i)&&ext_set_passband(_,i,void 0,a),!any_alternate_click_event(e)&&!dx.ctrl_click&&dx_list[t].params){var o=decodeURIComponent(dx_list[t].params).split(",");extint.param=o.slice(1).join(","),extint_open(o[0],250)}dx.ctrl_click=!1}return cancelEvent(e)}function dx_enter(e,t,a){dx_z_save=e.style.zIndex,e.style.zIndex=999,dx_bg_color_save=e.style.backgroundColor,e.style.backgroundColor=w3_contains(e,"id-has-ext")&&!any_alternate_click_event(a)?"magenta":"yellow";var n=w3_el(parseInt(e.id)+"-id-dx-line");n.zIndex=998,n.style.width="3px",t&&(dx_canvas.style.left=t-dx_car_w/2+"px",dx_canvas.style.zIndex=100)}function dx_leave(e,t){e.style.zIndex=dx_z_save,e.style.backgroundColor=dx_bg_color_save;var a=w3_el(parseInt(e.id)+"-id-dx-line");a.zIndex=110,a.style.width="1px",t&&(dx_canvas.style.zIndex=99)}var SMETER_RHS=38,SMETER_SCALE_HEIGHT=29,SMETER_BIAS=127,SMETER_INPUT_MAX=3.4,SMETER_INPUT_RANGE=SMETER_BIAS+SMETER_INPUT_MAX,SMETER_DISPLAY_MAX=-6,SMETER_DISPLAY_RANGE=SMETER_BIAS+SMETER_DISPLAY_MAX,sMeter_dBm_biased=0,sMeter_ctx,smeter_ovfl,bars={dBm:[-121,-109,-97,-85,-73,-63,-53,-33,-13],text:["S1","S3","S5","S7","S9","+10","+20","+40","+60"]};function smeter_dBm_biased_to_x(e){return e>SMETER_DISPLAY_RANGE&&(e=SMETER_DISPLAY_RANGE),Math.round(e/SMETER_DISPLAY_RANGE*smeter_width)}function smeter_init(){w3_innerHTML("id-control-smeter",'<canvas id="id-smeter-scale" class="class-smeter-scale" width="0" height="0"></canvas>',w3_div("id-smeter-ovfl w3-hide","OV"),w3_div("id-smeter-dbm-value"),w3_div("id-smeter-dbm-units","dBm"));var e=w3_el("id-smeter-scale");smeter_ovfl=w3_el("smeter-ovfl");var t=smeter_width=divControl.activeWidth-SMETER_RHS-html_LR_border_pad(e),a=SMETER_SCALE_HEIGHT,n=a-8,_=t+SMETER_RHS;(sMeter_ctx=e.getContext("2d")).canvas.width=_,sMeter_ctx.canvas.height=a,sMeter_ctx.fillStyle="gray",sMeter_ctx.globalAlpha=1,sMeter_ctx.fillRect(0,0,_,a),sMeter_ctx.font="11px Verdana",sMeter_ctx.textBaseline="middle",sMeter_ctx.textAlign="center",sMeter_ctx.fillStyle="white";for(var i=0;i<bars.text.length;i++){var o=smeter_dBm_biased_to_x(bars.dBm[i]+SMETER_BIAS);line_stroke(sMeter_ctx,1,3,"white",o,n-8,o,n+8),sMeter_ctx.fillText(bars.text[i],o,n-15)}line_stroke(sMeter_ctx,0,5,"black",0,n,t,n),setInterval(update_smeter,100)}var sm_px=0,sm_timeout=0,sm_interval=10,sm_ovfl_showing=!1,ident_tout;function update_smeter(){var e=smeter_dBm_biased_to_x(sMeter_dBm_biased),t=SMETER_SCALE_HEIGHT-8;sMeter_ctx.globalAlpha=1,line_stroke(sMeter_ctx,0,5,"lime",0,t,e,t),0==sm_timeout--?(sm_timeout=sm_interval,e<sm_px&&line_stroke(sMeter_ctx,0,5,"black",e,t,sm_px,t),sm_px=e):e<sm_px?line_stroke(sMeter_ctx,0,5,"red",e,t,sm_px,t):(sm_px=e,sm_timeout=sm_interval),audio_ext_adc_ovfl&&!sm_ovfl_showing?(w3_hide("id-smeter-dbm-units"),w3_show("id-smeter-ovfl"),sm_ovfl_showing=!0):!audio_ext_adc_ovfl&&sm_ovfl_showing&&(w3_hide("id-smeter-ovfl"),w3_show("id-smeter-dbm-units"),sm_ovfl_showing=!1),w3_innerHTML("id-smeter-dbm-value",(sMeter_dBm_biased-SMETER_BIAS).toFixed(0))}var ident_user="",need_ident=!1;function ident_init(){var e=initCookie("ident","");e=kiwi_strip_tags(e,""),w3_el("id-ident-input").value=e,ident_user=e,need_ident=!0}function ident_complete(){var e=w3_el("id-ident-input"),t=e.value;t=kiwi_strip_tags(t,""),e.value=t,kiwi_clearTimeout(ident_tout),w3_field_select(e,{mobile:1}),writeCookie("ident",t),ident_user=t,need_ident=!0}function ident_keyup(e,t){if(kiwi_clearTimeout(ident_tout),null!=t&&null!=t.key){var a=t.key.length;if(any_alternate_click_event(t)||1!=a)return}ident_tout=setTimeout(ident_complete,5e3)}var shortcut={nav_off:0,keys:""};function keyboard_shortcut_init(){kiwi_isMobile()||kiwi_isFirefox()<47||kiwi_isChrome()<=49||kiwi_isOpera()<=36||(shortcut.help=w3_div("",w3_inline_percent("w3-padding-tiny w3-bold w3-text-aqua","Keys",25,"Function"),w3_inline_percent("w3-padding-tiny","g =",25,"select frequency entry field"),w3_inline_percent("w3-padding-tiny","j i LR-arrow-keys",25,"frequency step down/up, add shift or alt/ctrl for faster<br>shift plus alt/ctrl to step to next/prev DX label"),w3_inline_percent("w3-padding-tiny","t T",25,"scroll frequency memory list"),w3_inline_percent("w3-padding-tiny","a l u c f q",25,"select mode: AM LSB USB CW NBFM IQ"),w3_inline_percent("w3-padding-tiny","p P",25,"passband narrow/widen"),w3_inline_percent("w3-padding-tiny","r",25,"toggle audio recording"),w3_inline_percent("w3-padding-tiny","z Z",25,"zoom in/out, add alt/ctrl for max in/out"),w3_inline_percent("w3-padding-tiny","< >",25,"waterfall page down/up"),w3_inline_percent("w3-padding-tiny","w W",25,"waterfall min dB slider -/+ 1 dB, add alt/ctrl for -/+ 10 dB"),w3_inline_percent("w3-padding-tiny","S",25,"waterfall auto-scale"),w3_inline_percent("w3-padding-tiny","s d",25,"spectrum on/off toggle, slow device mode"),w3_inline_percent("w3-padding-tiny","v V m",25,"volume less/more, mute"),w3_inline_percent("w3-padding-tiny","o",25,'toggle between option bar "off" and "stats" mode,<br>others selected by related shortcut key'),w3_inline_percent("w3-padding-tiny","@",25,"DX label filter"),w3_inline_percent("w3-padding-tiny","x y",25,"toggle visibility of control panels, top bar"),w3_inline_percent("w3-padding-tiny","esc",25,"close/cancel action"),w3_inline_percent("w3-padding-tiny","? h",25,"toggle this help list"),w3_inline_percent("w3-padding-tiny w3-bold w3-text-aqua","",25,"Windows, Linux: use alt, not ctrl"),w3_inline_percent("w3-padding-tiny w3-bold w3-text-aqua","",25,"Mac: use ctrl or alt")),w3_el("id-kiwi-body").addEventListener("keydown",keyboard_shortcut_event,!0))}function keyboard_shortcut_help(){confirmation_show_content(shortcut.help,550,465)}function keyboard_shortcut_nav(e){w3_el("id-nav-optbar-"+e).click(),shortcut.nav_click=!0}function keyboard_shortcut_key_proc(){shortcut.key_i>=shortcut.keys.length||(keyboard_shortcut(shortcut.keys[shortcut.key_i],0,0),shortcut.key_i++,setTimeout(keyboard_shortcut_key_proc,100))}function keyboard_shortcut_url_keys(){shortcut.keys=shortcut.keys.split(""),shortcut.key_i=0,keyboard_shortcut_key_proc()}function keyboard_shortcut(e,t,a){var n=!0,_=ext_get_mode();switch(shortcut.nav_click=!1,e){case"a":ext_set_mode("am"==_?"amn":"am");break;case"l":ext_set_mode("lsb");break;case"u":ext_set_mode("usb");break;case"c":ext_set_mode("cw"==_?"cwn":"cw");break;case"f":ext_set_mode("nbfm");break;case"q":ext_set_mode("iq");break;case"j":case"J":case"ArrowLeft":t<3?freqstep(2-t):dx_label_step(-1);break;case"i":case"I":case"ArrowRight":t<3?freqstep(3+t):dx_label_step(1);break;case"p":passband_increment(!1);break;case"P":passband_increment(!0);break;case"v":setvolume(1,volume-10),toggle_or_set_mute(0),keyboard_shortcut_nav("audio");break;case"V":setvolume(1,volume+10),toggle_or_set_mute(0),keyboard_shortcut_nav("audio");break;case"m":toggle_or_set_mute(),shortcut.nav_click=!0;break;case"g":case"=":freqset_select();break;case"t":freq_up_down_cb(null,1);break;case"T":freq_up_down_cb(null,0);break;case"<":page_scroll(-page_scroll_amount);break;case">":page_scroll(+page_scroll_amount);break;case"z":zoom_step(a?ext_zoom.NOM_IN:ext_zoom.IN);break;case"Z":zoom_step(a?ext_zoom.MAX_OUT:ext_zoom.OUT);break;case"w":incr_mindb(1,a?-10:-1),keyboard_shortcut_nav("wf");break;case"W":incr_mindb(1,a?10:1),keyboard_shortcut_nav("wf");break;case"s":toggle_or_set_spec(),keyboard_shortcut_nav("wf");break;case"S":wf_autoscale(),keyboard_shortcut_nav("wf");break;case"d":toggle_or_set_slow_dev(),keyboard_shortcut_nav("wf");break;case"o":keyboard_shortcut_nav(shortcut.nav_off?"status":"off"),shortcut.nav_off^=1;break;case"r":toggle_or_set_rec();break;case"x":toggle_or_set_hide_panels();break;case"y":toggle_or_set_hide_topbar();break;case"@":dx_filter(),shortcut.nav_click=!0;break;case"?":case"h":keyboard_shortcut_help();break;default:n=!1}n&&!shortcut.nav_click&&keyboard_shortcut_nav("users"),ignore_next_keyup_event=!0}function keyboard_shortcut_event(e){if(e.target){var t=e.key;if("Escape"==t||t.match(/F[1-9][12]?/))return;var a=e.target.id;""==a&&w3_iterate_classList(e.target,function(e,t){e.startsWith("id-")&&(a=e," (class)")});var n=e.shiftKey,_=e.ctrlKey,i=e.altKey,o=e.metaKey,s=_||i,r=n&&!s?1:!n&s?2:n&&s?3:0,l=t>="0"&&t<="9"&&!_||"."==t||","==t||"/"==t||":"==t||"-"==t||"k"==t||"M"==t||"Enter"==t||"ArrowUp"==t||"ArrowDown"==t||"Backspace"==t||"Delete"==t;if("INPUT"!=e.target.nodeName||"id-freq-input"==a&&!l){if(kiwi_isOSX()){if(o)return}else if(_)return;return i&&!t.startsWith("Arrow")&&(t=String.fromCharCode(e.keyCode).toLowerCase(),n&&(t=t.toUpperCase())),keyboard_shortcut(t,r,s),void cancelEvent(e)}}}var panel_margin=10,ac_play_button;function test_audio_suspended(){if("running"!=ac_play_button.state){var e=w3_div('id-play-button-container||onclick="play_button()"',w3_div("id-play-button",'<img src="gfx/openwebrx-play-button.png" width="150" height="150" /><br><br>'+(kiwi_isMobile()?"Tap to":"Click to")+" start OpenWebRX"));w3_appendElement("id-main-container","div",e),el=w3_el("id-play-button"),el.style.marginTop=px(w3_center_in_window(el))}}function panels_setup(){w3_el("id-ident").innerHTML='<form id="id-ident-form" action="#" onsubmit="ident_complete(); return false;">'+w3_input('w3-label-not-bold/id-ident-input|padding:1px|size=20 onkeyup="ident_keyup(this, event)"',"Your name or callsign:")+"</form>",w3_el("id-control-freq1").innerHTML=w3_inline("",w3_div("id-freq-cell",'<form id="id-freq-form" name="form_freq" action="#" onsubmit="freqset_complete(0); return false;">'+w3_input('id-freq-input|padding:0 4px;max-width:74px|size=8 onkeydown="freqset_keydown(event)" onkeyup="freqset_keyup(this, event)"')+"</form>"),w3_div("|padding:0 0 0 3px",w3_icon('w3-show-block w3-text-orange||title="prev"',"fa-arrow-circle-up",15,"","freq_up_down_cb",1)+w3_icon('w3-show-block w3-text-aqua||title="next"',"fa-arrow-circle-down",15,"","freq_up_down_cb",0)),w3_div("id-select-band-cell|padding:0 4px",'<select id="id-select-band" class="w3-pointer" onchange="select_band(this.value)"><option value="0" selected disabled>select band</option>'+setup_band_menu()+"</select>"),w3_div("select-ext-cell|padding:0",'<select id="select-ext" class="w3-pointer" onchange="freqset_select(); extint_select(this.value)"><option value="-1" selected disabled>extension</option>'+extint_select_menu()+"</select>"));try{if(window.AudioContext=window.AudioContext||window.webkitAudioContext,ac_play_button=new AudioContext,kiwi_isSafari()){var e=ac_play_button.createBufferSource();e.connect(ac_play_button.destination);try{e.start(0)}catch(t){e.noteOn(0)}}setTimeout(test_audio_suspended,500)}catch(e){console.log("#### no AudioContext?")}if(w3_el("id-control-freq2").innerHTML=w3_inline("w3-halign-space-between w3-margin-T-4/",w3_div("id-mouse-freq",w3_div("id-mouse-unit","-----.--")),w3_div("id-link-cell",w3_div("id-freq-link|padding-left:0px")),w3_div("id-9-10-cell",w3_div('id-button-9-10 class-button-small||title="LW/MW 9/10 kHz tuning step" onclick="button_9_10()"',"10")),w3_div("id-step-freq",'<img id="id-step-0" src="icons/stepdn.20.png" onclick="freqstep(0)" />','<img id="id-step-1" src="icons/stepdn.18.png" onclick="freqstep(1)" style="padding-bottom:1px" />','<img id="id-step-2" src="icons/stepdn.16.png" onclick="freqstep(2)" style="padding-bottom:2px" />','<img id="id-step-3" src="icons/stepup.16.png" onclick="freqstep(3)" style="padding-bottom:2px" />','<img id="id-step-4" src="icons/stepup.18.png" onclick="freqstep(4)" style="padding-bottom:1px" />','<img id="id-step-5" src="icons/stepup.20.png" onclick="freqstep(5)" />'),w3_div("",w3_button("id-button-spectrum class-button","Spec","toggle_or_set_spec")),w3_div("",w3_div('fa-stack||title="record"',w3_icon("id-rec1","fa-circle fa-nudge-down fa-stack-2x w3-text-pink",22,"","toggle_or_set_rec"),w3_icon("id-rec2","fa-stop fa-stack-1x w3-text-pink w3-hide",10,"","toggle_or_set_rec"))),w3_div('|width:8%|title="mute"',w3_div("id-mute-no fa-stack|width:100%;",w3_icon("","fa-volume-up fa-stack-2x fa-nudge-right-OFF",24,"lime","toggle_or_set_mute")),w3_div("id-mute-yes fa-stack w3-hide|width:100%;color:magenta;",w3_icon("","fa-volume-off fa-stack-2x fa-nudge-left",24,"","toggle_or_set_mute"),w3_icon("","fa-times fa-right fa-nudge-left-OFF",12,"","toggle_or_set_mute")))),isNaN(override_9_10)){var t=ext_get_cfg_param("init.AM_BCB_chan");step_9_10=null==t||null==t?0:t?0:1}else step_9_10=override_9_10;button_9_10(step_9_10),w3_el("id-control-mode").innerHTML=w3_inline("w3-halign-space-between/",w3_div('id-button-am class-button||onclick="mode_button(event, this)" onmousedown="cancelEvent(event)" onmouseover="mode_over(event, this)"',"AM"),w3_div('id-button-amn class-button||onclick="mode_button(event, this)" onmousedown="cancelEvent(event)" onmouseover="mode_over(event, this)"',"AMN"),w3_div('id-button-lsb class-button||onclick="mode_button(event, this)" onmousedown="cancelEvent(event)" onmouseover="mode_over(event, this)"',"LSB"),w3_div('id-button-usb class-button||onclick="mode_button(event, this)" onmousedown="cancelEvent(event)" onmouseover="mode_over(event, this)"',"USB"),w3_div('id-button-cw class-button||onclick="mode_button(event, this)" onmousedown="cancelEvent(event)" onmouseover="mode_over(event, this)"',"CW"),w3_div('id-button-cwn class-button||onclick="mode_button(event, this)" onmousedown="cancelEvent(event)" onmouseover="mode_over(event, this)"',"CWN"),w3_div('id-button-nbfm class-button||onclick="mode_button(event, this)" onmousedown="cancelEvent(event)" onmouseover="mode_over(event, this)"',"NBFM"),w3_div('id-button-iq class-button||onclick="mode_button(event, this)" onmousedown="cancelEvent(event)" onmouseover="mode_over(event, this)"',"IQ"));var a=audioFFT_active?" w3-disabled":"",n=audioFFT_active?' w3-disabled||onclick="audioFFT_update()"':"";w3_el("id-control-zoom").innerHTML=w3_inline("w3-halign-space-between/",w3_div("id-zoom-in class-icon"+a+'||onclick="zoom_click(event,1)" onmouseover="zoom_over(event)" title="zoom in"','<img src="icons/zoomin.png" width="32" height="32" />'),w3_div("id-zoom-out class-icon"+a+'||onclick="zoom_click(event,-1)" onmouseover="zoom_over(event)" title="zoom out"','<img src="icons/zoomout.png" width="32" height="32" />'),w3_div("id-maxin"+n,w3_div('class-icon||onclick="zoom_click(event,8)" title="max in"','<img src="icons/maxin.png" width="32" height="32" />')),w3_div("id-maxin-nom w3-hide"+n,w3_div('class-icon||onclick="zoom_click(event,8)" title="max in"','<img src="icons/maxin.nom.png" width="32" height="32" />')),w3_div("id-maxin-max w3-hide"+n,w3_div('class-icon||onclick="zoom_click(event,8)" title="max in"','<img src="icons/maxin.max.png" width="32" height="32" />')),w3_div("id-maxout"+n,w3_div('class-icon||onclick="zoom_click(event,-9)" title="max out"','<img src="icons/maxout.png" width="32" height="32" />')),w3_div("id-maxout-max w3-hide"+n,w3_div('class-icon||onclick="zoom_click(event,-9)" title="max out"','<img src="icons/maxout.max.png" width="32" height="32" />')),w3_div("class-icon"+a+'||onclick="zoom_click(event,0)" title="zoom to band"','<img src="icons/zoomband.png" width="32" height="16" style="padding-top:13px; padding-bottom:13px;"/>'),w3_div("class-icon"+a+'||onclick="page_scroll_icon_click(event,'+-page_scroll_amount+')" title="page down\nalt: label step"','<img src="icons/pageleft.png" width="32" height="32" />'),w3_div("class-icon"+a+'||onclick="page_scroll_icon_click(event,'+page_scroll_amount+')" title="page up\nalt: label step"','<img src="icons/pageright.png" width="32" height="32" />'));var _=["w3-pink","w3-blue","w3-purple","w3-aqua","w3-yellow","w3-black","w3-red","w3-khaki","w3-green","w3-orange","w3-lime","w3-indigo","w3-brown","w3-teal"],i=0,o=" w3-center|width:15.2%",s=o+";margin-right:6px";if(w3_el("id-optbar").innerHTML=w3_navbar("cl-optbar",w3_navdef(_[i++]+s,"WF","optbar-wf","optbar"),w3_nav(_[i++]+s,"Audio","optbar-audio","optbar"),w3_nav(_[i++]+s,"AGC","optbar-agc","optbar"),w3_nav(_[i++]+s,"Users","optbar-users","optbar"),w3_nav(_[i++]+s,"Stats","optbar-status","optbar"),w3_nav(_[i++]+o,"Off","optbar-off","optbar")),null==(spec_filter=readCookie("last_spec_filter"))&&(spec_filter=0),"string"==typeof spectrum_show){var r=spectrum_show.toLowerCase();spec_filter_s.forEach(function(e,t){r==e.toLowerCase()&&(spec_filter=t)})}w3_el("id-optbar-wf").innerHTML=w3_col_percent("",w3_div("",w3_col_percent("w3-valign/class-slider",w3_text(optbar_prefix_color,"WF max"),19,'<input id="id-input-maxdb" type="range" min="-100" max="20" value="'+maxdb+'" step="1" onchange="setmaxdb(1,this.value)" oninput="setmaxdb(0, this.value)">',60,w3_div("id-field-maxdb class-slider"),19),w3_col_percent("w3-valign/class-slider",w3_text(optbar_prefix_color,"WF min"),19,'<input id="id-input-mindb" type="range" min="-190" max="-30" value="'+mindb+'" step="1" onchange="setmindb(1,this.value)" oninput="setmindb(0, this.value)">',60,w3_div("id-field-mindb class-slider"),19),w3_col_percent("w3-valign/class-slider",w3_text(optbar_prefix_color,"WF rate"),19,'<input id="slider-rate" class="'+a+'" type="range" min="0" max="4" value="'+wf_speed+'" step="1" onchange="setwfspeed(1,this.value)" oninput="setwfspeed(0,this.value)">',60,w3_div("slider-rate-field class-slider"),19),w3_col_percent("w3-valign/class-slider",w3_text(optbar_prefix_color,"SP parm"),19,w3_slider("slider-spparam","","sp_param",sp_param,0,10,1,"spec_filter_param_cb"),60,w3_div("slider-spparam-field class-slider"),19),w3_inline("w3-halign-space-around/",w3_select("|color:red","","colormap","wf.cmap",wf.cmap,wf_cmap_s,"wf_cmap_cb"),w3_select("|color:red","","spec filter","spec_filter",spec_filter,spec_filter_s,"spec_filter_cb"),w3_div("w3-hcenter",w3_button("id-button-spec-peak class-button","Peak","toggle_or_set_spec_peak")))),85,w3_div("",w3_div("w3-hcenter w3-margin-T-2 w3-margin-B-10",w3_button("id-button-wf-autoscale class-button","Auto<br>Scale","wf_autoscale")),w3_div("w3-hcenter w3-margin-B-10",w3_button("id-button-slow-dev class-button","Slow<br>Dev","toggle_or_set_slow_dev")),w3_div("w3-hcenter",w3_button("id-button-wf-gnd class-button w3-momentary","GND","wf_gnd_cb",1))),15),setwfspeed(1,wf_speed),toggle_or_set_slow_dev(toggle_e.FROM_COOKIE|toggle_e.SET,0),toggle_or_set_spec_peak(toggle_e.FROM_COOKIE|toggle_e.SET_URL,peak_initially),null==(de_emphasis=readCookie("last_de_emphasis"))&&(de_emphasis=0),null==(pan=readCookie("last_pan"))&&(pan=0),w3_el("id-optbar-audio").innerHTML=w3_col_percent("w3-valign/class-slider",w3_div("w3-show-inline-block",w3_text(optbar_prefix_color,"Noise gate")),20,'<input id="input-noise-gate" type="range" min="100" max="5000" value="'+noiseGate+'" step="100" onchange="setNoiseGate(1,this.value)" oninput="setNoiseGate(0,this.value)">',50,w3_div("field-noise-gate w3-show-inline-block",noiseGate.toString())+" uS",15,w3_div("w3-hcenter",w3_div('id-button-nb class-button||title="noise blanker"; onclick="toggle_or_set_nb();"',"NB")),15)+w3_col_percent("w3-valign/class-slider",w3_div("w3-show-inline-block",w3_text(optbar_prefix_color+" cl-closer-spaced-label-text","Noise<br>threshold")),20,'<input id="input-noise-th" type="range" min="0" max="100" value="'+noiseThresh+'" step="1" onchange="setNoiseThresh(1,this.value)" oninput="setNoiseThresh(0,this.value)">',50,w3_div("field-noise-th w3-show-inline-block",noiseThresh.toString())+"%",15,w3_button('id-button-compression class-button w3-hcenter||title="compression"',"Comp","toggle_or_set_compression"),15)+w3_col_percent("w3-valign w3-margin-TB-4/",w3_div("w3-show-inline-block",w3_text(optbar_prefix_color,"LMS filter")),25,w3_div("w3-valign",w3_checkbox("w3-label-inline w3-label-not-bold","Denoiser","lms.denoise",!1,"lms_denoise_load_cb")),30,w3_div("w3-valign",w3_checkbox("w3-label-inline w3-label-not-bold","Autonotch","lms.autonotch",!1,"lms_autonotch_load_cb")),30,w3_div("w3-hcenter",w3_div("id-button-lms-ext class-button||onclick=\"extint_open('LMS'); freqset_select();\"","More")),15)+w3_col_percent("w3-valign/class-slider",w3_text(optbar_prefix_color,"Volume"),20,'<input id="id-input-volume" type="range" min="0" max="200" value="'+volume+'" step="1" onchange="setvolume(1, this.value)" oninput="setvolume(0, this.value)">',35,w3_select("|color:red","","de-emp","de_emphasis",de_emphasis,de_emphasis_s,"de_emp_cb"),30,w3_div("w3-hcenter",w3_div('id-button-mute class-button||onclick="toggle_or_set_mute();"',"Mute")),15)+w3_col_percent("id-squelch w3-valign w3-hide/class-slider",w3_text("id-squelch-label","Squelch"),20,'<input id="id-squelch-value" type="range" min="0" max="99" value="'+squelch+'" step="1" onchange="setsquelch(1,this.value)" oninput="setsquelch(1, this.value)">',50,w3_div("id-squelch-field class-slider"),30)+w3_col_percent("id-pan w3-valign w3-hide/class-slider",w3_text(optbar_prefix_color,"Pan"),20,'<input id="id-pan-value" type="range" min="-1" max="1" value="'+pan+'" step="0.01" onchange="setpan(1,this.value)" oninput="setpan(0, this.value)">',50,w3_div("id-pan-field"),15),w3_color("id-button-mute",muted?"lime":"white"),toggle_or_set_test(0),toggle_or_set_compression(toggle_e.FROM_COOKIE|toggle_e.SET,1),nb_setup(toggle_e.FROM_COOKIE|toggle_e.SET),toggle_or_set_nb(toggle_e.FROM_COOKIE|toggle_e.SET,0),squelch_setup(toggle_e.FROM_COOKIE),audio_panner_ui_init(),w3_el("id-optbar-agc").innerHTML=w3_col_percent("w3-valign/class-slider",'<div id="id-button-agc" class="class-button" onclick="toggle_agc(event)" onmousedown="cancelEvent(event)" onmouseover="agc_over(event)">AGC</div>',13,'<div id="id-button-hang" class="class-button" onclick="toggle_or_set_hang();">Hang</div>',17,w3_divs("w3-show-inline-block/id-label-man-gain cl-closer-spaced-label-text","Manual<br>gain"),15,'<input id="input-man-gain" type="range" min="0" max="120" value="'+manGain+'" step="1" onchange="setManGain(1,this.value)" oninput="setManGain(0,this.value)">',40,w3_div("field-man-gain w3-show-inline-block",manGain.toString())+" dB",15)+w3_div("",w3_col_percent("w3-valign/class-slider",w3_div("label-threshold w3-show-inline-block","Threshold"),18,'<input id="input-threshold" type="range" min="-130" max="0" value="'+thresh+'" step="1" onchange="setThresh(1,this.value)" oninput="setThresh(0,this.value)">',52,w3_div("field-threshold w3-show-inline-block",thresh.toString())+" dB",30),w3_col_percent("w3-valign/class-slider",w3_div("label-slope w3-show-inline-block","Slope"),18,'<input id="input-slope" type="range" min="0" max="10" value="'+slope+'" step="1" onchange="setSlope(1,this.value)" oninput="setSlope(0,this.value)">',52,w3_div("field-slope w3-show-inline-block",slope.toString())+" dB",30),w3_col_percent("w3-valign/class-slider",w3_div("label-decay w3-show-inline-block","Decay"),18,'<input id="input-decay" type="range" min="20" max="5000" value="'+decay+'" step="1" onchange="setDecay(1,this.value)" oninput="setDecay(0,this.value)">',52,w3_div("field-decay w3-show-inline-block",decay.toString())+" mS",30)),setup_agc(toggle_e.FROM_COOKIE|toggle_e.SET),w3_click_nav(kiwi_toggle(toggle_e.FROM_COOKIE|toggle_e.SET,"optbar-wf","optbar-wf","last_optbar"),"optbar","init"),w3_el("id-news").style.backgroundColor=news_color,w3_el("id-news-inner").innerHTML='<span style="font-size: 14pt; font-weight: bold;">KiwiSDR now available on <a href="https://www.kickstarter.com/projects/1575992013/kiwisdr-beaglebone-software-defined-radio-sdr-with" target="_blank"><img class="class-KS" src="icons/kickstarter-logo-light.150x18.png" /></a></span>',w3_el("id-readme").style.backgroundColor=readme_color,w3_el("id-readme-inner").innerHTML='<span style="font-size: 15pt; font-weight: bold;">Welcome!</span>&nbsp;&nbsp;&nbsp;Project website: <a href="http://kiwisdr.com" target="_blank">kiwisdr.com</a>&nbsp;&nbsp;&nbsp;&nbsp;Here are some tips: \t\t<ul style="padding-left: 12px;"> \t\t<li> Please <a href="javascript:sendmail(\'pvsslqwChjtjpgq-`ln\');">email us</a> \t\t\tif your browser is having problems with the SDR. </li>\t\t<li> Windows: Firefox, Chrome & Edge work; IE does not work. </li>\t\t<li> Mac & Linux: Safari, Firefox, Chrome & Opera should work fine. </li>\t\t<li> Open and close the panels by using the circled arrows at the top right corner. </li>\t\t<li> You can click and/or drag almost anywhere on the page to change settings. </li>\t\t<li> Enter a numeric frequency in the box marked "kHz" at right. </li>\t\t<li> Or use the "select band" menu to jump to a pre-defined band. </li>\t\t<li> Use the zoom icons to control the waterfall span. </li>\t\t<li> Tune by clicking on the waterfall, spectrum or the cyan/red-colored station labels. </li>\t\t<li> Ctrl-shift or alt-shift click in the waterfall to lookup frequency in online databases. </li>\t\t<li> Control or option/alt click to page spectrum down and up in frequency. </li>\t\t<li> Adjust the "WF min" slider for best waterfall colors. </li>\t\t<li> See the <a href="http://www.kiwisdr.com/quickstart/" target="_blank">Operating information</a> page\t\t     and <a href="https://www.dropbox.com/s/i1bjyp1acghnc16/KiwiSDR.design.review.pdf?dl=1" target="_blank">Design review document</a>. </li>\t\t</ul> \t\t';var l=ext_get_cfg_param("contact_admin");void 0===l&&(l=!0);var d=ext_get_cfg_param("admin_email");null!=(d="undefined"!=l&&null!=l&&1==l&&"undefined"!=d&&null!=d?d:null)&&(d=encodeURIComponent(encodeURIComponent(enc(d)))),w3_el("id-optbar-status").innerHTML=w3_div("id-status-msg")+w3_div("",w3_text(optbar_prefix_color,"Links"),w3_text("",(d?"<a href=\"javascript:sendmail('"+d+"');\">Owner/Admin</a> | ":"")+'<a href="http://kiwisdr.com" target="_blank">KiwiSDR</a> | <a href="http://valentfx.com/vanilla/discussions" target="_blank">Forum</a> | <a href="https://kiwiirc.com/client/chat.freenode.net/#kiwisdr" target="_blank">Chat</a> '))+w3_div("id-status-adc")+w3_div("id-status-config")+w3_div("id-status-gps")+w3_div("",w3_div("id-status-audio w3-show-inline")," ",w3_div("id-status-problems w3-show-inline"))+w3_div("id-status-stats-cpu")+w3_div("id-status-stats-xfer"),setTimeout(function(){setInterval(status_periodic,5e3)},1e3)}var prev_optbar=null;function optbar_focus(e,t){var a;writeCookie("last_optbar",e),"optbar-off"==e?("init"!=t&&"optbar-off"==prev_optbar&&toggle_or_set_hide_topbar(),w3_hide("id-optbar-content"),a=px(CONTROL_HEIGHT)):(w3_show_block("id-optbar-content"),a=px(CONTROL_HEIGHT+OPTBAR_HEIGHT+OPTBAR_TMARGIN)),w3_el("id-control").style.height=a,prev_optbar=e,freqset_select()}function optbar_blur(e){}function zoomCorrection(){return 3*zoom_level}var WF_SPEED_OFF=0,WF_SPEED_1HZ=1,WF_SPEED_SLOW=2,WF_SPEED_MED=3,WF_SPEED_FAST=4,wf_speed=WF_SPEED_FAST,wf_speeds=["off","1 Hz","slow","med","fast"],wf={contr:0,cmap:0},wf_contr_s={0:"normal",1:"scheme 1",2:"scheme 2",3:"scheme 3",4:"scheme 4"};function wf_contr_cb(e,t,a){console.log("wf_contr_cb idx="+t+" first="+a)}var wf_gnd=0,wf_gnd_value_base=150,wf_gnd_value=wf_gnd_value_base;function wf_gnd_cb(e,t,a){wf_gnd=!t,0==t&&freqset_select()}var sp_param=0,spec_filter=0,spec_filter_s=["IIR","MMA","EMA","off"],spec_filter_e={IIR:0,MMA:1,EMA:2,OFF:3},spec_filter_p={IIR_min:0,IIR_max:1,IIR_step:.1,IIR_def:.2,IIR_val:void 0,MMA_min:1,MMA_max:64,MMA_step:1,MMA_def:8,MMA_val:void 0,EMA_min:1,EMA_max:64,EMA_step:1,EMA_def:8,EMA_val:void 0,off_min:0,off_max:0,off_step:0,off_def:0,off_val:void 0};function spec_show(){toggle_or_set_spec(toggle_e.SET,1);var e=-1;spectrum_param=parseFloat(spectrum_param),isNaN(spectrum_param)||-1==spectrum_param||(e=spectrum_param);var t=spec_filter_s[spec_filter];e>=spec_filter_p[t+"_min"]&&e<=spec_filter_p[t+"_max"]&&(console.log("spec_show sp="+e),spec_filter_param_cb("",e,!0,!1))}function spec_filter_cb(e,t,a){var n=spec_filter_s[spec_filter=t=+t],_=spec_filter_p[n+"_val"];if(null==_){_=spec_filter_p[n+"_def"];var i=parseFloat(readCookie("last_spec_filter")),o=parseFloat(readCookie("last_spec_filter_param"));i!=spec_filter||isNaN(o)||(_=o)}writeCookie("last_spec_filter",spec_filter.toString()),w3_slider_setup("slider-spparam",spec_filter_p[n+"_min"],spec_filter_p[n+"_max"],spec_filter_p[n+"_step"],_),spec_filter_param_cb("",_,!0,!1),need_clear_specavg=!0,freqset_select()}function spectrum_filter(e){spec_filter_cb("",e,!1)}function spec_filter_param_cb(e,t,a,n){n||(sp_param=+t,spec_filter_p[spec_filter_s[spec_filter]+"_val"]=sp_param,w3_set_value("slider-spparam",sp_param),w3_el("slider-spparam-field").innerHTML=sp_param,a&&(writeCookie("last_spec_filter_param",sp_param.toFixed(2)),freqset_select()))}var wf_cmap_s=["default","CuteSDR","greyscale","user 1"];function wf_cmap_cb(e,t,a){if(!a){var n=[1,0,2,3];((t=+t)<0||t>=n.length)&&(t=0),colormap_select=n[t],console.log("wf_cmap_cb idx="+t+" first="+a+" colormap_select="+colormap_select),mkcolormap(),spectrum_dB_bands(),freqset_select()}}function setwfspeed(e,t){audioFFT_active?freqset_select():(wf_speed=+t,w3_set_value("slider-rate",wf_speed),w3_el("slider-rate-field").innerHTML=wf_speeds[wf_speed],w3_el("slider-rate-field").style.color=wf_speed?"white":"orange",wf_send("SET wf_speed="+wf_speed.toFixed(0)),e&&freqset_select())}function setmaxdb(e,t){var a=parseFloat(t);a<=mindb?(maxdb=mindb+1,html("id-input-maxdb").value=maxdb,html("id-field-maxdb").innerHTML=maxdb.toFixed(0)+" dB",html("id-field-maxdb").style.color="red"):(maxdb=a,html("id-field-maxdb").innerHTML=a.toFixed(0)+" dB",html("id-field-maxdb").style.color="white",html("id-field-mindb").style.color="white"),setmaxmindb(e)}function incr_mindb(e,t){var a=+mindb+t;setmindb(e,Math.max(-190,Math.min(-30,a)).toFixed(0))}function setmindb(e,t){var a=parseFloat(t);maxdb<=a?(mindb=maxdb-1,html("id-input-mindb").value=mindb,html("id-field-mindb").innerHTML=mindb.toFixed(0)+" dB",html("id-field-mindb").style.color="red"):(mindb=a,html("id-input-mindb").value=mindb,html("id-field-mindb").innerHTML=a.toFixed(0)+" dB",html("id-field-mindb").style.color="white",html("id-field-maxdb").style.color="white"),mindb_un=mindb+zoomCorrection(),setmaxmindb(e)}function setmaxmindb(e){full_scale=(full_scale=maxdb-mindb)||1,spectrum_dB_bands(),wf_send("SET maxdb="+maxdb.toFixed(0)+" mindb="+mindb.toFixed(0)),need_clear_specavg=!0,e&&(freqset_select(),writeCookie(audioFFT_active?"last_AF_max_dB":"last_max_dB",maxdb.toFixed(0)),writeCookie(audioFFT_active?"last_AF_min_dB":"last_min_dB",mindb_un.toFixed(0)))}function update_maxmindb_sliders(){mindb=mindb_un-zoomCorrection(),full_scale=(full_scale=maxdb-mindb)||1,spectrum_dB_bands(),html("id-input-maxdb").value=maxdb,html("id-field-maxdb").innerHTML=maxdb.toFixed(0)+" dB",html("id-input-mindb").value=mindb,html("id-field-mindb").innerHTML=mindb.toFixed(0)+" dB"}var need_wf_autoscale=!1;function wf_autoscale(){freqset_select(),need_wf_autoscale=!0}var spectrum_slow_dev=0;function toggle_or_set_slow_dev(e,t){"number"==typeof e?spectrum_slow_dev=kiwi_toggle(e,t,spectrum_slow_dev,"last_slow_dev"):spectrum_slow_dev^=1,w3_color("id-button-slow-dev",spectrum_slow_dev?"lime":"white"),freqset_select(),writeCookie("last_slow_dev",spectrum_slow_dev.toString()),spectrum_slow_dev&&wf_speed==WF_SPEED_FAST&&setwfspeed(1,WF_SPEED_MED)}var spectrum_peak=0,spectrum_peak_clear=!1;function toggle_or_set_spec_peak(e,t){"number"==typeof e?spectrum_peak=kiwi_toggle(e,t,spectrum_peak,"last_spec_peak"):spectrum_peak^=1,spectrum_peak||(spectrum_peak_clear=!0),w3_color("id-button-spec-peak",spectrum_peak?"lime":"white"),freqset_select(),writeCookie("last_spec_peak",spectrum_peak.toString())}var muted_until_freq_set=!0,muted=!1,volume=50,f_volume=0,recording=!1;function setvolume(e,t){volume=+t,volume=Math.max(0,Math.min(200,volume)),f_volume=muted?0:volume/100,e&&(w3_set_value("id-input-volume",volume),freqset_select())}function toggle_or_set_mute(e){"number"==typeof e?muted=e:muted^=1,w3_show_hide("id-mute-no",!muted),w3_show_hide("id-mute-yes",muted),w3_color("id-button-mute",muted?"lime":"white"),f_volume=muted?0:volume/100,freqset_select()}var de_emphasis=0,de_emphasis_s=["off","75us","50us"];function de_emp_cb(e,t,a){snd_send("SET de_emp="+(de_emphasis=+t)),writeCookie("last_de_emphasis",de_emphasis.toString())}var pan=0;function setpan(e,t){var a=+t;a>-.1&&a<.1&&(a=0),w3_set_value("id-pan-value",a),w3_innerHTML("id-pan-field",a?(100*Math.abs(a)).toFixed(0)+" "+(a<0?"L":"R"):"L=R"),audio_set_pan(a),e&&(writeCookie("last_pan",a.toString()),freqset_select())}function audio_panner_ui_init(){audio_panner&&(w3_show_block("id-pan"),setpan(1,pan))}var hide_topbar=0;function toggle_or_set_hide_topbar(e){"number"==typeof e?hide_topbar=e:1&(hide_topbar=hide_topbar+1&3)&&(extint.using_data_container||spectrum_display)&&(hide_topbar=hide_topbar+1&3),w3_set_props("id-top-container","w3-panel-override-hide",1&hide_topbar),w3_set_props("id-band-container","w3-panel-override-hide",2&hide_topbar),openwebrx_resize()}var hide_panels=0,test_button;function toggle_or_set_hide_panels(e){"number"==typeof e?hide_panels=e:hide_panels^=1,w3_iterate_children("id-panels-container",function(e){w3_contains(e,"class-panel")&&w3_set_props(e,"w3-panel-override-hide",hide_panels)})}function toggle_or_set_test(e){"number"==typeof e?test_button=e:test_button^=1,console.log("toggle_or_set_test set="+e+" test_button="+test_button),w3_color("id-button-test",test_button?"lime":"white"),snd_send("SET test="+(test_button?1:0)),freqset_select()}function toggle_or_set_rec(e){recording=!recording;var t=w3_el("id-rec1"),a=w3_el("id-rec2");if(recording?(w3_remove_then_add(t,"fa-circle","fa-circle-o-notch fa-spin"),w3_remove(a,"w3-hide")):(w3_remove_then_add(t,"fa-circle-o-notch fa-spin","fa-circle"),w3_add(a,"w3-hide")),recording)window.recording_meta={buffers:[],data:null,offset:0,total_size:0,filename:window.location.hostname+"_"+(new Date).toISOString().replace(/:/g,"_").replace(/\.[0-9]+Z$/,"Z")+"_"+w3_el("id-freq-input").value+"_"+cur_mode+".wav"},window.recording_meta.buffers.push(new ArrayBuffer(65536)),window.recording_meta.data=new DataView(window.recording_meta.buffers[0]);else{var n=new ArrayBuffer(44),_=new DataView(n);_.setUint32(0,1380533830),_.setUint32(4,window.recording_meta.total_size+36,!0),_.setUint32(8,1463899717),_.setUint32(12,1718449184),_.setUint32(16,16,!0),_.setUint16(20,1,!0);var i="iq"===cur_mode?2:1;_.setUint16(22,i,!0);var o=Math.round(audio_input_rate||12e3);_.setUint32(24,o,!0);_.setUint32(28,o*i*2,!0),_.setUint16(32,2*i,!0),_.setUint16(34,16,!0),_.setUint32(36,1684108385),_.setUint32(40,window.recording_meta.total_size,!0),window.recording_meta.buffers.unshift(n);var s=new Blob(window.recording_meta.buffers,{type:"octet/stream"}),r=document.createElement("a");r.style="display: none",r.href=window.URL.createObjectURL(s),r.download=window.recording_meta.filename,document.body.appendChild(r),r.click(),window.URL.revokeObjectURL(r.href),document.body.removeChild(r),delete window.recording_meta}}var squelch_state=0,squelch=0;function squelch_setup(e){if(e&toggle_e.FROM_COOKIE){var t=readCookie("last_squelch");null!=t&&(squelch=t,w3_set_value("id-squelch-value",t),setsquelch(1,t))}"nbfm"==cur_mode?(w3_el("id-squelch-label").style.color=squelch_state?"lime":"white",w3_el("id-squelch-field").innerHTML=squelch,w3_show_block("id-squelch")):w3_hide("id-squelch")}function setsquelch(e,t){squelch=parseFloat(t),w3_el("id-squelch-field").innerHTML=t,e&&(snd_send("SET squelch="+squelch.toFixed(0)+" max="+squelch_threshold.toFixed(0)),writeCookie("last_squelch",t))}var btn_less_buffering=0;function toggle_or_set_audio(e,t){"number"==typeof e?btn_less_buffering=kiwi_toggle(e,t,btn_less_buffering,"last_audio"):btn_less_buffering^=1;var a=w3_el("id-button-buffering");a&&(a.style.color=btn_less_buffering?"lime":"white",a.style.visibility="visible",freqset_select()),writeCookie("last_audio",btn_less_buffering.toString()),"number"!=typeof e&&window.location.reload(!0)}var btn_compression=0;function toggle_or_set_compression(e,t){if(!recording){"number"==typeof e?btn_compression=kiwi_toggle(e,t,btn_compression,"last_compression"):btn_compression^=1;var a=w3_el("id-button-compression");a&&(a.style.color=btn_compression?"lime":"white",a.style.visibility="visible",freqset_select()),writeCookie("last_compression",btn_compression.toString()),snd_send("SET compression="+btn_compression.toFixed(0))}}var btn_nb=0;function toggle_or_set_nb(e,t){null!=e?btn_nb=kiwi_toggle(e,t,btn_nb,"last_nb"):btn_nb^=1;var a=w3_el("id-button-nb");a.style.color=btn_nb?"lime":"white",a.style.visibility="visible",freqset_select(),writeCookie("last_nb",btn_nb.toString()),nb_send(btn_nb?noiseGate:0,noiseThresh)}function nb_send(e,t){snd_send("SET nb="+e+" th="+t),wf_send("SET nb="+e+" th="+t)}var default_noiseGate=100,noiseGate=default_noiseGate;function setNoiseGate(e,t){noiseGate=parseFloat(t),html("input-noise-gate").value=noiseGate,html("field-noise-gate").innerHTML=t,nb_send(btn_nb?noiseGate:0,noiseThresh),writeCookie("last_noiseGate",noiseGate.toString()),e&&freqset_select()}var default_noiseThresh=50,noiseThresh=default_noiseThresh;function setNoiseThresh(e,t){noiseThresh=parseFloat(t),html("input-noise-th").value=noiseThresh,html("field-noise-th").innerHTML=t,nb_send(btn_nb?noiseGate:0,noiseThresh),writeCookie("last_noiseThresh",noiseThresh.toString()),e&&freqset_select()}function nb_setup(e){setNoiseGate(!0,noiseGate=kiwi_toggle(e,default_noiseGate,noiseGate,"last_noiseGate")),setNoiseThresh(!0,noiseThresh=kiwi_toggle(e,default_noiseThresh,noiseThresh,"last_noiseThresh"))}var nb_test=0;function toggle_nb_test(){nb_test^=1,w3_el("id-button-nb-test").style.color=nb_test?"lime":"white",freqset_select(),nb_send(nb_test?-1:-2,noiseThresh)}function lms_denoise_load_cb(e,t,a){a||kiwi_load_js(["extensions/LMS_filter/LMS_filter.js"],function(){lms_denoise_cb(e,t,a)})}function lms_autonotch_load_cb(e,t,a){a||kiwi_load_js(["extensions/LMS_filter/LMS_filter.js"],function(){lms_autonotch_cb(e,t,a)})}function set_agc(){snd_send("SET agc="+agc+" hang="+hang+" thresh="+thresh+" slope="+slope+" decay="+decay+" manGain="+manGain)}var agc=0;function toggle_agc(e){return any_alternate_click_event(e)?setup_agc(toggle_e.SET):toggle_or_set_agc(),cancelEvent(e)}function agc_over(e){w3_el("id-button-agc").title=any_alternate_click_event(e)?"restore AGC params":""}var default_agc=1,default_hang=0,default_manGain=50,default_thresh=-130,default_slope=6,default_decay=1e3;function setup_agc(e){toggle_or_set_agc(agc=kiwi_toggle(e,default_agc,agc,"last_agc")),toggle_or_set_hang(hang=kiwi_toggle(e,default_hang,hang,"last_hang")),setManGain(!0,manGain=kiwi_toggle(e,default_manGain,manGain,"last_manGain")),setThresh(!0,thresh=kiwi_toggle(e,default_thresh,thresh,"last_thresh")),setSlope(!0,slope=kiwi_toggle(e,default_slope,slope,"last_slope")),setDecay(!0,decay=kiwi_toggle(e,default_decay,decay,"last_decay"))}function toggle_or_set_agc(e){null!=e?agc=e:agc^=1,html("id-button-agc").style.color=agc?"lime":"white",agc?(html("id-label-man-gain").style.color="white",html("id-button-hang").style.borderColor=html("label-threshold").style.color=html("label-slope").style.color=html("label-decay").style.color="orange"):(html("id-label-man-gain").style.color="orange",html("id-button-hang").style.borderColor=html("label-threshold").style.color=html("label-slope").style.color=html("label-decay").style.color="white"),set_agc(),writeCookie("last_agc",agc.toString()),freqset_select()}var hang=0;function toggle_or_set_hang(e){null!=e?hang=e:hang^=1,html("id-button-hang").style.color=hang?"lime":"white",set_agc(),writeCookie("last_hang",hang.toString()),freqset_select()}var manGain=0;function setManGain(e,t){manGain=parseFloat(t),html("input-man-gain").value=manGain,html("field-man-gain").innerHTML=t,set_agc(),writeCookie("last_manGain",manGain.toString()),e&&freqset_select()}var thresh=0;function setThresh(e,t){thresh=parseFloat(t),html("input-threshold").value=thresh,html("field-threshold").innerHTML=t,set_agc(),writeCookie("last_thresh",thresh.toString()),e&&freqset_select()}var slope=0;function setSlope(e,t){slope=parseFloat(t),html("input-slope").value=slope,html("field-slope").innerHTML=t,set_agc(),writeCookie("last_slope",slope.toString()),e&&freqset_select()}var decay=0;function setDecay(e,t){decay=parseFloat(t),html("input-decay").value=decay,html("field-decay").innerHTML=t,set_agc(),writeCookie("last_decay",decay.toString()),e&&freqset_select()}function users_setup(){for(var e="",t=0;t<rx_chans;t++)e+=w3_div("",w3_div("w3-show-inline-block w3-left w3-margin-R-5 "+(t==rx_chan?"w3-text-css-lime":optbar_prefix_color),"RX"+t),w3_div("id-optbar-user-"+t+" w3-show-inline-block"));html("id-optbar-users").innerHTML=w3_div("w3-nowrap",e)}function play_button(){try{if(kiwi_is_iOS()){var e=audio_context,t=e.createBufferSource();t.connect(e.destination);try{t.start(0)}catch(e){t.noteOn(0)}}else try{audio_context&&audio_context.resume()}catch(e){console.log("#### audio_context.resume() FAILED")}}catch(e){add_problem("audio start")}w3_el("id-play-button-container").style.opacity=0,setTimeout(function(){w3_hide("id-play-button-container")},1100),freqset_select()}function freq_up_down_cb(e,t){freq_memory_up_down(+t),w3_field_select("id-freq-input",{focus_only:1})}var spectrum_display=!1;function toggle_or_set_spec(e,t){"number"==typeof e&&e&toggle_e.SET?spectrum_display=t:spectrum_display^=1,extint.using_data_container&&spectrum_display&&extint_panel_hide(),html("id-button-spectrum").style.color=spectrum_display?"lime":"white",w3_show_hide("id-spectrum-container",spectrum_display),w3_show_hide("id-top-container",!spectrum_display),freqset_select()}var band_menu=[],step_9_10,divControl;function setup_band_menu(){var e,t=0,a=null,n="";for(band_menu[t++]=null,e=0;e<bands.length;e++){var _=bands[e];"*"!=_.region&&">"!=_.region.charAt(0)&&"m"!=_.region||(_.s!=svc.L&&_.s!=svc.X||"m"!=_.region||_.name.includes("IBP")||(_.name="IBP "+_.name),a!=_.s.name&&(a=_.s.name,n+='<option value="'+t+'" disabled>'+_.s.name.toUpperCase()+"</option>",band_menu[t++]=null),n+='<option value="'+t+'">'+_.name+"</option>",band_menu[t++]=_)}return n}function mode_over(e,t){t.title=e.shiftKey?"restore passband":""}function any_alternate_click_event(e){return e.shiftKey||e.ctrlKey||e.altKey||e.button==mouse.middle||e.button==mouse.right}function restore_passband(e){passbands[e].last_lo=passbands[e].lo,passbands[e].last_hi=passbands[e].hi}function mode_button(e,t){var a=t.innerHTML.toLowerCase();recording&&"iq"===cur_mode||recording&&"iq"!=cur_mode&&"iq"===a||(any_alternate_click_event(e)&&restore_passband(a),demodulator_analog_replace(a))}function button_9_10(e){null!=e?step_9_10=e:step_9_10^=1,writeCookie("last_9_10",step_9_10),freq_step_update_ui(!0),w3_el("id-button-9-10").innerHTML=step_9_10?"9":"10",freqset_select()}function pop_bottommost_panel(e){min_order=parseInt(e[0].getAttribute("data-panel-order")),min_index=0;for(var t=0;t<e.length;t++)actual_order=parseInt(e[t].getAttribute("data-panel-order")),actual_order<min_order&&(min_index=t,min_order=actual_order);return to_return=e[min_index],e.splice(min_index,1),to_return}function place_panels(){for(var e=[],t=[],a=html("id-panels-container").children,n=0;n<a.length;n++){var _=a[n];if(_.classList.contains("class-panel")){var i=_.getAttribute("data-panel-pos");if(!i)continue;var o=_.getAttribute("data-panel-size").split(",");"left"==i?e.push(_):"right"==i&&t.push(_),_.idName=_.id.replace("id-",""),_.style.width=o[0]+"px",_.style.height=o[1]+"px",_.style.margin=px(panel_margin),_.uiWidth=parseInt(o[0]),_.uiHeight=parseInt(o[1]),_.defaultWidth=parseInt(o[0]),_.defaultHeight=parseInt(o[1]);var s=html_LR_border_pad(_);_.activeWidth=_.uiWidth-s,"center"==i&&(_.style.left=px(window.innerWidth/2-_.activeWidth/2),_.style.bottom=px(window.innerHeight/2-_.uiHeight/2),_.style.visibility="hidden"),"bottom-left"==i&&(_.style.left=0,_.style.bottom=0,_.style.visibility="hidden")}}for(y=0;e.length>0;)p=pop_bottommost_panel(e),p.style.left=0,p.style.bottom=px(y),p.style.visibility="visible",y+=p.uiHeight+3*panel_margin,w3_call("panel_setup_"+p.idName,p);for(y=0;t.length>0;)p=pop_bottommost_panel(t),p.style.right=px(kiwi_scrollbar_width()),p.style.bottom=px(y),p.style.visibility="visible",y+=p.uiHeight+3*panel_margin,w3_call("panel_setup_"+p.idName,p)}var CONTROL_HEIGHT=230,OPTBAR_HEIGHT=136,OPTBAR_TMARGIN=8;function panel_setup_control(e){divControl=e,w3_el("id-control-inner").innerHTML=w3_div("id-control-freq1")+w3_div("id-control-freq2")+w3_div("id-control-mode w3-margin-T-6")+w3_div("id-control-zoom w3-margin-T-6")+w3_div("id-control-squelch")+w3_div("id-optbar w3-margin-T-4")+w3_div("id-optbar-content w3-margin-T-8 w3-scroll-y|height:"+px(OPTBAR_HEIGHT),w3_div("id-optbar-wf w3-hide"),w3_div("id-optbar-audio w3-hide"),w3_div("id-optbar-agc w3-hide"),w3_div("id-optbar-users w3-hide w3-scroll-x"),w3_div("id-optbar-status w3-hide"))+w3_div("id-control-smeter w3-margin-T-8"),w3_el("id-control-freq1").style.width=px(e.activeWidth-visIcon-6),w3_show_hide("id-mute-no",!muted),w3_show_hide("id-mute-yes",muted)}function panel_set_vis_button(e){var t=w3_el(e),a=w3_el(e+"-vis"),n=t.activeWidth-visIcon;a.style.left=px(n+visBorder)}function panel_set_width_height(e,t,a){var n=w3_el(e);null==t&&(t=n.defaultWidth),n.style.width=px(t),n.uiWidth=t,null==a&&(a=n.defaultHeight),n.style.height=px(a),n.uiHeight=a;var _=html_LR_border_pad(n);n.activeWidth=n.uiWidth-_,panel_set_vis_button(e)}function event_dump(e,t){console.log("================================"),console.log("EVENT_DUMP: "+t+" type="+e.type),console.log((e.shiftKey?"SFT ":"")+(e.ctrlKey?"CTL ":"")+(e.altKey?"ALT ":"")+(e.metaKey?"META ":"")+"key="+e.key),console.log("this.id="+this.id+" tgt.name="+e.target.nodeName+" tgt.id="+e.target.id+" ctgt.id="+e.currentTarget.id),console.log("button="+e.button+" buttons="+e.buttons+" detail="+e.detail+" which="+e.which),console.log("offX="+e.offsetX+" pageX="+e.pageX+" clientX="+e.clientX+" layerX="+e.layerX),console.log("offY="+e.offsetY+" pageY="+e.pageY+" clientY="+e.clientY+" layerY="+e.layerY),console.log("evt, evt.target, evt.currentTarget:"),console.log(e),console.log(e.target),console.log(e.currentTarget),console.log("----")}function arrayBufferToString(e){return String.fromCharCode.apply(null,new Uint8Array(e))}function arrayBufferToStringLen(e,t){var a=new Uint8Array(e),n=String();t=Math.min(t,a.length);for(var _=0;_<t;_++)n+=String.fromCharCode(a[_]);return n}function add_problem(e,t,a,n){if(el=w3_el(n||"id-status-problems"),el){if(void 0!==el.children){for(var _=0;_<el.children.length;_++)if(el.children[_].innerHTML==e)return;if(0==t)for(;0!=el.children.length;)el.removeChild(el.children.shift())}var i=w3_appendElement(el,"span",e);1!=a&&window.setTimeout(function(e,t){try{e.removeChild(t)}catch(e){}},1e3,el,i)}}function set_gen(e,t){snd_send("SET genattn="+t.toFixed(0)),snd_send("SET gen="+e+" mix=-1")}var bin_server=0,zoom_server=0;function owrx_msg_cb(e,t){switch(e[0]){case"wf_setup":waterfall_init();break;case"extint_list_json":extint_list_json(e[1]),override_ext?extint_open(override_ext,3e3):"s4285"==override_mode&&extint_open("s4285",3e3);break;case"bandwidth":bandwidth=parseInt(e[1]);break;case"center_freq":center_freq=parseInt(e[1]);break;case"wf_fft_size":wf_fft_size=parseInt(e[1]);break;case"wf_fps_max":wf_fps_max=parseInt(e[1]);break;case"wf_fps":wf_fps=parseInt(e[1]);break;case"start":bin_server=parseInt(e[1]);break;case"zoom":zoom_server=parseInt(e[1]);break;case"zoom_max":zoom_levels_max=parseInt(e[1]),zoom_nom=Math.min(ZOOM_NOMINAL,zoom_levels_max);break;case"audio_init":toggle_or_set_audio(toggle_e.FROM_COOKIE|toggle_e.SET,1),audio_init(parseInt(e[1]),btn_less_buffering,kiwi_toggle(toggle_e.FROM_COOKIE|toggle_e.SET,1,1,"last_compression"));break;case"audio_rate":audio_rate(parseFloat(e[1]));break;case"kiwi_up":kiwi_up(parseInt(e[1]));break;case"gps":toggle_or_set_spec(toggle_e.SET,1);break;case"fft_mode":kiwi_fft_mode();break;case"squelch":squelch_state=parseInt(e[1]);var a=w3_el("id-squelch-label");a&&(a.style.color=squelch_state?"lime":"white")}}function owrx_ws_open_snd(e,t){return ws_snd=open_websocket("SND",e,t,owrx_msg_cb,audio_recv,on_ws_error)}function owrx_ws_open_wf(e,t){return ws_wf=open_websocket("W/F",e,t,owrx_msg_cb,waterfall_add_queue,on_ws_error)}function on_ws_error(){divlog("WebSocket error.",1)}function snd_send(e){try{return ws_snd.send(e),0}catch(t){return console.log("CATCH snd_send('"+e+"') ex="+t),kiwi_trace(),-1}}function wf_send(e){try{return ws_wf.send(e),0}catch(t){return console.log("CATCH wf_send('"+e+"') ex="+t),kiwi_trace(),-1}}var need_geo=!0,need_status=!0;function send_keepalive(){for(var e=0;e<1&&(ws_snd.up&&!(snd_send("SET keepalive")<0));e++){if(need_geo&&""!=kiwi_geo()){if(msg_send("SET geo="+kiwi_geo())<0)break;if(msg_send("SET geojson="+kiwi_geojson())<0)break;need_geo=!1}if(need_ident){if(ident_user||(ident_user=""),snd_send("SET ident_user="+encodeURIComponent(ident_user))<0)break;need_ident=!1}if(need_status){if(snd_send("SET need_status=1")<0)break;need_status=!1}}ws_wf.up&&wf_send("SET keepalive")}