!function(t,i){"use strict";"function"==typeof define&&define.amd?define(["leaflet"],t):"object"==typeof exports&&(module.exports=t(require("leaflet"))),void 0!==i&&i.L&&(i.L.Ruler=t(L))}(function(t){"use strict";t.Control.Ruler=t.Control.extend({options:{position:"topright",circleMarker:{color:"red",radius:2},lineStyle:{color:"red",dashArray:"1,6"},lengthUnit:{display:"km",decimal:2,factor:null,label:"Distance:"},angleUnit:{display:"&deg;",decimal:2,factor:null,label:"Bearing:"}},onAdd:function(i){return this._map=i,this._container=t.DomUtil.create("div","leaflet-bar"),this._container.classList.add("leaflet-ruler"),t.DomEvent.disableClickPropagation(this._container),t.DomEvent.on(this._container,"click",this._toggleMeasure,this),this._choice=!1,this._defaultCursor=this._map._container.style.cursor,this._allLayers=t.layerGroup(),this._container},onRemove:function(){t.DomEvent.off(this._container,"click",this._toggleMeasure,this)},_toggleMeasure:function(){this._choice=!this._choice,this._clickedLatLong=null,this._clickedPoints=[],this._totalLength=0,this._choice?(this._map.doubleClickZoom.disable(),t.DomEvent.on(this._map._container,"keydown",this._escape,this),t.DomEvent.on(this._map._container,"dblclick",this._closePath,this),this._container.classList.add("leaflet-ruler-clicked"),this._clickCount=0,this._tempLine=t.featureGroup().addTo(this._allLayers),this._tempPoint=t.featureGroup().addTo(this._allLayers),this._pointLayer=t.featureGroup().addTo(this._allLayers),this._polylineLayer=t.featureGroup().addTo(this._allLayers),this._allLayers.addTo(this._map),this._map._container.style.cursor="crosshair",this._map.on("click",this._clicked,this),this._map.on("mousemove",this._moving,this)):(this._map.doubleClickZoom.enable(),t.DomEvent.off(this._map._container,"keydown",this._escape,this),t.DomEvent.off(this._map._container,"dblclick",this._closePath,this),this._container.classList.remove("leaflet-ruler-clicked"),this._map.removeLayer(this._allLayers),this._allLayers=t.layerGroup(),this._map._container.style.cursor=this._defaultCursor,this._map.off("click",this._clicked,this),this._map.off("mousemove",this._moving,this))},_clicked:function(i){var e;(this._clickedLatLong=i.latlng,this._clickedPoints.push(this._clickedLatLong),t.circleMarker(this._clickedLatLong,this.options.circleMarker).addTo(this._pointLayer),this._clickCount>0&&!i.latlng.equals(this._clickedPoints[this._clickedPoints.length-2]))&&(this._movingLatLong&&t.polyline([this._clickedPoints[this._clickCount-1],this._movingLatLong],this.options.lineStyle).addTo(this._polylineLayer),this._totalLength+=this._result.Distance,e=this._clickCount>1?"<b>"+this.options.angleUnit.label+"</b>&nbsp;"+this._result.Bearing.toFixed(this.options.angleUnit.decimal)+"&nbsp;"+this.options.angleUnit.display+"<br><b>"+this.options.lengthUnit.label+"</b>&nbsp;"+this._totalLength.toFixed(this.options.lengthUnit.decimal)+"&nbsp;"+this.options.lengthUnit.display:"<b>"+this.options.angleUnit.label+"</b>&nbsp;"+this._result.Bearing.toFixed(this.options.angleUnit.decimal)+"&nbsp;"+this.options.angleUnit.display+"<br><b>"+this.options.lengthUnit.label+"</b>&nbsp;"+this._result.Distance.toFixed(this.options.lengthUnit.decimal)+"&nbsp;"+this.options.lengthUnit.display,t.circleMarker(this._clickedLatLong,this.options.circleMarker).bindTooltip(e,{permanent:!0,className:"result-tooltip"}).addTo(this._pointLayer).openTooltip());this._clickCount++},_moving:function(i){var e;this._clickedLatLong&&(t.DomEvent.off(this._container,"click",this._toggleMeasure,this),this._movingLatLong=i.latlng,this._tempLine&&(this._map.removeLayer(this._tempLine),this._map.removeLayer(this._tempPoint)),this._addedLength=0,this._tempLine=t.featureGroup(),this._tempPoint=t.featureGroup(),this._tempLine.addTo(this._map),this._tempPoint.addTo(this._map),this._calculateBearingAndDistance(),this._addedLength=this._result.Distance+this._totalLength,t.polyline([this._clickedLatLong,this._movingLatLong],this.options.lineStyle).addTo(this._tempLine),e=this._clickCount>1?"<b>"+this.options.angleUnit.label+"</b>&nbsp;"+this._result.Bearing.toFixed(this.options.angleUnit.decimal)+"&nbsp;"+this.options.angleUnit.display+"<br><b>"+this.options.lengthUnit.label+"</b>&nbsp;"+this._addedLength.toFixed(this.options.lengthUnit.decimal)+"&nbsp;"+this.options.lengthUnit.display+'<br><div class="plus-length">(+'+this._result.Distance.toFixed(this.options.lengthUnit.decimal)+")</div>":"<b>"+this.options.angleUnit.label+"</b>&nbsp;"+this._result.Bearing.toFixed(this.options.angleUnit.decimal)+"&nbsp;"+this.options.angleUnit.display+"<br><b>"+this.options.lengthUnit.label+"</b>&nbsp;"+this._result.Distance.toFixed(this.options.lengthUnit.decimal)+"&nbsp;"+this.options.lengthUnit.display,t.circleMarker(this._movingLatLong,this.options.circleMarker).bindTooltip(e,{sticky:!0,offset:t.point(0,-40),className:"moving-tooltip"}).addTo(this._tempPoint).openTooltip())},_escape:function(t){27===t.keyCode&&(this._clickCount>0?this._closePath():(this._choice=!0,this._toggleMeasure()))},_calculateBearingAndDistance:function(){var t=this._clickedLatLong.lat,i=this._clickedLatLong.lng,e=this._movingLatLong.lat,s=this._movingLatLong.lng,n=Math.PI/180,o=Math.sin((s-i)*n)*Math.cos(e*n),a=Math.cos(t*n)*Math.sin(e*n)-Math.sin(t*n)*Math.cos(e*n)*Math.cos((s-i)*n),l=Math.atan2(o,a)*((this.options.angleUnit.factor?this.options.angleUnit.factor/2:180)/Math.PI);l+=l<0?this.options.angleUnit.factor?this.options.angleUnit.factor:360:0;var h=this.options.lengthUnit.factor?6371*this.options.lengthUnit.factor:6371,c=(e-t)*n,r=(s-i)*n,_=Math.sin(c/2)*Math.sin(c/2)+Math.cos(t*n)*Math.cos(e*n)*Math.sin(r/2)*Math.sin(r/2),p=h*(2*Math.atan2(Math.sqrt(_),Math.sqrt(1-_)));this._result={Bearing:l,Distance:p}},_closePath:function(){this._map.removeLayer(this._tempLine),this._map.removeLayer(this._tempPoint),this._choice=!1,t.DomEvent.on(this._container,"click",this._toggleMeasure,this),this._toggleMeasure()}}),t.control.ruler=function(i){return new t.Control.Ruler(i)}},window);